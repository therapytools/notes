<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Safety Plan Tool</title>
    <!-- Tailwind CSS for modern styling and responsiveness -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <!-- jsPDF library for PDF generation -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .form-label {
            font-weight: 600;
            color: #374151;
            margin-bottom: 0.5rem;
            display: block;
        }
        .form-group {
            margin-bottom: 1.5rem;
        }
        .dynamic-input, .three-col-input {
            display: flex;
            align-items: center;
            margin-bottom: 0.5rem;
            gap: 0.5rem;
        }
        .dynamic-input input[type="text"], .three-col-input input[type="text"] {
            flex: 1;
        }
        .three-col-input .ext-field {
            flex-basis: 100px;
            flex-grow: 0;
        }
        .dynamic-input button, .three-col-input button {
            flex-shrink: 0;
        }
    </style>
</head>
<body class="bg-gray-100">

    <div class="container mx-auto p-4 md:p-8 max-w-4xl">
        <main class="bg-white p-6 rounded-xl shadow-lg" id="app-container">
            <header class="text-center mb-8">
                <h1 class="text-3xl md:text-4xl font-bold text-gray-800">Safety Plan</h1>
            </header>
            
            <div class="header-row grid grid-cols-1 md:grid-cols-3 gap-4 mb-8">
                <div>
                    <label class="form-label" for="patientName">Patient Name:</label>
                    <input id="patientName" name="patientName" type="text" class="w-full p-2 border border-gray-300 rounded-md">
                </div>
                <div>
                    <label class="form-label" for="planDate">Date:</label>
                    <input id="planDate" name="planDate" type="date" class="w-full p-2 border border-gray-300 rounded-md">
                </div>
                <div>
                    <label class="form-label" for="createdWith">Created with help from:</label>
                    <input id="createdWith" name="createdWith" type="text" class="w-full p-2 border border-gray-300 rounded-md">
                </div>
            </div>

            <div class="form-group">
                <label class="form-label">Warning signs (thoughts, images, mood, situation, behavior) that a crisis may be developing:</label>
                <div id="warningSignsList" class="space-y-2"></div>
            </div>
            <div class="form-group">
                <label class="form-label">Internal coping strategies (relaxation techniques, physical activities, distractions, etc.):</label>
                <div id="copingStrategiesList" class="space-y-2"></div>
            </div>
            <div class="form-group">
                <label class="form-label">People who can provide distractions:</label>
                <div id="distractionPeopleList" class="space-y-2"></div>
            </div>
            <div class="form-group">
                <label class="form-label">Social settings that can provide distractions:</label>
                <div id="socialSettingsList" class="space-y-2"></div>
            </div>
            <div class="form-group">
                <label class="form-label">People who I can ask for help:</label>
                <div id="helpPeopleList" class="space-y-2"></div>
            </div>
            <div class="form-group">
                <label class="form-label">Ways I can make my environment safe:</label>
                <div id="safetyEnvironmentList" class="space-y-2"></div>
            </div>
            <div class="form-group">
                <label class="form-label">Professionals or agencies I can contact for help:</label>
                <div id="professionalHelpList" class="space-y-2"></div>
            </div>

            <div class="form-group checkbox-group">
                <label class="form-label">National and NYS Resources:</label>
                <div class="grid grid-cols-1 gap-y-2">
                    <label class="flex items-center"><input type="checkbox" checked class="h-4 w-4 rounded border-gray-300 text-indigo-600 mr-2"> <strong>Suicide &amp; Crisis Lifeline:</strong> 988</label>
                    <label class="flex items-center"><input type="checkbox" class="h-4 w-4 rounded border-gray-300 text-indigo-600 mr-2"> <strong>Veteran Crisis Line:</strong> 988, option 1</label>
                    <label class="flex items-center"><input type="checkbox" checked class="h-4 w-4 rounded border-gray-300 text-indigo-600 mr-2"> <strong>Crisis Text Line:</strong> Text HOME to 741741</label>
                    <label class="flex items-center"><input type="checkbox" class="h-4 w-4 rounded border-gray-300 text-indigo-600 mr-2"> <strong>NAMI:</strong> 1-800-950-NAMI (6264)</label>
                    <label class="flex items-center"><input type="checkbox" class="h-4 w-4 rounded border-gray-300 text-indigo-600 mr-2"> <strong>SAMHSA:</strong> 1‑800‑662‑HELP (4357)</label>
                    <label class="flex items-center"><input type="checkbox" class="h-4 w-4 rounded border-gray-300 text-indigo-600 mr-2"> <strong>NYS HOPEline:</strong> 1-877-846-7369</label>
                    <label class="flex items-center"><input type="checkbox" class="h-4 w-4 rounded border-gray-300 text-indigo-600 mr-2"> <strong>Disaster & Distress Help Line:</strong> 1-800-985-5990</label>
                    <label class="flex items-center"><input type="checkbox" class="h-4 w-4 rounded border-gray-300 text-indigo-600 mr-2"> <strong>National Domestic Violence Hotline:</strong> 1-800‑799‑SAFE (7233)</label>
                    <label class="flex items-center"><input type="checkbox" class="h-4 w-4 rounded border-gray-300 text-indigo-600 mr-2"> <strong>NYS Domestic Violence Hotline:</strong> 1-800-942-6906</label>
                    <label class="flex items-center"><input type="checkbox" class="h-4 w-4 rounded border-gray-300 text-indigo-600 mr-2"> <strong>Childhelp National Child Abuse Hotline:</strong> 1‑800‑422‑4453</label>
                    <label class="flex items-center"><input type="checkbox" class="h-4 w-4 rounded border-gray-300 text-indigo-600 mr-2"> <strong>RAINN (Sexual Assault):</strong> 1‑800‑656‑4673</label>
                    <label class="flex items-center"><input type="checkbox" class="h-4 w-4 rounded border-gray-300 text-indigo-600 mr-2"> <strong>National Eating Disorder Association:</strong> 1‑800‑931‑2237</label>
                    <label class="flex items-center"><input type="checkbox" class="h-4 w-4 rounded border-gray-300 text-indigo-600 mr-2"> <strong>The Trevor Project for LGBTQ Youth:</strong> 1‑866‑488‑7386</label>
                </div>
            </div>
            
            <button id="saveBtn" class="mt-8 w-full md:w-auto px-6 py-3 bg-indigo-600 text-white font-semibold rounded-lg shadow-md hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">Save as PDF</button>
        </main>
    </div>

<script>
    const { jsPDF } = window.jspdf;

    /**
     * PDF Generation Function
     */
    function generatePDF() {
      const doc = new jsPDF();
      const pageHeight = doc.internal.pageSize.height;
      const pageWidth = doc.internal.pageSize.width;
      const margin = 15;
      let y = 20; // Initial Y position

      function checkPageBreak(requiredHeight) {
        if (y + requiredHeight >= pageHeight - margin) {
          doc.addPage();
          y = margin;
        }
      }

      doc.setFontSize(18);
      doc.setFont(undefined, 'bold');
      doc.text("Safety Plan", pageWidth / 2, y, { align: 'center' });
      y += 10;

      const patientName = `Patient Name: ${document.getElementById('patientName').value || 'N/A'}`;
      let planDateStr = "N/A";
      const dateValue = document.getElementById('planDate').value;
      if (dateValue) {
        const [year, month, day] = dateValue.split('-');
        planDateStr = `${month}-${day}-${year}`;
      }
      const planDate = `Date: ${planDateStr}`;
      const createdWith = `Created with: ${document.getElementById('createdWith').value || 'N/A'}`;
      
      doc.setFontSize(9);
      doc.setFont(undefined, 'normal');
      checkPageBreak(10);
      doc.text(patientName, margin, y);
      doc.text(planDate, pageWidth / 2, y, { align: 'center' });
      doc.text(createdWith, pageWidth - margin, y, { align: 'right' });
      y += 10;
      
      const formGroups = document.querySelectorAll('.form-group');
      formGroups.forEach(group => {
        const label = group.querySelector('.form-label');
        if (label) {
            checkPageBreak(10);
            doc.setFontSize(11);
            doc.setFont(undefined, 'bold');
            doc.text(label.textContent, margin, y);
            y += 6;
        }

        const threeColInputs = group.querySelectorAll('.three-col-input');
        if (threeColInputs.length > 0) {
            const col1x = margin + 5, col2x = 90, col3x = 145;
            const col1Width = col2x - col1x - 2, col2Width = col3x - col2x - 2, col3Width = pageWidth - col3x - margin;

            if (Array.from(threeColInputs).some(input => input.querySelector('.name-field').value)) {
                doc.setFontSize(9);
                doc.setFont(undefined, 'bold');
                doc.text("Name", col1x, y);
                doc.text("Phone", col2x, y);
                doc.text("Extension", col3x, y);
                y += 4;
            }
            
            doc.setFontSize(9);
            doc.setFont(undefined, 'normal');
            threeColInputs.forEach(inputWrapper => {
                const name = inputWrapper.querySelector('.name-field').value;
                const phone = inputWrapper.querySelector('.phone-field').value;
                const ext = inputWrapper.querySelector('.ext-field').value;

                if (name || phone || ext) {
                    const nameLines = doc.splitTextToSize(name, col1Width);
                    const phoneLines = doc.splitTextToSize(phone, col2Width);
                    const extLines = doc.splitTextToSize(ext, col3Width);
                    
                    const linesRequired = Math.max(nameLines.length, phoneLines.length, extLines.length);
                    const heightRequired = linesRequired * 4;
                    checkPageBreak(heightRequired);

                    doc.text(nameLines, col1x, y);
                    doc.text(phoneLines, col2x, y);
                    doc.text(extLines, col3x, y);

                    y += heightRequired + 1;
                }
            });
        }
        
        const singleInputs = group.querySelectorAll('.dynamic-input input[type="text"]');
        if (singleInputs.length > 0) {
            doc.setFont(undefined, 'normal');
            doc.setFontSize(9);
            singleInputs.forEach(input => {
                if (input.value.trim() !== '') {
                    const line = `- ${input.value}`;
                    const splitText = doc.splitTextToSize(line, pageWidth - (margin * 2) - 5);
                    const heightRequired = splitText.length * 4;
                    checkPageBreak(heightRequired);
                    doc.text(splitText, margin + 5, y);
                    y += heightRequired + 1;
                }
            });
        }
        
        if (group.classList.contains('checkbox-group')) {
            const resources = [];
            const checkedBoxes = group.querySelectorAll('input[type="checkbox"]:checked');
            checkedBoxes.forEach(checkbox => {
                const fullText = checkbox.parentElement.textContent.trim();
                const parts = fullText.split(':');
                if (parts.length >= 2) {
                    const label = parts[0].trim();
                    let value = parts.slice(1).join(':').trim().replace(/‑/g, '-');
                    resources.push({ label, value });
                }
            });

            if (resources.length > 0) {
                const col1Width = 80;
                const col2x = margin + col1Width + 2;
                doc.setFontSize(9);
                resources.forEach(resource => {
                    doc.setFont(undefined, 'bold');
                    const labelLines = doc.splitTextToSize(resource.label, col1Width);
                    doc.setFont(undefined, 'normal');
                    const valueLines = doc.splitTextToSize(resource.value, pageWidth - col2x - margin);
                    const linesRequired = Math.max(labelLines.length, valueLines.length);
                    const heightRequired = linesRequired * 5;
                    checkPageBreak(heightRequired);
                    doc.setFont(undefined, 'bold');
                    doc.text(resource.label, margin + 5, y, { maxWidth: col1Width, align: 'left' });
                    doc.setFont(undefined, 'normal');
                    doc.text(resource.value, col2x, y, { maxWidth: (pageWidth - col2x - margin), align: 'left' });
                    y += heightRequired + 2;
                });
            }
        }
        y += 4;
      });
      
      const totalPages = doc.internal.getNumberOfPages();
      doc.setPage(totalPages);
      let signatureBlockY = pageHeight - 40;
      if (y > signatureBlockY) {
        doc.addPage();
        y = margin;
      }
      const signatureY = pageHeight - 35;
      const dateY = signatureY + 15;
      const labelY = signatureY + 4;
      const dateLabelY = dateY + 4;
      const lineLength = 75;
      const leftX = margin;
      const rightX = pageWidth - margin;
      doc.setFontSize(9);
      doc.setFont(undefined, 'normal');
      doc.line(leftX, signatureY, leftX + lineLength, signatureY);
      doc.text("Client", leftX, labelY);
      doc.line(leftX, dateY, leftX + lineLength, dateY);
      doc.text("Date", leftX, dateLabelY);
      doc.line(rightX - lineLength, signatureY, rightX, signatureY);
      doc.text("Clinician", rightX - lineLength, labelY);
      doc.line(rightX - lineLength, dateY, rightX, dateY);
      doc.text("Date", rightX - lineLength, dateLabelY);

      doc.save("safety_plan.pdf");
    }

    document.getElementById("saveBtn").addEventListener("click", generatePDF);

    function createPhoneRow() {
        return `
            <input type="text" placeholder="Name" class="name-field w-full p-2 border border-gray-300 rounded-md">
            <input type="text" placeholder="Phone (###-###-####)" class="phone-field w-full p-2 border border-gray-300 rounded-md">
            <input type="text" placeholder="Ext." class="ext-field w-full p-2 border border-gray-300 rounded-md">
        `;
    }

    function createDynamicList(containerId, count, isTriple = false) {
      const container = document.getElementById(containerId);
      for (let i = 0; i < count; i++) {
        addEntry(containerId, isTriple);
      }
    }

    function addEntry(containerId, isTriple = false) {
      const container = document.getElementById(containerId);
      const wrapper = document.createElement('div');
      wrapper.className = isTriple ? 'three-col-input' : 'dynamic-input';
      
      if (isTriple) {
        wrapper.innerHTML += createPhoneRow();
      } else {
        wrapper.innerHTML += '<input type="text" class="w-full p-2 border border-gray-300 rounded-md">';
      }

      const addBtn = document.createElement('button');
      addBtn.type = 'button';
      addBtn.innerHTML = '➕';
      addBtn.className = 'p-2 bg-green-500 text-white rounded-md hover:bg-green-600';
      addBtn.onclick = () => addEntry(containerId, isTriple);

      const removeBtn = document.createElement('button');
      removeBtn.type = 'button';
      removeBtn.innerHTML = '➖';
      removeBtn.className = 'p-2 bg-red-500 text-white rounded-md hover:bg-red-600';
      removeBtn.onclick = () => removeEntry(removeBtn);
      
      wrapper.appendChild(addBtn);
      wrapper.appendChild(removeBtn);
      container.appendChild(wrapper);
    }

    function removeEntry(button) {
      const row = button.parentElement;
      const container = row.parentElement;
      if (container.children.length > 1) {
        container.removeChild(row);
      }
    }

    document.addEventListener('input', function(e) {
        if (e.target.matches('.phone-field')) {
            const input = e.target;
            const value = input.value.replace(/\D/g, '').substring(0, 10);
            const size = value.length;
            if (size > 6) {
                input.value = `${value.substring(0, 3)}-${value.substring(3, 6)}-${value.substring(6, 10)}`;
            } else if (size > 3) {
                input.value = `${value.substring(0, 3)}-${value.substring(3, 6)}`;
            } else if (size > 0) {
                input.value = value;
            }
        }
    });

    document.addEventListener('DOMContentLoaded', () => {
      document.getElementById('planDate').value = new Date().toISOString().split('T')[0];
      createDynamicList('warningSignsList', 3);
      createDynamicList('copingStrategiesList', 3);
      createDynamicList('distractionPeopleList', 2, true);
      createDynamicList('socialSettingsList', 2);
      createDynamicList('helpPeopleList', 2, true);
      createDynamicList('safetyEnvironmentList', 2);
      createDynamicList('professionalHelpList', 2, true);
    });
  </script>
</body>
</html>
