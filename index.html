<!DOCTYPE html>
<html lang="en">
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <meta content="width=device-width, initial-scale=1.0" name="viewport">
    <title>Therapy Tools</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Custom styles for the tab interface */
        .tab-button {
            transition: background-color 0.3s, color 0.3s;
        }
        .tab-button.active {
            border-color: #4f46e5;
            color: #4f46e5;
            font-weight: 600;
        }
        /* Styles for MSE form */
        .mse-form-container {
            max-width: 900px;
            margin: 0 auto;
        }
        .mse-category {
            display: flex;
            flex-wrap: wrap;
            justify-content: space-between;
        }
        .mse-category label {
            width: 48%; /* Adjust for better spacing */
            margin-bottom: 4px;
        }
        @media (min-width: 768px) {
            .mse-category label {
                width: 30%;
            }
        }
        .mse-category input[type="text"] {
            width: 100%;
            margin: 5px 0;
        }
        .mse-custom-input {
            width: 98%;
            margin: 1%;
        }
        .mse-form-container legend {
            font-weight: bold;
            color: #c2410c; /* A more modern orange/red */
            font-size: 1.1em;
            margin-bottom: 0.5rem;
        }
        /* Styles for DARP form */
        .darp-form-container label, .darp-form-container select, .darp-form-container input {
            display: block;
        }
        .darp-form-container textarea {
            width: 100%;
            min-height: 80px;
            resize: none;
            overflow: hidden;
        }
        .darp-interventions {
            display: grid;
            gap: 1rem;
            grid-template-columns: 1fr; /* 1 column on mobile */
        }
        @media (min-width: 640px) { /* sm */
            .darp-interventions {
                grid-template-columns: repeat(2, 1fr);
            }
        }
        @media (min-width: 1024px) { /* lg */
            .darp-interventions {
                grid-template-columns: repeat(4, 1fr); /* Adjusted for 4 columns */
            }
        }
        .darp-column {
            padding: 0.75rem;
            border: 1px solid #d1d5db;
            border-radius: 8px;
            box-sizing: border-box;
        }
        .darp-inline-checkbox {
            display: flex;
            align-items: center;
            margin-bottom: 0.5rem;
            gap: 0.5rem; /* Adds space between checkbox and label */
        }
    </style>
</head>
<body class="bg-gray-100 font-sans p-4 md:p-8">
<div class="bg-white rounded-lg shadow-lg">
    <div class="border-b border-gray-200">
        <!-- This container now properly separates the wrapping tabs from the Clear All button -->
        <div class="flex justify-between items-center flex-wrap">
            <!-- This inner container holds all the tabs and allows them to wrap -->
            <div class="flex flex-1 flex-wrap">
                <button class="tab-button flex-grow text-center text-gray-500 hover:text-gray-700 py-4 px-2 border-b-2 border-transparent text-base md:text-lg active" id="defaultOpen" onclick="openTab(event, 'MSE')">
                    MSE
                </button>
                <button class="tab-button flex-grow text-center text-gray-500 hover:text-gray-700 py-4 px-2 border-b-2 border-transparent text-base md:text-lg" onclick="openTab(event, 'DARP')">
                    DARP
                </button>
                <button class="tab-button flex-grow text-center text-gray-500 hover:text-gray-700 py-4 px-2 border-b-2 border-transparent text-base md:text-lg" onclick="openTab(event, 'NoteTemplates')">
                    Templates
                </button>
                <button class="tab-button flex-grow text-center text-gray-500 hover:text-gray-700 py-4 px-2 border-b-2 border-transparent text-base md:text-lg" onclick="openTab(event, 'SUD')">
                    SUD Dx
                </button>
                <button class="tab-button flex-grow text-center text-gray-500 hover:text-gray-700 py-4 px-2 border-b-2 border-transparent text-base md:text-lg" onclick="openTab(event, 'Planner')">Planner</button>
                <button class="tab-button flex-grow text-center text-gray-500 hover:text-gray-700 py-4 px-2 border-b-2 border-transparent text-base md:text-lg" onclick="openTab(event, 'Letters')">Letters</button>
                <button class="tab-button flex-grow text-center text-gray-500 hover:text-gray-700 py-4 px-2 border-b-2 border-transparent text-base md:text-lg" onclick="openTab(event, 'SafetyPlan')">Safety Plan</button>
            </div>
            <!-- The Clear All button is now outside the wrapping container -->
            <button onclick="location.reload()" class="ml-4 my-2 mr-4 px-4 py-2 bg-red-600 text-white font-semibold rounded-md shadow-sm hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500 flex-shrink-0">
                Clear All
            </button>
        </div>
    </div>

    <!-- MSE Tab Content -->
    <div class="tabcontent p-4 sm:p-6 md:p-8" id="MSE" style="display: block;">
        <div class="mse-form-container">
            <h1 class="text-3xl font-bold text-center text-gray-800 mb-6">Mental Status Exam</h1>
            <fieldset class="border p-3 rounded-md mb-4">
                <legend>Presets</legend>
                <div class="space-y-2">
                    <label class="flex items-center"><input class="h-4 w-4 rounded border-gray-300 text-indigo-600 focus:ring-indigo-500" id="positiveMSE" onclick="togglePositiveMSE()" type="checkbox"> <span class="ml-2">Normal MSE</span></label>
                    <label class="flex items-center"><input class="h-4 w-4 rounded border-gray-300 text-indigo-600 focus:ring-indigo-500" id="telehealthpositiveMSE" onclick="TelehealthPositiveMSE()" type="checkbox"> <span class="ml-2">Telehealth Normal MSE</span></label><br>
                   <button class="mt-2 px-6 py-2 bg-indigo-600 text-white font-semibold rounded-md shadow-sm hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500" onclick="clearAllMseCheckboxes(); updateMseText();">
                        Clear Form
                    </button>
                </div>
            </fieldset>
            <div class="space-y-4">
                <fieldset class="border p-3 rounded-md"><legend>Orientation</legend><div class="mse-category"><label><input id="x4" onclick="updateMseText()" type="checkbox"> Oriented x4</label><label><input id="time" onclick="updateMseText()" type="checkbox"> Time</label><label><input id="place" onclick="updateMseText()" type="checkbox"> Place</label><label><input id="situation" onclick="updateMseText()" type="checkbox"> Situation</label><label><input id="person" onclick="updateMseText()" type="checkbox"> Person</label><input class="mse-custom-input border-gray-300 rounded-md" id="orientationCustom" oninput="updateMseText()" placeholder="Other" type="text"></div></fieldset>
                <fieldset class="border p-3 rounded-md"><legend>Clothing/Grooming</legend><div class="mse-category"><label><input id="neat" onclick="updateMseText()" type="checkbox"> Neat</label><label><input id="clean" onclick="updateMseText()" type="checkbox"> Clean</label><label><input id="appropriatelydressed" onclick="updateMseText()" type="checkbox"> Appropriately Dressed</label><label><input id="careless" onclick="updateMseText()" type="checkbox"> Careless</label><label><input id="disheveled" onclick="updateMseText()" type="checkbox"> Disheveled</label><label><input id="dirty" onclick="updateMseText()" type="checkbox"> Dirty</label><label><input id="inappropriate" onclick="updateMseText()" type="checkbox"> Inappropriate</label><label><input id="bizarre" onclick="updateMseText()" type="checkbox"> Bizarre</label><input class="mse-custom-input border-gray-300 rounded-md" id="clothingGroomingCustom" oninput="updateMseText()" placeholder="Other" type="text"></div></fieldset>
                <fieldset class="border p-3 rounded-md"><legend>Motor Activity</legend><div class="mse-category"><label><input id="notRemarkable" onclick="updateMseText()" type="checkbox"> Not Remarkable</label><label><input id="slowed" onclick="updateMseText()" type="checkbox"> Slowed</label><label><input id="repetitive" onclick="updateMseText()" type="checkbox"> Repetitive</label><label><input id="restless" onclick="updateMseText()" type="checkbox"> Restless</label><label><input id="agitated" onclick="updateMseText()" type="checkbox"> Agitated</label><label><input id="tremor" onclick="updateMseText()" type="checkbox"> Tremor</label><input class="mse-custom-input border-gray-300 rounded-md" id="motorActivityCustom" oninput="updateMseText()" placeholder="Other" type="text"></div></fieldset>
                <fieldset class="border p-3 rounded-md"><legend>Behavior</legend><div class="mse-category"><label><input id="appropriate" onclick="updateMseText()" type="checkbox"> Appropriate</label><label><input id="aggressive" onclick="updateMseText()" type="checkbox"> Aggressive</label><label><input id="angry" onclick="updateMseText()" type="checkbox"> Angry</label><label><input id="apathetic" onclick="updateMseText()" type="checkbox"> Apathetic</label><label><input id="irritable" onclick="updateMseText()" type="checkbox"> Irritable</label><label><input id="passive" onclick="updateMseText()" type="checkbox"> Passive</label><label><input id="manipulative" onclick="updateMseText()" type="checkbox"> Manipulative</label><input class="mse-custom-input border-gray-300 rounded-md" id="behaviorCustom" oninput="updateMseText()" placeholder="Other" type="text"></div></fieldset>
                <fieldset class="border p-3 rounded-md"><legend>Attention</legend><div class="mse-category"><label><input id="normalAttention" onclick="updateMseText()" type="checkbox"> Normal</label><label><input id="unaware" onclick="updateMseText()" type="checkbox"> Unaware</label><label><input id="distractible" onclick="updateMseText()" type="checkbox"> Distractible</label><label><input id="vigilant" onclick="updateMseText()" type="checkbox"> Vigilant</label><input class="mse-custom-input border-gray-300 rounded-md" id="attentionCustom" oninput="updateMseText()" placeholder="Other" type="text"></div></fieldset>
                <fieldset class="border p-3 rounded-md"><legend>Recall/Memory</legend><div class="mse-category"><label><input id="normalMemory" onclick="updateMseText()" type="checkbox"> Normal</label><label><input id="shortTermImpaired" onclick="updateMseText()" type="checkbox"> Short-term Impaired, Long-Term Intact</label><label><input id="longTermImpaired" onclick="updateMseText()" type="checkbox"> Short-term Intact, Long-term Impaired</label><input class="mse-custom-input border-gray-300 rounded-md" id="recallMemoryCustom" oninput="updateMseText()" placeholder="Other" type="text"></div></fieldset>
                <fieldset class="border p-3 rounded-md"><legend>Eye Contact</legend><div class="mse-category"><label><input id="normalEyeContact" onclick="updateMseText()" type="checkbox"> Normal</label><label><input id="fleeting" onclick="updateMseText()" type="checkbox"> Fleeting</label><label><input id="avoided" onclick="updateMseText()" type="checkbox"> Avoided</label><label><input id="none" onclick="updateMseText()" type="checkbox"> None</label><label><input id="staring" onclick="updateMseText()" type="checkbox"> Staring</label><input class="mse-custom-input border-gray-300 rounded-md" id="eyeContactCustom" oninput="updateMseText()" placeholder="Other" type="text"></div></fieldset>
                <fieldset class="border p-3 rounded-md"><legend>Facial Expression</legend><div class="mse-category"><label><input id="responsive" onclick="updateMseText()" type="checkbox"> Responsive</label><label><input id="tense" onclick="updateMseText()" type="checkbox"> Tense</label><label><input id="anxious" onclick="updateMseText()" type="checkbox"> Anxious</label><label><input id="sad" onclick="updateMseText()" type="checkbox"> Sad</label><label><input id="angry" onclick="updateMseText()" type="checkbox"> Angry</label><input class="mse-custom-input border-gray-300 rounded-md" id="facialExpressionCustom" oninput="updateMseText()" placeholder="Other" type="text"></div></fieldset>
                <fieldset class="border p-3 rounded-md"><legend>Attitude toward Evaluator</legend><div class="mse-category"><label><input id="cooperative" onclick="updateMseText()" type="checkbox"> Cooperative</label><label><input id="friendly" onclick="updateMseText()" type="checkbox"> Friendly</label><label><input id="guarded" onclick="updateMseText()" type="checkbox"> Guarded</label><label><input id="hostile" onclick="updateMseText()" type="checkbox"> Hostile</label><label><input id="indifferent" onclick="updateMseText()" type="checkbox"> Indifferent</label><label><input id="ingratiating" onclick="updateMseText()" type="checkbox"> Ingratiating</label><label><input id="manipulative" onclick="updateMseText()" type="checkbox"> Manipulative</label><label><input id="open" onclick="updateMseText()" type="checkbox"> Open</label><label><input id="seductive" onclick="updateMseText()" type="checkbox"> Seductive</label><label><input id="suspicious" onclick="updateMseText()" type="checkbox"> Suspicious</label><label><input id="uncooperative" onclick="updateMseText()" type="checkbox"> Uncooperative</label><input class="mse-custom-input border-gray-300 rounded-md" id="attitudeEvaluatorCustom" oninput="updateMseText()" placeholder="Other" type="text"></div></fieldset>
                <fieldset class="border p-3 rounded-md"><legend>Affect</legend><div class="mse-category"><label><input id="affectCongruent" onclick="updateMseText()" type="checkbox"> Congruent</label><label><input id="affectIncongruent" onclick="updateMseText()" type="checkbox"> Incongruent</label><label><input id="affectAppropriate" onclick="updateMseText()" type="checkbox"> Appropriate</label><label><input id="affectInappropriate" onclick="updateMseText()" type="checkbox"> Inappropriate</label><label><input id="labile" onclick="updateMseText()" type="checkbox"> Labile</label><label><input id="restricted" onclick="updateMseText()" type="checkbox"> Restricted</label><label><input id="flat" onclick="updateMseText()" type="checkbox"> Flat</label><label><input id="reactive" onclick="updateMseText()" type="checkbox"> Reactive</label><label><input id="blunted" onclick="updateMseText()" type="checkbox"> Blunted</label><input class="mse-custom-input border-gray-300 rounded-md" id="affectCustom" oninput="updateMseText()" placeholder="Other" type="text"></div></fieldset>
                <fieldset class="border p-3 rounded-md"><legend>Mood</legend><div class="mse-category"><label><input id="euthymic" onclick="updateMseText()" type="checkbox"> Euthymic</label><label><input id="dysphoric" onclick="updateMseText()" type="checkbox"> Dysphoric</label><label><input id="anxiousmood" onclick="updateMseText()" type="checkbox"> Anxious</label><label><input id="angrymood" onclick="updateMseText()" type="checkbox"> Angry</label><label><input id="irritableMood" onclick="updateMseText()" type="checkbox"> Irritable</label><label><input id="pessimistic" onclick="updateMseText()" type="checkbox"> Pessimistic</label><label><input id="depressed" onclick="updateMseText()" type="checkbox"> Depressed</label><label><input id="hypomanic" onclick="updateMseText()" type="checkbox"> Hypomanic</label><label><input id="euphoric" onclick="updateMseText()" type="checkbox"> Euphoric</label><input class="mse-custom-input border-gray-300 rounded-md" id="moodCustom" oninput="updateMseText()" placeholder="Other" type="text"></div></fieldset>
                <fieldset class="border p-3 rounded-md"><legend>Speech</legend><div class="mse-category"><label><input id="normalSpeech" onclick="updateMseText()" type="checkbox"> Normal</label><label><input id="loud" onclick="updateMseText()" type="checkbox"> Loud</label><label><input id="blocked" onclick="updateMseText()" type="checkbox"> Blocked</label><label><input id="pressured" onclick="updateMseText()" type="checkbox"> Pressured</label><label><input id="flightOfIdeas" onclick="updateMseText()" type="checkbox"> Flight of Ideas</label><label><input id="slurred" onclick="updateMseText()" type="checkbox"> Slurred</label><label><input id="soft" onclick="updateMseText()" type="checkbox"> Soft</label><label><input id="stuttering" onclick="updateMseText()" type="checkbox"> Stuttering</label><label><input id="mute" onclick="updateMseText()" type="checkbox"> Mute</label><label><input id="verbose" onclick="updateMseText()" type="checkbox"> Verbose</label><input class="mse-custom-input border-gray-300 rounded-md" id="speechCustom" oninput="updateMseText()" placeholder="Other" type="text"></div></fieldset>
                <fieldset class="border p-3 rounded-md"><legend>Expression of Thought Content</legend><div class="mse-category"><label><input id="expressionCongruent" onclick="updateMseText()" type="checkbox"> Congruent</label><label><input id="expressionIncongruent" onclick="updateMseText()" type="checkbox"> Incongruent</label><label><input id="looseassociations" onclick="updateMseText()" type="checkbox"> Loose Associations</label><label><input id="suspicions" onclick="updateMseText()" type="checkbox"> Suspicions</label><label><input id="delusions" onclick="updateMseText()" type="checkbox"> Delusions</label><label><input id="phobias" onclick="updateMseText()" type="checkbox"> Phobias</label><label><input id="obsessions" onclick="updateMseText()" type="checkbox"> Obsessions</label><input class="mse-custom-input border-gray-300 rounded-md" id="expressionCustom" oninput="updateMseText()" placeholder="Other" type="text"></div></fieldset>
                <fieldset class="border p-3 rounded-md"><legend>Organization of Thought</legend><div class="mse-category"><label><input id="normalOrganization" onclick="updateMseText()" type="checkbox"> Normal</label><label><input id="logical" onclick="updateMseText()" type="checkbox"> Logical</label><label><input id="goalDirected" onclick="updateMseText()" type="checkbox"> Goal-directed</label><input class="mse-custom-input border-gray-300 rounded-md" id="organizationCustom" oninput="updateMseText()" placeholder="Other" type="text"></div></fieldset>
                <fieldset class="border p-3 rounded-md"><legend>Perception</legend><div class="mse-category"><label><input id="noHallucinations" onclick="updateMseText()" type="checkbox"> No Hallucinations or Delusions during Interview</label><label><input id="auditoryhallucinations" onclick="updateMseText()" type="checkbox"> Auditory Hallucinations</label><label><input id="visualhallucinations" onclick="updateMseText()" type="checkbox"> Visual Hallucinations</label><label><input id="olfactoryhallucinations" onclick="updateMseText()" type="checkbox"> Olfactory Hallucinations</label><label><input id="tactilehallucinations" onclick="updateMseText()" type="checkbox"> Tactile Hallucinations</label><label><input id="gustatoryhallucinations" onclick="updateMseText()" type="checkbox"> Gustatory Hallucinations</label><label><input id="delusionsPresent" onclick="updateMseText()" type="checkbox"> Delusions Present</label><input class="mse-custom-input border-gray-300 rounded-md" id="perceptionCustom" oninput="updateMseText()" placeholder="Other" type="text"></div></fieldset>
                <fieldset class="border p-3 rounded-md"><legend>Insight</legend><div class="mse-category"><label><input id="insightExcellent" onclick="updateMseText()" type="checkbox"> Excellent</label><label><input id="insightGood" onclick="updateMseText()" type="checkbox"> Good</label><label><input id="insightFair" onclick="updateMseText()" type="checkbox"> Fair</label><label><input id="insightPoor" onclick="updateMseText()" type="checkbox"> Poor</label><label><input id="insightNil" onclick="updateMseText()" type="checkbox"> nil</label><input class="mse-custom-input border-gray-300 rounded-md" id="insightCustom" oninput="updateMseText()" placeholder="Other" type="text"></div></fieldset>
                <fieldset class="border p-3 rounded-md"><legend>Judgment</legend><div class="mse-category"><label><input id="judgementExcellent" onclick="updateMseText()" type="checkbox"> Excellent</label><label><input id="judgementGood" onclick="updateMseText()" type="checkbox"> Good</label><label><input id="judgementFair" onclick="updateMseText()" type="checkbox"> Fair</label><label><input id="judgementPoor" onclick="updateMseText()" type="checkbox"> Poor</label><label><input id="judgementNil" onclick="updateMseText()" type="checkbox"> nil</label><label><input id="judgementDangerous" onclick="updateMseText()" type="checkbox"> Dangerous</label><input class="mse-custom-input border-gray-300 rounded-md" id="judgmentCustom" oninput="updateMseText()" placeholder="Other" type="text"></div></fieldset>
                <fieldset class="border p-3 rounded-md"><legend>Decision Making</legend><div class="mse-category"><label><input id="normalDecisionMaking" onclick="updateMseText()" type="checkbox"> Normal</label><label><input id="onlySimple" onclick="updateMseText()" type="checkbox"> Only Simple</label><label><input id="impulsive" onclick="updateMseText()" type="checkbox"> Impulsive</label><label><input id="confused" onclick="updateMseText()" type="checkbox"> Confused</label><input class="mse-custom-input border-gray-300 rounded-md" id="decisionMakingCustom" oninput="updateMseText()" placeholder="Other" type="text"></div></fieldset>
                <fieldset class="border p-3 rounded-md"><legend>Safety</legend><div class="mse-category"><label><input id="noSIHI" onclick="updateMseText()" type="checkbox"> No evidence or report of SI/HI</label><label><input id="deniesSIHI" onclick="updateMseText()" type="checkbox"> Denies SI/HI</label><label><input id="reportsHI" onclick="updateMseText()" type="checkbox"> Reports HI</label><label><input id="reportsPassiveSIT" onclick="updateMseText()" type="checkbox"> Reports Passive Suicidal Thoughts</label><label><input id="reportsSuicidePlan" onclick="updateMseText()" type="checkbox"> Reports Suicide Plan</label><label><input id="reportsSuicidalIntention" onclick="updateMseText()" type="checkbox"> Reports Suicidal Intention</label><input class="mse-custom-input border-gray-300 rounded-md" id="safetyCustom" oninput="updateMseText()" placeholder="Other" type="text"></div></fieldset>
            </div>
            <textarea class="w-full mt-4 p-2 border border-gray-300 rounded-md" id="mseTextbox" rows="12"></textarea>
            <button class="mt-2 px-6 py-2 bg-indigo-600 text-white font-semibold rounded-md shadow-sm hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500" onclick="copyMseToClipboard()">COPY MSE</button>
        </div>
    </div>
    
    <!-- DARP Tab Content -->
    <div class="tabcontent p-4 sm:p-6 md:p-8" id="DARP" style="display:none;">
        <div class="darp-form-container">
            <h2 class="text-3xl font-bold text-center text-gray-800 mb-4">Progress Note Form</h2>
            <form id="progressNoteForm">
                <h3 class="text-xl font-semibold text-gray-700 mt-4 mb-2">DATA:</h3>
                <label class="font-medium text-gray-700 mb-2" for="diagnoses">Diagnoses:</label>
                <textarea class="p-2 border border-gray-300 rounded-md w-full" id="diagnoses" name="diagnoses" oninput="autoResize(this); updateDarpProgressNote();"></textarea>
               <label class="font-medium text-gray-700 mb-1" for="problemsAddressed">Session Content and Problems Addressed:</label>
                <textarea class="p-2 border border-gray-300 rounded-md w-full" id="problemsAddressed" name="problemsAddressed" oninput="autoResize(this); updateDarpProgressNote();"></textarea>
                <p class="text-sm text-gray-500 italic mt-1">Remember to include person-centered language and client quotes.</p>
                
                <br>
                <label class="font-medium text-gray-700 mb-2">Updates and Progress to Client's Treatment Goals:</label>
                <div id="treatmentGoalsContainer" class="space-y-2">
                    <!-- Treatment goal rows will be dynamically inserted here by JavaScript -->
                </div>

                <div class="darp-inline-checkbox mt-2"><input id="toxicologyScreen" name="toxicologyScreen" type="checkbox" onchange="updateDarpProgressNote()"><label for="toxicologyScreen">Client provided a toxicology screen</label></div>
                <label class="font-medium text-gray-700 mb-2 mt-2" for="additionalNotes">Additional Notes:</label>
                <textarea class="p-2 border border-gray-300 rounded-md w-full" id="additionalNotes" name="additionalNotes" oninput="autoResize(this); updateDarpProgressNote();"></textarea>
                
                <h3 class="text-xl font-semibold text-gray-700 mt-4 mb-2">Interventions Used:</h3>
                <div class="darp-interventions">
                    <div class="darp-column">
                        <strong class="font-semibold">Custom Interventions</strong><br>
                        <div class="controls mt-2 flex gap-2">
                            <input class="flex-grow p-2 border border-gray-300 rounded-md" id="customInput" placeholder="Enter custom intervention" type="text">
                            <button class="px-3 py-1 bg-green-500 text-white rounded-md hover:bg-green-600" onclick="addCustomIntervention()" type="button">+</button>
                            <button class="px-3 py-1 bg-red-500 text-white rounded-md hover:bg-red-600" onclick="removeSelectedIntervention()" type="button">-</button>
                        </div>
                        <div class="mt-2" id="customList"></div>
                    </div>
                    <div class="darp-column">
                        <strong class="font-semibold">CBT</strong><br>
                        <div class="darp-inline-checkbox"><input id="cbt_cr" name="CBT" type="checkbox" value="Cognitive Restructuring" onchange="updateDarpProgressNote()"><label for="cbt_cr">Cognitive Restructuring</label></div>
                        <div class="darp-inline-checkbox"><input id="cbt_ba" name="CBT" type="checkbox" value="Behavioral Activation" onchange="updateDarpProgressNote()"><label for="cbt_ba">Behavioral Activation</label></div>
                        <div class="darp-inline-checkbox"><input id="cbt_mt" name="CBT" type="checkbox" value="Mindfulness Training" onchange="updateDarpProgressNote()"><label for="cbt_mt">Mindfulness Training</label></div>
                        <div class="darp-inline-checkbox"><input id="cbt_ps" name="CBT" type="checkbox" value="Problem-Solving" onchange="updateDarpProgressNote()"><label for="cbt_ps">Problem-Solving</label></div>
                        <div class="darp-inline-checkbox"><input id="cbt_as" name="CBT" type="checkbox" value="Activity Scheduling" onchange="updateDarpProgressNote()"><label for="cbt_as">Activity Scheduling</label></div>
                        <div class="darp-inline-checkbox"><input id="cbt_rt" name="CBT" type="checkbox" value="Relaxation Techniques" onchange="updateDarpProgressNote()"><label for="cbt_rt">Relaxation Techniques</label></div>
                        <div class="darp-inline-checkbox"><input id="cbt_cd" name="CBT" type="checkbox" value="Cognitive Defusion" onchange="updateDarpProgressNote()"><label for="cbt_cd">Cognitive Defusion</label></div>
                        <div class="darp-inline-checkbox"><input id="cbt_icd" name="CBT" type="checkbox" value="Identifying Cognitive Distortions and alternative thinking patterns" onchange="updateDarpProgressNote()"><label for="cbt_icd">Identifying Cognitive Distortions and alternative thinking patterns</label></div>
                        Other: <input class="mt-1 p-2 border border-gray-300 rounded-md w-full" id="CBTOther" type="text" oninput="updateDarpProgressNote()">
                    </div>
                    <div class="darp-column">
                        <strong class="font-semibold">Person Centered</strong><br>
                        <div class="darp-inline-checkbox"><input id="pc_emp" name="Person Centered" type="checkbox" value="Empathy" onchange="updateDarpProgressNote()"><label for="pc_emp">Empathy</label></div>
                        <div class="darp-inline-checkbox"><input id="pc_al" name="Person Centered" type="checkbox" value="Active Listening" onchange="updateDarpProgressNote()"><label for="pc_al">Active Listening</label></div>
                        <div class="darp-inline-checkbox"><input id="pc_rl" name="Person Centered" type="checkbox" value="Reflective Listening" onchange="updateDarpProgressNote()"><label for="pc_rl">Reflective Listening</label></div>
                        <div class="darp-inline-checkbox"><input id="pc_oeq" name="Person Centered" type="checkbox" value="Open-ended questions" onchange="updateDarpProgressNote()"><label for="pc_oeq">Open-ended questions</label></div>
                        <div class="darp-inline-checkbox"><input id="pc_sum" name="Person Centered" type="checkbox" value="Summarizing" onchange="updateDarpProgressNote()"><label for="pc_sum">Summarizing</label></div>
                        <div class="darp-inline-checkbox"><input id="pc_val" name="Person Centered" type="checkbox" value="Validation" onchange="updateDarpProgressNote()"><label for="pc_val">Validation</label></div>
                        <div class="darp-inline-checkbox"><input id="pc_sil" name="Person Centered" type="checkbox" value="Silence" onchange="updateDarpProgressNote()"><label for="pc_sil">Silence</label></div>
                        <div class="darp-inline-checkbox"><input id="pc_ep" name="Person Centered" type="checkbox" value="Emotional Presence" onchange="updateDarpProgressNote()"><label for="pc_ep">Emotional Presence</label></div>
                        <div class="darp-inline-checkbox"><input id="pc_ea" name="Person Centered" type="checkbox" value="Encouraging Autonomy" onchange="updateDarpProgressNote()"><label for="pc_ea">Encouraging Autonomy</label></div>
                        <div class="darp-inline-checkbox"><input id="pc_fsd" name="Person Centered" type="checkbox" value="Facilitation of Self-Discovery" onchange="updateDarpProgressNote()"><label for="pc_fsd">Facilitation of Self-Discovery</label></div>
                        <div class="darp-inline-checkbox"><input id="pc_upr" name="Person Centered" type="checkbox" value="Unconditional Positive Regard" onchange="updateDarpProgressNote()"><label for="pc_upr">Unconditional Positive Regard</label></div>
                        Other: <input class="mt-1 p-2 border border-gray-300 rounded-md w-full" id="PersonCenteredOther" type="text" oninput="updateDarpProgressNote()">
                    </div>
                    <div class="darp-column">
                        <strong class="font-semibold">Motivational Interviewing</strong><br>
                        <div class="darp-inline-checkbox"><input id="mi_oeq" name="Motivational Interviewing" type="checkbox" value="Open-Ended Questions" onchange="updateDarpProgressNote()"><label for="mi_oeq">Open-Ended Questions</label></div>
                        <div class="darp-inline-checkbox"><input id="mi_aff" name="Motivational Interviewing" type="checkbox" value="Affirmations" onchange="updateDarpProgressNote()"><label for="mi_aff">Affirmations</label></div>
                        <div class="darp-inline-checkbox"><input id="mi_rl" name="Motivational Interviewing" type="checkbox" value="Reflective Listening" onchange="updateDarpProgressNote()"><label for="mi_rl">Reflective Listening</label></div>
                        <div class="darp-inline-checkbox"><input id="mi_sum" name="Motivational Interviewing" type="checkbox" value="Summarizing" onchange="updateDarpProgressNote()"><label for="mi_sum">Summarizing</label></div>
                        <div class="darp-inline-checkbox"><input id="mi_db" name="Motivational Interviewing" type="checkbox" value="Decisional Balance (Pros/Cons)" onchange="updateDarpProgressNote()"><label for="mi_db">Decisional Balance (Pros/Cons)</label></div>
                        <div class="darp-inline-checkbox"><input id="mi_did" name="Motivational Interviewing" type="checkbox" value="Developing and Identifying Discrepancy" onchange="updateDarpProgressNote()"><label for="mi_did">Developing and Identifying Discrepancy</label></div>
                        <div class="darp-inline-checkbox"><input id="mi_sse" name="Motivational Interviewing" type="checkbox" value="Supporting Self-Efficacy" onchange="updateDarpProgressNote()"><label for="mi_sse">Supporting Self-Efficacy</label></div>
                        <div class="darp-inline-checkbox"><input id="mi_ecl" name="Motivational Interviewing" type="checkbox" value="Evoking Commitment Language" onchange="updateDarpProgressNote()"><label for="mi_ecl">Evoking Commitment Language</label></div>
                        Other: <input class="mt-1 p-2 border border-gray-300 rounded-md w-full" id="MotivationalInterviewingOther" type="text" oninput="updateDarpProgressNote()">
                    </div>
                </div>
                <h3 class="text-xl font-semibold text-gray-700 mt-4 mb-2">ASSESSMENT:</h3>
                <label class="font-medium text-gray-700 mb-2" for="mentalStatus">Mental Status Exam:</label>
                <textarea class="p-2 border border-gray-300 rounded-md w-full" id="mentalStatus" name="mentalStatus" oninput="autoResize(this); updateDarpProgressNote();"></textarea>
                <label class="font-medium text-gray-700 mb-2" for="additionalAssessment">Additional Assessment:</label>
                <textarea class="p-2 border border-gray-300 rounded-md w-full" id="additionalAssessment" name="additionalAssessment" oninput="autoResize(this); updateDarpProgressNote();"></textarea>
                <h3 class="text-xl font-semibold text-gray-700 mt-4 mb-2">RESPONSE:</h3>
                <label class="font-medium text-gray-700 mb-2" for="response">Response:</label>
                <textarea class="p-2 border border-gray-300 rounded-md w-full" id="response" name="response" oninput="autoResize(this); updateDarpProgressNote();"></textarea>
                <h3 class="text-xl font-semibold text-gray-700 mt-4 mb-2">PLAN:</h3>
                <label class="font-medium text-gray-700 mb-2" for="plan">Plan:</label>
                <textarea class="p-2 border border-gray-300 rounded-md w-full" id="plan" name="plan" oninput="autoResize(this); updateDarpProgressNote();"></textarea>
            </form>
            <h3 class="text-2xl font-bold text-gray-800 mt-6 mb-2">Generated Progress Note</h3>
            <textarea class="w-full p-2 border border-gray-300 rounded-md bg-gray-50" id="progressNote" oninput="autoResize(this)"></textarea>
            <button class="mt-2 px-6 py-2 bg-indigo-600 text-white font-semibold rounded-md shadow-sm hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500" onclick="copyDarpToClipboard()">COPY DARP NOTE</button>
        </div>
    </div>

    <!-- Note Templates Tab Content -->
    <div class="tabcontent p-4 sm:p-6 md:p-8" id="NoteTemplates" style="display:none;">
        <iframe src="https://therapytools.github.io/notes/Templates.html" class="w-full h-[85vh]" style="border:none;" title="Note Templates"></iframe>
    </div>

    <!-- SUD Tab Content -->
    <div class="tabcontent p-4 sm:p-6 md:p-8" id="SUD" style="display:none;">
        <iframe src="https://therapytools.github.io/notes/SUD_Diagnostic_Tool.html" class="w-full h-[85vh]" style="border:none;" title="SUD Diagnostic Tool"></iframe>
    </div>

    <!-- Planner Tab Content -->
    <div class="tabcontent p-4 sm:p-6 md:p-8" id="Planner" style="display:none;">
        <iframe src="https://therapytools.github.io/notes/Treatment_Planner.html" class="w-full h-[85vh]" style="border:none;" title="Treatment Planner"></iframe>
    </div>

    <!-- Letters Tab Content (NEW) -->
    <div class="tabcontent p-4 sm:p-6 md:p-8" id="Letters" style="display:none;">
        <iframe src="http://therapytools.github.io/notes/letters.html" class="w-full h-[85vh]" style="border:none;" title="Letters"></iframe>
    </div>

    <!-- Safety Plan Tab Content -->
    <div class="tabcontent p-4 sm:p-6 md:p-8" id="SafetyPlan" style="display:none">
        <iframe src="https://therapytools.github.io/notes/safetyplan.html" class="w-full h-[85vh]" style="border:none;" title="Safety Plan"></iframe>
    </div>
</div>
<script>
    // --- Core Tab and UI Logic ---
    function openTab(evt, tabName) {
        const tabcontent = document.getElementsByClassName("tabcontent");
        for (let i = 0; i < tabcontent.length; i++) {
            tabcontent[i].style.display = "none";
        }
        const tablinks = document.getElementsByClassName("tab-button");
        for (let i = 0; i < tablinks.length; i++) {
            tablinks[i].className = tablinks[i].className.replace(" active", "");
        }
        document.getElementById(tabName).style.display = "block";
        evt.currentTarget.className += " active";
    }
    document.getElementById("defaultOpen").click();

    function autoResize(textarea) {
        if(textarea) {
            textarea.style.height = 'auto';
            textarea.style.height = textarea.scrollHeight + 'px';
        }
    }

    // --- MSE (Mental Status Exam) Logic ---
    function clearAllMseCheckboxes() {
        document.querySelectorAll('#MSE input[type="checkbox"]').forEach(cb => cb.checked = false);
    }

    function togglePositiveMSE() {
        clearAllMseCheckboxes();
        document.getElementById("positiveMSE").checked = true;
        ["x4","neat","clean","appropriatelydressed","notRemarkable","appropriate","normalAttention",
         "normalMemory","normalEyeContact","responsive","cooperative","affectCongruent","affectAppropriate",
         "euthymic","normalSpeech","expressionCongruent","normalOrganization","noHallucinations",
         "insightGood","judgementGood","normalDecisionMaking","noSIHI"]
         .forEach(id => {
             const el = document.getElementById(id);
             if(el) el.checked = true;
        });
        updateMseText();
    }

    function TelehealthPositiveMSE() {
        clearAllMseCheckboxes();
        document.getElementById("telehealthpositiveMSE").checked = true;
        ["x4","appropriate","normalAttention","normalMemory","normalEyeContact","responsive","cooperative",
         "affectCongruent","euthymic","normalSpeech","expressionCongruent","normalOrganization",
         "noHallucinations","insightGood","judgementGood","normalDecisionMaking","noSIHI"]
         .forEach(id => {
            const el = document.getElementById(id);
            if(el) el.checked = true;
        });
        updateMseText();
    }

    function updateMseText() {
        const mseTextbox = document.getElementById("mseTextbox");
        const darpMentalStatusTextarea = document.getElementById("mentalStatus");
        let text = "";

        const categories = [
            { name: "Orientation", checkboxes: ["x4", "time", "place", "situation", "person"], custom: "orientationCustom" },
            { name: "Clothing/Grooming", checkboxes: ["neat", "clean", "appropriatelydressed", "careless", "disheveled", "dirty", "inappropriate", "bizarre"], custom: "clothingGroomingCustom" },
            { name: "Motor Activity", checkboxes: ["notRemarkable", "slowed", "repetitive", "restless", "agitated", "tremor"], custom: "motorActivityCustom" },
            { name: "Behavior", checkboxes: ["appropriate", "aggressive", "angry", "apathetic", "irritable", "passive", "manipulative"], custom: "behaviorCustom" },
            { name: "Attention", checkboxes: ["normalAttention", "unaware", "distractible", "vigilant"], custom: "attentionCustom" },
            { name: "Recall/Memory", checkboxes: ["normalMemory", "shortTermImpaired", "longTermImpaired"], custom: "recallMemoryCustom" },
            { name: "Eye Contact", checkboxes: ["normalEyeContact", "fleeting", "avoided", "none", "staring"], custom: "eyeContactCustom" },
            { name: "Facial Expression", checkboxes: ["responsive", "tense", "anxious", "sad", "angry"], custom: "facialExpressionCustom" },
            { name: "Attitude toward Evaluator", checkboxes: ["cooperative", "friendly", "guarded", "hostile", "indifferent", "ingratiating", "manipulative", "open", "seductive", "suspicious", "uncooperative"], custom: "attitudeEvaluatorCustom" },
            { name: "Affect", checkboxes: ["affectCongruent", "affectIncongruent", "affectAppropriate", "affectInappropriate", "labile", "restricted", "flat", "reactive", "blunted"], custom: "affectCustom" },
            { name: "Mood", checkboxes: ["euthymic", "dysphoric", "anxiousmood", "angrymood", "irritableMood", "pessimistic", "depressed", "hypomanic", "euphoric"], custom: "moodCustom" },
            { name: "Speech", checkboxes: ["normalSpeech", "loud", "blocked", "pressured", "flightOfIdeas", "slurred", "soft", "stuttering", "mute", "verbose"], custom: "speechCustom" },
            { name: "Expression of Thought Content", checkboxes: ["expressionCongruent", "expressionIncongruent", "looseassociations", "suspicions", "delusions", "phobias", "obsessions"], custom: "expressionCustom" },
            { name: "Organization of Thought", checkboxes: ["normalOrganization", "logical", "goalDirected"], custom: "organizationCustom" },
            { name: "Perception", checkboxes: ["noHallucinations", "auditoryhallucinations", "visualhallucinations", "olfactoryhallucinations", "tactilehallucinations", "gustatoryhallucinations", "delusionsPresent"], custom: "perceptionCustom" },
            { name: "Insight", checkboxes: ["insightExcellent", "insightGood", "insightFair", "insightPoor", "insightNil"], custom: "insightCustom" },
            { name: "Judgment", checkboxes: ["judgementExcellent", "judgementGood", "judgementFair", "judgementPoor", "judgementNil", "judgementDangerous"], custom: "judgmentCustom" },
            { name: "Decision Making", checkboxes: ["normalDecisionMaking", "onlySimple", "impulsive", "confused"], custom: "decisionMakingCustom" },
            { name: "Safety", checkboxes: ["noSIHI", "deniesSIHI", "reportsHI", "reportsPassiveSIT", "reportsSuicidePlan", "reportsSuicidalIntention"], custom: "safetyCustom" }
        ];

        categories.forEach(category => {
            const checkedItems = [];
            category.checkboxes.forEach(id => {
                const checkbox = document.getElementById(id);
                if (checkbox && checkbox.checked) {
                    checkedItems.push(checkbox.nextSibling.nodeValue.trim());
                }
            });
            const customInput = document.getElementById(category.custom) ? document.getElementById(category.custom).value : "";
            if (customInput) {
                checkedItems.push(customInput);
            }
            if (checkedItems.length > 0) {
                text += `${category.name}: ${checkedItems.join(", ")}\n`;
            }
        });

        const generatedText = text.trim();
        mseTextbox.value = generatedText;
        if (darpMentalStatusTextarea) {
            darpMentalStatusTextarea.value = generatedText;
            autoResize(darpMentalStatusTextarea);
            updateDarpProgressNote();
        }
    }

    function copyMseToClipboard() {
        const textbox = document.getElementById("mseTextbox");
        textbox.select();
        document.execCommand("copy");
        // Using a more modern notification approach could be an improvement, but alert is simple and effective.
        alert("MSE text copied to clipboard!");
    }

    // --- DARP (Progress Note) Logic ---

    function addTreatmentGoalRow() {
        const container = document.getElementById('treatmentGoalsContainer');
        const goalRow = document.createElement('div');
        goalRow.className = 'treatment-goal-row flex items-start gap-2 p-2 border rounded-md';

        goalRow.innerHTML = `
            <div class="flex-grow space-y-2">
                <div class="flex items-center gap-2">
                    <label class="font-medium text-gray-700 w-28 flex-shrink-0">Treatment Goal:</label>
                    <input type="text" class="p-2 border border-gray-300 rounded-md w-full treatment-goal-input" oninput="updateDarpProgressNote()">
                </div>
                <div class="flex items-start gap-2">
                    <label class="font-medium text-gray-700 w-28 flex-shrink-0 mt-2">Update:</label>
                    <textarea class="p-2 border border-gray-300 rounded-md w-full treatment-goal-update" oninput="autoResize(this); updateDarpProgressNote()"></textarea>
                </div>
            </div>
            <div class="flex flex-col gap-2">
                <button type="button" class="px-3 py-1 bg-green-500 text-white rounded-md hover:bg-green-600" onclick="addTreatmentGoalRow()">+</button>
                <button type="button" class="px-3 py-1 bg-red-500 text-white rounded-md hover:bg-red-600 remove-goal-btn" onclick="removeTreatmentGoalRow(this)">-</button>
            </div>
        `;

        container.appendChild(goalRow);
        const newTextarea = goalRow.querySelector('textarea');
        autoResize(newTextarea);
        updateRemoveButtonsState();
        updateDarpProgressNote();
    }

    function removeTreatmentGoalRow(button) {
        const row = button.closest('.treatment-goal-row');
        if (row) {
            row.remove();
            updateDarpProgressNote();
            updateRemoveButtonsState();
        }
    }

    function updateRemoveButtonsState() {
        const rows = document.querySelectorAll('#treatmentGoalsContainer .treatment-goal-row');
        rows.forEach(row => {
            const removeBtn = row.querySelector('.remove-goal-btn');
            if (removeBtn) {
                 removeBtn.style.display = rows.length <= 1 ? 'none' : 'block';
            }
        });
    }

    function updateDarpProgressNote() {
        const mentalStatus = document.getElementById('mentalStatus')?.value || '';
        const problemsAddressed = document.getElementById('problemsAddressed')?.value || '';
        const diagnoses = document.getElementById('diagnoses')?.value || '';
        
        let updatesProgressText = "";
        const goalRows = document.querySelectorAll('#treatmentGoalsContainer .treatment-goal-row');
        goalRows.forEach((row, index) => {
            const goalInput = row.querySelector('.treatment-goal-input');
            const updateInput = row.querySelector('.treatment-goal-update');
            if (goalInput && updateInput) {
                const goal = goalInput.value.trim();
                const update = updateInput.value.trim();
                if (goal || update) {
                    updatesProgressText += `Goal: ${goal}\nUpdate: ${update}\n\n`;
                }
            }
        });
        updatesProgressText = updatesProgressText.trim();

        const additionalNotes = document.getElementById('additionalNotes')?.value || '';
        const additionalAssessment = document.getElementById('additionalAssessment')?.value || '';
        const response = document.getElementById('response')?.value || '';
        const plan = document.getElementById('plan')?.value || '';
        const toxicologyScreen = document.getElementById('toxicologyScreen')?.checked;
        
        let interventionsUsed = "Interventions Used:\n";
        interventionsUsed += getCustomInterventions();
        interventionsUsed += getInterventions('CBT');
        interventionsUsed += getInterventions('Person Centered');
        interventionsUsed += getInterventions('Motivational Interviewing');

        let progressNote = "DATA:\n";
        if (diagnoses) progressNote += `Diagnoses:\n${diagnoses}\n\n`;
        if (problemsAddressed) progressNote += `Problems Addressed in the Counseling Session:\n${problemsAddressed}\n\n`;
        if (updatesProgressText) progressNote += `Updates and Progress to Client's Treatment Goals:\n${updatesProgressText}\n\n`;
        if (toxicologyScreen) progressNote += `Client provided a toxicology screen.\n\n`;
        if (additionalNotes) progressNote += `Additional Notes:\n${additionalNotes}\n\n`;
        if (interventionsUsed.trim() !== "Interventions Used:") progressNote += `${interventionsUsed}\n`;

        progressNote += "ASSESSMENT:\n";
        if (mentalStatus) progressNote += `Mental Status Exam:\n${mentalStatus}\n\n`;
        if (additionalAssessment) progressNote += `Additional Assessment:\n${additionalAssessment}\n\n`;

        progressNote += "RESPONSE:\n";
        if (response) progressNote += `${response}\n\n`;

        progressNote += "PLAN:\n";
        if (plan) progressNote += `${plan}`;

        const noteBox = document.getElementById('progressNote');
        if (noteBox) {
            noteBox.value = progressNote;
            autoResize(noteBox);
        }
    }

    function getInterventions(columnTitle) {
        const selected = document.querySelectorAll(`input[name='${columnTitle}']:checked`);
        const otherInput = document.getElementById(`${columnTitle.replace(/\s+/g, '')}Other`);
        let interventions = Array.from(selected).map(cb => cb.value);
        if (otherInput && otherInput.value.trim()) {
            interventions.push(otherInput.value.trim());
        }
        return interventions.length ? `${columnTitle}: ${interventions.join(", ")}\n` : '';
    }

    function getCustomInterventions() {
        const selected = document.querySelectorAll('#customList input[type="checkbox"]:checked');
        const interventions = Array.from(selected).map(cb => cb.value);
        return interventions.length ? `${interventions.join(", ")}\n` : '';
    }

    function copyDarpToClipboard() {
        const note = document.getElementById('progressNote');
        note.select();
        document.execCommand("copy");
        alert("Progress note copied to clipboard!");
    }

    let savedCustoms = JSON.parse(localStorage.getItem('customInterventions') || '["PD: Interpretation", "PD: Clarification", "PD: Confrontation", "PD: Linking Past & Present", "PD: Defense Interpretation", "PD: Identifying Resistance", "Inner Child Work", "Reflection", "Mirroring"]');

    function addCustomIntervention() {
        const input = document.getElementById('customInput');
        const value = input.value.trim();
        if (!value || savedCustoms.includes(value)) return;
        savedCustoms.push(value);
        localStorage.setItem('customInterventions', JSON.stringify(savedCustoms));
        addCustomElement(value);
        input.value = '';
        updateDarpProgressNote();
    }

    function addCustomElement(text) {
        const div = document.createElement('div');
        div.className = 'darp-inline-checkbox';
        const cbId = `custom-cb-${text.replace(/[^a-zA-Z0-9]/g, '-')}`;
        const cb = document.createElement('input');
        cb.type = 'checkbox';
        cb.id = cbId;
        cb.value = text;
        cb.addEventListener('change', updateDarpProgressNote);
        div.appendChild(cb);
        const label = document.createElement('label');
        label.setAttribute('for', cbId);
        label.textContent = text;
        div.appendChild(label);
        document.getElementById('customList').appendChild(div);
    }

    function removeSelectedIntervention() {
        const checkboxes = document.querySelectorAll('#customList input[type="checkbox"]:checked');
        checkboxes.forEach(cb => {
            const value = cb.value;
            savedCustoms = savedCustoms.filter(item => item !== value);
            cb.parentElement.remove();
        });
        localStorage.setItem('customInterventions', JSON.stringify(savedCustoms));
        updateDarpProgressNote();
    }

    // --- Combined DOMContentLoaded Initializer ---
    window.addEventListener('DOMContentLoaded', () => {
        // DARP Init
        addTreatmentGoalRow();
        savedCustoms.forEach(addCustomElement);
        
        // Initial call to populate MSE field in DARP from the other tab
        if (document.getElementById('mseTextbox')) {
            updateMseText(); 
        }

        // --- ADDED: Logic for editable & synced MSE textareas ---
        const mseTextbox = document.getElementById('mseTextbox');
        const darpMentalStatusTextarea = document.getElementById('mentalStatus');

        if (mseTextbox && darpMentalStatusTextarea) {
            // Sync from MSE tab to DARP tab
            mseTextbox.addEventListener('input', () => {
                darpMentalStatusTextarea.value = mseTextbox.value;
                autoResize(darpMentalStatusTextarea);
                updateDarpProgressNote();
            });

            // Sync from DARP tab to MSE tab
            // The existing oninput attribute on mentalStatus already calls autoResize and updateDarpProgressNote.
            // We just add the sync back to mseTextbox.
            darpMentalStatusTextarea.addEventListener('input', () => {
                mseTextbox.value = darpMentalStatusTextarea.value;
                autoResize(mseTextbox);
            });
        }
    });
</script>
</body>
</html>
