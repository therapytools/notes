<!DOCTYPE html>
<html lang="en">
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <meta content="width=device-width, initial-scale=1.0" name="viewport">
    <title>Therapy Tools</title>
    <link href="./dist/output.css" rel="stylesheet">
    <style>
        /* Custom styles for the tab interface */
        .tab-button {
            transition: background-color 0.3s, color 0.3s;
        }
        .tab-button.active {
            border-color: #4f46e5;
            color: #4f46e5;
            font-weight: 600;
        }
        /* Styles for MSE form */
        .mse-form-container {
            max-width: 900px;
            margin: 0 auto;
        }
        .mse-category {
            display: flex;
            flex-wrap: wrap;
            justify-content: space-between;
        }
        .mse-category label {
            width: 48%; /* Adjust for better spacing */
            margin-bottom: 4px;
        }
        @media (min-width: 768px) {
            .mse-category label {
                width: 30%;
            }
        }
        .mse-category input[type="text"] {
            width: 100%;
            margin: 5px 0;
        }
        .mse-custom-input {
            width: 98%;
            margin: 1%;
        }
        .mse-form-container legend {
            font-weight: bold;
            color: #c2410c; /* A more modern orange/red */
            font-size: 1.1em;
            margin-bottom: 0.5rem;
        }
        /* Styles for DARP form */
        .darp-form-container label, .darp-form-container select, .darp-form-container input {
            display: block;
        }
        .darp-form-container textarea {
            width: 100%;
            min-height: 80px;
            resize: none;
            overflow: hidden;
        }
        .darp-interventions {
            display: grid;
            gap: 1rem;
            grid-template-columns: 1fr; /* 1 column on mobile */
        }
        @media (min-width: 640px) { /* sm */
            .darp-interventions {
                grid-template-columns: repeat(2, 1fr);
            }
        }
        @media (min-width: 1024px) { /* lg */
            .darp-interventions {
                grid-template-columns: repeat(4, 1fr); /* Adjusted for 4 columns */
            }
        }
        .darp-column {
            padding: 0.75rem;
            border: 1px solid #d1d5db;
            border-radius: 8px;
            box-sizing: border-box;
            border-color: #d1d5db !important;
        }
        .darp-inline-checkbox {
            display: flex;
            align-items: center;
            margin-bottom: 0.5rem;
            gap: 0.5rem; /* Adds space between checkbox and label */
        }
        .scroll-top-btn {
            position: fixed;
            bottom: 1.25rem;
            right: 1.25rem;
            display: none;
            align-items: center;
            gap: 0.35rem;
            padding: 0.75rem 1rem;
            background: #4f46e5;
            color: #fff;
            font-weight: 700;
            border: none;
            border-radius: 9999px;
            box-shadow: 0 10px 15px -3px rgba(79, 70, 229, 0.4);
            cursor: pointer;
            z-index: 50;
        }
        .scroll-top-btn:hover {
            background: #4338ca;
        }
    </style>
</head>
<body class="bg-gray-100 font-sans p-4 md:p-8">
<div class="bg-white rounded-lg shadow-lg">
    <div class="border-b border-gray-200">
        <div class="flex justify-between items-center flex-wrap">
            <div class="flex flex-1 flex-wrap">
                <button class="tab-button flex-grow text-center text-gray-500 hover:text-gray-700 py-4 px-2 border-b-2 border-transparent text-base md:text-lg active" id="defaultOpen" onclick="openTab(event, 'MSE')">
                    MSE
                </button>
                <button class="tab-button flex-grow text-center text-gray-500 hover:text-gray-700 py-4 px-2 border-b-2 border-transparent text-base md:text-lg" onclick="openTab(event, 'DARP')">
                    DARP
                </button>
                <button class="tab-button flex-grow text-center text-gray-500 hover:text-gray-700 py-4 px-2 border-b-2 border-transparent text-base md:text-lg" onclick="openTab(event, 'NoteTemplates')">
                    Templates
                </button>
                <div class="relative flex-grow" id="sudContainer" onmouseenter="showSudDropdown()" onmouseleave="hideSudDropdown()">
                    <button class="tab-button w-full text-center text-gray-500 hover:text-gray-700 py-4 px-2 border-b-2 border-transparent text-base md:text-lg" onclick="toggleSudDropdown(event)">
                        SUD Dx
                    </button>
                    <div id="sudDropdown" class="absolute left-0 mt-0 w-full bg-white border border-gray-200 rounded shadow-lg hidden z-10">
                        <button type="button" class="dropdown-option w-full text-left px-4 py-2 text-gray-700 transition-all" onclick="openTab(event, 'SUD')" onmouseenter="highlightOption(this)" onmouseleave="unhighlightOption(this)">
                            SUD Dx
                        </button>
                        <button type="button" class="dropdown-option w-full text-left px-4 py-2 text-gray-700 transition-all border-t border-gray-200" onclick="openTab(event, 'DSMDx')" onmouseenter="highlightOption(this)" onmouseleave="unhighlightOption(this)">
                            DSM-V-TR Dx
                        </button>
                    </div>
                </div>
                <button class="tab-button flex-grow text-center text-gray-500 hover:text-gray-700 py-4 px-2 border-b-2 border-transparent text-base md:text-lg" onclick="openTab(event, 'Planner')">Planner</button>
                <button class="tab-button flex-grow text-center text-gray-500 hover:text-gray-700 py-4 px-2 border-b-2 border-transparent text-base md:text-lg" onclick="openTab(event, 'Letters')">Letters</button>
                <button class="tab-button flex-grow text-center text-gray-500 hover:text-gray-700 py-4 px-2 border-b-2 border-transparent text-base md:text-lg" onclick="openTab(event, 'SafetyPlan')">Safety Plan</button>
            </div>
            <button onclick="location.reload()" class="ml-4 my-2 mr-4 px-4 py-2 bg-red-600 text-white font-semibold rounded-md shadow-sm hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500 flex-shrink-0">
                Clear All
            </button>
        </div>
    </div>

    <div class="tabcontent p-4 sm:p-6 md:p-8" id="MSE" style="display: block;">
        <form autocomplete="off">
                <h1 class="text-3xl font-bold text-center text-gray-800 mb-6">Mental Status Exam</h1>
                <fieldset class="border p-3 rounded-md mb-4">
                    <legend>Presets</legend>
                    <div class="space-y-2">
                        <label class="flex items-center"><input class="h-4 w-4 rounded border-gray-300 text-indigo-600 focus:ring-indigo-500" id="positiveMSE" onclick="togglePositiveMSE()" type="checkbox"> <span class="ml-2">Normal MSE</span></label>
                        <label class="flex items-center"><input class="h-4 w-4 rounded border-gray-300 text-indigo-600 focus:ring-indigo-500" id="telehealthpositiveMSE" onclick="TelehealthPositiveMSE()" type="checkbox"> <span class="ml-2">Telehealth Normal MSE</span></label><br>
                       <button class="mt-2 px-6 py-2 bg-indigo-600 text-white font-semibold rounded-md shadow-sm hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500" onclick="clearAllMseCheckboxes(); updateMseText();" type="button">
                            Clear Form
                        </button>
                    </div>
                </fieldset>
                <div class="space-y-4">
                    <fieldset class="border p-3 rounded-md"><legend>Orientation</legend><div class="mse-category"><label><input id="x4" onclick="updateMseText()" type="checkbox"> Oriented x4</label><label><input id="time" onclick="updateMseText()" type="checkbox"> Time</label><label><input id="place" onclick="updateMseText()" type="checkbox"> Place</label><label><input id="situation" onclick="updateMseText()" type="checkbox"> Situation</label><label><input id="person" onclick="updateMseText()" type="checkbox"> Person</label><input class="mse-custom-input border-gray-300 rounded-md" id="orientationCustom" oninput="updateMseText()" placeholder="Other" type="text"></div></fieldset>
                    <fieldset class="border p-3 rounded-md"><legend>Clothing/Grooming</legend><div class="mse-category"><label><input id="neat" onclick="updateMseText()" type="checkbox"> Neat</label><label><input id="clean" onclick="updateMseText()" type="checkbox"> Clean</label><label><input id="appropriatelydressed" onclick="updateMseText()" type="checkbox"> Appropriately Dressed</label><label><input id="careless" onclick="updateMseText()" type="checkbox"> Careless</label><label><input id="disheveled" onclick="updateMseText()" type="checkbox"> Disheveled</label><label><input id="dirty" onclick="updateMseText()" type="checkbox"> Dirty</label><label><input id="inappropriate" onclick="updateMseText()" type="checkbox"> Inappropriate</label><label><input id="bizarre" onclick="updateMseText()" type="checkbox"> Bizarre</label><input class="mse-custom-input border-gray-300 rounded-md" id="clothingGroomingCustom" oninput="updateMseText()" placeholder="Other" type="text"></div></fieldset>
                    <fieldset class="border p-3 rounded-md"><legend>Motor Activity</legend><div class="mse-category"><label><input id="notRemarkable" onclick="updateMseText()" type="checkbox"> Not Remarkable</label><label><input id="slowed" onclick="updateMseText()" type="checkbox"> Slowed</label><label><input id="repetitive" onclick="updateMseText()" type="checkbox"> Repetitive</label><label><input id="restless" onclick="updateMseText()" type="checkbox"> Restless</label><label><input id="agitated" onclick="updateMseText()" type="checkbox"> Agitated</label><label><input id="tremor" onclick="updateMseText()" type="checkbox"> Tremor</label><input class="mse-custom-input border-gray-300 rounded-md" id="motorActivityCustom" oninput="updateMseText()" placeholder="Other" type="text"></div></fieldset>
                    <fieldset class="border p-3 rounded-md"><legend>Behavior</legend><div class="mse-category"><label><input id="appropriate" onclick="updateMseText()" type="checkbox"> Appropriate</label><label><input id="aggressive" onclick="updateMseText()" type="checkbox"> Aggressive</label><label><input id="angry" onclick="updateMseText()" type="checkbox"> Angry</label><label><input id="apathetic" onclick="updateMseText()" type="checkbox"> Apathetic</label><label><input id="irritable" onclick="updateMseText()" type="checkbox"> Irritable</label><label><input id="passive" onclick="updateMseText()" type="checkbox"> Passive</label><label><input id="manipulative" onclick="updateMseText()" type="checkbox"> Manipulative</label><input class="mse-custom-input border-gray-300 rounded-md" id="behaviorCustom" oninput="updateMseText()" placeholder="Other" type="text"></div></fieldset>
                    <fieldset class="border p-3 rounded-md"><legend>Attention</legend><div class="mse-category"><label><input id="normalAttention" onclick="updateMseText()" type="checkbox"> Normal</label><label><input id="unaware" onclick="updateMseText()" type="checkbox"> Unaware</label><label><input id="distractible" onclick="updateMseText()" type="checkbox"> Distractible</label><label><input id="vigilant" onclick="updateMseText()" type="checkbox"> Vigilant</label><input class="mse-custom-input border-gray-300 rounded-md" id="attentionCustom" oninput="updateMseText()" placeholder="Other" type="text"></div></fieldset>
                    <fieldset class="border p-3 rounded-md"><legend>Recall/Memory</legend><div class="mse-category"><label><input id="normalMemory" onclick="updateMseText()" type="checkbox"> Normal</label><label><input id="shortTermImpaired" onclick="updateMseText()" type="checkbox"> Short-term Impaired, Long-Term Intact</label><label><input id="longTermImpaired" onclick="updateMseText()" type="checkbox"> Short-term Intact, Long-term Impaired</label><input class="mse-custom-input border-gray-300 rounded-md" id="recallMemoryCustom" oninput="updateMseText()" placeholder="Other" type="text"></div></fieldset>
                    <fieldset class="border p-3 rounded-md"><legend>Eye Contact</legend><div class="mse-category"><label><input id="normalEyeContact" onclick="updateMseText()" type="checkbox"> Normal</label><label><input id="fleeting" onclick="updateMseText()" type="checkbox"> Fleeting</label><label><input id="avoided" onclick="updateMseText()" type="checkbox"> Avoided</label><label><input id="none" onclick="updateMseText()" type="checkbox"> None</label><label><input id="staring" onclick="updateMseText()" type="checkbox"> Staring</label><input class="mse-custom-input border-gray-300 rounded-md" id="eyeContactCustom" oninput="updateMseText()" placeholder="Other" type="text"></div></fieldset>
                    <fieldset class="border p-3 rounded-md"><legend>Facial Expression</legend><div class="mse-category"><label><input id="responsive" onclick="updateMseText()" type="checkbox"> Responsive</label><label><input id="tense" onclick="updateMseText()" type="checkbox"> Tense</label><label><input id="anxious" onclick="updateMseText()" type="checkbox"> Anxious</label><label><input id="sad" onclick="updateMseText()" type="checkbox"> Sad</label><label><input id="angry" onclick="updateMseText()" type="checkbox"> Angry</label><input class="mse-custom-input border-gray-300 rounded-md" id="facialExpressionCustom" oninput="updateMseText()" placeholder="Other" type="text"></div></fieldset>
                    <fieldset class="border p-3 rounded-md"><legend>Attitude toward Evaluator</legend><div class="mse-category"><label><input id="cooperative" onclick="updateMseText()" type="checkbox"> Cooperative</label><label><input id="friendly" onclick="updateMseText()" type="checkbox"> Friendly</label><label><input id="guarded" onclick="updateMseText()" type="checkbox"> Guarded</label><label><input id="hostile" onclick="updateMseText()" type="checkbox"> Hostile</label><label><input id="indifferent" onclick="updateMseText()" type="checkbox"> Indifferent</label><label><input id="ingratiating" onclick="updateMseText()" type="checkbox"> Ingratiating</label><label><input id="manipulative" onclick="updateMseText()" type="checkbox"> Manipulative</label><label><input id="open" onclick="updateMseText()" type="checkbox"> Open</label><label><input id="seductive" onclick="updateMseText()" type="checkbox"> Seductive</label><label><input id="suspicious" onclick="updateMseText()" type="checkbox"> Suspicious</label><label><input id="uncooperative" onclick="updateMseText()" type="checkbox"> Uncooperative</label><input class="mse-custom-input border-gray-300 rounded-md" id="attitudeEvaluatorCustom" oninput="updateMseText()" placeholder="Other" type="text"></div></fieldset>
                    <fieldset class="border p-3 rounded-md"><legend>Affect</legend><div class="mse-category"><label><input id="affectCongruent" onclick="updateMseText()" type="checkbox"> Congruent</label><label><input id="affectIncongruent" onclick="updateMseText()" type="checkbox"> Incongruent</label><label><input id="affectAppropriate" onclick="updateMseText()" type="checkbox"> Appropriate</label><label><input id="affectInappropriate" onclick="updateMseText()" type="checkbox"> Inappropriate</label><label><input id="labile" onclick="updateMseText()" type="checkbox"> Labile</label><label><input id="restricted" onclick="updateMseText()" type="checkbox"> Restricted</label><label><input id="flat" onclick="updateMseText()" type="checkbox"> Flat</label><label><input id="reactive" onclick="updateMseText()" type="checkbox"> Reactive</label><label><input id="blunted" onclick="updateMseText()" type="checkbox"> Blunted</label><input class="mse-custom-input border-gray-300 rounded-md" id="affectCustom" oninput="updateMseText()" placeholder="Other" type="text"></div></fieldset>
                    <fieldset class="border p-3 rounded-md"><legend>Mood</legend><div class="mse-category"><label><input id="euthymic" onclick="updateMseText()" type="checkbox"> Euthymic</label><label><input id="dysphoric" onclick="updateMseText()" type="checkbox"> Dysphoric</label><label><input id="anxiousmood" onclick="updateMseText()" type="checkbox"> Anxious</label><label><input id="angrymood" onclick="updateMseText()" type="checkbox"> Angry</label><label><input id="irritableMood" onclick="updateMseText()" type="checkbox"> Irritable</label><label><input id="pessimistic" onclick="updateMseText()" type="checkbox"> Pessimistic</label><label><input id="depressed" onclick="updateMseText()" type="checkbox"> Depressed</label><label><input id="hypomanic" onclick="updateMseText()" type="checkbox"> Hypomanic</label><label><input id="euphoric" onclick="updateMseText()" type="checkbox"> Euphoric</label><input class="mse-custom-input border-gray-300 rounded-md" id="moodCustom" oninput="updateMseText()" placeholder="Other" type="text"></div></fieldset>
                    <fieldset class="border p-3 rounded-md"><legend>Speech</legend><div class="mse-category"><label><input id="normalSpeech" onclick="updateMseText()" type="checkbox"> Normal</label><label><input id="loud" onclick="updateMseText()" type="checkbox"> Loud</label><label><input id="blocked" onclick="updateMseText()" type="checkbox"> Blocked</label><label><input id="pressured" onclick="updateMseText()" type="checkbox"> Pressured</label><label><input id="flightOfIdeas" onclick="updateMseText()" type="checkbox"> Flight of Ideas</label><label><input id="slurred" onclick="updateMseText()" type="checkbox"> Slurred</label><label><input id="soft" onclick="updateMseText()" type="checkbox"> Soft</label><label><input id="stuttering" onclick="updateMseText()" type="checkbox"> Stuttering</label><label><input id="mute" onclick="updateMseText()" type="checkbox"> Mute</label><label><input id="verbose" onclick="updateMseText()" type="checkbox"> Verbose</label><input class="mse-custom-input border-gray-300 rounded-md" id="speechCustom" oninput="updateMseText()" placeholder="Other" type="text"></div></fieldset>
                    <fieldset class="border p-3 rounded-md"><legend>Expression of Thought Content</legend><div class="mse-category"><label><input id="expressionCongruent" onclick="updateMseText()" type="checkbox"> Congruent</label><label><input id="expressionIncongruent" onclick="updateMseText()" type="checkbox"> Incongruent</label><label><input id="looseassociations" onclick="updateMseText()" type="checkbox"> Loose Associations</label><label><input id="suspicions" onclick="updateMseText()" type="checkbox"> Suspicions</label><label><input id="delusions" onclick="updateMseText()" type="checkbox"> Delusions</label><label><input id="phobias" onclick="updateMseText()" type="checkbox"> Phobias</label><label><input id="obsessions" onclick="updateMseText()" type="checkbox"> Obsessions</label><input class="mse-custom-input border-gray-300 rounded-md" id="expressionCustom" oninput="updateMseText()" placeholder="Other" type="text"></div></fieldset>
                    <fieldset class="border p-3 rounded-md"><legend>Organization of Thought</legend><div class="mse-category"><label><input id="normalOrganization" onclick="updateMseText()" type="checkbox"> Normal</label><label><input id="logical" onclick="updateMseText()" type="checkbox"> Logical</label><label><input id="goalDirected" onclick="updateMseText()" type="checkbox"> Goal-directed</label><input class="mse-custom-input border-gray-300 rounded-md" id="organizationCustom" oninput="updateMseText()" placeholder="Other" type="text"></div></fieldset>
                    <fieldset class="border p-3 rounded-md"><legend>Perception</legend><div class="mse-category"><label><input id="noHallucinations" onclick="updateMseText()" type="checkbox"> No Hallucinations or Delusions during Interview</label><label><input id="auditoryhallucinations" onclick="updateMseText()" type="checkbox"> Auditory Hallucinations</label><label><input id="visualhallucinations" onclick="updateMseText()" type="checkbox"> Visual Hallucinations</label><label><input id="olfactoryhallucinations" onclick="updateMseText()" type="checkbox"> Olfactory Hallucinations</label><label><input id="tactilehallucinations" onclick="updateMseText()" type="checkbox"> Tactile Hallucinations</label><label><input id="gustatoryhallucinations" onclick="updateMseText()" type="checkbox"> Gustatory Hallucinations</label><label><input id="delusionsPresent" onclick="updateMseText()" type="checkbox"> Delusions Present</label><input class="mse-custom-input border-gray-300 rounded-md" id="perceptionCustom" oninput="updateMseText()" placeholder="Other" type="text"></div></fieldset>
                    <fieldset class="border p-3 rounded-md"><legend>Insight</legend><div class="mse-category"><label><input id="insightExcellent" onclick="updateMseText()" type="checkbox"> Excellent</label><label><input id="insightGood" onclick="updateMseText()" type="checkbox"> Good</label><label><input id="insightFair" onclick="updateMseText()" type="checkbox"> Fair</label><label><input id="insightPoor" onclick="updateMseText()" type="checkbox"> Poor</label><label><input id="insightNil" onclick="updateMseText()" type="checkbox"> nil</label><input class="mse-custom-input border-gray-300 rounded-md" id="insightCustom" oninput="updateMseText()" placeholder="Other" type="text"></div></fieldset>
                    <fieldset class="border p-3 rounded-md"><legend>Judgment</legend><div class="mse-category"><label><input id="judgementExcellent" onclick="updateMseText()" type="checkbox"> Excellent</label><label><input id="judgementGood" onclick="updateMseText()" type="checkbox"> Good</label><label><input id="judgementFair" onclick="updateMseText()" type="checkbox"> Fair</label><label><input id="judgementPoor" onclick="updateMseText()" type="checkbox"> Poor</label><label><input id="judgementNil" onclick="updateMseText()" type="checkbox"> nil</label><label><input id="judgementDangerous" onclick="updateMseText()" type="checkbox"> Dangerous</label><input class="mse-custom-input border-gray-300 rounded-md" id="judgmentCustom" oninput="updateMseText()" placeholder="Other" type="text"></div></fieldset>
                    <fieldset class="border p-3 rounded-md"><legend>Decision Making</legend><div class="mse-category"><label><input id="normalDecisionMaking" onclick="updateMseText()" type="checkbox"> Normal</label><label><input id="onlySimple" onclick="updateMseText()" type="checkbox"> Only Simple</label><label><input id="impulsive" onclick="updateMseText()" type="checkbox"> Impulsive</label><label><input id="confused" onclick="updateMseText()" type="checkbox"> Confused</label><input class="mse-custom-input border-gray-300 rounded-md" id="decisionMakingCustom" oninput="updateMseText()" placeholder="Other" type="text"></div></fieldset>
                    <fieldset class="border p-3 rounded-md"><legend>Safety</legend><div class="mse-category"><label><input id="noSIHI" onclick="updateMseText()" type="checkbox"> No evidence or report of SI/HI</label><label><input id="deniesSIHI" onclick="updateMseText()" type="checkbox"> Denies SI/HI</label><label><input id="reportsHI" onclick="updateMseText()" type="checkbox"> Reports HI</label><label><input id="reportsPassiveSIT" onclick="updateMseText()" type="checkbox"> Reports Passive Suicidal Thoughts</label><label><input id="reportsSuicidePlan" onclick="updateMseText()" type="checkbox"> Reports Suicide Plan</label><label><input id="reportsSuicidalIntention" onclick="updateMseText()" type="checkbox"> Reports Suicidal Intention</label><input class="mse-custom-input border-gray-300 rounded-md" id="safetyCustom" oninput="updateMseText()" placeholder="Other" type="text"></div></fieldset>
                </div>
                <textarea class="w-full mt-4 p-2 border border-gray-300 rounded-md" id="mseTextbox" rows="12"></textarea>
                <button class="mt-2 px-6 py-2 bg-indigo-600 text-white font-semibold rounded-md shadow-sm hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500" onclick="copyMseToClipboard()" type="button">COPY MSE</button>
            </form>
    </div>
    
    <div class="tabcontent p-4 sm:p-6 md:p-8" id="DARP" style="display:none;">
        <div class="darp-form-container">
            <h2 class="text-3xl font-bold text-center text-gray-800 mb-4">Progress Note Form</h2>
            <form id="progressNoteForm" autocomplete="off">
                
                <div class="darp-inline-checkbox mb-2">
                    <input id="internNoteCheckbox" name="internNoteCheckbox" type="checkbox" onchange="toggleInternNote(); updateDarpProgressNote();" class="h-4 w-4 rounded border-gray-300 text-indigo-600 focus:ring-indigo-500">
                    <label for="internNoteCheckbox" class="font-medium text-gray-700">Intern Note</label>
                </div>
                
                <div id="internStatementSection" class="bg-blue-100 p-4 rounded-md mb-4" style="display:none;">
                    Intern informed client that they are a counselor-in-training completing an internship at the clinic under the supervision of a licensed clinician. Intern explained the supervisory relationship and the role of the supervisor in supporting client care and ensuring quality services. Client was informed that parts of sessions may be reviewed for supervision purposes. Intern obtained client’s verbal consent to proceed with treatment under intern status. Client expressed understanding and agreed to continue services.
                </div>
                <h3 class="text-xl font-semibold text-gray-700 mt-4 mb-2">DATA:</h3>
                
                <label class="font-medium text-gray-700 mb-2" for="diagnoses">Diagnoses:</label>
                <textarea class="p-2 border border-gray-300 rounded-md w-full" id="diagnoses" name="diagnoses" oninput="autoResize(this); updateDarpProgressNote();"></textarea>
               <label class="font-medium text-gray-700 mb-1" for="problemsAddressed">Session Content and Problems Addressed:</label>
                <textarea class="p-2 border border-gray-300 rounded-md w-full" id="problemsAddressed" name="problemsAddressed" oninput="autoResize(this); updateDarpProgressNote();"></textarea>
                <p class="text-sm text-gray-500 italic mt-1">Remember to include person-centered language and client quotes.</p>
                
<div class="flex items-center mt-4 space-x-2">
    <label class="font-medium text-gray-700">Updates and Progress to Client's Treatment Goals:</label>
    <input type="date" id="sessionDate" name="sessionDate" class="p-2 border border-gray-300 rounded-md" onchange="syncSessionDateToGoals(this.value)">
</div>
                <div id="treatmentGoalsContainer" class="space-y-2">
                    </div>

                <div class="darp-inline-checkbox mt-2"><input id="toxicologyScreen" name="toxicologyScreen" type="checkbox" onchange="updateDarpProgressNote()"><label for="toxicologyScreen">Client provided a toxicology screen</label></div>
                <label class="font-medium text-gray-700 mb-2 mt-2" for="additionalNotes">Additional Notes:</label>
                <textarea class="p-2 border border-gray-300 rounded-md w-full" id="additionalNotes" name="additionalNotes" oninput="autoResize(this); updateDarpProgressNote();"></textarea>
                
                <h3 class="text-xl font-semibold text-gray-700 mt-4 mb-2">Interventions Used:</h3>
                
                <!-- Controls to add new modality -->
                <div class="mb-4 flex gap-2 items-end">
                    <div class="flex-grow">
                         <label class="block text-sm font-medium text-gray-700 mb-1">Add New Modality Category</label>
                        <input type="text" id="newModalityInput" class="w-full p-2 border border-gray-300 rounded-md" placeholder="e.g. DBT, EMDR">
                    </div>
                    <button type="button" onclick="addNewModality()" class="px-4 py-2 bg-indigo-600 text-white font-semibold rounded-md shadow-sm hover:bg-indigo-700">
                        Add Category
                    </button>
                    <button type="button" onclick="resetModalitiesToDefault()" class="px-4 py-2 bg-gray-500 text-white font-semibold rounded-md shadow-sm hover:bg-gray-600" title="Reset to defaults">
                        Reset
                    </button>
                </div>

                <div id="darp-interventions-container" class="darp-interventions">
                    <!-- Dynamic content will be rendered here -->
                </div>
                <h3 class="text-xl font-semibold text-gray-700 mt-4 mb-2">ASSESSMENT:</h3>
                <label class="font-medium text-gray-700 mb-2" for="mentalStatus">Mental Status Exam:</label>
                <textarea class="p-2 border border-gray-300 rounded-md w-full" id="mentalStatus" name="mentalStatus" oninput="autoResize(this); updateDarpProgressNote();"></textarea>
                <label class="font-medium text-gray-700 mb-2" for="additionalAssessment">Additional Assessment:</label>
                <textarea class="p-2 border border-gray-300 rounded-md w-full" id="additionalAssessment" name="additionalAssessment" oninput="autoResize(this); updateDarpProgressNote();"></textarea>
                <h3 class="text-xl font-semibold text-gray-700 mt-4 mb-2">RESPONSE:</h3>
                <label class="font-medium text-gray-700 mb-2" for="response">Response:</label>
                <textarea class="p-2 border border-gray-300 rounded-md w-full" id="response" name="response" oninput="autoResize(this); updateDarpProgressNote();"></textarea>
                <h3 class="text-xl font-semibold text-gray-700 mt-4 mb-2">PLAN:</h3>
                <label class="font-medium text-gray-700 mb-2" for="plan">Plan:</label>
                <textarea class="p-2 border border-gray-300 rounded-md w-full" id="plan" name="plan" oninput="autoResize(this); updateDarpProgressNote();"></textarea>
            
                <div id="internInfoSection" class="bg-blue-100 p-4 rounded-md mt-6" style="display:none;">
                    <h3 class="text-lg font-semibold mb-3">Internship Information</h3>
                    <div class="grid grid-cols-[auto_1fr] gap-x-4 gap-y-2 items-center">
                        <label for="internName" class="font-medium text-gray-700 justify-self-end">Name of Intern:</label>
                        <input type="text" id="internName" class="p-2 border border-gray-300 rounded-md w-full" oninput="updateDarpProgressNote()">
                        
                        <label for="supervisorName" class="font-medium text-gray-700 justify-self-end">Name of Supervisor:</label>
                        <input type="text" id="supervisorName" class="p-2 border border-gray-300 rounded-md w-full" oninput="updateDarpProgressNote()">
                        
                        <label for="supervisorCredential" class="font-medium text-gray-700 justify-self-end">Supervisor Credential:</label>
                        <input type="text" id="supervisorCredential" class="p-2 border border-gray-300 rounded-md w-full" oninput="updateDarpProgressNote()">
                        
                        <label for="supervisorCredentialNum" class="font-medium text-gray-700 justify-self-end">Supervisor Credential Number:</label>
                        <input type="text" id="supervisorCredentialNum" class="p-2 border border-gray-300 rounded-md w-full" oninput="updateDarpProgressNote()">
                    </div>
                    <div class="flex gap-2 mt-4">
                        <button type="button" id="saveInternInfo" class="px-4 py-2 bg-blue-600 text-white font-semibold rounded-md shadow-sm hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                            Save Information
                        </button>
                        <button type="button" id="clearInternInfo" class="px-4 py-2 bg-gray-500 text-white font-semibold rounded-md shadow-sm hover:bg-gray-600 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-gray-400">
                            Clear Information
                        </button>
                    </div>
                </div>
                </form>
            <h3 class="text-2xl font-bold text-gray-800 mt-6 mb-2">Generated Progress Note</h3>
            <textarea class="w-full p-2 border border-gray-300 rounded-md bg-gray-50" id="progressNote" oninput="autoResize(this)"></textarea>
            <button class="mt-2 px-6 py-2 bg-indigo-600 text-white font-semibold rounded-md shadow-sm hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500" onclick="copyDarpToClipboard()">COPY DARP NOTE</button>
        </div>
    </div>

    <div class="tabcontent p-4 sm:p-6 md:p-8" id="NoteTemplates" style="display:none;">
        <iframe src="https://therapytools.github.io/notes/Templates.html" class="w-full h-[85vh]" style="border:none;" title="Note Templates"></iframe>
    </div>

    <div class="tabcontent p-4 sm:p-6 md:p-8" id="SUD" style="display:none;">
        <iframe src="https://therapytools.github.io/notes/SUD_Diagnostic_Tool.html" class="w-full h-[85vh]" style="border:none;" title="SUD Diagnostic Tool"></iframe>
    </div>

    <div class="tabcontent p-4 sm:p-6 md:p-8" id="DSMDx" style="display:none;">
        <iframe src="https://therapytools.github.io/DSMDx/index.html" class="w-full h-[85vh]" style="border:none;" title="DSM-V-TR Diagnostic Tool"></iframe>
    </div>

    <div class="tabcontent p-4 sm:p-6 md:p-8" id="Planner" style="display:none;">
        <iframe src="https://therapytools.github.io/notes/Treatment_Planner.html" class="w-full h-[85vh]" style="border:none;" title="Treatment Planner"></iframe>
    </div>

    <div class="tabcontent p-4 sm:p-6 md:p-8" id="Letters" style="display:none;">
        <iframe src="https://therapytools.github.io/notes/letters.html" class="w-full h-[85vh]" style="border:none;" title="Letters"></iframe>
    </div>

    <div class="tabcontent p-4 sm:p-6 md:p-8" id="SafetyPlan" style="display:none">
        <iframe src="https://therapytools.github.io/notes/safetyplan.html" class="w-full h-[85vh]" style="border:none;" title="Safety Plan"></iframe>
    </div>
</div>
<button id="scrollTopBtn" class="scroll-top-btn" type="button" onclick="scrollToTop()" aria-label="Scroll to top">Top</button>
<script>
    if ('scrollRestoration' in history) {
        history.scrollRestoration = 'manual';
    }
    window.scrollTo({ top: 0, behavior: 'auto' });
    // --- Core Tab and UI Logic ---
    function toggleSudDropdown(evt) {
        const dropdown = document.getElementById('sudDropdown');
        dropdown.classList.toggle('hidden');
        evt.stopPropagation();
    }

    function showSudDropdown() {
        const dropdown = document.getElementById('sudDropdown');
        dropdown.classList.remove('hidden');
    }

    function hideSudDropdown() {
        const dropdown = document.getElementById('sudDropdown');
        dropdown.classList.add('hidden');
    }

    function highlightOption(element) {
        element.classList.add('bg-indigo-200', 'font-semibold');
    }

    function unhighlightOption(element) {
        element.classList.remove('bg-indigo-200', 'font-semibold');
    }

    // Close dropdown when clicking outside
    document.addEventListener('click', function() {
        const dropdown = document.getElementById('sudDropdown');
        const sudContainer = document.getElementById('sudContainer');
        if (dropdown && !dropdown.classList.contains('hidden') && !sudContainer.contains(event.target)) {
            dropdown.classList.add('hidden');
        }
    });

    function openTab(evt, tabName) {
        const tabcontent = document.getElementsByClassName("tabcontent");
        for (let i = 0; i < tabcontent.length; i++) {
            tabcontent[i].style.display = "none";
        }
        const tablinks = document.getElementsByClassName("tab-button");
        for (let i = 0; i < tablinks.length; i++) {
            tablinks[i].className = tablinks[i].className.replace(" active", "");
        }
        document.getElementById(tabName).style.display = "block";
        evt.currentTarget.className += " active";
        
        // Close dropdown after selection
        const dropdown = document.getElementById('sudDropdown');
        if (dropdown && !dropdown.classList.contains('hidden')) {
            dropdown.classList.add('hidden');
        }
        setScrollTopVisibility(tabName);
    }
    document.getElementById("defaultOpen").click();

    function setScrollTopVisibility(tabName) {
        const btn = document.getElementById('scrollTopBtn');
        if (!btn) return;
        const shouldShow = tabName === 'MSE' || tabName === 'DARP';
        btn.style.display = shouldShow ? 'flex' : 'none';
    }

    function scrollToTop() {
        window.scrollTo({ top: 0, behavior: 'smooth' });
    }

    function autoResize(textarea) {
        if(textarea) {
            textarea.style.height = 'auto';
            textarea.style.height = textarea.scrollHeight + 'px';
        }
    }

    // --- MSE (Mental Status Exam) Logic ---
    function clearAllMseCheckboxes() {
        document.querySelectorAll('#MSE input[type="checkbox"]').forEach(cb => cb.checked = false);
    }

    function togglePositiveMSE() {
        clearAllMseCheckboxes();
        document.getElementById("positiveMSE").checked = true;
        ["x4","neat","clean","appropriatelydressed","notRemarkable","appropriate","normalAttention",
         "normalMemory","normalEyeContact","responsive","cooperative","affectCongruent","affectAppropriate",
         "euthymic","normalSpeech","expressionCongruent","normalOrganization","noHallucinations",
         "insightGood","judgementGood","normalDecisionMaking","noSIHI"]
         .forEach(id => {
             const el = document.getElementById(id);
             if(el) el.checked = true;
        });
        updateMseText();
    }

    function TelehealthPositiveMSE() {
        clearAllMseCheckboxes();
        document.getElementById("telehealthpositiveMSE").checked = true;
        ["x4","appropriate","normalAttention","normalMemory","normalEyeContact","responsive","cooperative",
         "affectCongruent","euthymic","normalSpeech","expressionCongruent","normalOrganization",
         "noHallucinations","insightGood","judgementGood","normalDecisionMaking","noSIHI"]
         .forEach(id => {
            const el = document.getElementById(id);
            if(el) el.checked = true;
        });
        updateMseText();
    }

    function updateMseText() {
        const mseTextbox = document.getElementById("mseTextbox");
        const darpMentalStatusTextarea = document.getElementById("mentalStatus");
        let text = "";

        const categories = [
            { name: "Orientation", checkboxes: ["x4", "time", "place", "situation", "person"], custom: "orientationCustom" },
            { name: "Clothing/Grooming", checkboxes: ["neat", "clean", "appropriatelydressed", "careless", "disheveled", "dirty", "inappropriate", "bizarre"], custom: "clothingGroomingCustom" },
            { name: "Motor Activity", checkboxes: ["notRemarkable", "slowed", "repetitive", "restless", "agitated", "tremor"], custom: "motorActivityCustom" },
            { name: "Behavior", checkboxes: ["appropriate", "aggressive", "angry", "apathetic", "irritable", "passive", "manipulative"], custom: "behaviorCustom" },
            { name: "Attention", checkboxes: ["normalAttention", "unaware", "distractible", "vigilant"], custom: "attentionCustom" },
            { name: "Recall/Memory", checkboxes: ["normalMemory", "shortTermImpaired", "longTermImpaired"], custom: "recallMemoryCustom" },
            { name: "Eye Contact", checkboxes: ["normalEyeContact", "fleeting", "avoided", "none", "staring"], custom: "eyeContactCustom" },
            { name: "Facial Expression", checkboxes: ["responsive", "tense", "anxious", "sad", "angry"], custom: "facialExpressionCustom" },
            { name: "Attitude toward Evaluator", checkboxes: ["cooperative", "friendly", "guarded", "hostile", "indifferent", "ingratiating", "manipulative", "open", "seductive", "suspicious", "uncooperative"], custom: "attitudeEvaluatorCustom" },
            { name: "Affect", checkboxes: ["affectCongruent", "affectIncongruent", "affectAppropriate", "affectInappropriate", "labile", "restricted", "flat", "reactive", "blunted"], custom: "affectCustom" },
            { name: "Mood", checkboxes: ["euthymic", "dysphoric", "anxiousmood", "angrymood", "irritableMood", "pessimistic", "depressed", "hypomanic", "euphoric"], custom: "moodCustom" },
            { name: "Speech", checkboxes: ["normalSpeech", "loud", "blocked", "pressured", "flightOfIdeas", "slurred", "soft", "stuttering", "mute", "verbose"], custom: "speechCustom" },
            { name: "Expression of Thought Content", checkboxes: ["expressionCongruent", "expressionIncongruent", "looseassociations", "suspicions", "delusions", "phobias", "obsessions"], custom: "expressionCustom" },
            { name: "Organization of Thought", checkboxes: ["normalOrganization", "logical", "goalDirected"], custom: "organizationCustom" },
            { name: "Perception", checkboxes: ["noHallucinations", "auditoryhallucinations", "visualhallucinations", "olfactoryhallucinations", "tactilehallucinations", "gustatoryhallucinations", "delusionsPresent"], custom: "perceptionCustom" },
            { name: "Insight", checkboxes: ["insightExcellent", "insightGood", "insightFair", "insightPoor", "insightNil"], custom: "insightCustom" },
            { name: "Judgment", checkboxes: ["judgementExcellent", "judgementGood", "judgementFair", "judgementPoor", "judgementNil", "judgementDangerous"], custom: "judgmentCustom" },
            { name: "Decision Making", checkboxes: ["normalDecisionMaking", "onlySimple", "impulsive", "confused"], custom: "decisionMakingCustom" },
            { name: "Safety", checkboxes: ["noSIHI", "deniesSIHI", "reportsHI", "reportsPassiveSIT", "reportsSuicidePlan", "reportsSuicidalIntention"], custom: "safetyCustom" }
        ];

        categories.forEach(category => {
            const checkedItems = [];
            category.checkboxes.forEach(id => {
                const checkbox = document.getElementById(id);
                if (checkbox && checkbox.checked) {
                    checkedItems.push(checkbox.nextSibling.nodeValue.trim());
                }
            });
            const customInput = document.getElementById(category.custom) ? document.getElementById(category.custom).value : "";
            if (customInput) {
                checkedItems.push(customInput);
            }
            if (checkedItems.length > 0) {
                text += `${category.name}: ${checkedItems.join(", ")}\n`;
            }
        });

        const generatedText = text.trim();
        mseTextbox.value = generatedText;
        if (darpMentalStatusTextarea) {
            darpMentalStatusTextarea.value = generatedText;
            autoResize(darpMentalStatusTextarea);
            updateDarpProgressNote();
        }
    }

    function copyMseToClipboard() {
        const textbox = document.getElementById("mseTextbox");
        textbox.select();
        document.execCommand("copy");
        // Using a more modern notification approach could be an improvement, but alert is simple and effective.
        alert("MSE text copied to clipboard!");
    }

    // --- DARP (Progress Note) Logic ---

    // *** NEW: Intern Note Logic ***
    const internStatementText = "Intern informed client that they are a counselor-in-training completing an internship at the clinic under the supervision of a licensed clinician. Intern explained the supervisory relationship and the role of the supervisor in supporting client care and ensuring quality services. Client was informed that parts of sessions may be reviewed for supervision purposes. Intern obtained client’s verbal consent to proceed with treatment under intern status. Client expressed understanding and agreed to continue services.";

    function toggleInternNote() {
        const isChecked = document.getElementById('internNoteCheckbox').checked;
        const displayStyle = isChecked ? 'block' : 'none';
        
        // This controls the top blue statement box
        const statementSection = document.getElementById('internStatementSection');
        if (statementSection) statementSection.style.display = displayStyle;
        
        // This controls the bottom blue information box
        const infoSection = document.getElementById('internInfoSection');
        if (infoSection) infoSection.style.display = displayStyle;
    }

    function saveInternInfo() {
        const internData = {
            name: document.getElementById('internName').value,
            supervisor: document.getElementById('supervisorName').value,
            credential: document.getElementById('supervisorCredential').value,
            credentialNum: document.getElementById('supervisorCredentialNum').value
        };
        localStorage.setItem('internData', JSON.stringify(internData));
        localStorage.setItem('autoCheckInternNote', 'true');
        alert('Intern information saved.');
    }

    function clearInternInfo() {
        localStorage.removeItem('internData');
        localStorage.removeItem('autoCheckInternNote');
        
        document.getElementById('internName').value = '';
        document.getElementById('supervisorName').value = '';
        document.getElementById('supervisorCredential').value = '';
        document.getElementById('supervisorCredentialNum').value = '';
        
        document.getElementById('internNoteCheckbox').checked = false;
        toggleInternNote(); // This will hide the sections
        updateDarpProgressNote();
        alert('Saved intern information cleared.');
    }

    function loadInternInfo() {
        if (localStorage.getItem('autoCheckInternNote') === 'true') {
            const internData = JSON.parse(localStorage.getItem('internData'));
            if (internData) {
                document.getElementById('internName').value = internData.name || '';
                document.getElementById('supervisorName').value = internData.supervisor || '';
                document.getElementById('supervisorCredential').value = internData.credential || '';
                document.getElementById('supervisorCredentialNum').value = internData.credentialNum || '';
            }
            document.getElementById('internNoteCheckbox').checked = true;
        }
        // Always run toggle to set initial visibility based on (potentially loaded) checkbox state
        toggleInternNote();
    }
    // *** END: Intern Note Logic ***


    function addTreatmentGoalRow() {
        const container = document.getElementById('treatmentGoalsContainer');
        const goalRow = document.createElement('div');
        goalRow.className = 'treatment-goal-row flex items-start gap-2 p-2 border border-gray-300 rounded-md';

        const dateInput = document.getElementById('sessionDate');
        let datePrefix = '';
        if (dateInput && dateInput.value) {
            const date = new Date(dateInput.value);
            // Adjust for timezone to get the correct local date
            const userTimezoneOffset = date.getTimezoneOffset() * 60000;
            const localDate = new Date(date.getTime() + userTimezoneOffset);
            const month = String(localDate.getMonth() + 1).padStart(2, '0');
            const day = String(localDate.getDate()).padStart(2, '0');
            const year = localDate.getFullYear();
            datePrefix = `${month}/${day}/${year} - `;
        }

        goalRow.innerHTML = `
            <div class="flex-grow space-y-2">
                <div class="flex items-center gap-2">
                    <label class="font-medium text-gray-700 w-28 flex-shrink-0">Treatment Goal:</label>
                    <input type="text" class="p-2 border border-gray-300 rounded-md w-full treatment-goal-input" oninput="updateDarpProgressNote()">
                </div>
                <div class="flex items-start gap-2">
                    <label class="font-medium text-gray-700 w-28 flex-shrink-0 mt-2">Update:</label>
                    <textarea class="p-2 border border-gray-300 rounded-md w-full treatment-goal-update" oninput="autoResize(this); updateDarpProgressNote()">${datePrefix}</textarea>
                </div>
            </div>
            <div class="flex flex-col gap-2">
                <button type="button" class="px-3 py-1 bg-green-500 text-white rounded-md hover:bg-green-600" onclick="addTreatmentGoalRow()">+</button>
                <button type="button" class="px-3 py-1 bg-red-500 text-white rounded-md hover:bg-red-600 remove-goal-btn" onclick="removeTreatmentGoalRow(this)">-</button>
            </div>
        `;

        container.appendChild(goalRow);
        const newTextarea = goalRow.querySelector('textarea');
        autoResize(newTextarea);
        updateRemoveButtonsState();
        updateDarpProgressNote();
    }

    function removeTreatmentGoalRow(button) {
        const row = button.closest('.treatment-goal-row');
        if (row) {
            row.remove();
            updateDarpProgressNote();
            updateRemoveButtonsState();
        }
    }

    function updateRemoveButtonsState() {
        const rows = document.querySelectorAll('#treatmentGoalsContainer .treatment-goal-row');
        rows.forEach(row => {
            const removeBtn = row.querySelector('.remove-goal-btn');
            if (removeBtn) {
                 removeBtn.style.display = rows.length <= 1 ? 'none' : 'block';
            }
        });
    }

    // *** NEW FUNCTION ***
    function syncSessionDateToGoals(dateValue) {
        // Find all goal row update textareas
        const goalUpdateTextareas = document.querySelectorAll('#treatmentGoalsContainer .treatment-goal-row .treatment-goal-update');
        
        goalUpdateTextareas.forEach(textarea => {
            let datePrefix = '';
            if (dateValue) {
                const date = new Date(dateValue);
                // Adjust for timezone to get the correct local date
                const userTimezoneOffset = date.getTimezoneOffset() * 60000;
                const localDate = new Date(date.getTime() + userTimezoneOffset);
                const month = String(localDate.getMonth() + 1).padStart(2, '0');
                const day = String(localDate.getDate()).padStart(2, '0');
                const year = localDate.getFullYear();
                datePrefix = `${month}/${day}/${year} - `;
            }
            
            let currentValue = textarea.value;
            // Regex to find a date prefix like "MM/DD/YYYY - "
            const dateRegex = /^\d{2}\/\d{2}\/\d{4} - /;
            
            if (dateRegex.test(currentValue)) {
                // If a date prefix already exists, replace only the date part, preserve the rest
                textarea.value = currentValue.replace(dateRegex, datePrefix);
            } else if (currentValue.trim() === '') {
                // If the textarea is empty, just add the new prefix
                textarea.value = datePrefix;
            } else {
                // If the textarea has content but no date, prepend the new prefix
                textarea.value = `${datePrefix}${currentValue}`;
            }
            
            // Trigger updates
            autoResize(textarea);
        });
        
        updateDarpProgressNote();
    }
    // *** END NEW FUNCTION ***

    function updateDarpProgressNote() {
        let progressNote = "";
        const isInternNote = document.getElementById('internNoteCheckbox')?.checked;

        // *** NEW: Prepend intern statement ***
        if (isInternNote) {
            const internStatement = document.getElementById('internStatementSection')?.innerText.trim();
            if(internStatement) progressNote += `${internStatement}\n\n`;
        }
        
        const mentalStatus = document.getElementById('mentalStatus')?.value || '';
        const problemsAddressed = document.getElementById('problemsAddressed')?.value || '';
        const diagnoses = document.getElementById('diagnoses')?.value || '';
        
        let updatesProgressText = "";
        const goalRows = document.querySelectorAll('#treatmentGoalsContainer .treatment-goal-row');
        goalRows.forEach((row, index) => {
            const goalInput = row.querySelector('.treatment-goal-input');
            const updateInput = row.querySelector('.treatment-goal-update');
            if (goalInput && updateInput) {
                const goal = goalInput.value.trim();
                const update = updateInput.value.trim();
                if (goal || update) {
                    updatesProgressText += `Goal: ${goal}\nUpdate: ${update}\n\n`;
                }
            }
        });
        updatesProgressText = updatesProgressText.trim();

        const additionalNotes = document.getElementById('additionalNotes')?.value || '';
        const additionalAssessment = document.getElementById('additionalAssessment')?.value || '';
        const response = document.getElementById('response')?.value || '';
        const plan = document.getElementById('plan')?.value || '';
        const toxicologyScreen = document.getElementById('toxicologyScreen')?.checked;
        
        progressNote += "DATA:\n";
        if (diagnoses) progressNote += `Diagnoses:\n${diagnoses}\n\n`;
        if (problemsAddressed) progressNote += `Problems Addressed in the Counseling Session:\n${problemsAddressed}\n\n`;
        if (updatesProgressText) progressNote += `Updates and Progress to Client's Treatment Goals:\n${updatesProgressText}\n\n`;
        if (toxicologyScreen) progressNote += `Client provided a toxicology screen.\n\n`;
        if (additionalNotes) progressNote += `Additional Notes:\n${additionalNotes}\n\n`;
        
        // --- Interventions Logic ---
        let interventionsUsed = "Interventions Used:\n";
        const containers = document.querySelectorAll('.darp-column');

        // Note: darpModalities might not be populated if this runs before render.
        // But since render calls this, it should be fine.
        if (typeof darpModalities !== 'undefined') {
             containers.forEach((container) => {
                 const modalityIndex = container.getAttribute('data-index');
                 const modality = darpModalities[modalityIndex];
                 if(!modality) return;

                 const checkedBoxes = container.querySelectorAll('input[type="checkbox"]:checked');
                 const selectedItems = Array.from(checkedBoxes).map(cb => cb.value);
                 
                 if (selectedItems.length > 0) {
                     if (modality.title === "Custom Interventions") {
                         interventionsUsed += selectedItems.join(", ") + "\n";
                     } else {
                         interventionsUsed += `${modality.title}: ${selectedItems.join(", ")}\n`;
                     }
                 }
            });
        }
        
        if (interventionsUsed.trim() !== "Interventions Used:") progressNote += `${interventionsUsed}\n`;

        progressNote += "ASSESSMENT:\n";
        if (mentalStatus) progressNote += `Mental Status Exam:\n${mentalStatus}\n\n`;
        if (additionalAssessment) progressNote += `Additional Assessment:\n${additionalAssessment}\n\n`;

        progressNote += "RESPONSE:\n";
        if (response) progressNote += `${response}\n\n`;

        progressNote += "PLAN:\n";
        if (plan) progressNote += `${plan}`;

        // *** NEW: Append intern signature block ***
        if (isInternNote) {
            const internName = document.getElementById('internName').value || '(Name of Intern)';
            const supervisorName = document.getElementById('supervisorName').value || '(Name of Supervisor)';
            const supervisorCredential = document.getElementById('supervisorCredential').value || '(Supervisor Credential)';
            const supervisorCredentialNum = document.getElementById('supervisorCredentialNum').value || '(Credential Number)';
            
            const signature = `\n\n\nSession completed by ${internName}\nSession reviewed and signed by ${supervisorName}, ${supervisorCredential}, ${supervisorCredentialNum}`;
            progressNote += signature;
        }

        const noteBox = document.getElementById('progressNote');
        if (noteBox) {
            noteBox.value = progressNote;
            autoResize(noteBox);
        }
    }

    function copyDarpToClipboard() {
        const note = document.getElementById('progressNote');
        note.select();
        document.execCommand("copy");
        alert("Progress note copied to clipboard!");
    }

    /* =========================================
       DYNAMIC MODALITIES / INTERVENTIONS LOGIC
       ========================================= */
       
    const DEFAULT_MODALITIES = [
        {
            title: "Custom Interventions",
            items: ["Reflective Listening", "Mirroring"],
            isCustom: true
        },
        {
            title: "CBT",
            items: [
                "Cognitive Restructuring", "Behavioral Activation", "Mindfulness Training",
                "Problem-Solving", "Activity Scheduling", "Relaxation Techniques",
                "Cognitive Defusion", "Identifying Cognitive Distortions and alternative thinking patterns"
            ]
        },
        {
            title: "Person Centered",
            items: [
                "Open-ended questions", "Reflective Listening", "Summarizing",
                "Empathy", "Active Listening", "Validation", "Silence",
                "Emotional Presence", "Encouraging Autonomy", "Facilitation of Self-Discovery",
                "Unconditional Positive Regard"
            ]
        },
        {
            title: "Motivational Interviewing",
            items: [
                "Open-Ended Questions", "Reflective Listening", "Summarizing",
                "Affirmations", "Decisional Balance (Pros/Cons)",
                "Developing and Identifying Discrepancy", "Supporting Self-Efficacy",
                "Evoking Commitment Language"
            ]
        }
    ];

    let darpModalities = JSON.parse(localStorage.getItem('darpModalities')) || JSON.parse(JSON.stringify(DEFAULT_MODALITIES));

    function saveModalities() {
        localStorage.setItem('darpModalities', JSON.stringify(darpModalities));
        renderInterventions();
        updateDarpProgressNote();
    }

    function resetModalitiesToDefault() {
        if(confirm("Are you sure you want to reset all intervention categories to default? This will clear your custom changes.")){
            darpModalities = JSON.parse(JSON.stringify(DEFAULT_MODALITIES));
            saveModalities();
        }
    }

    function renderInterventions() {
        const container = document.getElementById('darp-interventions-container');
        if (!container) return;
        
        container.innerHTML = ''; // Clear existing

        darpModalities.forEach((modality, modIndex) => {
            const col = document.createElement('div');
            col.className = 'darp-column relative p-2 border border-blue-50 rounded bg-blue-50/30';
            col.setAttribute('data-index', modIndex);
            
            // Header with delete button
            const header = document.createElement('div');
            header.className = 'flex justify-between items-center mb-2';
            
            const titleRow = document.createElement('div');
            titleRow.className = 'flex items-center gap-2';
            
            const title = document.createElement('strong');
            title.className = 'font-semibold text-gray-800';
            title.textContent = modality.title;
            titleRow.appendChild(title);
            
            // Rename Button
            const renameBtn = document.createElement('button');
            renameBtn.innerHTML = '&#9998;'; // Pencil icon
            renameBtn.className = 'text-gray-400 hover:text-blue-600 text-sm';
            renameBtn.title = 'Rename category';
            renameBtn.onclick = () => renameModality(modIndex);
            titleRow.appendChild(renameBtn);

            header.appendChild(titleRow);

            // Delete Modality Button
            const deleteBtn = document.createElement('button');
            deleteBtn.innerHTML = '&times;';
            deleteBtn.className = 'text-red-500 hover:text-red-700 font-bold text-lg px-2';
            deleteBtn.title = 'Remove this data set';
            deleteBtn.onclick = () => deleteModality(modIndex);
            header.appendChild(deleteBtn);
            
            col.appendChild(header);

            // Add Intervention Input
            const controls = document.createElement('div');
            controls.className = 'controls mb-2 flex gap-2';
            const input = document.createElement('input');
            input.type = 'text';
            input.placeholder = 'Add new intervention';
            input.className = 'flex-grow p-1 text-sm border border-gray-300 rounded';
            input.onkeydown = (e) => {
                if(e.key === 'Enter') {
                    e.preventDefault();
                    addIntervention(modIndex, input.value);
                }
            };
            
            const addBtn = document.createElement('button');
            addBtn.textContent = '+';
            addBtn.className = 'px-2 py-1 bg-green-500 text-white rounded hover:bg-green-600 text-sm';
            addBtn.onclick = () => addIntervention(modIndex, input.value);
            
            controls.appendChild(input);
            controls.appendChild(addBtn);
            col.appendChild(controls);

            // List of interventions
            const listDiv = document.createElement('div');
            listDiv.className = 'space-y-1';
            
            modality.items.forEach((item, itemIndex) => {
                const itemDiv = document.createElement('div');
                itemDiv.className = 'darp-inline-checkbox flex items-center justify-between group';
                
                const leftDiv = document.createElement('div');
                leftDiv.className = 'flex items-center gap-2';

                const cb = document.createElement('input');
                cb.type = 'checkbox';
                cb.id = `mod-${modIndex}-item-${itemIndex}`;
                cb.value = item;
                // Important: checkboxes don't persist state in darpModalities (only structural config). 
                // State is transient for the session usually, unless we want to save checked state too?
                // The original app didn't seem to save checked state across reloads explicitly, 
                // but the old Custom did because it was just a list.
                // We will just let them be unchecked by default on reload.
                cb.onchange = updateDarpProgressNote;
                
                const label = document.createElement('label');
                label.htmlFor = `mod-${modIndex}-item-${itemIndex}`;
                label.textContent = item;
                label.className = 'text-sm text-gray-700';

                leftDiv.appendChild(cb);
                leftDiv.appendChild(label);
                
                // Delete Item Button (visible when hovering group?)
                const delItemBtn = document.createElement('button');
                delItemBtn.innerHTML = '&times;';
                delItemBtn.className = 'text-gray-400 hover:text-red-600 font-bold ml-2 opacity-0 group-hover:opacity-100 transition-opacity';
                delItemBtn.onclick = () => deleteIntervention(modIndex, itemIndex);
                
                itemDiv.appendChild(leftDiv);
                itemDiv.appendChild(delItemBtn);
                listDiv.appendChild(itemDiv);
            });
            
            col.appendChild(listDiv);
            container.appendChild(col);
        });
    }

    function addNewModality() {
        const input = document.getElementById('newModalityInput');
        const title = input.value.trim();
        if (!title) {
            alert("Please enter a name for the new category.");
            return;
        }
        
        darpModalities.push({
            title: title,
            items: []
        });
        
        input.value = '';
        saveModalities();
    }

    function renameModality(index) {
        const currentTitle = darpModalities[index].title;
        const newTitle = prompt("Enter new name for this category:", currentTitle);
        if (newTitle && newTitle.trim() !== "") {
            darpModalities[index].title = newTitle.trim();
            saveModalities();
        }
    }

    function deleteModality(index) {
        if(confirm(`Delete "${darpModalities[index].title}" and all its options?`)) {
            darpModalities.splice(index, 1);
            saveModalities();
        }
    }

    function addIntervention(modIndex, text) {
        text = text.trim();
        if(!text) return;
        
        // Prevent duplicates in same list?
        if(darpModalities[modIndex].items.includes(text)) {
            alert("This item already exists in this list.");
            return;
        }

        darpModalities[modIndex].items.push(text);
        saveModalities();
    }

    function deleteIntervention(modIndex, itemIndex) {
        if(confirm(`Remove "${darpModalities[modIndex].items[itemIndex]}"?`)) {
            darpModalities[modIndex].items.splice(itemIndex, 1);
            saveModalities();
        }
    }

    // --- Combined DOMContentLoaded Initializer ---
    window.addEventListener('DOMContentLoaded', () => {
        window.scrollTo({ top: 0, behavior: 'auto' });
        if(typeof setScrollTopVisibility === 'function') setScrollTopVisibility('MSE');
        
        // DARP Init
        if(typeof addTreatmentGoalRow === 'function') addTreatmentGoalRow();
        
        // Initialize dynamic interventions
        renderInterventions();
        
        // *** NEW: Load intern info and set up buttons ***
        if(typeof loadInternInfo === 'function') loadInternInfo(); 
        const saveBtn = document.getElementById('saveInternInfo');
        if (saveBtn) saveBtn.addEventListener('click', saveInternInfo);
        
        const clearBtn = document.getElementById('clearInternInfo');
        if (clearBtn) clearBtn.addEventListener('click', clearInternInfo);
        // *** END NEW ***
        
        // Initial call to populate MSE field in DARP from the other tab
        if (typeof updateMseText === 'function' && document.getElementById('mseTextbox')) {
            updateMseText(); 
        }

        // --- ADDED: Logic for editable & synced MSE textareas ---
        const mseTextbox = document.getElementById('mseTextbox');
        const darpMentalStatusTextarea = document.getElementById('mentalStatus');

        if (mseTextbox && darpMentalStatusTextarea) {
            // Sync from MSE tab to DARP tab
            mseTextbox.addEventListener('input', () => {
                darpMentalStatusTextarea.value = mseTextbox.value;
                autoResize(darpMentalStatusTextarea);
                updateDarpProgressNote();
            });

            // Sync from DARP tab to MSE tab
            darpMentalStatusTextarea.addEventListener('input', () => {
                mseTextbox.value = darpMentalStatusTextarea.value;
                autoResize(mseTextbox);
            });
        }
        
        // *** NEW: Pre-populate session date with current date ***
        const sessionDateInput = document.getElementById('sessionDate');
        if (sessionDateInput) {
            const today = new Date();
            const year = today.getFullYear();
            const month = String(today.getMonth() + 1).padStart(2, '0');
            const day = String(today.getDate()).padStart(2, '0');
            sessionDateInput.value = `${year}-${month}-${day}`;
            // Sync the date to treatment goals
            if(typeof syncSessionDateToGoals === 'function') syncSessionDateToGoals(sessionDateInput.value);
        }
        // *** END NEW ***
        
        // Final update to ensure note is correct on load
        updateDarpProgressNote();
    });
</script>
</body>
</html>