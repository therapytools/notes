<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Letter Generator</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        /* Simple animation for showing/hiding sections */
        .form-section {
            transition: opacity 0.5s ease-in-out;
        }
        /* Styles for the custom notification */
        #notification {
            transition: opacity 0.5s, transform 0.5s;
        }
        /* Removed margin from pdf-signature-block to control spacing with newlines */
        #pdf-signature-block {
             white-space: pre-wrap;
        }
        /* Ensure signature images print cleanly without background */
        #pdf-signature, #signaturePreview {
            background: transparent !important;
            background-color: transparent !important;
            padding: 0 !important;
            margin: 0 !important;
        }
        /* Print media query to ensure clean signature printing */
        @media print {
            #pdf-signature, #signaturePreview, img[alt="Signature"] {
                background: transparent !important;
                background-color: transparent !important;
                box-shadow: none !important;
                filter: none !important;
            }
        }
        /* Styles for the integrated form */
        .inline-input, .inline-input-date, .inline-select {
            background-color: #f0f9ff; /* light blue bg */
            border: none;
            border-bottom: 1px solid #93c5fd; /* blue bottom border */
            padding: 2px 6px;
            border-radius: 4px;
            margin: 0 4px;
            font-family: inherit;
            font-size: inherit;
            color: #1e40af;
        }
        .inline-input:focus, .inline-input-date:focus, .inline-select:focus {
            outline: none;
            box-shadow: 0 2px 0 0 #2563eb;
        }
        .inline-input-date { width: 160px; }
        .inline-input { width: 180px; }
        .inline-select {
             -webkit-appearance: none; -moz-appearance: none; appearance: none;
        }
        .form-letter-section {
            transition: opacity 0.3s ease;
        }
        .form-letter-section.disabled {
            opacity: 0.4;
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">
    <!-- Password Protection Overlay -->
    <div id="password-overlay" class="fixed inset-0 bg-gray-800 bg-opacity-75 flex items-center justify-center z-50">
        <div class="bg-white p-8 rounded-lg shadow-xl text-center w-full max-w-sm">
            <h2 class="text-2xl font-bold mb-4">Enter Password</h2>
            <input type="password" id="password-input" class="w-full px-4 py-2 border border-gray-300 rounded-lg mb-4 focus:ring-2 focus:ring-blue-500">
            <button onclick="checkPassword()" class="w-full bg-blue-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-blue-700 transition-colors">Submit</button>
            <p id="error-message" class="text-red-500 mt-2 hidden">Incorrect Password. Please try again.</p>
        </div>
    </div>

    <!-- Main Content (Initially Hidden) -->
    <div id="main-content" class="hidden">
        <div class="container mx-auto p-4 sm:p-6 lg:p-8">
            <div class="max-w-7xl mx-auto bg-white rounded-2xl shadow-lg p-6 sm:p-8">
                <div class="flex items-center justify-center mb-6">
                    <img id="visible-logo" src="https://therapytools.github.io/notes/logo.png" alt="Delphi Rise Logo" class="h-20" onerror="this.onerror=null;this.src='https://placehold.co/200x80/ffffff/333333?text=Logo';">
                </div>
                <h1 class="text-2xl sm:text-3xl font-bold text-center text-gray-700 mb-8">Letter Generator</h1>

                <!-- Letter Type Selector -->
                <div class="mb-8 max-w-4xl mx-auto">
                    <label for="letterType" class="block text-lg font-semibold text-gray-700 mb-2">Select Letter Type</label>
                    <select id="letterType" onchange="handleTemplateChange()" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition text-lg">
                        <option value="generalUse">General Use</option>
                        <option value="discharge">Discharge Letter</option>
                        <option value="enrollmentVerification">Enrollment Verification</option>
                        <option value="evalInProgress">Evaluation in Progress</option>
                        <option value="reEngagement">Re-Engagement</option>
                        <option value="treatmentNotRec">Treatment Not Recommended</option>
                        <option value="treatmentRec">Treatment Recommended</option>
                    </select>
                </div>

                <!-- ===== TEMPLATE: General Use ===== -->
                <div id="generalUseFields" class="hidden form-section max-w-4xl mx-auto">
                    <div class="bg-gray-50 p-6 rounded-xl border border-gray-200 mb-6">
                        <h2 class="text-xl font-semibold mb-4 text-gray-600 border-b pb-2">Letter Details</h2>
                        <div class="space-y-4">
                            <div>
                                <label for="guLetterDate" class="block text-sm font-medium text-gray-700 mb-1">Letter Date</label>
                                <input type="date" id="guLetterDate" oninput="generateReport()" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                            </div>
                            <div>
                                <label for="guSubject" class="block text-sm font-medium text-gray-700 mb-1">Subject</label>
                                <input type="text" id="guSubject" oninput="generateReport()" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" placeholder="Enter subject line">
                            </div>
                            <div>
                                <label for="guBody" class="block text-sm font-medium text-gray-700 mb-1">Body</label>
                                <textarea id="guBody" oninput="generateReport()" rows="12" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" placeholder="Enter letter body text here">[Insert the content of your letter here.]

Sincerely,</textarea>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- ===== TEMPLATE: Discharge Letter ===== -->
                <div id="dischargeFields" class="hidden form-section max-w-4xl mx-auto">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                        <!-- Client & Dates -->
                        <div class="bg-gray-50 p-6 rounded-xl border border-gray-200">
                            <h2 class="text-xl font-semibold mb-4 text-gray-600 border-b pb-2">Client &amp; Dates</h2>
                            <div class="space-y-4">
                                <div>
                                    <label for="disClientFirstName" class="block text-sm font-medium text-gray-700 mb-1">Client’s First Name</label>
                                    <input type="text" id="disClientFirstName" oninput="generateReport()" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                                </div>
                                <div>
                                    <label for="disClientLastName" class="block text-sm font-medium text-gray-700 mb-1">Client’s Last Name</label>
                                    <input type="text" id="disClientLastName" oninput="generateReport()" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                                </div>
                                <div>
                                    <label for="disClientDOB" class="block text-sm font-medium text-gray-700 mb-1">Date of Birth</label>
                                    <input type="date" id="disClientDOB" oninput="generateReport()" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                                </div>
                                <div>
                                    <label for="disAdmissionDate" class="block text-sm font-medium text-gray-700 mb-1">Admission Date</label>
                                    <input type="date" id="disAdmissionDate" oninput="generateReport()" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                                </div>
                                <div>
                                    <label for="disDischargeDate" class="block text-sm font-medium text-gray-700 mb-1">Discharge Date</label>
                                    <input type="date" id="disDischargeDate" oninput="generateReport()" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                                </div>
                            </div>
                        </div>
                        <!-- Treatment Summary -->
                        <div class="bg-gray-50 p-6 rounded-xl border border-gray-200">
                             <h2 class="text-xl font-semibold mb-4 text-gray-600 border-b pb-2">Treatment Summary</h2>
                             <div class="space-y-4">
                                 <div>
                                     <label for="disNumSessions" class="block text-sm font-medium text-gray-700 mb-1">Number of Sessions</label>
                                     <input type="number" id="disNumSessions" oninput="generateReport()" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                                 </div>
                                 <div>
                                     <label for="disGoalAchievement" class="block text-sm font-medium text-gray-700 mb-1">Treatment Goal Achievement</label>
                                     <select id="disGoalAchievement" onchange="generateReport()" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                                         <option value="achieved">achieved</option>
                                         <option value="partially achieved">partially achieved</option>
                                         <option value="did not achieve">did not achieve</option>
                                     </select>
                                 </div>
                             </div>
                        </div>
                    </div>
                        <!-- Discharge Status -->
                    <div class="bg-gray-50 p-6 rounded-xl border border-gray-200 mb-8">
                        <h2 class="text-xl font-semibold mb-4 text-gray-600 border-b pb-2">Discharge Status</h2>
                        <div class="space-y-4">
                           <div>
                                <label for="disOasasReasonSelect" class="block text-sm font-medium text-gray-700 mb-1">OASAS Reporting Reason</label>
                                <select id="disOasasReasonSelect" onchange="toggleOasasOther(); generateReport();" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                                    <option value="completed treatment, and all goals were met">Completed treatment: all goals met</option>
                                    <option value="completed treatment, and some goals were met">Completed treatment: some goals met</option>
                                    <option value="transferred to another OASAS-certified program">Transferred to another OASAS-certified program</option>
                                    <option value="transferred to another non-OASAS program / level of care">Transferred to another non-OASAS program / level of care</option>
                                    <option value="was referred elsewhere for non-treatment services">Referred elsewhere (non-treatment services)</option>
                                    <option value="left against professional advice (APA)">Left against professional advice (APA)</option>
                                    <option value="dropped out (lost to contact)" selected>Dropped out (lost to contact)</option>
                                    <option value="was incarcerated">Incarcerated</option>
                                    <option value="is deceased">Deceased</option>
                                    <option value="Other">Other</option>
                                </select>
                           </div>
                            <div id="oasasOtherContainer" class="hidden pl-2">
                                <label for="disOasasOtherText" class="block text-sm font-medium text-gray-700 mb-1">Specify Other Reason</label>
                                <input type="text" id="disOasasOtherText" oninput="generateReport()" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                            </div>
                        </div>
                    </div>
                </div>

                <!-- ===== TEMPLATE: Enrollment Verification ===== -->
                <div id="enrollmentVerificationFields" class="hidden form-section">
                    <div class="max-w-4xl mx-auto bg-white p-8 sm:p-12 rounded-2xl shadow-lg border border-gray-200 font-serif text-gray-900 leading-relaxed text-lg">
                        <!-- Letter Head -->
                        <div class="flex justify-between items-start mb-10">
                            <img id="ev-preview-logo" src="https://therapytools.github.io/notes/logo.png" alt="Delphi Rise Logo" class="h-16" onerror="this.onerror=null;this.src='https://placehold.co/150x50/ffffff/333333?text=Logo';">
                            <p id="ev-todays-date-display" class="text-sm"></p>
                        </div>
                
                        <!-- Salutation -->
                        <p class="mb-6">To Whom It May Concern,</p>
                
                        <!-- Paragraph 1: Client Info -->
                        <p class="mb-6">
                            This letter is to verify that
                            <input type="text" id="evClientFirstName" placeholder="First Name" class="inline-input" oninput="generateReport()">
                            <input type="text" id="evClientLastName" placeholder="Last Name" class="inline-input" oninput="generateReport()">,
                            DOB <input type="date" id="evClientDOB" class="inline-input-date" oninput="generateReport()">,
                            is currently enrolled in services with Delphi Rise. Services began on
                            <input type="date" id="evStartDate" class="inline-input-date" oninput="generateReport()">.
                        </p>
                
                        <!-- Paragraph 2: Attendance -->
                        <div id="evAttendanceSection" class="mb-6 p-4 bg-blue-50/50 rounded-lg flex items-center justify-between gap-4 form-letter-section">
                           <p>The client has been attending services on an
                                <select id="evAttendance" onchange="generateReport()" class="inline-select">
                                    <option value="regular">regular</option>
                                    <option value="irregular">irregular</option>
                                </select>
                                basis.
                            </p>
                            <div class="flex items-center flex-shrink-0">
                                <input type="checkbox" id="evAttOmit" onchange="toggleSection(this, 'evAttendanceSection'); generateReport();" class="h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded">
                                <label for="evAttOmit" class="ml-2 text-sm text-gray-600 font-sans">Omit</label>
                            </div>
                        </div>
                        
                        <!-- Paragraph 3: Toxicology -->
                        <div class="mb-6 p-4 bg-blue-50/50 rounded-lg space-y-4">
                            <div id="evToxPositiveContainer" class="flex items-center justify-between gap-4 form-letter-section">
                                <p class="flex-grow">The most recent positive toxicology screen was on
                                    <input type="date" id="evToxPositiveDate" class="inline-input-date" oninput="generateReport()">
                                    for <input type="text" id="evToxPositiveSubstance" placeholder="e.g., THC" class="inline-input" oninput="generateReport()">.
                                </p>
                                <div class="flex items-center flex-shrink-0">
                                    <input type="checkbox" id="evToxPositiveOmit" onchange="toggleSection(this, 'evToxPositiveContainer'); generateReport();" class="h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded">
                                    <label for="evToxPositiveOmit" class="ml-2 text-sm text-gray-600 font-sans">Omit</label>
                                </div>
                            </div>
                            <div id="evToxNegativeContainer" class="flex items-center justify-between gap-4 form-letter-section">
                                <p class="flex-grow">All toxicology screens have been negative since
                                    <input type="date" id="evToxNegativeDate" class="inline-input-date" oninput="generateReport()">.
                                </p>
                                <div class="flex items-center flex-shrink-0">
                                    <input type="checkbox" id="evToxNegativeOmit" onchange="toggleSection(this, 'evToxNegativeContainer'); generateReport();" class="h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded">
                                    <label for="evToxNegativeOmit" class="ml-2 text-sm text-gray-600 font-sans">Omit</label>
                                </div>
                            </div>
                        </div>

                        <!-- Paragraph 4: MAT -->
                         <div id="evMatSection" class="mb-6 p-4 bg-blue-50/50 rounded-lg flex items-center justify-between gap-4 form-letter-section">
                            <p class="flex-grow">The client is currently participating in our medication-assisted treatment (MAT) program.</p>
                            <div class="flex items-center flex-shrink-0">
                                 <input type="checkbox" id="evMatOmit" onchange="toggleSection(this, 'evMatSection'); generateReport();" class="h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded">
                                 <label for="evMatOmit" class="ml-2 text-sm text-gray-600 font-sans">Omit</label>
                            </div>
                        </div>
                
                        <!-- Closing Paragraphs -->
                        <p class="mb-4 text-base text-gray-600">Delphi Rise provides a range of recovery and supportive services designed to assist individuals in achieving and maintaining recovery, addressing substance use concerns, and supporting overall well-being. This verification is provided to confirm current enrollment and participation in services only.</p>
                        <p class="mb-6 text-base text-gray-600">Should you have any additional questions or require further details, please do not hesitate to contact our office.</p>
                        
                        <!-- Signature -->
                        <p class="mb-12">Sincerely,</p>
                        <div id="ev-signature-block-preview" class="whitespace-pre-wrap text-base">
                            <!-- Live signature block preview -->
                        </div>
                    </div>
                    <!-- The buttons below are now part of the main output section, which will be displayed for all letter types -->
                </div>

                <!-- ===== TEMPLATE: Treatment Recommended ===== -->
                <div id="treatmentRecFields" class="hidden form-section max-w-4xl mx-auto">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                        <!-- Client Information -->
                        <div class="bg-gray-50 p-6 rounded-xl border border-gray-200">
                            <h2 class="text-xl font-semibold mb-4 text-gray-600 border-b pb-2">Client Information</h2>
                            <div class="space-y-4">
                                <div>
                                    <label for="trClientFirstName" class="block text-sm font-medium text-gray-700 mb-1">Client’s First Name</label>
                                    <input type="text" id="trClientFirstName" oninput="generateReport()" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                                </div>
                                <div>
                                    <label for="trClientLastName" class="block text-sm font-medium text-gray-700 mb-1">Client’s Last Name</label>
                                    <input type="text" id="trClientLastName" oninput="generateReport()" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                                </div>
                            </div>
                        </div>
                        <!-- Evaluation Details -->
                        <div class="bg-gray-50 p-6 rounded-xl border border-gray-200">
                             <h2 class="text-xl font-semibold mb-4 text-gray-600 border-b pb-2">Evaluation Details</h2>
                             <div class="space-y-4">
                                 <div>
                                     <label for="trTodaysDate" class="block text-sm font-medium text-gray-700 mb-1">Date of Report</label>
                                     <input type="date" id="trTodaysDate" oninput="generateReport()" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                                 </div>
                                 <div>
                                     <label for="trEvaluationDate" class="block text-sm font-medium text-gray-700 mb-1">Date of Evaluation</label>
                                     <input type="date" id="trEvaluationDate" oninput="generateReport()" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                                 </div>
                                 <div>
                                     <label for="trLevelOfCare" class="block text-sm font-medium text-gray-700 mb-1">Recommended Level of Care</label>
                                     <input type="text" id="trLevelOfCare" oninput="generateReport()" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" placeholder="e.g., Outpatient">
                                 </div>
                             </div>
                        </div>
                    </div>
                        <!-- Diagnosis Details -->
                    <div class="bg-gray-50 p-6 rounded-xl border border-gray-200 mb-6">
                        <h2 class="text-xl font-semibold mb-4 text-gray-600 border-b pb-2">Diagnosis</h2>
                        <div class="flex items-end gap-4">
                            <div class="flex-grow">
                                <label for="dsm5Selector" class="block text-sm font-medium text-gray-700 mb-1">Select DSM-5-TR Diagnosis</label>
                                <select id="dsm5Selector" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                                    <!-- Options will be populated by JS -->
                                </select>
                            </div>
                            <button onclick="addDiagnosis()" class="bg-blue-500 text-white font-semibold py-2 px-4 rounded-lg hover:bg-blue-600 transition-colors whitespace-nowrap">Add +</button>
                        </div>
                        <div id="diagnosesContainer" class="mt-4 space-y-2">
                            <!-- Selected diagnoses will appear here -->
                        </div>
                    </div>
                    <!-- Toxicology Details -->
                    <div class="bg-gray-50 p-6 rounded-xl border border-gray-200 mb-8">
                        <h2 class="text-xl font-semibold mb-4 text-gray-600 border-b pb-2">Toxicology Screen</h2>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div>
                                <label for="trToxScreenDate" class="block text-sm font-medium text-gray-700 mb-1">Tox Screen Date</label>
                                <input type="date" id="trToxScreenDate" oninput="generateReport()" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Tox Screen Result</label>
                                <div class="flex items-center space-x-6">
                                   <div class="flex items-center">
                                        <input type="radio" id="trToxNegative" name="trToxResult" value="negative" checked onchange="toggleTrPositiveSubstance(); generateReport();" class="h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300">
                                        <label for="trToxNegative" class="ml-2 block text-sm text-gray-900">Negative</label>
                                   </div>
                                   <div class="flex items-center">
                                        <input type="radio" id="trToxPositive" name="trToxResult" value="positive" onchange="toggleTrPositiveSubstance(); generateReport();" class="h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300">
                                        <label for="trToxPositive" class="ml-2 block text-sm text-gray-900">Positive</label>
                                   </div>
                                </div>
                            </div>
                        </div>
                         <div id="trPositiveSubstanceContainer" class="hidden mt-4">
                            <label for="trPositiveSubstance" class="block text-sm font-medium text-gray-700 mb-1">Positive for</label>
                            <input type="text" id="trPositiveSubstance" oninput="generateReport()" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" placeholder="e.g., THC, Opiates">
                        </div>
                    </div>
                </div>

                <!-- ===== TEMPLATE: Treatment Not Recommended ===== -->
                <div id="treatmentNotRecFields" class="hidden form-section max-w-4xl mx-auto">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
                        <!-- Client Information -->
                        <div class="bg-gray-50 p-6 rounded-xl border border-gray-200">
                            <h2 class="text-xl font-semibold mb-4 text-gray-600 border-b pb-2">Client Information</h2>
                            <div class="space-y-4">
                                <div>
                                    <label for="clientFirstName" class="block text-sm font-medium text-gray-700 mb-1">Client’s First Name</label>
                                    <input type="text" id="clientFirstName" oninput="generateReport()" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition">
                                </div>
                                <div>
                                    <label for="clientLastName" class="block text-sm font-medium text-gray-700 mb-1">Client’s Last Name</label>
                                    <input type="text" id="clientLastName" oninput="generateReport()" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition">
                                </div>
                            </div>
                        </div>

                        <!-- Report Details -->
                        <div class="bg-gray-50 p-6 rounded-xl border border-gray-200">
                            <h2 class="text-xl font-semibold mb-4 text-gray-600 border-b pb-2">Report Details</h2>
                            <div class="space-y-4">
                                <div>
                                    <label for="recipientType" class="block text-sm font-medium text-gray-700 mb-1">Recipient</label>
                                    <select id="recipientType" onchange="toggleRecipientName(); generateReport();" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition">
                                        <option value="toWhom">To Whom It May Concern,</option>
                                        <option value="dear">Dear...</option>
                                    </select>
                                </div>
                                <div id="recipientNameContainer" class="hidden">
                                    <label for="recipientName" class="block text-sm font-medium text-gray-700 mb-1">Recipient Name</label>
                                    <input type="text" id="recipientName" oninput="generateReport()" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition">
                                </div>
                                <div>
                                    <label for="todaysDate" class="block text-sm font-medium text-gray-700 mb-1">Date of Report</label>
                                    <input type="date" id="todaysDate" oninput="generateReport()" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition">
                                </div>
                                <div>
                                    <label for="evaluationDate" class="block text-sm font-medium text-gray-700 mb-1">Evaluation Date</label>
                                    <input type="date" id="evaluationDate" oninput="generateReport()" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition">
                                </div>
                                <div class="pt-2">
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Assessment Methods</label>
                                    <div class="flex items-center">
                                        <input id="includeInterviews" type="checkbox" oninput="generateReport()" class="h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded">
                                        <label for="includeInterviews" class="ml-2 block text-sm text-gray-900">Include Personal Interviews</label>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <!-- Toxicology Details -->
                    <div class="bg-gray-50 p-6 rounded-xl border border-gray-200 md:col-span-2">
                        <h2 class="text-xl font-semibold mb-4 text-gray-600 border-b pb-2">Toxicology Screen Details</h2>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div>
                                <label for="toxScreenDate" class="block text-sm font-medium text-gray-700 mb-1">Tox Screen Date</label>
                                <input type="date" id="toxScreenDate" oninput="generateReport()" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Tox Screen Result</label>
                                <div class="flex items-center space-x-6">
                                   <div class="flex items-center">
                                        <input type="radio" id="toxNegative" name="toxResult" value="negative" checked onchange="togglePositiveSubstance(); generateReport();" class="h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300">
                                        <label for="toxNegative" class="ml-2 block text-sm text-gray-900">Negative</label>
                                   </div>
                                   <div class="flex items-center">
                                        <input type="radio" id="toxPositive" name="toxResult" value="positive" onchange="togglePositiveSubstance(); generateReport();" class="h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300">
                                        <label for="toxPositive" class="ml-2 block text-sm text-gray-900">Positive</label>
                                   </div>
                                </div>
                            </div>
                        </div>
                         <div id="positiveSubstanceContainer" class="hidden mt-4">
                            <label for="positiveSubstance" class="block text-sm font-medium text-gray-700 mb-1">Positive for</label>
                            <input type="text" id="positiveSubstance" oninput="generateReport()" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition" placeholder="e.g., THC, Opiates">
                        </div>
                    </div>
                </div>

                <!-- ===== TEMPLATE: Evaluation in Progress ===== -->
                <div id="evalInProgressFields" class="hidden form-section max-w-4xl mx-auto">
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
                                <!-- Client Information -->
                                <div class="bg-gray-50 p-6 rounded-xl border border-gray-200">
                                    <h2 class="text-xl font-semibold mb-4 text-gray-600 border-b pb-2">Client Information</h2>
                                    <div class="space-y-4">
                                        <div>
                                            <label for="eipClientFirstName" class="block text-sm font-medium text-gray-700 mb-1">Client’s First Name</label>
                                            <input type="text" id="eipClientFirstName" oninput="generateReport()" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition">
                                        </div>
                                        <div>
                                            <label for="eipClientLastName" class="block text-sm font-medium text-gray-700 mb-1">Client’s Last Name</label>
                                            <input type="text" id="eipClientLastName" oninput="generateReport()" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition">
                                        </div>
                                    </div>
                                </div>
                                <!-- Evaluation Details -->
                                <div class="bg-gray-50 p-6 rounded-xl border border-gray-200">
                                    <h2 class="text-xl font-semibold mb-4 text-gray-600 border-b pb-2">Evaluation Details</h2>
                                     <div class="space-y-4">
                                         <div>
                                             <label for="eipTodaysDate" class="block text-sm font-medium text-gray-700 mb-1">Date of Report</label>
                                             <input type="date" id="eipTodaysDate" oninput="generateReport()" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition">
                                         </div>
                                         <div>
                                             <label for="eipEvaluationDate" class="block text-sm font-medium text-gray-700 mb-1">Evaluation Date</label>
                                             <input type="date" id="eipEvaluationDate" oninput="generateReport()" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition">
                                         </div>
                                          <div>
                                             <label for="eipEvaluationTime" class="block text-sm font-medium text-gray-700 mb-1">Evaluation Time</label>
                                             <input type="time" id="eipEvaluationTime" oninput="generateReport()" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition">
                                         </div>
                                     </div>
                                </div>
                            </div>
                </div>
                
                <!-- ===== TEMPLATE: Re-Engagement ===== -->
                <div id="reEngagementFields" class="hidden form-section max-w-4xl mx-auto">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
                        <!-- Client Information -->
                        <div class="bg-gray-50 p-6 rounded-xl border border-gray-200">
                            <h2 class="text-xl font-semibold mb-4 text-gray-600 border-b pb-2">Client Information</h2>
                            <div class="space-y-4">
                                <div>
                                    <label for="reClientFirstName" class="block text-sm font-medium text-gray-700 mb-1">Client’s First Name</label>
                                    <input type="text" id="reClientFirstName" oninput="generateReport()" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition">
                                </div>
                                <div>
                                    <label for="reClientLastName" class="block text-sm font-medium text-gray-700 mb-1">Client’s Last Name</label>
                                    <input type="text" id="reClientLastName" oninput="generateReport()" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition">
                                </div>
                                <div>
                                    <label for="reClientAddress" class="block text-sm font-medium text-gray-700 mb-1">Address</label>
                                    <input type="text" id="reClientAddress" oninput="generateReport()" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition">
                                </div>
                                <div>
                                    <label for="reClientCityStateZip" class="block text-sm font-medium text-gray-700 mb-1">City, State, Zip</label>
                                    <input type="text" id="reClientCityStateZip" oninput="generateReport()" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition">
                                </div>
                            </div>
                        </div>

                        <!-- Letter Details -->
                        <div class="bg-gray-50 p-6 rounded-xl border border-gray-200">
                            <h2 class="text-xl font-semibold mb-4 text-gray-600 border-b pb-2">Letter Details</h2>
                            <div class="space-y-4">
                                <div>
                                    <label for="lastServiceDate" class="block text-sm font-medium text-gray-700 mb-1">Last Date of Service</label>
                                    <input type="date" id="lastServiceDate" oninput="generateReport()" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition">
                                </div>
                                <div>
                                    <label for="reTodaysDate" class="block text-sm font-medium text-gray-700 mb-1">Today's Date</label>
                                    <input type="date" id="reTodaysDate" oninput="generateReport()" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition">
                                </div>
                                <div>
                                    <label for="closureDate" class="block text-sm font-medium text-gray-700 mb-1">Closure Date</label>
                                    <input type="date" id="closureDate" oninput="generateReport()" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition">
                                    <p class="text-xs text-gray-500 mt-1">Friday of next week suggested.</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Counselor Information (Shared) -->
                <div class="bg-gray-50 p-6 rounded-xl border border-gray-200 mb-8 max-w-4xl mx-auto">
                    <h2 class="text-xl font-semibold mb-4 text-gray-600 border-b pb-2">Counselor Signature Block</h2>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div class="space-y-4">
                            <div>
                                <label for="counselorName" class="block text-sm font-medium text-gray-700 mb-1">Counselor’s Name</label>
                                <input type="text" id="counselorName" oninput="generateReport()" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition">
                            </div>
                            <div>
                                <label for="counselorCredentials" class="block text-sm font-medium text-gray-700 mb-1">Counselor’s Credentials</label>
                                <input type="text" id="counselorCredentials" oninput="generateReport()" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition" placeholder="e.g., CASAC-T">
                            </div>
                            <div>
                                <label for="counselorExtension" class="block text-sm font-medium text-gray-700 mb-1">Extension</label>
                                <input type="text" id="counselorExtension" oninput="generateReport()" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition">
                            </div>
                            <div>
                                <label for="counselorEmail" class="block text-sm font-medium text-gray-700 mb-1">Counselor’s E-Mail</label>
                                <input type="email" id="counselorEmail" oninput="generateReport()" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition">
                            </div>
                        </div>
                        <div class="space-y-4">
                            <div>
                                <label for="signatureUpload" class="block text-sm font-medium text-gray-700 mb-1">Upload Signature Image</label>
                                <input type="file" id="signatureUpload" accept="image/*" class="w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-lg file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100">
                                <img id="signaturePreview" src="" alt="Signature Preview" class="hidden mt-4 max-h-20 rounded-lg"/>
                            </div>
                            <div class="flex items-center space-x-4 pt-5">
                                <button onclick="saveSignature()" class="w-full bg-blue-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-blue-700 transition-colors shadow-md">Save Signature Info</button>
                                <button onclick="deleteSignature()" class="w-full bg-red-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-red-700 transition-colors shadow-md">Delete Saved Info</button>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Generated Report Output (Shared) -->
                <div id="outputSection" class="max-w-4xl mx-auto">
                    <h2 class="text-xl font-semibold mb-4 text-gray-600 border-b pb-2">Generated Report Text</h2>
                    <div class="bg-gray-50 p-4 rounded-xl border border-gray-200">
                        <textarea id="generatedText" rows="20" class="w-full p-4 border border-gray-300 rounded-lg bg-white focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition" aria-label="Generated report text for copying"></textarea>
                    </div>
                    <div class="flex items-center justify-center space-x-4 mt-6">
                        <button onclick="copyText()" class="bg-gray-700 text-white font-semibold py-2 px-6 rounded-lg hover:bg-gray-800 transition-colors shadow-md">Copy Text</button>
                        <button onclick="downloadPDF()" class="bg-purple-600 text-white font-semibold py-2 px-6 rounded-lg hover:bg-purple-700 transition-colors shadow-md">Download PDF</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
            <!-- Hidden div for PDF generation (Shared) -->
    <div id="pdf-content" class="hidden" style="width: 8.5in; height: 11in; background: white; color: black; font-size: 10pt; line-height: 1.5; box-sizing: border-box; position: relative;">
          <!-- PDF Header with logo always at top left -->
          <div id="pdf-header" style="position: absolute; top: 1in; left: 1in; width: 100%; height: 80px;">
               <img id="pdf-logo" src="" alt="Delphi Rise Logo" style="height: 80px;">
          </div>
          <!-- Vertically centered content area, with body and signature block sharing the same alignment/margins -->
          <div id="pdf-main-content" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; display: flex; flex-direction: column; justify-content: center; align-items: center; pointer-events: none;">
               <div style="max-width: 6.5in; width: 100%; pointer-events: auto;">
                    <div id="pdf-text-content" style="white-space: pre-wrap;"></div>
                    <div id="pdf-signature-area" style="margin-top: 1rem;">
                        <div>Sincerely,</div>
                        <img id="pdf-signature" src="" alt="Signature" style="max-height: 60px; margin-top: 0.5rem; display: none; background: transparent; padding: 0; margin: 0;"/>
                        <div id="pdf-signature-block" style="white-space: pre-wrap;"></div>
                    </div>
               </div>
          </div>
          <div id="pdf-footer" style="position: absolute; bottom: 1in; right: 1in; text-align: right; font-size: 8pt; color: #555; line-height: 1.2;">
               Treatment | Prevention | Care Management | Counseling<br>
               72 Hinchey Road, Rochester, NY 14624 | 585-467-2230<br>
               www.delphirise.org
          </div>
    </div>    <!-- Custom Notification/Toast -->
    <div id="notification" class="fixed bottom-5 right-5 bg-gray-800 text-white py-3 px-6 rounded-lg shadow-lg opacity-0 transform translate-y-2">
        <p id="notification-message"></p>
    </div>

    <script>
        // --- Custom Notification System ---
        function showNotification(message, isError = false) {
            const notification = document.getElementById('notification');
            const messageEl = document.getElementById('notification-message');
            
            messageEl.textContent = message;
            notification.className = `fixed bottom-5 right-5 text-white py-3 px-6 rounded-lg shadow-lg opacity-0 transform translate-y-2 ${isError ? 'bg-red-600' : 'bg-gray-800'}`;

            // Show notification
            setTimeout(() => {
                notification.classList.remove('opacity-0', 'translate-y-2');
                notification.classList.add('opacity-100', 'translate-y-0');
            }, 10);

            // Hide after 3 seconds
            setTimeout(() => {
                notification.classList.remove('opacity-100', 'translate-y-0');
                notification.classList.add('opacity-0', 'translate-y-2');
            }, 3000);
        }


        // --- Password Protection ---
        function setCookie(name, value, days) {
            let expires = "";
            if (days) {
                const date = new Date();
                date.setTime(date.getTime() + (days * 24 * 60 * 60 * 1000));
                expires = "; expires=" + date.toUTCString();
            }
            // Added SameSite=Lax for better iframe compatibility
            document.cookie = name + "=" + (value || "") + expires + "; path=/; SameSite=Lax";
        }

        function getCookie(name) {
            const nameEQ = name + "=";
            const ca = document.cookie.split(';');
            for (let i = 0; i < ca.length; i++) {
                let c = ca[i];
                while (c.charAt(0) === ' ') c = c.substring(1, c.length);
                if (c.indexOf(nameEQ) === 0) return c.substring(nameEQ.length, c.length);
            }
            return null;
        }

        function checkPassword() {
            const password = document.getElementById('password-input').value;
            const errorMessage = document.getElementById('error-message');
            // IMPORTANT: This is a simple MD5 hash for demonstration. 
            // For real applications, use a secure, server-side authentication method.
            // The password is "delphi".
            const correctPasswordHash = '0c9649d18dba98d8e1397fddf98ce03c';

            if (CryptoJS.MD5(password).toString() === correctPasswordHash) {
                document.getElementById('password-overlay').style.display = 'none';
                document.getElementById('main-content').style.display = 'block';
                setCookie('isAuthenticated', 'true', 7); // Cookie expires in 7 days
                initializeApp(); // Initialize app after successful login
            } else {
                errorMessage.style.display = 'block';
            }
        }

        // --- Main Application Logic ---

        // Data for DSM-5 Diagnosis Dropdown
        const dsm5Disorders = [
            "Alcohol Use Disorder", "Cannabis Use Disorder", "Phencyclidine Use Disorder", 
            "Other Hallucinogen Use Disorder", "Inhalant Use Disorder", "Opioid Use Disorder",
            "Sedative, Hypnotic, or Anxiolytic Use Disorder", "Stimulant Use Disorder", "Tobacco Use Disorder",
            "Other (or Unknown) Substance Use Disorder", "Gambling Disorder"
        ];
        let selectedDiagnoses = [];

        async function initializeApp() {
            const today = new Date();
            const yyyy = today.getFullYear();
            const mm = String(today.getMonth() + 1).padStart(2, '0');
            const dd = String(today.getDate()).padStart(2, '0');
            const todayString = `${yyyy}-${mm}-${dd}`;
            
            // Set today's date for all relevant fields
            document.getElementById('guLetterDate').value = todayString;
            document.getElementById('todaysDate').value = todayString;
            document.getElementById('eipTodaysDate').value = todayString;
            document.getElementById('reTodaysDate').value = todayString;
            document.getElementById('trTodaysDate').value = todayString;
            document.getElementById('disDischargeDate').value = todayString;
            document.getElementById('evStartDate').value = todayString;
            
            // Set the default closure date for the re-engagement letter
            setClosureDate();
            
            // Populate the diagnosis dropdown
            const dsm5Selector = document.getElementById('dsm5Selector');
            dsm5Disorders.forEach(disorder => {
                const option = document.createElement('option');
                option.value = disorder;
                option.textContent = disorder;
                dsm5Selector.appendChild(option);
            });

            // Convert logo to base64 to prevent PDF generation issues
            const logoUrl = 'https://therapytools.github.io/notes/logo.png';
            const base64Logo = await toDataURL(logoUrl);
            if (base64Logo !== logoUrl) {
                document.getElementById('visible-logo').src = base64Logo;
                document.getElementById('pdf-logo').src = base64Logo;
                document.getElementById('ev-preview-logo').src = base64Logo; 
            }

            loadSignature();
            handleTemplateChange();

            // Set initial state for Enrollment Verification interactive form
            toggleSection(document.getElementById('evAttOmit'), 'evAttendanceSection');
            toggleSection(document.getElementById('evToxPositiveOmit'), 'evToxPositiveContainer');
            toggleSection(document.getElementById('evToxNegativeOmit'), 'evToxNegativeContainer');
            toggleSection(document.getElementById('evMatOmit'), 'evMatSection');
        }

        window.onload = function() {
            if (getCookie('isAuthenticated') === 'true') {
                document.getElementById('password-overlay').style.display = 'none';
                document.getElementById('main-content').style.display = 'block';
                initializeApp();
            }
            // Add event listener for the Enter key on the password input
            document.getElementById('password-input').addEventListener('keypress', function(event) {
                if (event.key === 'Enter') {
                    event.preventDefault(); // Prevent form submission
                    checkPassword();
                }
            });
        };

        // Function to convert an image URL to a base64 string to avoid CORS issues with html2canvas
        async function toDataURL(url) {
            try {
                const response = await fetch(url);
                const blob = await response.blob();
                return new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    reader.onloadend = () => resolve(reader.result);
                    reader.onerror = reject;
                    reader.readAsDataURL(blob);
                });
            } catch (error) {
                console.error('Failed to convert image to base64:', error);
                return url;
            }
        }

        function handleTemplateChange() {
            const letterType = document.getElementById('letterType').value;
            const allFields = document.querySelectorAll('.form-section');
            allFields.forEach(field => field.style.display = 'none');

            const selectedFields = document.getElementById(letterType + 'Fields');
            if (selectedFields) {
                selectedFields.style.display = 'block';
            }
            // Make the output section visible for all letter types
            document.getElementById('outputSection').style.display = 'block';
            
            generateReport();
        }

        document.getElementById('signatureUpload').addEventListener('change', function(event) {
            const [file] = event.target.files;
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const preview = document.getElementById('signaturePreview');
                    preview.src = e.target.result;
                    preview.classList.remove('hidden');
                    generateReport(); // Regenerate report when image is added/changed
                };
                reader.readAsDataURL(file);
            }
        });

        function toggleRecipientName() {
            const recipientType = document.getElementById('recipientType').value;
            const recipientNameContainer = document.getElementById('recipientNameContainer');
            recipientNameContainer.style.display = recipientType === 'dear' ? 'block' : 'none';
        }

        function togglePositiveSubstance() {
            const toxResult = document.querySelector('input[name="toxResult"]:checked').value;
            const positiveContainer = document.getElementById('positiveSubstanceContainer');
            positiveContainer.style.display = toxResult === 'positive' ? 'block' : 'none';
        }

        function toggleTrPositiveSubstance() {
            const toxResult = document.querySelector('input[name="trToxResult"]:checked').value;
            const positiveContainer = document.getElementById('trPositiveSubstanceContainer');
            positiveContainer.style.display = toxResult === 'positive' ? 'block' : 'none';
        }
        
        function toggleOasasOther() {
            const oasasResult = document.getElementById('disOasasReasonSelect').value;
            const otherContainer = document.getElementById('oasasOtherContainer');
            otherContainer.style.display = oasasResult === 'Other' ? 'block' : 'none';
        }

        function toggleSection(checkbox, sectionId) {
            const section = document.getElementById(sectionId);
            if (!section) return;

            const inputs = section.querySelectorAll('input, select');
            const isOmitted = checkbox.checked;

            if (isOmitted) {
                section.classList.add('disabled');
            } else {
                section.classList.remove('disabled');
            }

            inputs.forEach(input => {
                if (input !== checkbox) { // Don't disable the controller checkbox itself
                    input.disabled = isOmitted;
                }
            });
        }


        function saveSignature() {
            const signaturePreview = document.getElementById('signaturePreview');
            const signatureData = {
                name: document.getElementById('counselorName').value,
                credentials: document.getElementById('counselorCredentials').value,
                extension: document.getElementById('counselorExtension').value,
                email: document.getElementById('counselorEmail').value,
                imgSrc: signaturePreview.src.startsWith('data:image') ? signaturePreview.src : null
            };
            // NOTE: localStorage may be restricted in some iframe contexts.
            localStorage.setItem('delphiRiseSignatureInfo', JSON.stringify(signatureData));
            showNotification('Signature information saved!');
        }

        function loadSignature() {
            // NOTE: localStorage may be restricted in some iframe contexts.
            const savedData = localStorage.getItem('delphiRiseSignatureInfo');
            if (savedData) {
                const signatureData = JSON.parse(savedData);
                document.getElementById('counselorName').value = signatureData.name || '';
                document.getElementById('counselorCredentials').value = signatureData.credentials || '';
                document.getElementById('counselorExtension').value = signatureData.extension || '';
                document.getElementById('counselorEmail').value = signatureData.email || '';
                if (signatureData.imgSrc) {
                    const signaturePreview = document.getElementById('signaturePreview');
                    signaturePreview.src = signatureData.imgSrc;
                    signaturePreview.classList.remove('hidden');
                }
            }
        }

        function deleteSignature() {
            localStorage.removeItem('delphiRiseSignatureInfo');
            document.getElementById('counselorName').value = '';
            document.getElementById('counselorCredentials').value = '';
            document.getElementById('counselorExtension').value = '';
            document.getElementById('counselorEmail').value = '';
            const signaturePreview = document.getElementById('signaturePreview');
            signaturePreview.src = '';
            signaturePreview.classList.add('hidden');
            document.getElementById('signatureUpload').value = null;
            showNotification('Saved signature information deleted.');
            generateReport();
        }

        function setClosureDate() {
            const today = new Date();
            let futureDate = new Date();
            futureDate.setDate(today.getDate() + 7);

            const dayOfWeek = futureDate.getDay(); // Sunday = 0, Friday = 5
            const daysUntilFriday = (5 - dayOfWeek + 7) % 7;
            futureDate.setDate(futureDate.getDate() + daysUntilFriday);

            const yyyy = futureDate.getFullYear();
            const mm = String(futureDate.getMonth() + 1).padStart(2, '0');
            const dd = String(futureDate.getDate()).padStart(2, '0');
            const closureDateString = `${yyyy}-${mm}-${dd}`;
            document.getElementById('closureDate').value = closureDateString;
        }
        
        // --- Diagnosis Management ---
        function addDiagnosis() {
            const selector = document.getElementById('dsm5Selector');
            const diagnosis = selector.value;
            if (diagnosis && !selectedDiagnoses.includes(diagnosis)) {
                selectedDiagnoses.push(diagnosis);
                renderDiagnoses();
                generateReport();
            }
        }

        function removeDiagnosis(index) {
            selectedDiagnoses.splice(index, 1);
            renderDiagnoses();
            generateReport();
        }

        function renderDiagnoses() {
            const container = document.getElementById('diagnosesContainer');
            container.innerHTML = '';
            selectedDiagnoses.forEach((diagnosis, index) => {
                const div = document.createElement('div');
                div.className = 'flex items-center justify-between bg-blue-100 p-2 rounded-lg';
                div.innerHTML = `
                    <span class="text-blue-800">${diagnosis}</span>
                    <button onclick="removeDiagnosis(${index})" class="text-red-500 hover:text-red-700 font-bold text-lg">&times;</button>
                `;
                container.appendChild(div);
            });
        }

        function formatDiagnoses(diagnoses) {
            if (diagnoses.length === 0) return '[diagnosis]';
            if (diagnoses.length === 1) return diagnoses[0];
            if (diagnoses.length === 2) return diagnoses.join(' and ');
            return diagnoses.slice(0, -1).join(', ') + ', and ' + diagnoses.slice(-1);
        }

        function generateReport() {
            const letterType = document.getElementById('letterType').value;
            switch (letterType) {
                case 'generalUse':
                    generateGeneralUseReport();
                    break;
                case 'treatmentNotRec':
                    generateTreatmentNotRecReport();
                    break;
                case 'evalInProgress':
                    generateEvalInProgressReport();
                    break;
                case 'reEngagement':
                    generateReEngagementReport();
                    break;
                case 'treatmentRec':
                    generateTreatmentRecReport();
                    break;
                case 'discharge':
                    generateDischargeReport();
                    break;
                case 'enrollmentVerification':
                    generateEnrollmentVerificationReport();
                    break;
            }
        }
        
        // --- Report Generation Functions ---
        
        const formatDate = (dateString, placeholder) => {
            if (!dateString) return `[${placeholder}]`;
            const date = new Date(dateString);
            if (isNaN(date.getTime())) return `[${placeholder}]`;
            const adjustedDate = new Date(date.getUTCFullYear(), date.getUTCMonth(), date.getUTCDate());
            return adjustedDate.toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' });
        };
        
        function generateGeneralUseReport() {
            const letterDate = formatDate(document.getElementById('guLetterDate').value, "Today's Date");
            const subject = document.getElementById('guSubject').value || '[Subject]';
            const body = document.getElementById('guBody').value || '[Letter body]';
            
            const mainParagraphs = [
                letterDate,
                `Subject: ${subject}`,
                body
            ];
            
            const signatureBlock = getSignatureBlock();
            const fullText = mainParagraphs.join('\n\n') + `\n\n\n${signatureBlock}`;
            document.getElementById('generatedText').value = fullText;
        }
        
        function generateDischargeReport() {
            const dischargeDate = formatDate(document.getElementById('disDischargeDate').value, "Today's Date");
            const clientFirstName = document.getElementById('disClientFirstName').value || '[First Name]';
            const clientLastName = document.getElementById('disClientLastName').value || '[Last Name]';
            const clientFullName = `${clientFirstName} ${clientLastName}`.trim();
            const clientDOB = formatDate(document.getElementById('disClientDOB').value, "Date of Birth");
            const admissionDate = formatDate(document.getElementById('disAdmissionDate').value, "Admission Date");
            const numSessions = document.getElementById('disNumSessions').value || '[Number of Sessions]';
            const goalAchievement = document.getElementById('disGoalAchievement').value;

            let oasasReasonText = document.getElementById('disOasasReasonSelect').value;
            let finalOasasSentence;

            if (oasasReasonText === 'Other') {
                const otherText = document.getElementById('disOasasOtherText').value || '______________________________';
                finalOasasSentence = `Client was discharged for another reason: ${otherText}.`;
            } else {
                finalOasasSentence = `Client ${oasasReasonText}.`;
            }

            const mainParagraphs = [
                dischargeDate,
                `To Whom It May Concern,`,
                `This letter is to confirm that ${clientFullName}, date of birth ${clientDOB}, was admitted to Delphi Rise Outpatient on ${admissionDate} and discharged on ${dischargeDate}.`,
                `During treatment, ${clientFirstName} attended a total of ${numSessions} sessions. At the time of discharge, ${clientFirstName} ${goalAchievement} the treatment goals established at the start of services.`,
                `In accordance with OASAS reporting requirements, this discharge is recorded as follows: ${finalOasasSentence}`,
                `If further information is required, please contact me using the information provided below.`
            ];
            
            const signatureBlock = getSignatureBlock();
            const fullText = mainParagraphs.join('\n\n') + `\n\nSincerely,\n\n\n\n${signatureBlock}`;
            document.getElementById('generatedText').value = fullText;
        }

        function generateEnrollmentVerificationReport() {
            // Update live preview elements within the form
            document.getElementById('ev-todays-date-display').textContent = formatDate(new Date().toISOString().slice(0,10), "Today's Date");
            document.getElementById('ev-signature-block-preview').textContent = getSignatureBlock();

            // Build the final text for copy/PDF
            const clientFirstName = document.getElementById('evClientFirstName').value || '[Client First Name]';
            const clientLastName = document.getElementById('evClientLastName').value || '[Client Last Name]';
            const clientFullName = `${clientFirstName} ${clientLastName}`.trim();
            const clientDOB = formatDate(document.getElementById('evClientDOB').value, "DOB");
            const startDate = formatDate(document.getElementById('evStartDate').value, "Start Date");

            const bodyParagraphs = [
                document.getElementById('ev-todays-date-display').textContent,
                `To Whom It May Concern,`,
                `This letter is to verify that ${clientFullName}, DOB ${clientDOB}, is currently enrolled in services with Delphi Rise. Services began on ${startDate}.`
            ];

            // Attendance
            if (!document.getElementById('evAttOmit').checked) {
                const attendance = document.getElementById('evAttendance').value;
                bodyParagraphs.push(`The client has been attending services on an ${attendance} basis.`);
            }

            // Positive Toxicology
            if (!document.getElementById('evToxPositiveOmit').checked) {
                const positiveDate = document.getElementById('evToxPositiveDate').value;
                if (positiveDate) {
                    const substance = document.getElementById('evToxPositiveSubstance').value || '[Substance]';
                    bodyParagraphs.push(`The most recent positive toxicology screen was on ${formatDate(positiveDate, 'Date')} for ${substance}.`);
                }
            }
            // Negative Toxicology
            if (!document.getElementById('evToxNegativeOmit').checked) {
                const negativeDate = document.getElementById('evToxNegativeDate').value;
                if (negativeDate) {
                    bodyParagraphs.push(`All toxicology screens have been negative since ${formatDate(negativeDate, 'Date')}.`);
                }
            }
            
            // MAT
            if (!document.getElementById('evMatOmit').checked) {
                bodyParagraphs.push(`The client is currently participating in our medication-assisted treatment (MAT) program.`);
            }

            bodyParagraphs.push(
                `Delphi Rise provides a range of recovery and supportive services designed to assist individuals in achieving and maintaining recovery, addressing substance use concerns, and supporting overall well-being. This verification is provided to confirm current enrollment and participation in services only.`,
                `Should you have any additional questions or require further details, please do not hesitate to contact our office.`
            );

            const signatureBlock = getSignatureBlock();
            const fullText = bodyParagraphs.join('\n\n') + `\n\nSincerely,\n\n\n\n${signatureBlock}`;
            
            // The generatedText textarea is now primarily for the PDF/Copy functions, not for display.
            document.getElementById('generatedText').value = fullText;
        }

        function generateTreatmentRecReport() {
            const clientFirstName = document.getElementById('trClientFirstName').value || '[Client’s First Name]';
            const clientLastName = document.getElementById('trClientLastName').value || '[Client’s Last Name]';
            const clientFullName = `${clientFirstName} ${clientLastName}`.trim();
            const todaysDate = formatDate(document.getElementById('trTodaysDate').value, "DATE");
            const evaluationDate = formatDate(document.getElementById('trEvaluationDate').value, "Date of Evaluation");
            const diagnosisText = formatDiagnoses(selectedDiagnoses);
            const levelOfCare = document.getElementById('trLevelOfCare').value || '[level of care]';
            const toxScreenDate = formatDate(document.getElementById('trToxScreenDate').value, "Toxicology Screen Date");
            const toxResult = document.querySelector('input[name="trToxResult"]:checked').value;
            let toxSentence = `${clientFirstName}’s toxicology screen, which was collected on ${toxScreenDate}, was ${toxResult}`;
            if (toxResult === 'positive') {
                const substances = document.getElementById('trPositiveSubstance').value || '[substances]';
                toxSentence += ` for ${substances}.`;
            } else {
                toxSentence += '.';
            }

            const mainParagraphs = [
                `Re: Evaluation Results for ${clientFullName}`,
                `Date: ${todaysDate}`,
                `On ${evaluationDate}, ${clientFullName} completed a substance and alcohol use disorder evaluation at Delphi Rise. The evaluation included gathering a history of substance and alcohol use, collateral interviews, a toxicology screen, and a brief screen to identify potential mental health concerns.`,
                `Based on this comprehensive clinical evaluation, ${clientFirstName} has been diagnosed with ${diagnosisText} and is recommended for ${levelOfCare} treatment. ${toxSentence}`,
                `Delphi Rise is committed to providing personalized, evidence-based treatment to help clients achieve long-term recovery. We believe that ${clientFirstName} would benefit from ongoing engagement in the recommended services and a structured, supportive environment to address the challenges of substance and alcohol use.`,
                `Please feel free to contact us if you require any additional information or clarification regarding this evaluation or the services we provide.`
            ];

            const signatureBlock = getSignatureBlock();
            const fullText = mainParagraphs.join('\n\n') + `\n\nSincerely,\n\n\n\n${signatureBlock}`;
            document.getElementById('generatedText').value = fullText;
        }

        function generateTreatmentNotRecReport() {
            const clientFirstName = document.getElementById('clientFirstName').value || '[Client’s First Name]';
            const clientLastName = document.getElementById('clientLastName').value || '[Client’s Last Name]';
            const clientFullName = `${clientFirstName} ${clientLastName}`.trim() || '[Client’s Full Name]';
            const todaysDate = formatDate(document.getElementById('todaysDate').value, "Date of Report");
            const recipientType = document.getElementById('recipientType').value;
            let recipientSalutation = "To Whom It May Concern,";
            if (recipientType === 'dear') {
                const name = document.getElementById('recipientName').value || '_____';
                recipientSalutation = `Dear ${name},`;
            }
            const evaluationDate = formatDate(document.getElementById('evaluationDate').value, 'Evaluation Date');
            const toxScreenDate = formatDate(document.getElementById('toxScreenDate').value, 'Tox Screen Date');
            const includeInterviews = document.getElementById('includeInterviews').checked;
            let assessmentParts = ["a thorough review of " + clientFirstName + "’s history", "a toxicology screen"];
            if (includeInterviews) {
                assessmentParts.splice(1, 0, 'personal interviews');
            }
            let assessmentString = assessmentParts.length === 2 ? assessmentParts.join(' and ') : assessmentParts.slice(0, -1).join(', ') + ', and ' + assessmentParts.slice(-1);
            const firstP = `I am writing to provide an update regarding ${clientFullName}, who was evaluated at Delphi Rise on ${evaluationDate} for substance and alcohol use disorders. As part of our comprehensive assessment, a detailed evaluation was conducted, including ${assessmentString}.`;
            const toxResult = document.querySelector('input[name="toxResult"]:checked').value;
            let toxParagraph = '';
            if (toxResult === 'negative') {
                toxParagraph = `The toxicology screen was collected on ${toxScreenDate} and was negative for all substances and alcohol.`;
            } else {
                const substance = document.getElementById('positiveSubstance').value || '_______';
                toxParagraph = `The toxicology screen was collected on ${toxScreenDate} and was positive for ${substance}.`;
            }
            const conclusionSource = includeInterviews ? 'our clinical evaluation and interviews' : 'our clinical evaluation';
            const conclusionParagraph = `Additionally, based on ${conclusionSource}, there is no current evidence suggesting a substance or alcohol use disorder at this time.`;
            
            const mainParagraphs = [
                `Subject: Evaluation Report for ${clientFullName}`,
                `Date: ${todaysDate}`,
                recipientSalutation,
                firstP,
                `${toxParagraph} ${conclusionParagraph}`,
                `Given these findings, we do not recommend ${clientFirstName} for further treatment or intervention related to substance use at this moment. Should there be any future concerns or changes in ${clientFirstName}’s status, we would be prepared to reassess and provide further recommendations as needed.`,
                `Please let us know if there are any additional requirements or if further information is needed. We are committed to supporting ${clientFirstName}’s ongoing progress and well-being in any way we can.`
            ];
            
            const signatureBlock = getSignatureBlock();
            const fullText = mainParagraphs.join('\n\n') + `\n\nSincerely,\n\n\n\n${signatureBlock}`;
            document.getElementById('generatedText').value = fullText;
        }

        function generateEvalInProgressReport() {
            const formatTime = (timeString, placeholder) => {
                if (!timeString) return `[${placeholder}]`;
                const [hours, minutes] = timeString.split(':');
                const date = new Date();
                date.setHours(hours, minutes);
                return date.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit', hour12: true });
            };
            const clientFirstName = document.getElementById('eipClientFirstName').value || '[Client’s First Name]';
            const clientLastName = document.getElementById('eipClientLastName').value || '[Client’s Last Name]';
            const clientFullName = `${clientFirstName} ${clientLastName}`.trim();
            const todaysDate = formatDate(document.getElementById('eipTodaysDate').value, "Today's Date");
            const evaluationDate = formatDate(document.getElementById('eipEvaluationDate').value, 'Evaluation Date');
            const evaluationTime = formatTime(document.getElementById('eipEvaluationTime').value, 'Evaluation Time');
            
            const mainParagraphs = [
                `Re: Evaluation Status for ${clientFullName}`,
                `Date: ${todaysDate}`,
                `To Whom it May Concern;`,
                `I am writing to inform you of the current status of the substance use disorder evaluation for ${clientFullName}, which took place on ${evaluationDate} at ${evaluationTime}.`,
                `${clientFirstName} attended the evaluation as scheduled. The assessment has been conducted; however, the results are currently pending the completion of a toxicology screen, which is necessary for a comprehensive evaluation.`,
                `We will provide the final evaluation results as soon as the toxicology screen results are available. Please feel free to contact our office if you need any additional information or if there are any specific forms or documentation required in the interim.`,
                `Thank you for your attention to this matter.`
            ];
            
            const signatureBlock = getSignatureBlock();
            const fullText = mainParagraphs.join('\n\n') + `\n\nSincerely,\n\n\n\n${signatureBlock}`;
            document.getElementById('generatedText').value = fullText;
        }
        
        function generateReEngagementReport() {
            const clientFirstName = document.getElementById('reClientFirstName').value || '[FIRST NAME]';
            const clientLastName = document.getElementById('reClientLastName').value || '[LAST NAME]';
            const clientFullName = `${clientFirstName} ${clientLastName}`.trim();
            const address = document.getElementById('reClientAddress').value || '[ADDRESS]';
            const cityStateZip = document.getElementById('reClientCityStateZip').value || '[CITY], [STATE] [ZIP]';
            const todaysDateFormatted = formatDate(document.getElementById('reTodaysDate').value, "TODAY'S DATE");
            const closureDate = formatDate(document.getElementById('closureDate').value, "CLOSURE DATE");

            // Calculate days since last service
            const lastServiceDateVal = document.getElementById('lastServiceDate').value;
            const reTodaysDateVal = document.getElementById('reTodaysDate').value;
            let daysDifference = '[XX]';
            if (lastServiceDateVal && reTodaysDateVal) {
                const lastServiceDate = new Date(lastServiceDateVal);
                const reTodaysDate = new Date(reTodaysDateVal);
                if (!isNaN(lastServiceDate.getTime()) && !isNaN(reTodaysDate.getTime())) {
                    const differenceInTime = reTodaysDate.getTime() - lastServiceDate.getTime();
                    const differenceInDays = Math.round(differenceInTime / (1000 * 3600 * 24));
                    daysDifference = differenceInDays >= 0 ? differenceInDays : '[XX]';
                }
            }

            const addressBlock = [clientFullName, address, cityStateZip].join('\n');
            
            const bodyParagraphs = [
                todaysDateFormatted,
                `Dear ${clientFirstName},`,
                `I hope you’re doing well. It has been ${daysDifference} days since your last service with us, and in accordance with OASAS regulations, we are required to close your chart if there is no further engagement. However, we want to ensure you continue receiving the support and services that can help you in your recovery.`,
                `If you would like to remain active with Delphi Rise and continue receiving services, we ask that you schedule an appointment by ${closureDate}. You can do so by calling us at 585-467-2230.`,
                `If there are any barriers preventing you from scheduling, please reach out—we are happy to discuss ways to help. We value your well-being and hope to continue supporting you on your journey.`
            ];

            const signatureBlock = getSignatureBlock();
            const fullText = bodyParagraphs.join('\n\n') + `\n\nSincerely,\n\n\n\n${signatureBlock}`;
            document.getElementById('generatedText').value = `${addressBlock}\n\n${fullText}`;
        }

        function getSignatureBlock() {
            const counselorName = document.getElementById('counselorName').value || '[Counselor’s Name]';
            const counselorCredentials = document.getElementById('counselorCredentials').value;
            const counselorExtension = document.getElementById('counselorExtension').value || '[Extension]';
            const counselorEmail = document.getElementById('counselorEmail').value || '[Counselor’s E-Mail]';
            
            const nameLine = counselorCredentials ? `${counselorName}, ${counselorCredentials}` : counselorName;

            return `${nameLine}\nOutpatient Counselor\nDelphi Rise\n72 Hinchey Road\nRochester, NY 14624\n585-467-2230 ext. ${counselorExtension}\n${counselorEmail}`;
        }

        function copyText() {
            // Ensure the text is generated before copying, especially for EV letter
            generateReport();
            const textarea = document.getElementById('generatedText');
            textarea.select();
            textarea.setSelectionRange(0, 99999);
            try {
                // Use execCommand as a fallback for iframe environments where Clipboard API might be restricted.
                document.execCommand('copy');
                showNotification('Report text copied to clipboard!');
            } catch (err) {
                showNotification('Failed to copy text.', true);
                console.error('Copy to clipboard failed:', err);
            }
        }

        async function processSignatureImage(dataUrl) {
            // Create a canvas to process the signature image and remove grey backgrounds
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            const img = new Image();
            
            return new Promise((resolve) => {
                img.onload = function() {
                    canvas.width = img.width;
                    canvas.height = img.height;
                    
                    // Draw image
                    ctx.drawImage(img, 0, 0);
                    
                    // Get image data
                    const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
                    const data = imageData.data;
                    
                    // Remove grey backgrounds by making them transparent
                    // Grey values are typically similar in R, G, B channels
                    for (let i = 0; i < data.length; i += 4) {
                        const r = data[i];
                        const g = data[i + 1];
                        const b = data[i + 2];
                        const a = data[i + 3];
                        
                        // Check if pixel is light grey/white (potential background)
                        // If R, G, B are very similar and light (> 200), make transparent
                        const max = Math.max(r, g, b);
                        const min = Math.min(r, g, b);
                        const diff = max - min;
                        
                        if (diff < 30 && max > 200 && a > 200) {
                            // This is a light grey/white pixel, make it transparent
                            data[i + 3] = 0;
                        }
                    }
                    
                    ctx.putImageData(imageData, 0, 0);
                    resolve(canvas.toDataURL('image/png'));
                };
                
                img.src = dataUrl;
            });
        }

        async function downloadPDF() {
            // Store the current text value BEFORE calling generateReport to preserve manual edits
            const currentReportText = document.getElementById('generatedText').value;
            const { jsPDF } = window.jspdf;
            const signaturePreview = document.getElementById('signaturePreview');
            const hasSignatureImage = signaturePreview.src && signaturePreview.src.startsWith('data:image') && !signaturePreview.classList.contains('hidden');

            const pdfTextContent = document.getElementById('pdf-text-content');
            const pdfSignatureImg = document.getElementById('pdf-signature');
            const pdfSignatureBlock = document.getElementById('pdf-signature-block');
            const pdfContentDiv = document.getElementById('pdf-content');

            // Find the last occurrence of "Sincerely," to split the main body from the signature part.
            const sincerelyIndex = currentReportText.lastIndexOf('Sincerely,');
            const mainBody = (sincerelyIndex !== -1) ? currentReportText.substring(0, sincerelyIndex).trim() : currentReportText;
            pdfTextContent.innerText = mainBody;

            // Handle the signature block based on whether an image is present
            if (hasSignatureImage) {
                // Process the signature image to remove any background before adding to PDF
                const processedSignatureData = await processSignatureImage(signaturePreview.src);
                pdfSignatureImg.src = processedSignatureData;
                pdfSignatureImg.style.display = 'block';
                // If there is an image, the text block appears directly below it with no extra spacing.
                pdfSignatureBlock.innerText = getSignatureBlock();
            } else {
                pdfSignatureImg.src = "";
                pdfSignatureImg.style.display = 'none';
                // If there is NO image, add three line breaks before the text block for manual signing space.
                pdfSignatureBlock.innerText = `\n\n\n${getSignatureBlock()}`;
            }

            pdfContentDiv.classList.remove('hidden');
            pdfContentDiv.style.position = 'absolute';
            pdfContentDiv.style.left = '-9999px';
            // Use lower scale to avoid compression artifacts, then convert with lossless PNG
            const canvas = await html2canvas(pdfContentDiv, { scale: 2, useCORS: true, backgroundColor: null, logging: false, allowTaint: true });
            pdfContentDiv.classList.add('hidden');
            pdfContentDiv.style.position = '';
            pdfContentDiv.style.left = '';
            const imgData = canvas.toDataURL('image/png');
            // Create PDF without compression to preserve image quality and prevent grey artifacts
            const pdf = new jsPDF({ orientation: 'portrait', unit: 'in', format: 'letter', compress: false });
            const imgProps = pdf.getImageProperties(imgData);
            const pdfWidth = pdf.internal.pageSize.getWidth();
            const pdfHeight = (imgProps.height * pdfWidth) / imgProps.width;
            pdf.addImage(imgData, 'PNG', 0, 0, pdfWidth, pdfHeight);
            
            const letterType = document.getElementById('letterType').value;
            let clientFirstName = 'Client';
            let clientLastName = 'Report';

            switch(letterType) {
                case 'generalUse':
                    clientFirstName = document.getElementById('guSubject').value || 'General';
                    clientLastName = 'Letter';
                    break;
                case 'treatmentNotRec':
                    clientFirstName = document.getElementById('clientFirstName').value;
                    clientLastName = document.getElementById('clientLastName').value;
                    break;
                case 'evalInProgress':
                    clientFirstName = document.getElementById('eipClientFirstName').value;
                    clientLastName = document.getElementById('eipClientLastName').value;
                    break;
                case 'reEngagement':
                    clientFirstName = document.getElementById('reClientFirstName').value;
                    clientLastName = document.getElementById('reClientLastName').value;
                    break;
                case 'treatmentRec':
                    clientFirstName = document.getElementById('trClientFirstName').value;
                    clientLastName = document.getElementById('trClientLastName').value;
                    break;
                case 'discharge':
                    clientFirstName = document.getElementById('disClientFirstName').value;
                    clientLastName = document.getElementById('disClientLastName').value;
                    break;
                case 'enrollmentVerification':
                    clientFirstName = document.getElementById('evClientFirstName').value;
                    clientLastName = document.getElementById('evClientLastName').value;
                    break;
            }
            const clientName = `${clientFirstName} ${clientLastName}`.trim() || 'report';
            pdf.save(`${clientName.replace(/\s/g, '_')}_Report.pdf`);
        }
    </script>
</body>
</html>

