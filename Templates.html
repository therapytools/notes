<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Template-Based Notes</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            line-height: 1.6;
            background-color: #f4f7f9;
            color: #333;
            margin: 0;
            padding: 20px;
        }
        .container {
            max-width: 800px;
            margin: 0 auto;
            background-color: #ffffff;
            padding: 25px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
        }
        h1, h2, h3 {
            color: #2c3e50;
        }
        h2 {
            border-bottom: 2px solid #e0e0e0;
            padding-bottom: 10px;
        }
        label {
            display: block;
            font-weight: bold;
            margin-top: 15px;
            margin-bottom: 5px;
        }
        select, textarea, input[type="text"], input[type="date"] {
            width: 100%;
            padding: 10px;
            border-radius: 4px;
            border: 1px solid #ccc;
            font-size: 16px;
            box-sizing: border-box;
            margin: 10px 0;
            transition: border-color 0.2s;
        }
        select[multiple] {
            height: auto;
            padding: 10px;
        }
        select:focus, textarea:focus, input:focus {
            outline: none;
            border-color: #007bff;
            box-shadow: 0 0 5px rgba(0, 123, 255, 0.25);
        }
        textarea {
            resize: vertical;
            min-height: 100px;
            overflow-y: hidden;
        }
        optgroup {
            font-weight: bold;
            font-style: normal;
            background-color: #f0f0f0;
            color: #000;
        }
        option {
            padding: 5px 15px;
        }
        .note-container p, .note-container div {
            margin: 0;
            padding: 0;
        }
        .dynamic-row {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 5px;
        }
        .dynamic-row select, .dynamic-row input {
            flex-grow: 1;
            margin: 0;
        }
        .add-btn, .remove-btn {
            flex-shrink: 0;
            width: 38px;
            height: 38px;
            font-size: 20px;
            font-weight: bold;
            border-radius: 50%;
            border: 1px solid #ccc;
            cursor: pointer;
            display: flex;
            justify-content: center;
            align-items: center;
            transition: background-color 0.2s, border-color 0.2s;
        }
        .add-btn {
            background-color: #28a745;
            color: white;
            border-color: #218838;
        }
        .add-btn:hover {
            background-color: #218838;
        }
        .remove-btn {
            background-color: #dc3545;
            color: white;
            border-color: #c82333;
        }
        .remove-btn:hover {
            background-color: #c82333;
        }

        .checkbox-container {
            display: flex;
            align-items: flex-start;
            margin: 15px 0;
            background-color: #e9f5ff;
            padding: 12px;
            border-radius: 5px;
            border: 1px solid #bde0ff;
        }
        .checkbox-container input[type="checkbox"] {
            margin-right: 12px;
            margin-top: 5px;
            flex-shrink: 0;
            width: 18px;
            height: 18px;
        }
        .checkbox-container input[type="checkbox"]:disabled + label {
            color: #999;
        }
        .checkbox-container label, .scenario-label-text {
            margin: 0;
            font-weight: normal;
            line-height: 1.5;
        }
        .scenarios-section {
            margin-top: 20px;
            padding-top: 15px;
            border-top: 1px solid #e0e0e0;
        }
        .scenario-group {
            margin-bottom: 15px;
            padding-left: 20px; /* This indents the scenario groups */
        }
        .scenario-label {
            font-weight: bold;
            margin-bottom: 5px;
        }
        .info-box {
            background-color: #f8f9fa;
            border: 1px solid #e0e0e0;
            padding: 15px;
            margin-top: 5px;
        }
        .copy-area-container {
            margin-top: 30px;
        }
        #final-note-copy {
            background-color: #fdfdff;
            min-height: 200px;
            color: #333;
            border: 1px solid #ccc;
        }
        .copy-button, .mse-button {
            display: block;
            width: 100%;
            padding: 12px;
            font-size: 16px;
            font-weight: bold;
            color: #fff;
            background-color: #28a745;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            margin-top: 10px;
            transition: background-color 0.2s;
        }
        .copy-button:hover, .mse-button:hover {
            background-color: #218838;
        }
        .copy-button:active, .mse-button:active {
            background-color: #1e7e34;
        }
        .hidden {
                display: none !important;
        }
        .inline-form-element {
            display: inline-block;
            width: auto;
            min-width: 150px;
            margin: 0 5px;
            vertical-align: baseline;
        }
        .telehealth-text {
            line-height: 2.5;
        }
        .injection-field-group {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 10px 20px;
            align-items: center;
        }
        .injection-field-group label {
            margin: 0;
            font-weight: normal;
        }
        .injection-field-group input {
            margin: 0;
        }
        /* Styles for merged form */
        .radio-group label {
            font-weight: normal;
            display: inline-block;
            margin-right: 15px;
            margin-bottom: 5px;
        }
        .radio-group input[type="radio"] {
            margin-right: 8px;
            vertical-align: middle;
        }
        .conditional {
            /* display: none; <-- REMOVED THIS CONFLICTING STYLE */
            padding-left: 25px;
            margin-top: 15px;
            border-left: 3px solid #007bff;
        }
        .ouds-substance-grid, .auds-substance-grid {
            display: grid;
            grid-template-columns: 2fr 1fr 1fr;
            gap: 10px;
            align-items: center;
            margin-bottom: 10px;
        }
        .ouds-substance-grid label, .auds-substance-grid label {
            margin: 0;
            font-weight: normal;
        }
        .ouds-substance-grid input, .auds-substance-grid input {
            margin: 0;
        }
        /* Updated styling for ouds-inline-label to handle short textboxes */
        .ouds-inline-label, .auds-inline-label {
            display: grid; /* Use grid for alignment */
            grid-template-columns: 1fr 1fr; /* Create two even columns */
            align-items: start; /* Align items to the top for wrapped labels */
            gap: 20px; /* Add more gap for even columns */
            margin-top: 10px;
            margin-bottom: 10px;
        }
        .ouds-inline-label label, .auds-inline-label label {
            margin: 0;
            font-weight: bold; /* Keep labels bold */
        }
        .ouds-inline-label input[type="text"],
        .ouds-inline-label input[type="date"],
        .auds-inline-label input[type="text"],
        .auds-inline-label input[type="date"] {
            margin: 0;
            flex-grow: 1; /* Allow input to grow */
        }
        .ouds-inline-label textarea, .auds-inline-label textarea { /* Textareas should still take full width below label */
            grid-column: 1 / -1; /* Make textarea span all columns */
            margin: 0;
            flex-grow: 1;
        }
        .ouds-inline-label .radio-group, .auds-inline-label .radio-group {
            display: flex;
            gap: 15px;
            margin: 0;
            grid-column: 2; /* Align radio group to the right column */
            justify-content: flex-start;
        }
        /* Special case for Chief Complaint to remove input field entirely */
        #opioid-use-disorder-short-container #ouds-chief-complaint-display-label,
        #alcohol-use-disorder-short-container #auds-chief-complaint-display-label {
            grid-column: 1 / -1; /* Make the label span full width */
            margin-bottom: 10px;
        }
        /* New styles for aligned items in Plan and Time Statement */
        .ouds-aligned-item, .auds-aligned-item {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            align-items: center;
            margin: 5px 0;
        }
        
        .ouds-aligned-item > span,
        .ouds-aligned-item > label:first-child,
        .auds-aligned-item > span,
        .auds-aligned-item > label:first-child {
            display: flex;
            align-items: center;
            grid-column: 1 / 2;
        }
        
        .ouds-aligned-item > input[type="text"],
        .auds-aligned-item > input[type="text"] {
            grid-column: 2 / 3;
            margin: 0;
        }
        
        .ouds-aligned-item input[type="checkbox"],
        .auds-aligned-item input[type="checkbox"] {
            margin-right: 12px;
            margin-top: 0;
            flex-shrink: 0;
            width: 18px;
            height: 18px;
        }
        .ouds-aligned-item label, .auds-aligned-item label {
            font-weight: normal;
            margin: 0;
        }

        /* Styles for MSE Modal */
        .modal {
            display: none; 
            position: fixed; 
            z-index: 1000; 
            left: 0;
            top: 0;
            width: 100%; 
            height: 100%; 
            overflow: auto; 
            background-color: rgba(0,0,0,0.4); 
        }
        .modal-content {
            background-color: #fefefe;
            margin: 5% auto; 
            padding: 20px;
            border: 1px solid #888;
            width: 80%;
            max-width: 900px;
            border-radius: 8px;
            position: relative;
        }
        .close-btn {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            position: absolute;
            top: 10px;
            right: 25px;
        }
        .close-btn:hover,
        .close-btn:focus {
            color: black;
            text-decoration: none;
            cursor: pointer;
        }

        /* Styles for MSE form from user */
        .mse-form-container {
            background-color: #ffffff;
            padding: .25rem;
            border-radius: 0.25rem;
        }
        .mse-category {
            display: flex;
            flex-wrap: wrap;
            justify-content: flex-start; /* Align items to the start */
            gap: .25rem; /* Add some gap between items */
        }
        .mse-category label {
             display: inline-flex; /* Use flex to align checkbox and text */
            align-items: center;
            flex-grow: .25;
            flex-basis: calc(25% - 1rem); /* Default to 3 columns, adjusting for gap */
        }
        @media (max-width: 768px) {
            .mse-category label {
                flex-basis: calc(50% - 1rem); /* 2 columns on medium screens */
            }
        }
         @media (max-width: 480px) {
            .mse-category label {
                flex-basis: 100%; /* 1 column on small screens */
            }
        }
        .mse-category input[type="text"] {
            width: 100%;
            margin: 1px 0;
        }
        .mse-custom-input {
            width: 100%; /* Full width for custom input */
            margin-top: 0.25rem;
        }
        .mse-form-container legend {
            font-weight: bold;
            color: #c2410c;
            font-size: 1.1em;
            margin-bottom: 0.25rem;
        }
      /* Corrected spacing for labels above LARGE textareas in OUD Short note */
#opioid-use-disorder-short-container .ouds-inline-label:has(textarea),
#alcohol-use-disorder-short-container .auds-inline-label:has(textarea) {
    display: block;      /* Override the grid layout for these specific fields */
    grid-template-columns: none; /* Remove the column definition */
    gap: 0;              /* Remove the unwanted gap */
    margin-top: 20px;    /* Add space above the entire label-textbox unit */
    margin-bottom: 10px;
}

#opioid-use-disorder-short-container .ouds-inline-label:has(textarea) > label,
#alcohol-use-disorder-short-container .auds-inline-label:has(textarea) > label {
    margin-bottom: 0px; /* Reduce space between the label and its textbox */
    margin-top: 0;
}

#opioid-use-disorder-short-container .ouds-inline-label:has(textarea) > textarea,
#alcohol-use-disorder-short-container .auds-inline-label:has(textarea) > textarea {
    margin-top: 0; /* Ensure no extra space above the textarea */
}

/* This rule adds back a small amount of space for textareas that come directly after a main heading (like I-STOP). */
#opioid-use-disorder-short-container h3 + textarea,
#alcohol-use-disorder-short-container h3 + textarea {
    margin-top: 5px;
}
    </style>
</head>
<body>

<div class="container">
    <h1>Template-Based Notes</h1>

    <!-- New: Staff Role selector -->
    <label for="staff-type-select">Select Staff Role:</label>
    <select id="staff-type-select">
        <option value="" selected disabled>Select role...</option>
        <option value="counseling">Counseling Staff</option>
        <option value="medical">Medical Staff</option>
    </select>

    <label for="note-type-select" style="margin-top:12px;">Select Note Type:</label>
    <select id="note-type-select" disabled>
        <option value="" selected disabled>Select a role first...</option>
    </select>

    <!-- Container for Evaluation - Chemical Dependency Note -->
    <div id="eval-cd-container" class="note-container hidden">
        <h2 style="margin-top: 20px;">Note Details</h2>
        <p>The client presented for services and meets diagnostic criteria for a substance use disorder, specifically</p>
        <div id="diagnosis-container"></div>
        <p id="eval-cd-evidenced-by-label">, as evidenced by:</p>
        <textarea id="details-criteria" placeholder="Enter details here..."></textarea>
        <p>The client was provided a packet with the following information: Program expectations, rules, and attendance policies; Delphi Rise’s policy as a tobacco, nicotine, alcohol, and drug-free environment; and Client rights and responsibilities, including HIPAA and 42 CFR Part 2 confidentiality protections.</p>
        <br>
        <p>The clinician confirmed client understanding and emphasized the collaborative nature of recovery, highlighting the agency’s role in supporting the client’s treatment goals. The client demonstrated an understanding that participation in services is voluntary and may be discontinued at any time.</p>
        <div class="checkbox-container">
            <input type="checkbox" id="mandate-checkbox">
            <label for="mandate-checkbox">Include the following mandate information: The clinician clarified the implications of external mandates, noting that mandated status does not override the client’s right to voluntary engagement in treatment or toxicology screenings. Corresponding handouts were provided.</label>
        </div>
        <p>The clinician reviewed the client’s Behavioral Health and Chemical Dependency screening results and supported the client in understanding their scores. A comprehensive review of the client’s presenting concerns, referral reason, psychosocial needs, and current and historical functioning was conducted to assess eligibility for Outpatient services. The client's initial treatment goal is to complete the evaluation process; additional goals will be developed collaboratively in future sessions inclusive of discussions during evaluation session.</p>
        <div class="scenarios-section">
            <h2>Scenarios</h2>
            <p style="margin-bottom: 1rem;"><strong>PHQ-9 Score ≥9 or any suicide risk on C-SSRS:</strong></p>
            <div class="scenario-group">
                <p class="scenario-label">If the client has a mental health provider:</p>
                <div class="scenario-content checkbox-container">
                    <input type="checkbox" id="cd-has-mh-provider-text">
                    <label for="cd-has-mh-provider-text" class="scenario-label-text">The clinician discussed the client’s engagement with their current provider, encouraged prompt follow-up based on Behavioral Health screening results, and reviewed additional mental health resources if the client wishes to explore other providers. A signed release was obtained to coordinate care.</label>
                </div>
                    <div class="scenario-content checkbox-container">
                    <input type="checkbox" id="cd-safety-plan-has-provider">
                    <label for="cd-safety-plan-has-provider" class="scenario-label-text">A safety plan was developed collaboratively.</label>
                </div>
            </div>
            <div class="scenario-group">
                <p class="scenario-label">If the client does not have a mental health provider:</p>
                <div class="scenario-content checkbox-container">
                    <input type="checkbox" id="cd-no-mh-provider-text">
                    <label for="cd-no-mh-provider-text" class="scenario-label-text">The clinician encouraged a prompt mental health evaluation based on Behavioral Health screening results and provided a list of mental health referral options, reviewed the benefits of a comprehensive mental health evaluation, and offered support in making and completing the referral.</label>
                </div>
                    <div class="scenario-content checkbox-container">
                    <input type="checkbox" id="cd-safety-plan-no-provider">
                    <label for="cd-safety-plan-no-provider" class="scenario-label-text">A safety plan was developed to address suicide risk.</label>
                </div>
            </div>
            <h2>Other Scenarios</h2>
            <div class="scenario-group">
                <p class="scenario-label">Overdose Risk Identified:</p>
                    <div class="scenario-content checkbox-container">
                    <input type="checkbox" id="cd-overdose-risk">
                    <label for="cd-overdose-risk" class="scenario-label-text">The clinician reviewed the client’s overdose risk factors and collaborated with the client to create a personalized safety plan.</label>
                </div>
            </div>
                <div class="scenario-group">
                <p class="scenario-label">High-Risk Gambling Screen:</p>
                    <div class="scenario-content checkbox-container">
                    <input type="checkbox" id="cd-gambling-risk">
                    <label for="cd-gambling-risk" class="scenario-label-text">The clinician reviewed the client’s gambling screen results and initiated a referral to an in-house counselor trained in gambling treatment for further support.</label>
                </div>
            </div>
        </div>
        <h2 style="margin-top: 20px;">Evaluation Note Goals</h2>
        <label for="eval-cd-goal1-textbox">Goal 1:</label>
        <div style="display: flex; gap: 10px; align-items: flex-start;">
            <textarea id="eval-cd-goal1-textbox" rows="2" style="flex:1;" readonly>Engage in Intake Process</textarea>
            <button id="copy-eval-cd-goal1-btn" class="copy-button" style="width:auto; padding:8px 16px; margin-top:0;">Copy</button>
        </div>
        <label for="eval-cd-goal2-textbox" style="margin-top:20px;">Goal 2:</label>
        <div style="display: flex; gap: 10px; align-items: flex-start;">
            <textarea id="eval-cd-goal2-textbox" rows="4" style="flex:1;" readonly>Client will maintain and improve overall health status through engagement with the medical team as needed, including medical monitoring and adherence to provider recommendations, to support recovery and well-being.</textarea>
            <button id="copy-eval-cd-goal2-btn" class="copy-button" style="width:auto; padding:8px 16px; margin-top:0;">Copy</button>
        </div>
    </div>

    <!-- Container for Evaluation - Significant Other Note -->
    <div id="eval-so-container" class="note-container hidden">
        <h2 style="margin-top: 20px;">Note Details</h2>
        <p>The client presented for services due to experiencing stress related to supporting someone in their life who struggles with substance use. The client meets diagnostic criteria, specifically</p>
        <select id="so-diagnosis-select">
            <option value="" selected disabled>Select a diagnosis...</option>
            <option value="Z63.72 Alcoholism and drug addiction in family">Z63.72 Alcoholism and drug addiction in family</option>
            <option value="Z63.8 Other specified problems related to primary support group">Z63.8 Other specified problems related to primary support group</option>
        </select>
        <p>, as evidenced by:</p>
        <textarea id="so-details-criteria" placeholder="Enter details here..."></textarea>
        <p>The clinician reviewed: Program expectations, rules, and attendance policies; Delphi Rise’s policy as a tobacco, nicotine, alcohol, and drug-free environment; and Client rights and responsibilities, including HIPAA and 42 CFR Part 2 confidentiality protections.</p>
        <br>
        <p>The clinician confirmed client understanding and emphasized the collaborative nature of treatment, highlighting the agency’s role in supporting the client’s treatment goals. The client demonstrated an understanding that participation in services is voluntary and may be discontinued at any time.</p>
        <br>
        <p>The clinician reviewed the client’s Behavioral Health screening results and supported the client in understanding their scores. A comprehensive review of the client’s presenting concerns, referral reason, psychosocial needs, and current and historical functioning was conducted to assess eligibility for Outpatient services. The client's initial treatment goal is to complete the evaluation process; additional goals will be developed collaboratively in future sessions inclusive of discussions during evaluation session.</p>
        <div class="scenarios-section">
            <h2>Scenarios</h2>
            <p style="margin-bottom: 1rem;"><strong>PHQ-9 Score ≥9 or any suicide risk on C-SSRS:</strong></p>
            <div class="scenario-group">
                <p class="scenario-label">If the client has a mental health provider:</p>
                <div class="scenario-content checkbox-container">
                    <input type="checkbox" id="so-has-mh-provider-text">
                    <label for="so-has-mh-provider-text" class="scenario-label-text">The clinician discussed the client’s engagement with their current provider, encouraged prompt follow-up based on Behavioral Health screening results, and reviewed additional mental health resources if the client wishes to explore other providers. A signed release was obtained to coordinate care.</label>
                </div>
                    <div class="scenario-content checkbox-container">
                    <input type="checkbox" id="so-safety-plan-has-provider">
                    <label for="so-safety-plan-has-provider" class="scenario-label-text">A safety plan was developed collaboratively.</label>
                </div>
            </div>
            <div class="scenario-group">
                <p class="scenario-label">If the client does not have a mental health provider:</p>
                <div class="scenario-content checkbox-container">
                    <input type="checkbox" id="so-no-mh-provider-text">
                    <label for="so-no-mh-provider-text" class="scenario-label-text">The clinician encouraged a prompt mental health evaluation based on Behavioral Health screening results and provided a list of mental health referral options, reviewed the benefits of a comprehensive mental health evaluation, and offered support in making and completing the referral.</label>
                </div>
                    <div class="scenario-content checkbox-container">
                    <input type="checkbox" id="so-safety-plan-no-provider">
                    <label for="so-safety-plan-no-provider" class="scenario-label-text">A safety plan was developed to address suicide risk.</label>
                </div>
            </div>
            <h2>Other Scenarios</h2>
            <div class="scenario-group">
                <p class="scenario-label">Overdose Risk Identified:</p>
                    <div class="scenario-content checkbox-container">
                    <input type="checkbox" id="so-overdose-risk">
                    <label for="so-overdose-risk" class="scenario-label-text">The clinician reviewed the client’s overdose risk factors and collaborated with the client to create a personalized safety plan.</label>
                </div>
            </div>
                <div class="scenario-group">
                <p class="scenario-label">High-Risk Gambling Screen:</p>
                    <div class="scenario-content checkbox-container">
                    <input type="checkbox" id="so-gambling-risk">
                    <label for="so-gambling-risk" class="scenario-label-text">The clinician reviewed the client’s gambling screen results and initiated a referral to an in-house counselor trained in gambling treatment for further support.</label>
                </div>
            </div>
        </div>
        <h2 style="margin-top: 20px;">Suggested Goals</h2>
        <label for="eval-so-goal1-textbox">Goal 1:</label>
        <div style="display: flex; gap: 10px; align-items: flex-start;">
            <textarea id="eval-so-goal1-textbox" rows="2" style="flex:1;" readonly>Engage in Intake Process</textarea>
            <button id="copy-eval-so-goal1-btn" class="copy-button" style="width:auto; padding:8px 16px; margin-top:0;">Copy</button>
        </div>
        <label for="eval-so-goal2-textbox" style="margin-top:20px;">Goal 2:</label>
        <div style="display: flex; gap: 10px; align-items: flex-start;">
            <textarea id="eval-so-goal2-textbox" rows="4" style="flex:1;" readonly>Client will maintain and improve overall health status through engagement with the medical team as needed, including medical monitoring and adherence to provider recommendations, to support recovery and well-being.</textarea>
            <button id="copy-eval-so-goal2-btn" class="copy-button" style="width:auto; padding:8px 16px; margin-top:0;">Copy</button>
        </div>
    </div>
    
    <!-- Container for Entry Session - Chemical Dependency Note -->
    <div id="entry-cd-container" class="note-container hidden">
        <h2 style="margin-top: 20px;">Note Details</h2>
        <p>The client has identified personal goals to support their recovery, including:</p>
        <div id="client-goals-container"></div>
        <p>Based on the client’s psychosocial needs, current presentation, and clinical history, the client is expected to benefit from the following treatment plan goals:</p>
        <div id="treatment-goals-container"></div>
        <p>The clinician reviewed all services available through the Outpatient clinic, with a focus on peer support, medication management, and therapeutic group offerings. Corresponding handouts were provided to support the client’s engagement and alignment with their identified recovery goals.</p>
    </div>
    
    <!-- Container for Entry Session - Significant Other Note -->
    <div id="entry-so-container" class="note-container hidden">
        <h2 style="margin-top: 20px;">Note Details</h2>
        <p>The client has identified personal goals to support their recovery, including:</p>
        <div id="so-client-goals-container"></div>
        <p>Based on the client’s psychosocial needs, current presentation, and clinical history, the client is expected to benefit from the following treatment plan goals:</p>
        <div id="so-treatment-goals-container"></div>
        <p>The clinician reviewed all services available through the Outpatient clinic, with a focus on peer support, medication management, and therapeutic group offerings. Corresponding handouts were provided to support the client’s engagement and alignment with their identified recovery goals.</p>
    </div>

    <!-- Container for Narcan Education & Kit -->
    <div id="narcan-kit-container" class="note-container hidden">
        <h2 style="margin-top: 20px;">Note Details</h2>
        <div class="checkbox-container">
            <input type="checkbox" id="narcan-provided-checkbox">
            <label for="narcan-provided-checkbox">Education provided: I provided client with an overview of Narcan, showed a brief video demonstrating how to use, and provided a Narcan kit.</label>
        </div>
        <div class="checkbox-container">
            <input type="checkbox" id="narcan-declined-checkbox">
            <label for="narcan-declined-checkbox">Narcan training declined.</label>
        </div>

        <h2 style="margin-top: 20px;">Instructions</h2>
        <p><strong>What to say to the client:</strong></p>
        <p>“Narcan is a medicine that can save someone’s life during an opioid overdose. It works by quickly blocking the effects of opioids and helping the person breathe again. Narcan is easy to use and can be given by anyone, even without medical training. Having Narcan nearby can give people a second chance and time to get more help. It’s safe, doesn’t hurt someone if they didn’t take opioids, and can help prevent deaths from overdose.”</p>
        <br>
        <p><strong>Links:</strong></p>
        <p>Video: <a href="https://youtu.be/WnjgrRNMfKM?si=WvTS0Re5ZgYT79iP" rel="external" target="_blank">NARCAN Nasal Spray - How to use</a></p>
        <p>Handout: <a href="https://www.health.ny.gov/publications/12028.pdf" rel="external" target="_blank">How to use Narcan Nasal Spray for an opioid overdose</a></p>
    </div>

    <!-- Container for MAT Education -->
    <div id="mat-education-container" class="note-container hidden">
        <h2 style="margin-top: 20px;">MAT Education</h2>
        <label for="mat-education-type">Type of Education Provided:</label>
        <select id="mat-education-type">
            <option value="" selected disabled>Select an option...</option>
            <option value="not-taking">For Clients Not Already Taking MAT</option>
            <option value="already-taking">For Clients Already Taking MAT</option>
        </select>
        
        <div id="mat-not-taking-section" class="hidden">
            <p style="margin-top: 15px; background-color: #e9f5ff; padding: 12px; border-radius: 5px; border: 1px solid #bde0ff;">Medication Assisted Treatment (MAT) has been introduced, and education has been offered based on client's history and current presentation. Writer provided client with an overview of MAT’s benefits & risks and offered to connect client to medication management in our clinic.</p>
        </div>

        <div id="mat-already-taking-section" class="hidden">
            <p style="margin-top: 15px; background-color: #e9f5ff; padding: 12px; border-radius: 5px; border: 1px solid #bde0ff;">Client is currently taking medication to manage their Substance Use Disorder.</p>
        </div>
        
        <div id="mat-form-fields" class="hidden">
            <label for="mat-explored-options-dropdown">Explored Specific MAT Options?</label>
            <select id="mat-explored-options-dropdown">
                <option value="" selected disabled>Select an option...</option>
                <option value="did">Writer explored specific MAT options with client</option>
                <option value="did-not">Writer deferred conversation about specific medications to the medical staff</option>
            </select>

            <div id="mat-options-details-section" class="hidden">
                    <label for="mat-substances-textbox">MAT is recommended for the following substance(s):</label>
                <input type="text" id="mat-substances-textbox" placeholder="e.g., opioids, alcohol...">
                <label>What MAT options were explored?</label>
                <div id="mat-specific-options-checkboxes">
                    <div class="checkbox-container" style="margin-top: 10px; margin-bottom: 0;">
                        <input type="checkbox" id="mat-buprenorphine-checkbox" value="Buprenorphine (Suboxone, Sublocade)">
                        <label for="mat-buprenorphine-checkbox">Buprenorphine (Suboxone, Sublocade)</label>
                    </div>
                    <div class="checkbox-container" style="margin-top: 10px; margin-bottom: 0;">
                        <input type="checkbox" id="mat-naltrexone-checkbox" value="Naltrexone (Vivitrol)">
                        <label for="mat-naltrexone-checkbox">Naltrexone (Vivitrol)</label>
                    </div>
                    <div class="checkbox-container" style="margin-top: 10px; margin-bottom: 0;">
                        <input type="checkbox" id="mat-methadone-checkbox" value="Methadone">
                        <label for="mat-methadone-checkbox">Methadone</label>
                    </div>
                    <div class="checkbox-container" style="margin-top: 10px; margin-bottom: 0;">
                        <input type="checkbox" id="mat-acamprosate-checkbox" value="Acamprosate (Campral)">
                        <label for="mat-acamprosate-checkbox">Acamprosate (Campral)</label>
                    </div>
                </div>
            </div>

            <label for="mat-response-dropdown">Client's Response/Status:</label>
            <select id="mat-response-dropdown">
                <option value="" selected disabled>Select a response...</option>
                <option data-type="not-taking" value="Client expressed an interest in MAT and a referral was placed to our medical staff">Client expressed an interest in MAT and a referral was placed</option>
                <option data-type="not-taking" value="Client declined a referral to MAT">Client declined a referral</option>
                <option data-type="not-taking" value="Client was not appropriate for MAT at this stage">Client was not appropriate for MAT at this stage</option>
                <option data-type="already-taking" value="Client reports they are happy with their current MAT provider.">Client reports they are happy with their current MAT provider</option>
                <option data-type="already-taking" value="Client has been offered to connect to medication management at our clinic but declined to transfer care at this time">Client declined to transfer care</option>
                <option data-type="already-taking" value="Client has been offered to connect to medication management at our clinic, but reports they are happy with their current prescriber">Client is happy with current prescriber, declined to transfer</option>
            </select>

            <label for="mat-nicotine-use-dropdown">Client's Nicotine Use:</label>
            <select id="mat-nicotine-use-dropdown">
                <option value="" selected disabled>Select an option...</option>
                <option value="does">Client does current use nicotine</option>
                <option value="does-not">Client does not current use nicotine</option>
            </select>
            <div id="mat-nicotine-resources-section" class="hidden">
                <label>The following nicotine cessation resources were provided:</label>
                <div class="checkbox-container">
                    <input type="checkbox" id="mat-nicotine-replacement-checkbox">
                    <label for="mat-nicotine-replacement-checkbox">nicotine replacement options</label>
                </div>
                <div class="checkbox-container">
                    <input type="checkbox" id="mat-nicotine-counseling-checkbox">
                    <label for="mat-nicotine-counseling-checkbox">tobacco cessation counseling</label>
                </div>
                <div class="checkbox-container">
                    <input type="checkbox" id="mat-nicotine-referral-checkbox">
                    <label for="mat-nicotine-referral-checkbox">referral to a tobacco cessation program</label>
                </div>
                <div class="checkbox-container">
                    <input type="checkbox" id="mat-nicotine-other-checkbox">
                    <label for="mat-nicotine-other-checkbox">other</label>
                </div>
                <input type="text" id="mat-nicotine-other-textbox" class="hidden" placeholder="Specify other resource...">
            </div>
        </div>

        <div class="info-box" style="margin-top: 20px;">
            <label>Talking Points for Client Discussion:</label>
            <p>Studies show that using both medicine and therapy can help people who have problems with drugs or alcohol. For some people, medicine can make it easier to stay in recovery. These medicines are safe and approved by the Food and Drug Administration (FDA). Doctors pick the right medicine for each person to help them get better and avoid dangerous overdoses. Medicine can also help people live longer, stay in treatment, stop using illegal drugs, stay out of trouble, keep their jobs, have healthier babies if they’re pregnant, and lower the chance of getting diseases like HIV or hepatitis C. There are a few things to keep in mind. A doctor needs to check on you often, the medicine might cause side effects, and some people might misuse it.</p>
            <br>
            <a href="https://www.dhcs.ca.gov/individuals/Documents/MAT_Toolkit_for_Counselors.pdf" target="_blank">Medication Assisted Treatment Toolkit for Counselors</a>
        </div>
    </div>
    
    <div id="telehealth-container" class="note-container hidden">
        <h2 style="margin-top: 20px;">Telehealth Note Details</h2>
        <div class="telehealth-text">
            This session was conducted via 
            <select id="telehealth-visit-type" class="inline-form-element">
                <option value="" selected disabled>Select...</option>
                <option value="video">video</option>
                <option value="telephone">telephone</option>
            </select>
            , and client is clinically appropriate to receive services via telepractice. The use of telepractice was due to 
            <select id="telehealth-reason" class="inline-form-element">
                <option value="" selected disabled>Select...</option>
                <option value="client preference">client preference</option>
                <option value="location of the practitioner">location of the practitioner</option>
                <option value="location of the client">location of the client</option>
                <option value="lack of access to a video-enabled device">lack of access to a video-enabled device</option>
                <option value="temporary connectivity disruption">temporary connectivity disruption</option>
                <option value="other">other</option>
            </select>
            <input type="text" id="telehealth-reason-other" class="inline-form-element" style="display:none;" placeholder="specify...">
            . There 
            <select id="telehealth-disruption" class="inline-form-element">
                <option value="" selected disabled>Select...</option>
                <option value="were no service disruptions during the session">were no service disruptions during the session</option>
                <option value="was a service disruption">was a service disruption</option>
            </select>
            <span id="telehealth-disruption-followup" class="hidden">. Writer will follow up by <input type="text" id="telehealth-disruption-plan" class="inline-form-element" placeholder="plan for follow-up..."></span>
            . The client was located at 
            <input type="text" id="telehealth-client-location" class="inline-form-element" placeholder="client location">
            , and the practitioner was located at 
            <input type="text" id="telehealth-practitioner-location" class="inline-form-element" placeholder="practitioner location">
            at the time of the session. 
            <select id="telehealth-presence-dropdown" class="inline-form-element">
                <option value="" selected disabled>Select presence...</option>
                <option value="only">Provider and client were the only individuals present in the session</option>
                <option value="others">In addition to the provider and client, the following individual(s) were present with the client:</option>
            </select>
            <input type="text" id="telehealth-others-present" class="inline-form-element" style="display:none;" placeholder="specify...">
            . The client was asked about their satisfaction with receiving services via telepractice and 
            <select id="telehealth-satisfaction" class="inline-form-element">
                <option value="" selected disabled>Select...</option>
                <option value="reported satisfaction">reported satisfaction</option>
                <option value="expressed the following concerns:">expressed the following concerns:</option>
            </select>
            <input type="text" id="telehealth-satisfaction-concerns" class="inline-form-element" style="display:none;" placeholder="specify...">
            .
        </div>
    </div>

    <div id="closing-note-admitted-container" class="note-container hidden">
        <h2 style="margin-top: 20px;">Closing Note Details</h2>
        <p>Client was discharged due to <input type="text" id="closing-reason" placeholder="reason for discharge...">. Treatment recommendations include <input type="text" id="closing-recommendations" placeholder="recommended treatment plan...">. The client 
        <select id="closing-meds-dropdown">
            <option value="" selected disabled>Select...</option>
            <option value="is">is</option>
            <option value="is not">is not</option>
        </select>
        currently prescribed medications most recently prescribed at Delphi.</p>
        
        <div id="closing-meds-actions-container" class="hidden">
            <p>The following actions were taken to support the client’s medication management: <input type="text" id="closing-meds-actions" placeholder="describe actions taken..."></p>
        </div>

        <p>Referrals initiated to support the client post-discharge include: <input type="text" id="closing-referrals" placeholder="list referrals..."></p>
        <p>The 
        <select id="closing-offered-to-dropdown">
            <option value="" selected disabled>Select...</option>
            <option value="client">client</option>
            <option value="client and guardian">client and guardian</option>
        </select>
        was offered a copy of their discharge plan, a recovery resource handout outlining community resources for urgent support, harm reduction resources, referrals to MAT providers and recovery peer services, and an overdose prevention/Narcan kit.</p>
        <label for="closing-client-response">Client's Response to Resources Offered at Discharge:</label>
        <input type="text" id="closing-client-response" placeholder="Enter client's response...">
    </div>

    <div id="closing-note-non-admitted-container" class="note-container hidden">
        <h2 style="margin-top: 20px;">Closing Note Details</h2>
        <label for="non-admitted-client-type">Client Type:</label>
        <select id="non-admitted-client-type">
            <option value="" selected disabled>Select...</option>
            <option value="no-engage">Client did not engage in evaluation</option>
            <option value="higher-loc">Client is recommended to a higher level of care</option>
            <option value="no-criteria">Client does not meet criteria</option>
        </select>

        <div id="non-admitted-no-engage-section" class="hidden">
            <p>Client will not be admitted for treatment at this time due to not engaging in treatment beyond their evaluation(s). Engagement efforts included <input type="text" id="non-admitted-efforts" placeholder="list efforts...">. The decision not to admit was provided via mail to client <input type="text" id="non-admitted-provided-to-1" placeholder="and also provided to...">. Included in this letter is a recovery resource handout outlining community resources for urgent support, harm reduction resources, MAT providers, and recovery peer services.</p>
        </div>
        <div id="non-admitted-higher-loc-section" class="hidden">
            <p>The client will not be admitted for treatment at this time, as they meet criteria for a higher level of care <input type="text" id="non-admitted-locadtr" placeholder="LOCADTR outcome...">. Following a thorough review and discussion by the multidisciplinary team, it was determined that the client’s needs would be more safely and appropriately addressed in a setting equipped to provide a higher intensity of services. Efforts to explore treatment options and identify appropriate referrals were made, including: <input type="text" id="non-admitted-efforts-2" placeholder="list efforts made...">. The decision not to admit was communicated to the client via mail <input type="text" id="non-admitted-provided-to-2" placeholder="and also provided to...">. Included in the letter was a recovery resource handout outlining local options for urgent support, harm reduction services, MAT providers, and peer recovery resources.</p>
        </div>
        <div id="non-admitted-no-criteria-section" class="hidden">
            <p>Client will not be admitted for treatment at this time due to not meeting diagnostic criteria. Urine screen was <input type="text" id="non-admitted-urine-screen" placeholder="result..."> and no concerns were reported by collateral contacts. An outcome letter was provided to the client <input type="text" id="non-admitted-provided-to-3" placeholder="and..."></p>        </div>
    </div>

    <!-- Container for Injections -->
    <div id="injections-container" class="note-container hidden">
        <h2 style="margin-top: 20px;">Injections</h2>
        <label for="injection-type-select">Select Injection Type:</label>
        <select id="injection-type-select">
            <option value="" selected disabled>Select an injection...</option>
            <option value="brixadi">Brixadi SQ injection</option>
            <option value="sublocade">Sublocade SQ injection</option>
            <option value="vivitrol">Vivitrol 380mg Sus ER rec</option>
        </select>

        <!-- Vivitrol Section -->
        <div id="vivitrol-section" class="hidden">
            <p style="margin-top:15px;">Suspension prepared as instructed with preparation needle.</p>
            <div class="injection-field-group">
                <label for="vivitrol-site">Site:</label>
                <input type="text" id="vivitrol-site" placeholder="Enter site">
                <label for="vivitrol-lot">Lot #:</label>
                <input type="text" id="vivitrol-lot" placeholder="Enter lot number">
                <label for="vivitrol-exp">Exp date:</label>
                <input type="date" id="vivitrol-exp">
                <label for="vivitrol-sn">SN:</label>
                <input type="text" id="vivitrol-sn" placeholder="Enter serial number">
            </div>
            <p style="margin-top:15px;">Gluteal injection site identified by landmarks, prepped with alcohol swab. 2-inch admin needle used. 4.2 ml of suspension injected (Vivitrol 380 mg) with scant bleeding, Band-aid applied. Pt tolerated procedure well without complication. Reviewed with Pt medication side effects, signs/systems of infection at injection site. Encouraged PT to contact clinic for any concerns/ questions regarding injection.</p>
            <label for="vivitrol-next-injection">Next scheduled Injection:</label>
            <input type="date" id="vivitrol-next-injection">
        </div>

        <!-- Sublocade Section -->
        <div id="sublocade-section" class="hidden">
            <p style="margin-top:15px;">Sublocade SQ injection administered</p>
            <div class="injection-field-group">
                <label for="sublocade-site">Site:</label>
                <input type="text" id="sublocade-site" placeholder="Enter site">
                <label for="sublocade-lot">Lot #:</label>
                <input type="text" id="sublocade-lot" placeholder="Enter lot number">
                <label for="sublocade-exp">Exp date:</label>
                <input type="date" id="sublocade-exp">
                <label for="sublocade-sn">SN:</label>
                <input type="text" id="sublocade-sn" placeholder="Enter serial number">
            </div>
            <p style="margin-top:15px;">Ice pack applied to site prior to administration Cold Spray applied to site. Site prepped with alcohol swab. Pt tolerated procedure well without complication. Reviewed with Pt medication side effects, signs/systems of infection at injection site. Encouraged PT to contact clinic for any concerns/ questions regarding injection. PT instructed on importance of medication adherence and follow appointments with providers.</p>
            <label for="sublocade-next-injection">Next scheduled Injection:</label>
            <input type="date" id="sublocade-next-injection">
        </div>

        <!-- Brixadi Section -->
        <div id="brixadi-section" class="hidden">
            <p style="margin-top:15px;">Brixadi SQ injection administered</p>
            <div class="injection-field-group">
                <label for="brixadi-site">Site:</label>
                <input type="text" id="brixadi-site" placeholder="Enter site">
                <label for="brixadi-lot">Lot #:</label>
                <input type="text" id="brixadi-lot" placeholder="Enter lot number">
                <label for="brixadi-exp">Exp date:</label>
                <input type="date" id="brixadi-exp">
                <label for="brixadi-sn">SN:</label>
                <input type="text" id="brixadi-sn" placeholder="Enter serial number">
            </div>
            <p style="margin-top:15px;">Site prepped with alcohol swab. Pt tolerated procedure. Reviewed with Pt medication side effects, signs/systems of infection at injection site. Encouraged PT to contact clinic for any concerns/ questions regarding injection.</p>
            <label for="brixadi-next-injection">Next scheduled Injection:</label>
            <input type="date" id="brixadi-next-injection">
        </div>
    </div>

    <!-- START: Container for Medical Screening -->
    <div id="medical-screening-container" class="note-container hidden">
        <h2 style="margin-top: 20px;">PCP and Physical Exams</h2>

        <div class="form-group">
            <label>Does client have a primary care physician?</label>
            <div class="radio-group">
                <label><input type="radio" name="hasPCP" value="yes"> Yes</label>
                <label><input type="radio" name="hasPCP" value="no"> No</label>
            </div>
        </div>

        <div id="ms-pcpYesSection" class="conditional hidden">
            <label for="pcpName">Name of PCP:</label>
            <input type="text" id="pcpName" name="pcpName">
            <label for="lastPEDate">Date of Last PE:</label>
            <input type="date" id="lastPEDate" name="lastPEDate">
            <div class="checkbox-container">
                <input type="checkbox" id="pcpDiscussed" name="pcpDiscussed">
                <label for="pcpDiscussed">Writer and client discussed the importance of routine health maintenance and management of chronic conditions with PCP.</label>
            </div>
        </div>

        <div id="ms-pcpNoSection" class="conditional hidden">
            <label>Has client had a physical exam within the last year?</label>
            <div class="radio-group">
                <label><input type="radio" name="hadPELastYear" value="yes"> Yes</label>
                <label><input type="radio" name="hadPELastYear" value="no"> No</label>
            </div>

            <div id="ms-peLastYearYesSection" class="conditional hidden">
                <label for="peLocation">Where?</label>
                <input type="text" id="peLocation" name="peLocation">
                <label>Consent obtained to get PE records?</label>
                <select name="peConsent">
                    <option value="">Select an option...</option>
                    <option value="yes">Yes</option>
                    <option value="consent_declined">Consent Declined</option>
                </select>
            </div>

            <div id="ms-peLastYearNoSection" class="conditional hidden">
                    <div class="checkbox-container">
                    <input type="checkbox" id="noPeDiscussed" name="noPeDiscussed">
                    <label for="noPeDiscussed">Writer and client discussed the importance of routine health maintenance and management of chronic conditions with PCP. Client was provided with information of local PCP offices that are taking new clients, writer offered to provide support in making referral.</label>
                </div>
            </div>
        </div>
        
        <label>PCP consent completed?</label>
        <div class="radio-group">
            <label><input type="radio" name="pcpConsentCompleted" value="yes"> Yes</label>
            <label><input type="radio" name="pcpConsentCompleted" value="no"> No</label>
        </div>
        
        <div id="ms-pcpConsentNoSection" class="conditional hidden">
            <label>Reason for declining consent:</label>
                <div class="radio-group">
                    <label><input type="radio" name="declineReason" value="confidential"> Client does not want PCP to know about substance abuse treatment.</label>
                    <label><input type="radio" name="declineReason" value="other"> Other</label>
                </div>
                <div id="ms-declineReasonOtherSpecify" class="conditional hidden">
                    <input type="text" name="declineReasonOtherText" placeholder="Specify other reason">
                </div>
                <div class="checkbox-container">
                    <input type="checkbox" id="oasasReviewedNoConsent" name="oasasReviewedNoConsent">
                    <label for="oasasReviewedNoConsent">Reviewed with client OASAS guidelines regarding obtaining recent physical exam review, will only request last PE, current med list. Client understands and does not consent to PCP consent.</label>
                </div>
        </div>

        <h2>Communicable Diseases</h2>
        <label>Has client had recent STD, HEP testing?</label>
        <div class="radio-group">
            <label><input type="radio" name="stdHepTest" value="yes"> Yes</label>
            <label><input type="radio" name="stdHepTest" value="no"> No</label>
        </div>

        <div id="ms-stdHepTestYesSection" class="conditional hidden">
            <label for="stdHepStatus">Client reports recent STD, HEP testing:</label>
            <select id="stdHepStatus" name="stdHepStatus">
                <option value="">Select status...</option>
                <option value="known_negative">Known Negative</option>
                <option value="known_positive">Known Positive</option>
            </select>
                <div id="ms-stdHepPositiveSection" class="conditional hidden">
                    <label for="stdHepPositiveSpecify">Specify:</label>
                    <input type="text" id="stdHepPositiveSpecify" name="stdHepPositiveSpecify">
                </div>
        </div>

        <label>Has client been tested for TB?</label>
            <div class="radio-group">
                <label><input type="radio" name="tbTest" value="yes"> Yes</label>
                <label><input type="radio" name="tbTest" value="no"> No</label>
            </div>
        
        <div id="ms-tbTestYesSection" class="conditional hidden">
            <label>Test Result:</label>
            <div class="radio-group">
                <label><input type="radio" name="tbResult" value="negative"> Negative</label>
                <label><input type="radio" name="tbResult" value="positive"> Positive</label>
            </div>
            <div id="ms-tbPositiveDetailsSection" class="conditional hidden">
                <label for="tbPositiveDetails">Positive Result Details (e.g., treatment, follow-up):</label>
                <textarea id="tbPositiveDetails" name="tbPositiveDetails" rows="3"></textarea>
            </div>
        </div>

        <div id="ms-tbTestNoSection" class="conditional hidden">
            <label>Does client have risk factors/symptoms to indicate TB test?</label>
            <div class="radio-group">
                <label><input type="radio" name="tbRiskFactors" value="yes"> Yes</label>
                <label><input type="radio" name="tbRiskFactors" value="no"> No</label>
            </div>
            <label>Referral Status:</label>
            <select id="tbReferralStatus" name="tbReferralStatus">
                <option value="">Select referral status...</option>
                <option value="accepted">Client ACCEPTED offer for support with a referral.</option>
                <option value="declined">Client DECLINED offer for support with a referral.</option>
            </select>
        </div>

        <h2>Substance Use</h2>
        <label>Tobacco use:</label>
            <div class="radio-group">
                <label><input type="radio" name="tobaccoUse" value="yes"> Yes</label>
                <label><input type="radio" name="tobaccoUse" value="no"> No</label>
            </div>

        <div id="ms-tobaccoUseYesSection" class="conditional hidden">
            <label for="tobaccoAmount">Client reports tobacco use (amount):</label>
            <input type="text" id="tobaccoAmount" name="tobaccoAmount">
            <label for="vapeAmount">Client reports nicotine vape use (amount):</label>
            <input type="text" id="vapeAmount" name="vapeAmount">
            <label>Is client interested in smoking cessation/quitting smoking?</label>
            <div class="radio-group">
                <label><input type="radio" name="cessationInterest" value="yes"> Yes</label>
                <label><input type="radio" name="cessationInterest" value="no"> No</label>
            </div>
            <div id="ms-cessationInterestYesSection" class="conditional hidden">
                <label>Was client scheduled with med provider?</label>
                <div class="radio-group">
                    <label><input type="radio" name="medProviderScheduled" value="yes"> Yes</label>
                    <label><input type="radio" name="medProviderScheduled" value="no"> No</label>
                </div>
            </div>
        </div>
        
        <label>Is client currently on MAT?</label>
        <div class="radio-group">
            <label><input type="radio" name="onMAT" value="yes"> Yes</label>
            <label><input type="radio" name="onMAT" value="no"> No</label>
        </div>
        
        <div id="ms-matYesSection" class="conditional hidden">
            <div class="radio-group">
                <label><input type="radio" name="matProviderStatus" value="happy"> Client reports they are happy with their current provider.</label>
                <label><input type="radio" name="matProviderStatus" value="switch"> Client would like to switch MAT provider to Delphi and client has been scheduled with medication provider.</label>
            </div>
        </div>

        <div id="ms-matNoSection" class="conditional hidden">
                <div class="radio-group">
                    <label><input type="radio" name="matInterest" value="declined"> Client declined MAT at this time, client aware that if client is interested in MAT in the future to discuss with therapist or with nurse.</label>
                    <label><input type="radio" name="matInterest" value="accepted"> Client would like to see med provider for MAT and has been scheduled with medication provider.</label>
                </div>
        </div>

        <label>Narcan / Overdose Prevention</label>
            <div class="radio-group">
                <label><input type="radio" name="narcanOffered" value="yes"> Narcan training offered and accepted</label>
                <label><input type="radio" name="narcanOffered" value="no"> Narcan training offered and declined</label>
            </div>
    </div>
    <!-- END: Container for Medical Screening -->


    <!-- Container for MDT Note -->
    <div id="mdt-container" class="note-container hidden">
        <h2 style="margin-top: 20px;">MDT Note Details</h2>

        <label for="mdt-diagnosis-container">Diagnosis:</label>
        <div id="mdt-diagnosis-container"></div>

        <label for="mdt-reason-high-risk">Reason on High Risk:</label>
        <textarea id="mdt-reason-high-risk"></textarea>

        <label for="mdt-criteria-off-high-risk">Criteria to Come Off High Risk:</label>
        <textarea id="mdt-criteria-off-high-risk"></textarea>

        <label for="mdt-risk-factors">Risk Factors:</label>
        <textarea id="mdt-risk-factors"></textarea>

        <label for="mdt-protective-factors">Protective Factors:</label>
        <textarea id="mdt-protective-factors"></textarea>

        <label for="mdt-care-coordination">Care Coordination Needs:</label>
        <textarea id="mdt-care-coordination"></textarea>

        <label for="mdt-stage-of-change">Stage of Change / Motivation Level:</label>
        <select id="mdt-stage-of-change">
            <option value="" selected disabled>Select a stage...</option>
            <option value="Precontemplation">Precontemplation</option>
            <option value="Contemplation">Contemplation</option>
            <option value="Preparation">Preparation</option>
            <option value="Action">Action</option>
            <option value="Maintenance">Maintenance</option>
            <option value="Relapse">Relapse</option>
            <option value="Other">Other</option>
        </select>
        <input type="text" id="mdt-stage-of-change-other" class="hidden" placeholder="Specify other stage/motivation...">

        <label for="mdt-safety-plan-completed">Safety Plan Completed:</label>
        <select id="mdt-safety-plan-completed">
            <option value="" selected disabled>Select...</option>
            <option value="Yes">Yes</option>
            <option value="No">No</option>
        </select>

        <label for="mdt-safety-plan-applicable">Safety Plan Applicable to Current Presentation:</label>
        <textarea id="mdt-safety-plan-applicable"></textarea>

        <label for="mdt-mat-status">MAT Status:</label>
        <input type="text" id="mdt-mat-status">

        <label for="mdt-last-tox-date">Date Last Urine Toxicology Collected:</label>
        <input type="date" id="mdt-last-tox-date">

        <label for="mdt-tox-result">Result of Toxicology Screen:</label>
        <textarea id="mdt-tox-result"></textarea>

        <label for="mdt-client-engaging">Is Client Engaging?</label>
        <input type="text" id="mdt-client-engaging">

        <label for="mdt-most-recent-appt">Most Recent Appointment Date:</label>
        <input type="date" id="mdt-most-recent-appt">

        <label for="mdt-next-appt">Next Appointment Date:</label>
        <input type="date" id="mdt-next-appt">

        <label for="mdt-progress-recommendations">Progress on Most Recent MDT Recommendations:</label>
        <textarea id="mdt-progress-recommendations"></textarea>

        <label for="mdt-guiding-questions">Guiding Question(s) for Today’s MDT Discussion:</label>
        <textarea id="mdt-guiding-questions"></textarea>
    </div>


    <!-- Container for Discharge Plan -->
    <div id="discharge-plan-container" class="note-container hidden">
        <h2 style="margin-top: 20px;">Discharge Plan</h2>
        <label for="peer-support-textbox">Peer Support/Mutual Assistance</label>
        <div style="display: flex; gap: 10px; align-items: flex-start;">
            <textarea id="peer-support-textbox" rows="10" style="flex:1; min-height: 180px;">Delphi Rise Continuing Care
72 Hinchey Road
Rochester, NY 14624
(585) 467-2230

Delphi Rise Open Access
72 Hinchey Road
Rochester, NY 14624
(585) 627-1777

AA Rochester 
Find a Rochester meeting: https://www.rochesteraa.org/ 
Call (585) 232-6720 to speak to an AA support at our Central Office 

ROCovery Fitness  
1035 Dewey Avenue, Rochester, New York 14613   
https://www.rocoveryfitness.org/ 
</textarea>
            <button id="copy-peer-support-btn" class="copy-button" style="width:auto; padding:8px 16px; margin-top:0;">Copy</button>
        </div>
        <label for="family-services-textbox" style="margin-top:20px;">Services for Significant Others and/or Family:</label>
        <div style="display: flex; gap: 10px; align-items: flex-start;">
            <textarea id="family-services-textbox" rows="7" style="flex:1; min-height: 120px;">Delphi Rise Significant Other Counseling
72 Hinchey Road
Rochester, NY 14624
(585) 467-2230

Liberty Resources
175 N. Winton Rd
Rochester, NY
</textarea>
            <button id="copy-family-services-btn" class="copy-button" style="width:auto; padding:8px 16px; margin-top:0;">Copy</button>
        </div>
        <p style="margin-top:20px; color:#555;">You may copy and paste these resources into your discharge summary or provide them directly to clients/families.</p>
    </div>

    <!-- Container for Medication Management Follow-up -->
    <div id="med-mgmt-follow-up-container" class="note-container hidden">
        <h2 style="margin-top: 20px;">Medication Management Follow-up</h2>

        <h3>Chief Complaint:</h3>
        <textarea id="mmfu-chief-complaint" placeholder="Client’s statement here"></textarea>

        <h3>Diagnosis:</h3>
        <div id="mmfu-diagnosis-container"></div>

        <h3>Subjective:</h3>
        <p>Client presents for <input type="text" id="mmfu-presenting-concern" class="inline-form-element" placeholder="Describe presenting concern">. Current medication regimen <textarea id="mmfu-med-regimen" placeholder="medication, dose, frequency" rows="2"></textarea> addresses the presenting concern.</p>
        <label for="mmfu-symptoms">Symptoms/Cravings:</label>
        <input type="text" id="mmfu-symptoms" placeholder="Document client’s current symptoms, cravings, or withdrawal signs.">
        <label for="mmfu-substance-use">Substance Use:</label>
        <input type="text" id="mmfu-substance-use" placeholder="Document any substance use or alcohol use since last seen.">
        <label for="mmfu-adherence">Medication Adherence:</label>
        <input type="text" id="mmfu-adherence" placeholder="Document if taking medications as prescribed.">
        <label for="mmfu-side-effects">Side Effects/Complications:</label>
        <input type="text" id="mmfu-side-effects" placeholder="Note presence/absence of side effects.">
        <label for="mmfu-psychosocial">Psychosocial/Environmental Changes:</label>
        <textarea id="mmfu-psychosocial" placeholder="Document stressors, supports, or changes."></textarea>

        <label for="mmfu-nicotine-use">Patient uses a product containing nicotine?</label>
        <select id="mmfu-nicotine-use">
            <option value="" selected disabled>Select...</option>
            <option value="yes">Yes</option>
            <option value="no">No</option>
        </select>

        <div id="mmfu-nicotine-details-section" class="hidden">
            <label for="mmfu-nicotine-interest">Is the patient interested in cutting down?</label>
            <select id="mmfu-nicotine-interest">
                <option value="" selected disabled>Select...</option>
                <option value="yes">Yes</option>
                <option value="no">No</option>
            </select>
            <label for="mmfu-nicotine-details">Type of nicotine used, amount, frequency, factors that predispose use that were reviewed with patient such as social and environmental triggers, history of previous quit attempts, prior therapies or treatments used</label>
            <textarea id="mmfu-nicotine-details" rows="3"></textarea>
        </div>

        <h3>Objective:</h3>
        <label for="mmfu-istop">I-STOP/Prescription Monitoring:</label>
        <textarea id="mmfu-istop" placeholder="Date(s) reviewed, medications dispensed, quantities."></textarea>
        <label for="mmfu-uds">UDS Results (Reviewed):</label>
        <textarea id="mmfu-uds" placeholder="Date, results, and how it informs assessment."></textarea>

        <h3>Assessment:</h3>
        <label for="mmfu-interventions">Interventions:</label>
        <textarea id="mmfu-interventions" placeholder="Describe interventions used (review of labs, counseling, motivational interviewing, education, risk/benefit discussion, etc.)"></textarea>
        <label for="mmfu-med-plan">Medication Plan:</label>
        <textarea id="mmfu-med-plan" placeholder="Medication name, dose, frequency, max daily dose if applicable."></textarea>
        <label for="mmfu-client-response">Client's Response:</label>
        <textarea id="mmfu-client-response" placeholder="Client’s engagement, understanding, agreement/disagreement with plan. Response to interventions, risks/benefits discussion."></textarea>
        <label for="mmfu-suicidality">Suicidality:</label>
        <select id="mmfu-suicidality">
            <option value="Client denies SI/HI">Client denies SI/HI</option>
            <option value="Client endorses SI">Client endorses SI</option>
            <option value="Client endorses HI">Client endorses HI</option>
            <option value="Client endorses SI & HI">Client endorses SI & HI</option>
        </select>

        <h3>Plan:</h3>
        <div class="checkbox-container">
            <input type="checkbox" id="mmfu-plan-continue-meds">
            <label for="mmfu-plan-continue-meds">Continue medications as prescribed.</label>
        </div>
        <div class="checkbox-container">
            <input type="checkbox" id="mmfu-plan-attend-appts">
            <label for="mmfu-plan-attend-appts">Attend all medication management appointments.</label>
        </div>
        <p>Follow up in <input type="text" id="mmfu-plan-followup-time" class="inline-form-element" placeholder="timeframe"> for medication management.</p>
        <p>Follow up with <input type="text" id="mmfu-plan-followup-provider" class="inline-form-element" placeholder="counselor/medical provider/etc."> as scheduled.</p>
        <div class="checkbox-container">
            <input type="checkbox" id="mmfu-plan-call-911">
            <label for="mmfu-plan-call-911">Client agrees to call 911 and contact staff with any SI/HI or urgent mental health concerns.</label>
        </div>
    </div>

    <!-- Container for Opioid Use Disorder Short -->
    <div id="opioid-use-disorder-short-container" class="note-container hidden">
        <h2 style="margin-top: 20px;">Opioid Use Disorder Short</h2>
        <p>New patient visit.</p>
        
        <div class="ouds-inline-label" id="ouds-chief-complaint-display-label">
            <label>Chief Complaint: Opioid Use Disorder</label>
            <!-- Removed the input box for Chief Complaint as it's static now -->
        </div>

        <h3>Substance Use History</h3>
        <div class="ouds-inline-label">
            <label for="ouds-age-first-use">Age at first use:</label>
            <input type="text" id="ouds-age-first-use">
        </div>
        <div class="ouds-inline-label">
            <label for="ouds-types-substance">Type(s) of substance:</label>
            <input type="text" id="ouds-types-substance">
        </div>
        <div class="ouds-inline-label">
            <label for="ouds-frequency">Frequency of use:</label>
            <input type="text" id="ouds-frequency">
        </div>
        <div class="ouds-inline-label">
            <label for="ouds-prev-treatment">Previous treatment programs:</label>
            <input type="text" id="ouds-prev-treatment">
        </div>
        <div class="ouds-inline-label">
            <label for="ouds-prev-recovery">Previous periods in recovery:</label>
            <input type="text" id="ouds-prev-recovery">
        </div>
        <div class="ouds-inline-label">
            <label>Current active use:</label>
            <div class="radio-group">
                <label><input type="radio" name="ouds-active-use" value="yes"> Yes</label>
                <label><input type="radio" name="ouds-active-use" value="no"> No</label>
            </div>
        </div>
        <div id="ouds-last-use-date-row" class="conditional hidden ouds-inline-label">
            <label for="ouds-last-use-date">Date of last use:</label>
            <input type="date" id="ouds-last-use-date">
        </div>

        <h3>Pharmacotherapy</h3>
        <div class="ouds-inline-label">
            <label>Patient current on pharmacotherapy for SUD:</label>
            <div class="radio-group">
                <label><input type="radio" name="ouds-pharmacotherapy" value="yes"> Yes</label>
                <label><input type="radio" name="ouds-pharmacotherapy" value="no"> No</label>
            </div>
        </div>
        <div id="ouds-pharm-fields" class="conditional hidden">
            <label for="ouds-symptoms">Symptoms/Cravings:</label>
            <textarea id="ouds-symptoms" placeholder="Document client's current symptoms, cravings, or withdrawal signs."></textarea>
            <label for="ouds-substance-use">Substance use:</label>
            <textarea id="ouds-substance-use" placeholder="Document any substance use or alcohol use since started medication"></textarea>
            <label for="ouds-adherence">Medication adherence:</label>
            <textarea id="ouds-adherence" placeholder="Document if taking medications as prescribed."></textarea>
            <label for="ouds-side-effects">Side effects/Complications:</label>
            <textarea id="ouds-side-effects" placeholder="Note presence/absence of side effects."></textarea>
        </div>
        <h3>Any other substance use?</h3>
      <div style="display: grid; grid-template-columns: 2fr 1fr 1fr; gap: 10px; align-items: center; margin-bottom: 5px; font-weight: bold; padding-left: 42px;">
    <span style="grid-column: 1;">Substance</span>
    <span style="grid-column: 2;">Amount Used</span>
    <span style="grid-column: 3;">Last Date of Use</span>
</div>

        <div id="ouds-substance-list">
            <div class="ouds-substance-grid">
                <div class="checkbox-container" style="margin:0; padding:0; background:none; border:none;"><input type="checkbox" id="ouds-sub-alcohol"><label for="ouds-sub-alcohol">Alcohol:</label></div>
                <input type="text" id="ouds-amt-alcohol" class="hidden" placeholder="Amount Used">
                <input type="date" id="ouds-date-alcohol" class="hidden">
            </div>
            <div class="ouds-substance-grid">
                <div class="checkbox-container" style="margin:0; padding:0; background:none; border:none;"><input type="checkbox" id="ouds-sub-amphet"><label for="ouds-sub-amphet">Amphetamine / Methamphetamines / Crystal Meth:</label></div>
                <input type="text" id="ouds-amt-amphet" class="hidden" placeholder="Amount Used">
                <input type="date" id="ouds-date-amphet" class="hidden">
            </div>
            <div class="ouds-substance-grid">
                <div class="checkbox-container" style="margin:0; padding:0; background:none; border:none;"><input type="checkbox" id="ouds-sub-benzodiazepines"><label for="ouds-sub-benzodiazepines">Benzodiazepines:</label></div>
                <input type="text" id="ouds-amt-benzodiazepines" class="hidden" placeholder="Amount Used">
                <input type="date" id="ouds-date-benzodiazepines" class="hidden">
            </div>
            <div class="ouds-substance-grid">
                <div class="checkbox-container" style="margin:0; padding:0; background:none; border:none;"><input type="checkbox" id="ouds-sub-cocaine"><label for="ouds-sub-cocaine">Cocaine</label></div>
                <input type="text" id="ouds-amt-cocaine" class="hidden" placeholder="Amount Used">
                <input type="date" id="ouds-date-cocaine" class="hidden">
            </div>
            <div class="ouds-substance-grid">
                <div class="checkbox-container" style="margin:0; padding:0; background:none; border:none;"><input type="checkbox" id="ouds-sub-hallucinogens"><label for="ouds-sub-hallucinogens">Hallucinogens:</label></div>
                <input type="text" id="ouds-amt-hallucinogens" class="hidden" placeholder="Amount Used">
                <input type="date" id="ouds-date-hallucinogens" class="hidden">
            </div>
            <div class="ouds-substance-grid">
                <div class="checkbox-container" style="margin:0; padding:0; background:none; border:none;"><input type="checkbox" id="ouds-sub-illicit-opioids"><label for="ouds-sub-illicit-opioids">Illicit opioids:</label></div>
                <input type="text" id="ouds-amt-illicit-opioids" class="hidden" placeholder="Amount Used">
                <input type="date" id="ouds-date-illicit-opioids" class="hidden">
            </div>
            <div class="ouds-substance-grid">
                <div class="checkbox-container" style="margin:0; padding:0; background:none; border:none;"><input type="checkbox" id="ouds-sub-ivdu"><label for="ouds-sub-ivdu">IVDU:</label></div>
                <input type="text" id="ouds-amt-ivdu" class="hidden" placeholder="Amount Used">
                <input type="date" id="ouds-date-ivdu" class="hidden">
            </div>
            <div class="ouds-substance-grid">
                <div class="checkbox-container" style="margin:0; padding:0; background:none; border:none;"><input type="checkbox" id="ouds-sub-kratom"><label for="ouds-sub-kratom">Kratom:</label></div>
                <input type="text" id="ouds-amt-kratom" class="hidden" placeholder="Amount Used">
                <input type="date" id="ouds-date-kratom" class="hidden">
            </div>
            <div class="ouds-substance-grid">
                <div class="checkbox-container" style="margin:0; padding:0; background:none; border:none;"><input type="checkbox" id="ouds-sub-mdma"><label for="ouds-sub-mdma">MDMA:</label></div>
                <input type="text" id="ouds-amt-mdma" class="hidden" placeholder="Amount Used">
                <input type="date" id="ouds-date-mdma" class="hidden">
            </div>
            <div class="ouds-substance-grid">
                <div class="checkbox-container" style="margin:0; padding:0; background:none; border:none;"><input type="checkbox" id="ouds-sub-nicotine"><label for="ouds-sub-nicotine">Nicotine use:</label></div>
                <input type="text" id="ouds-amt-nicotine" class="hidden" placeholder="Amount Used">
                <input type="date" id="ouds-date-nicotine" class="hidden">
            </div>
            <div class="ouds-substance-grid">
                <div class="checkbox-container" style="margin:0; padding:0; background:none; border:none;"><input type="checkbox" id="ouds-sub-prescription-opioids"><label for="ouds-sub-prescription-opioids">Prescription opioids:</label></div>
                <input type="text" id="ouds-amt-prescription-opioids" class="hidden" placeholder="Amount Used">
                <input type="date" id="ouds-date-prescription-opioids" class="hidden">
            </div>
            <div class="ouds-substance-grid">
                <div class="checkbox-container" style="margin:0; padding:0; background:none; border:none;"><input type="checkbox" id="ouds-sub-other"><label for="ouds-sub-other">Other:</label></div>
                <input type="text" id="ouds-sub-other-text" class="hidden" placeholder="Identify other drug">
                <div>
                    <input type="text" id="ouds-amt-other" class="hidden" placeholder="Amount Used" style="width:100%; margin-bottom: 5px;">
                    <input type="date" id="ouds-date-other" class="hidden" style="width:100%;">
                </div>
            </div>
        </div>

        <h3>Medical History Related to Substance Use:</h3>
        <div class="checkbox-container"><input type="checkbox" id="ouds-med-ivdu"><label for="ouds-med-ivdu">History of IV drug use</label></div>
        <div class="checkbox-container"><input type="checkbox" id="ouds-med-shared"><label for="ouds-med-shared">History of shared needles</label></div>
        <div class="checkbox-container"><input type="checkbox" id="ouds-med-hep-c"><label for="ouds-med-hep-c">History of Hepatitis C</label></div>
        <div class="checkbox-container"><input type="checkbox" id="ouds-med-hiv"><label for="ouds-med-hiv">History of HIV</label></div>

        <div class="ouds-inline-label">
            <label for="ouds-pmh">PMH:</label>
            <textarea id="ouds-pmh" rows="2"></textarea>
        </div>
        <div class="ouds-inline-label">
            <label for="ouds-psych">Psych History:</label>
            <textarea id="ouds-psych" rows="2"></textarea>
        </div>
        <div class="ouds-inline-label">
            <label for="ouds-medications">Medications:</label>
            <textarea id="ouds-medications" rows="2"></textarea>
        </div>
        <div class="ouds-inline-label">
            <label for="ouds-allergies">Allergies:</label>
            <textarea id="ouds-allergies" rows="2"></textarea>
        </div>
        <div class="ouds-inline-label">
            <label for="ouds-pcp">PCP:</label>
            <input type="text" id="ouds-pcp">
        </div>
        <div class="ouds-inline-label">
            <label for="ouds-last-pcp-visit">Last Visit with PCP:</label>
            <input type="date" id="ouds-last-pcp-visit">
        </div>

        <h3>Pertinent Review of Systems:</h3>
        <div class="ouds-inline-label">
            <label>- GI: Constipation:</label>
            <div class="radio-group">
                <label><input type="radio" name="ouds-gi-const" value="yes"> Yes</label>
                <label><input type="radio" name="ouds-gi-const" value="no"> No</label>
            </div>
        </div>
        <div class="ouds-inline-label">
            <label for="ouds-psych-ideation">- Psychiatric: Suicidal or Homicidal Ideation:</label>
            <select id="ouds-psych-ideation" class="inline-form-element">
                <option value="Denies SI/HI">Denies SI/HI</option>
                <option value="Endorses SI">Endorses SI</option>
                <option value="Endorses HI">Endorses HI</option>
                <option value="Endorses SI/HI">Endorses SI/HI</option>
            </select>
        </div>
<div id="ouds-safety-planning-container" class="checkbox-container hidden" style="background:none; border:none; padding-left: 20px;">
 <input type="checkbox" id="ouds-safety-planning-checkbox">
 <label for="ouds-safety-planning-checkbox" style="color: red; font-weight: bold;">Staff provided safety planning</label>
</div>

        <div class="ouds-inline-label">
            <label for="ouds-family">Family History:</label>
            <textarea id="ouds-family" rows="2"></textarea>
        </div>
        <div class="ouds-inline-label">
            <label for="ouds-social">Social:</label>
            <input type="text" id="ouds-social">
        </div>
        <div class="ouds-inline-label">
            <label for="ouds-living">Current Living Situation:</label>
            <input type="text" id="ouds-living">
        </div>
        <div class="ouds-inline-label">
            <label for="ouds-employment">Employment:</label>
            <input type="text" id="ouds-employment">
        </div>
        <div class="ouds-inline-label">
            <label for="ouds-leisure">Leisure:</label>
            <input type="text" id="ouds-leisure">
        </div>

        <h3>Objective:</h3>
        <div class="ouds-inline-label">
            <label for="ouds-mse">MSE:</label>
            <div>
                <textarea id="ouds-mse" rows="4" readonly placeholder="Click 'Open MSE Form' to complete..."></textarea>
                <button type="button" class="mse-button open-mse-modal-btn" data-target="ouds-mse" style="width: auto; padding: 8px 16px;">Open Full MSE Form</button>
            </div>
        </div>
        
        <h3>I-STOP/Prescription Monitoring:</h3>
        <textarea id="ouds-istop" placeholder="Date(s) reviewed, medications dispensed, quantities."></textarea>
        
        <h3>UDS Results (Reviewed):</h3>
        <textarea id="ouds-uds" placeholder="Date, results, and how it informs assessment."></textarea>

        <h3>Assessment:</h3>
        <p>Opioid Use Disorder appropriate for pharmacotherapy</p>
<div class="checkbox-container"><input type="checkbox" id="ouds-assess-purpose"><label for="ouds-assess-purpose"><b>Medication Purpose & Use:</b> Discussed that buprenorphine is a partial opioid agonist used to treat opioid use disorder by reducing cravings and withdrawal symptoms. Explained the induction process and the need to be in mild to moderate withdrawal before first dose to avoid precipitated withdrawal. Reviewed dosing schedule, route of administration (typically sublingual or buccal), and importance of adherence.</label></div>
<div class="checkbox-container"><input type="checkbox" id="ouds-assess-side-effects"><label for="ouds-assess-side-effects"><b>Potential Side Effects:</b> Reviewed common side effects (e.g., headache, constipation, nausea, sedation) and rare but serious risks (e.g., respiratory depression when combined with other sedatives, hepatic injury).</label></div>
<div class="checkbox-container"><input type="checkbox" id="ouds-assess-overdose"><label for="ouds-assess-overdose"><b>Overdose Risk & Safety:</b> Advised that risk of overdose is lower than full opioid agonists but present if combined with other CNS depressants (benzodiazepines, alcohol). Provided prescription for Naloxone and instructed patient/family on its use.</label></div>
<div class="checkbox-container"><input type="checkbox" id="ouds-assess-dental"><label for="ouds-assess-dental"><b>Dental Health Considerations:</b> Educated patient that use of buprenorphine, especially in sublingual/buccal forms, has been associated with dental problems (tooth decay, cavities, oral infections). Recommended rinsing mouth with water after each dose, waiting at least 1 hour after taking medication before brushing teeth, maintaining regular dental hygiene, and notifying dentist about buprenorphine use.</label></div>
<div class="checkbox-container"><input type="checkbox" id="ouds-assess-followup"><label for="ouds-assess-followup"><b>Follow-up & Monitoring:</b> Explained need for regular follow-up appointments to assess response, side effects, urine drug testing, and support services (counseling, behavioral therapy).</label></div>
<div class="checkbox-container"><input type="checkbox" id="ouds-assess-consent"><label for="ouds-assess-consent"><b>Informed Consent:</b> Patient expressed understanding of risks and benefits, and agreed to start buprenorphine treatment.</label></div>
<div class="checkbox-container"><input type="checkbox" id="ouds-assess-therapeutic-contract"><label for="ouds-assess-therapeutic-contract" style="color: red; font-weight: bold;">Reviewed & Signed Therapeutic Contract</label></div>
<h3>Plan:</h3>
        <div class="ouds-aligned-item">
            <span>
                <input type="checkbox" id="ouds-plan-start">
                <label for="ouds-plan-start">Start buprenorphine as discussed</label>
            </span>
        </div>
        <div class="ouds-aligned-item">
            <span>
                <input type="checkbox" id="ouds-plan-prescribe">
                <label for="ouds-plan-prescribe">Provide prescription and instructions</label>
            </span>
        </div>
        <div class="ouds-aligned-item">
            <span>
                <input type="checkbox" id="ouds-plan-naloxone">
                <label for="ouds-plan-naloxone">Provide naloxone kit</label>
            </span>
        </div>
        <div class="ouds-aligned-item">
            <label for="ouds-plan-followup-time">Schedule follow-up in</label>
            <input type="text" id="ouds-plan-followup-time" placeholder="time frame" class="inline-form-element">
        </div>
        <div class="ouds-aligned-item">
            <span>
                <input type="checkbox" id="ouds-plan-dental">
                <label for="ouds-plan-dental">Encourage dental visit within next 3 months</label>
            </span>
        </div>

        <h3>Time Statement</h3>
        <p>Today's visit time consisted of the following:</p>
        <div class="ouds-aligned-item">
            <span>
                <input type="checkbox" id="ouds-time-face">
                <label for="ouds-time-face">Face to face/telephonic time:</label>
            </span>
            <input type="text" id="ouds-time-face-txt" class="inline-form-element">
        </div>
        <div class="ouds-aligned-item">
            <span>
                <input type="checkbox" id="ouds-time-doc">
                <label for="ouds-time-doc">Documentation:</label>
            </span>
            <input type="text" id="ouds-time-doc-txt" class="inline-form-element">
        </div>
        <div class="ouds-aligned-item">
            <span>
                <input type="checkbox" id="ouds-time-coord">
                <label for="ouds-time-coord">Coordination of care:</label>
            </span>
            <input type="text" id="ouds-time-coord-txt" class="inline-form-element">
        </div>
        <div class="ouds-aligned-item">
            <span>
                <input type="checkbox" id="ouds-time-total">
                <label for="ouds-time-total">Total visit time:</label>
            </span>
            <input type="text" id="ouds-time-total-txt" class="inline-form-element">
        </div>
    </div>
<div id="alcohol-use-disorder-short-container" class="note-container hidden">
    <h2 style="margin-top: 20px;">Alcohol Use Disorder Short</h2>
    <p>New patient visit.</p>
    
    <div class="auds-inline-label" id="auds-chief-complaint-display-label">
        <label>Chief Complaint: Alcohol Use Disorder</label>
    </div>

    <h3>Alcohol Use History</h3>
    <div class="auds-inline-label">
        <label for="auds-age-first-use">Age at first use:</label>
        <input type="text" id="auds-age-first-use">
    </div>
    <div class="auds-inline-label">
        <label for="auds-types-alcohol">Type(s) of Alcohol:</label>
        <input type="text" id="auds-types-alcohol">
    </div>
    <div class="auds-inline-label">
        <label for="auds-frequency">Frequency of use:</label>
        <input type="text" id="auds-frequency">
    </div>
    <div class="auds-inline-label">
        <label for="auds-prev-treatment">Previous treatment programs:</label>
        <input type="text" id="auds-prev-treatment">
    </div>
    <div class="auds-inline-label">
        <label for="auds-prev-recovery">Previous periods in recovery:</label>
        <input type="text" id="auds-prev-recovery">
    </div>
    <div class="auds-inline-label">
        <label for="auds-withdrawal-exp">Experience of withdrawal symptoms in past:</label>
        <input type="text" id="auds-withdrawal-exp">
    </div>
    <div class="auds-inline-label">
        <label for="auds-withdrawal-severity">Severity of withdrawal:</label>
        <input type="text" id="auds-withdrawal-severity">
    </div>
    <div class="auds-inline-label">
        <label>Current active drinking:</label>
        <div class="radio-group">
            <label><input type="radio" name="auds-active-drinking" value="yes"> Yes</label>
            <label><input type="radio" name="auds-active-drinking" value="no"> No</label>
        </div>
    </div>
    <div id="auds-last-drink-date-row" class="conditional hidden auds-inline-label">
        <label for="auds-last-drink-date">If yes, when was last drink:</label>
        <input type="date" id="auds-last-drink-date">
    </div>

    <h3>Pharmacotherapy</h3>
    <div class="auds-inline-label">
        <label>Patient current on pharmacotherapy for AUD:</label>
        <div class="radio-group">
            <label><input type="radio" name="auds-pharmacotherapy" value="yes"> Yes</label>
            <label><input type="radio" name="auds-pharmacotherapy" value="no"> No</label>
        </div>
    </div>
    <div id="auds-pharm-fields" class="conditional hidden">
        <div class="auds-inline-label">
            <label for="auds-symptoms">Symptoms/Cravings:</label>
            <textarea id="auds-symptoms" placeholder="Document client’s current symptoms, cravings, or withdrawal signs."></textarea>
        </div>
        <div class="auds-inline-label">
            <label for="auds-substance-use">Substance Use:</label>
            <textarea id="auds-substance-use" placeholder="Document any substance use or alcohol use since started medication"></textarea>
        </div>
        <div class="auds-inline-label">
            <label for="auds-adherence">Medication Adherence:</label>
            <textarea id="auds-adherence" placeholder="Document if taking medications as prescribed."></textarea>
        </div>
        <div class="auds-inline-label">
            <label for="auds-side-effects">Side Effects/Complications:</label>
            <textarea id="auds-side-effects" placeholder="Note presence/absence of side effects."></textarea>
        </div>
    </div>

    <h3>Any other substance use?</h3>
    <p style="font-size: 0.9em; color: #555;">(Check all that apply and enter amount and last date of use)</p>
    <div id="auds-substance-list">
        <div class="auds-substance-grid">
            <div class="checkbox-container" style="margin:0; padding:0; background:none; border:none;"><input type="checkbox" id="auds-sub-illicit-opioids"><label for="auds-sub-illicit-opioids">Illicit opioids:</label></div>
            <input type="text" id="auds-amt-illicit-opioids" class="hidden" placeholder="Amount Used">
            <input type="date" id="auds-date-illicit-opioids" class="hidden">
        </div>
        <div class="auds-substance-grid">
            <div class="checkbox-container" style="margin:0; padding:0; background:none; border:none;"><input type="checkbox" id="auds-sub-prescription-opioids"><label for="auds-sub-prescription-opioids">Prescription opioids:</label></div>
            <input type="text" id="auds-amt-prescription-opioids" class="hidden" placeholder="Amount Used">
            <input type="date" id="auds-date-prescription-opioids" class="hidden">
        </div>
        <div class="auds-substance-grid">
            <div class="checkbox-container" style="margin:0; padding:0; background:none; border:none;"><input type="checkbox" id="auds-sub-kratom"><label for="auds-sub-kratom">Kratom:</label></div>
            <input type="text" id="auds-amt-kratom" class="hidden" placeholder="Amount Used">
            <input type="date" id="auds-date-kratom" class="hidden">
        </div>
        <div class="auds-substance-grid">
            <div class="checkbox-container" style="margin:0; padding:0; background:none; border:none;"><input type="checkbox" id="auds-sub-ivdu"><label for="auds-sub-ivdu">IVDU:</label></div>
            <input type="text" id="auds-amt-ivdu" class="hidden" placeholder="Amount Used">
            <input type="date" id="auds-date-ivdu" class="hidden">
        </div>
         <div class="auds-substance-grid">
            <div class="checkbox-container" style="margin:0; padding:0; background:none; border:none;"><input type="checkbox" id="auds-sub-benzodiazepines"><label for="auds-sub-benzodiazepines">Benzodiazepines:</label></div>
            <input type="text" id="auds-amt-benzodiazepines" class="hidden" placeholder="Amount Used">
            <input type="date" id="auds-date-benzodiazepines" class="hidden">
        </div>
        <div class="auds-substance-grid">
            <div class="checkbox-container" style="margin:0; padding:0; background:none; border:none;"><input type="checkbox" id="auds-sub-cocaine"><label for="auds-sub-cocaine">Cocaine:</label></div>
            <input type="text" id="auds-amt-cocaine" class="hidden" placeholder="Amount Used">
            <input type="date" id="auds-date-cocaine" class="hidden">
        </div>
        <div class="auds-substance-grid">
            <div class="checkbox-container" style="margin:0; padding:0; background:none; border:none;"><input type="checkbox" id="auds-sub-amphet"><label for="auds-sub-amphet">Amphetamine / Methamphetamines / Crystal Meth:</label></div>
            <input type="text" id="auds-amt-amphet" class="hidden" placeholder="Amount Used">
            <input type="date" id="auds-date-amphet" class="hidden">
        </div>
        <div class="auds-substance-grid">
            <div class="checkbox-container" style="margin:0; padding:0; background:none; border:none;"><input type="checkbox" id="auds-sub-hallucinogens"><label for="auds-sub-hallucinogens">Hallucinogens:</label></div>
            <input type="text" id="auds-amt-hallucinogens" class="hidden" placeholder="Amount Used">
            <input type="date" id="auds-date-hallucinogens" class="hidden">
        </div>
        <div class="auds-substance-grid">
            <div class="checkbox-container" style="margin:0; padding:0; background:none; border:none;"><input type="checkbox" id="auds-sub-mdma"><label for="auds-sub-mdma">MDMA:</label></div>
            <input type="text" id="auds-amt-mdma" class="hidden" placeholder="Amount Used">
            <input type="date" id="auds-date-mdma" class="hidden">
        </div>
        <div class="auds-substance-grid">
            <div class="checkbox-container" style="margin:0; padding:0; background:none; border:none;"><input type="checkbox" id="auds-sub-alcohol"><label for="auds-sub-alcohol">Alcohol:</label></div>
            <input type="text" id="auds-amt-alcohol" class="hidden" placeholder="Amount Used">
            <input type="date" id="auds-date-alcohol" class="hidden">
        </div>
        <div class="auds-substance-grid">
            <div class="checkbox-container" style="margin:0; padding:0; background:none; border:none;"><input type="checkbox" id="auds-sub-nicotine"><label for="auds-sub-nicotine">Nicotine use:</label></div>
            <input type="text" id="auds-amt-nicotine" class="hidden" placeholder="Amount Used">
            <input type="date" id="auds-date-nicotine" class="hidden">
        </div>
    </div>

    <h3>Medical History Related to Substance Use</h3>
    <div class="checkbox-container"><input type="checkbox" id="auds-med-ivdu"><label for="auds-med-ivdu">History of IV drug use</label></div>
    <div class="checkbox-container"><input type="checkbox" id="auds-med-shared"><label for="auds-med-shared">History of shared needles</label></div>
    <div class="checkbox-container"><input type="checkbox" id="auds-med-hep-c"><label for="auds-med-hep-c">History of Hepatitis C</label></div>
    <div class="checkbox-container"><input type="checkbox" id="auds-med-hiv"><label for="auds-med-hiv">History of HIV</label></div>

    <div class="auds-inline-label">
        <label for="auds-pmh">PMH:</label>
        <textarea id="auds-pmh" rows="2"></textarea>
    </div>
    <div class="auds-inline-label">
        <label for="auds-psych">Psych History:</label>
        <textarea id="auds-psych" rows="2"></textarea>
    </div>
    <div class="auds-inline-label">
        <label for="auds-medications">Medications:</label>
        <textarea id="auds-medications" rows="2"></textarea>
    </div>
    <div class="auds-inline-label">
        <label for="auds-allergies">Allergies:</label>
        <textarea id="auds-allergies" rows="2"></textarea>
    </div>
    <div class="auds-inline-label">
        <label for="auds-pcp">PCP:</label>
        <input type="text" id="auds-pcp">
    </div>
    <div class="auds-inline-label">
        <label for="auds-last-pcp-visit">Last Visit with PCP:</label>
        <input type="date" id="auds-last-pcp-visit">
    </div>
    <div class="checkbox-container" style="padding-left: 0; background: none; border: none;">
         <input type="checkbox" id="auds-pcp-referral">
         <label for="auds-pcp-referral">Client requires assistance securing a PCP.</label>
    </div>

    <h3>Pertinent Review of Systems</h3>
    <div class="auds-inline-label">
        <label>- GI: Constipation:</label>
        <div class="radio-group">
            <label><input type="radio" name="auds-gi-const" value="yes"> Yes</label>
            <label><input type="radio" name="auds-gi-const" value="no"> No</label>
        </div>
    </div>
    <div class="auds-inline-label">
            <label for="auds-psych-ideation">- Psychiatric: Suicidal or Homicidal Ideation:</label>
            <select id="auds-psych-ideation" class="inline-form-element">
                <option value="Denies SI/HI">Denies SI/HI</option>
                <option value="Endorses SI">Endorses SI</option>
                <option value="Endorses HI">Endorses HI</option>
                <option value="Endorses SI/HI">Endorses SI/HI</option>
            </select>
        </div>
    <div id="auds-safety-planning-container" class="checkbox-container hidden" style="background:none; border:none; padding-left: 20px;">
        <input type="checkbox" id="auds-safety-planning-checkbox">
        <label for="auds-safety-planning-checkbox" style="color: red; font-weight: bold;">Staff provided safety planning</label>
    </div>

    <div class="auds-inline-label">
        <label for="auds-family">Family History:</label>
        <textarea id="auds-family" rows="2"></textarea>
    </div>
    <div class="auds-inline-label">
        <label for="auds-social">Social:</label>
        <input type="text" id="auds-social">
    </div>
    <div class="auds-inline-label">
        <label for="auds-living">Current Living Situation:</label>
        <input type="text" id="auds-living">
    </div>
    <div class="auds-inline-label">
        <label for="auds-employment">Employment:</label>
        <input type="text" id="auds-employment">
    </div>
    <div class="auds-inline-label">
        <label for="auds-leisure">Leisure:</label>
        <input type="text" id="auds-leisure">
    </div>

   <h3>Objective:</h3>
    <div class="auds-inline-label">
        <label for="auds-mse">MSE:</label>
        <div>
            <textarea id="auds-mse" rows="4" readonly placeholder="Click 'Open MSE Form' to complete..."></textarea>
            <button type="button" class="mse-button open-mse-modal-btn" data-target="auds-mse" style="width: auto; padding: 8px 16px;">Open Full MSE Form</button>
        </div>
    </div>

    <h3>I-STOP/Prescription Monitoring:</h3>
    <textarea id="auds-istop" placeholder="Date(s) reviewed, medications dispensed, quantities."></textarea>
    
    <h3>UDS Results (Reviewed):</h3>
    <textarea id="auds-uds" placeholder="Date, results, and how it informs assessment."></textarea>

    <h3>Assessment:</h3>
    <div id="auds-assessment-options">
        <p><strong>Alcohol Use Disorder appropriate for pharmacotherapy</strong></p>
        <hr>
        <div class="info-box" style="margin-top:15px;">
            <h4>General Counseling Provided</h4>
            <div class="checkbox-container"><input type="checkbox" id="auds-assess-purpose"><label for="auds-assess-purpose"><b>Purpose of Medications:</b> Discussed that medications can support recovery from alcohol use disorder by reducing cravings, reducing pleasurable effects of alcohol, and helping maintain abstinence. Reviewed that medication works best combined with counseling/behavioral therapy.</label></div>
            <h5>Medication Options and Key Counseling Points:</h5>
            <div class="checkbox-container"><input type="checkbox" id="auds-assess-naltrexone"><label for="auds-assess-naltrexone"><b>Naltrexone (oral or injectable):</b> Blocks opioid receptors to reduce rewarding effects of alcohol and decrease cravings. May cause nausea, headache, dizziness, fatigue. Should not be used if patient is currently using opioids or has acute hepatitis/liver failure. Importance of checking baseline liver function tests and periodic monitoring.</label></div>
            <div class="checkbox-container"><input type="checkbox" id="auds-assess-acamprosate"><label for="auds-assess-acamprosate"><b>Acamprosate:</b> Helps restore brain chemical balance and reduce post-acute withdrawal symptoms/cravings. Generally well tolerated; may cause diarrhea. Requires dosing three times daily. Safe for use in liver disease but contraindicated in severe renal impairment — baseline kidney function to be checked.</label></div>
            <div class="checkbox-container"><input type="checkbox" id="auds-assess-disulfiram"><label for="auds-assess-disulfiram"><b>Disulfiram:</b> Causes unpleasant reaction (flushing, nausea, vomiting, tachycardia) if alcohol is consumed. Must be fully abstinent before starting. Discussed risk of hepatotoxicity; will monitor liver function. Warned about avoiding alcohol-containing products (mouthwash, cough syrups, sauces, etc.).</label></div>
            <div class="checkbox-container"><input type="checkbox" id="auds-assess-safety-monitoring"><label for="auds-assess-safety-monitoring"><b>Safety & Monitoring:</b> Emphasized the need for medication adherence. Reviewed possible drug interactions and need to inform all healthcare providers of medication use. Arranged for baseline liver/kidney labs as appropriate, with periodic monitoring.</label></div>
            <div class="checkbox-container"><input type="checkbox" id="auds-assess-behavioral"><label for="auds-assess-behavioral"><b>Behavioral Support:</b> Reinforced that medication is most effective when combined with counseling, therapy, or mutual support groups (e.g., Alcoholics Anonymous). Provided resources for behavioral support.</label></div>
            <div class="checkbox-container"><input type="checkbox" id="auds-assess-consent"><label for="auds-assess-consent"><b>Informed Consent:</b> Patient verbalized understanding of medication options, side effects, and the importance of ongoing support. Patient agreed to start <input type="text" id="auds-chosen-med" class="inline-form-element" placeholder="[chosen medication]"></label></div>
        </div>
         <div class="info-box" style="margin-top:15px;">
            <h4>Naltrexone — Detailed Counseling Note</h4>
            <div class="checkbox-container"><input type="checkbox" id="auds-naltrexone-purpose"><label for="auds-naltrexone-purpose"><b>Medication Purpose & Mechanism:</b> Explained that naltrexone blocks opioid receptors to reduce the pleasurable effects of alcohol and help decrease cravings.</label></div>
            <div class="checkbox-container"><input type="checkbox" id="auds-naltrexone-dosing"><label for="auds-naltrexone-dosing"><b>Dosing & Administration:</b> Reviewed once-daily oral form or monthly injectable (Vivitrol) option. Patient to start on oral formulation first to confirm tolerability before long-acting injectable, if indicated.</label></div>
            <div class="checkbox-container"><input type="checkbox" id="auds-naltrexone-side-effects"><label for="auds-naltrexone-side-effects"><b>Side Effects:</b> Discussed common side effects (nausea, headache, dizziness, fatigue) and rare but serious risks (hepatotoxicity, allergic reaction).</label></div>
            <div class="checkbox-container"><input type="checkbox" id="auds-naltrexone-safety"><label for="auds-naltrexone-safety"><b>Safety Considerations:</b> Must be opioid-free for at least 7–10 days before starting to avoid precipitated withdrawal. Not to be used if patient has acute hepatitis or liver failure. Will obtain baseline liver function tests and monitor periodically. Carry medical alert card/bracelet noting naltrexone use.</label></div>
            <div class="checkbox-container"><input type="checkbox" id="auds-naltrexone-support"><label for="auds-naltrexone-support"><b>Behavioral Support:</b> Encouraged concurrent participation in counseling or mutual support groups (e.g., Alcoholics Anonymous) to enhance success.</label></div>
            <div class="checkbox-container"><input type="checkbox" id="auds-naltrexone-consent"><label for="auds-naltrexone-consent"><b>Informed Consent:</b> Patient verbalized understanding of risks, benefits, and alternatives and agreed to start naltrexone.</label></div>
        </div>
        <div class="info-box" style="margin-top:15px;">
            <h4>Acamprosate — Detailed Counseling Note</h4>
             <div class="checkbox-container"><input type="checkbox" id="auds-acamprosate-purpose"><label for="auds-acamprosate-purpose"><b>Medication Purpose & Mechanism:</b> Explained that acamprosate helps reduce post-acute withdrawal symptoms and cravings by restoring brain neurotransmitter balance disrupted by chronic alcohol use.</label></div>
            <div class="checkbox-container"><input type="checkbox" id="auds-acamprosate-dosing"><label for="auds-acamprosate-dosing"><b>Dosing & Administration:</b> Taken as 666 mg three times daily (may need dose adjustment for low body weight). Emphasized importance of adherence to TID dosing schedule.</label></div>
            <div class="checkbox-container"><input type="checkbox" id="auds-acamprosate-side-effects"><label for="auds-acamprosate-side-effects"><b>Side Effects:</b> Discussed common side effect of diarrhea and possible GI upset; usually mild and transient. Generally well tolerated.</label></div>
            <div class="checkbox-container"><input type="checkbox" id="auds-acamprosate-safety"><label for="auds-acamprosate-safety"><b>Safety Considerations:</b> Safe for patients with liver disease. Contraindicated in severe renal impairment (CrCl ≤30 mL/min); use caution in moderate renal impairment. Will obtain baseline renal function prior to initiation.</label></div>
            <div class="checkbox-container"><input type="checkbox" id="auds-acamprosate-support"><label for="auds-acamprosate-support"><b>Behavioral Support:</b> Reinforced need for concurrent counseling or support group involvement to improve success rates.</label></div>
            <div class="checkbox-container"><input type="checkbox" id="auds-acamprosate-consent"><label for="auds-acamprosate-consent"><b>Informed Consent:</b> Patient verbalized understanding of medication purpose, side effects, and agreed to start acamprosate.</label></div>
        </div>
        <div class="info-box" style="margin-top:15px;">
            <h4>Disulfiram — Detailed Counseling Note</h4>
            <div class="checkbox-container"><input type="checkbox" id="auds-disulfiram-purpose"><label for="auds-disulfiram-purpose"><b>Medication Purpose & Mechanism:</b> Explained that disulfiram works as an alcohol deterrent by causing an unpleasant physical reaction if alcohol is consumed (flushing, nausea, vomiting, headache, palpitations).</label></div>
            <div class="checkbox-container"><input type="checkbox" id="auds-disulfiram-dosing"><label for="auds-disulfiram-dosing"><b>Dosing & Administration:</b> Taken once daily; must be started only after patient has been completely abstinent from alcohol for at least 12–24 hours.</label></div>
            <div class="checkbox-container"><input type="checkbox" id="auds-disulfiram-side-effects"><label for="auds-disulfiram-side-effects"><b>Side Effects:</b> Reviewed potential side effects (drowsiness, fatigue, metallic taste) and rare but serious effects (hepatotoxicity, neuropathy, psychosis).</label></div>
            <div class="checkbox-container"><input type="checkbox" id="auds-disulfiram-safety"><label for="auds-disulfiram-safety"><b>Safety Considerations:</b> Avoid all forms of alcohol (including hidden sources: mouthwash, cough syrups, sauces, topical products, colognes). Baseline liver function tests prior to starting; monitor periodically. Discussed that disulfiram reaction can occur up to 14 days after last dose.</label></div>
            <div class="checkbox-container"><input type="checkbox" id="auds-disulfiram-support"><label for="auds-disulfiram-support"><b>Behavioral Support:</b> Emphasized that disulfiram works best when combined with behavioral therapy or counseling.</label></div>
            <div class="checkbox-container"><input type="checkbox" id="auds-disulfiram-consent"><label for="auds-disulfiram-consent"><b>Informed Consent:</b> Patient verbalized understanding of mechanism, risks, and need for strict alcohol abstinence, and agreed to start disulfiram.</label></div>
        </div>
    </div>

    <h3>Plan:</h3>
    <div id="auds-plan-options">
         <div class="info-box" style="margin-top:15px;">
            <h4>General Plan</h4>
            <div class="checkbox-container"><input type="checkbox" id="auds-plan-gen-start"><label for="auds-plan-gen-start">Start <input type="text" class="inline-form-element" placeholder="[chosen medication]"> as discussed</label></div>
            <div class="checkbox-container"><input type="checkbox" id="auds-plan-gen-labs"><label for="auds-plan-gen-labs">Obtain baseline labs (LFTs, renal function as indicated)</label></div>
            <div class="checkbox-container"><input type="checkbox" id="auds-plan-gen-support"><label for="auds-plan-gen-support">Provide counseling/referral to behavioral support</label></div>
            <div class="checkbox-container"><input type="checkbox" id="auds-plan-gen-fup"><label for="auds-plan-gen-fup">Schedule follow-up in 2–4 weeks to assess response, side effects, adherence</label></div>
            <div class="checkbox-container"><input type="checkbox" id="auds-plan-gen-pcp"><label for="auds-plan-gen-pcp">F/U with nurse to support connection with PCP</label></div>
        </div>
        <div class="info-box" style="margin-top:15px;">
            <h4>Naltrexone Plan</h4>
            <div class="checkbox-container"><input type="checkbox" id="auds-plan-nal-start"><label for="auds-plan-nal-start">Start oral naltrexone 50 mg daily</label></div>
            <div class="checkbox-container"><input type="checkbox" id="auds-plan-nal-labs"><label for="auds-plan-nal-labs">Obtain baseline LFTs</label></div>
            <div class="checkbox-container"><input type="checkbox" id="auds-plan-nal-fup"><label for="auds-plan-nal-fup">Schedule follow-up in 2–4 weeks</label></div>
            <div class="checkbox-container"><input type="checkbox" id="auds-plan-nal-pcp"><label for="auds-plan-nal-pcp">F/U with nurse to support connection with PCP</label></div>
        </div>
         <div class="info-box" style="margin-top:15px;">
            <h4>Acamprosate Plan</h4>
            <div class="checkbox-container"><input type="checkbox" id="auds-plan-aca-start"><label for="auds-plan-aca-start">Start acamprosate 666 mg TID</label></div>
            <div class="checkbox-container"><input type="checkbox" id="auds-plan-aca-labs"><label for="auds-plan-aca-labs">Obtain baseline renal function</label></div>
            <div class="checkbox-container"><input type="checkbox" id="auds-plan-aca-fup"><label for="auds-plan-aca-fup">Schedule follow-up in 2–4 weeks</label></div>
            <div class="checkbox-container"><input type="checkbox" id="auds-plan-aca-pcp"><label for="auds-plan-aca-pcp">F/U with nurse to support connection with PCP</label></div>
        </div>
        <div class="info-box" style="margin-top:15px;">
            <h4>Disulfiram Plan</h4>
            <div class="checkbox-container"><input type="checkbox" id="auds-plan-dis-start"><label for="auds-plan-dis-start">Start disulfiram 250 mg daily</label></div>
            <div class="checkbox-container"><input type="checkbox" id="auds-plan-dis-labs"><label for="auds-plan-dis-labs">Obtain baseline LFTs</label></div>
            <div class="checkbox-container"><input type="checkbox" id="auds-plan-dis-fup"><label for="auds-plan-dis-fup">Schedule follow-up in 2–4 weeks</label></div>
            <div class="checkbox-container"><input type="checkbox" id="auds-plan-dis-pcp"><label for="auds-plan-dis-pcp">F/U with nurse to support connection with PCP</label></div>
        </div>
    </div>

    <h3>Time Statement</h3>
    <p>Today's visit time consisted of the following:</p>
    <div class="auds-aligned-item">
        <span>
            <input type="checkbox" id="auds-time-face">
            <label for="auds-time-face">Face to face/telephonic time:</label>
        </span>
        <input type="text" id="auds-time-face-txt" class="inline-form-element">
    </div>
    <div class="auds-aligned-item">
        <span>
            <input type="checkbox" id="auds-time-doc">
            <label for="auds-time-doc">Documentation:</label>
        </span>
        <input type="text" id="auds-time-doc-txt" class="inline-form-element">
    </div>
    <div class="auds-aligned-item">
        <span>
            <input type="checkbox" id="auds-time-coord">
            <label for="auds-time-coord">Coordination of care:</label>
        </span>
        <input type="text" id="auds-time-coord-txt" class="inline-form-element">
    </div>
    <div class="auds-aligned-item">
        <span>
            <input type="checkbox" id="auds-time-total">
            <label for="auds-time-total">Total visit time:</label>
        </span>
        <input type="text" id="auds-time-total-txt" class="inline-form-element">
    </div>
</div>
<div id="nurse-follow-up-container" class="note-container hidden">
        <h2 style="margin-top: 20px;">Nurse Follow Up</h2>

        <label for="nurse-diag">Diagnosis:</label>
        <textarea id="nurse-diag"></textarea>

        <label for="nurse-goal">Goal:</label>
        <textarea id="nurse-goal" placeholder="Client will maintain and improve overall health status through engagement with the medical team as needed, including medical monitoring and adherence to provider recommendations, to support recovery and well-being."></textarea>

        <label for="nurse-reason">Reason for visit:</label>
        <textarea id="nurse-reason" placeholder="One sentence, can be a client quote. Example: Client is presenting for a medical screening; Client is presenting for monitoring and support with referrals."></textarea>

        <label for="nurse-services">Services provided & Client observations:</label>
        <textarea id="nurse-services" placeholder="Should connect to selected goal. Example: I reviewed client's relevant medical history pertaining to their treatment in the clinic. I supported the client through (screening, monitoring, education, or referrals)...I observed client to...(how presenting in session, impressions)."></textarea>

    <label>Interventions:</label>
        <div id="nurse-interventions-container">
                    </div>

        <label for="nurse-response">Client's response:</label>
        <textarea id="nurse-response" placeholder="Try to include a quote. Example: Client's response to your interventions - Client was responsive to education and discussion of referrals. Client identified clarity on next steps to pursue medication management."></textarea>

        <label>Plan/Next Steps:</label>
        <div id="nurse-plan-checkboxes" style="background-color: #f8f9fa; border: 1px solid #e0e0e0; padding: 15px; margin: 10px 0; border-radius: 4px;">
            <div class="checkbox-container" style="background-color: transparent; border: none; padding: 0; margin: 12px 0; display: flex; align-items: center; gap: 10px;">
                <input type="checkbox" id="nurse-plan-checkbox-1" data-text="Continued current medication regimen." style="flex-shrink: 0;">
                <label for="nurse-plan-checkbox-1" style="margin: 0; flex-grow: 1;">Continued current medication regimen</label>
            </div>
            <div class="checkbox-container" style="background-color: transparent; border: none; padding: 0; margin: 12px 0; display: flex; align-items: center; gap: 10px;">
                <input type="checkbox" id="nurse-plan-checkbox-2" data-text="Encouraged continued attendance in counseling/group." style="flex-shrink: 0;">
                <label for="nurse-plan-checkbox-2" style="margin: 0; flex-grow: 1;">Encouraged continued attendance in counseling/group</label>
            </div>
            <div class="checkbox-container" style="background-color: transparent; border: none; padding: 0; margin: 12px 0; display: flex; align-items: center; gap: 10px;">
                <input type="checkbox" id="nurse-plan-checkbox-3" data-text="Referred to RN/NP/MD for " style="flex-shrink: 0;">
                <label for="nurse-plan-checkbox-3" style="margin: 0;">Referred to RN/NP/MD for</label>
                <input type="text" id="nurse-plan-custom-3" placeholder="e.g., medication concerns" style="flex: 1; min-width: 200px; padding: 8px; border: 1px solid #ccc; border-radius: 4px; font-size: 14px;">
            </div>
            <div class="checkbox-container" style="background-color: transparent; border: none; padding: 0; margin: 12px 0; display: flex; align-items: center; gap: 10px;">
                <input type="checkbox" id="nurse-plan-checkbox-4" data-text="Scheduled next appointment for " style="flex-shrink: 0;">
                <label for="nurse-plan-checkbox-4" style="margin: 0;">Scheduled next appointment for</label>
                <input type="date" id="nurse-plan-custom-4" style="flex: 1; min-width: 200px; padding: 8px; border: 1px solid #ccc; border-radius: 4px; font-size: 14px;">
            </div>
        </div>

        <label for="nurse-plan">Additional Notes:</label>
        <textarea id="nurse-plan" placeholder="Add any additional plan/next steps information. Checked items above will be included in the note."></textarea>
    </div>
    
    <!-- Container for OP Alcohol Detox -->
    <div id="op-alcohol-detox-container" class="note-container hidden">
        <h2 style="margin-top: 20px;">OP Alcohol Detox</h2>

        <label for="op-chief">Chief Complaint</label>
        <div style="display:flex; gap:8px; align-items:center;">
            <select id="op-chief-quick" style="min-width: 220px;">
                <option value="">Select an option</option>
                <option value="I want to stop drinking">I want to stop drinking</option>
                <option value="Follow-up for alcohol detox">Follow-up for alcohol detox</option>
            </select>
            <input type="text" id="op-chief" value="" style="flex:1; padding:8px;" />
        </div>

        <h3 style="margin-top:12px;">History of Present Illness (HPI)</h3>
        <label>Alcohol use history:</label>
        <label style="display:block;">Onset and duration of alcohol use: <span style="font-size:0.8em; font-style:italic; color:#666;">(e.g., since teens)</span></label>
        <input type="text" id="op-hpi-onset" class="inline-form-element" />
        <label style="display:block;">Current quantity and frequency: <span style="font-size:0.8em; font-style:italic; color:#666;">(e.g., 6 drinks/day)</span></label>
        <input type="text" id="op-hpi-qty" class="inline-form-element" />
        <label style="display:block;">Type of alcohol (beer, wine, liquor): <span style="font-size:0.8em; font-style:italic; color:#666;">(e.g., beer)</span></label>
        <input type="text" id="op-hpi-type" class="inline-form-element" />
        <label style="display:block;">Last drink (date/time): <span style="font-size:0.8em; font-style:italic; color:#666;">(date/time)</span></label>
        <input type="text" id="op-hpi-last-drink" class="inline-form-element" />
        <label style="display:block;">Previous withdrawal symptoms: <span style="font-size:0.8em; font-style:italic; color:#666;">(e.g., tremor, seizure, hallucination, delirium)</span></label>
        <textarea id="op-hpi-prev-withdrawal" rows="3"></textarea>
        <label>Prior detox attempts or rehab programs:</label>
        <textarea id="op-hpi-prior-detox" rows="3"></textarea>
        <label style="display:block;">Duration of sobriety periods: <span style="font-size:0.8em; font-style:italic; color:#666;">(e.g., longest time sober)</span></label>
        <input type="text" id="op-hpi-duration-sobriety" class="inline-form-element" />
        <label>Triggers or reasons for relapse (if applicable):</label>
        <textarea id="op-hpi-triggers" rows="3"></textarea>

        <label style="margin-top:10px;">Withdrawal symptoms currently:</label>
        <div style="display:grid; grid-template-columns: repeat(3, 1fr); gap:8px;">
            <label><input type="checkbox" id="op-w-tremor"> Tremor</label>
            <label><input type="checkbox" id="op-w-anxiety"> Anxiety</label>
            <label><input type="checkbox" id="op-w-nausea"> Nausea/Vomiting</label>
            <label><input type="checkbox" id="op-w-sweating"> Sweating</label>
            <label><input type="checkbox" id="op-w-insomnia"> Insomnia</label>
            <label><input type="checkbox" id="op-w-hallucinations"> Hallucinations</label>
            <label><input type="checkbox" id="op-w-seizures"> Seizures</label>
            <label><input type="checkbox" id="op-w-headache"> Headache</label>
            <label><input type="checkbox" id="op-w-palpitations"> Palpitations</label>
            <div style="grid-column: 1 / -1; display:flex; gap:8px; align-items:center;"><label style="margin:0;"><input type="checkbox" id="op-w-other"> Other:</label><input type="text" id="op-w-other-text" placeholder="specify" style="flex:1; padding:6px;"/></div>
        </div>

        <label style="display:block;">Associated symptoms: <span style="font-size:0.8em; font-style:italic; color:#666;">(depression, anxiety, suicidal ideation, cravings, etc.)</span></label>
        <textarea id="op-associated" rows="3"></textarea>
        <label style="display:block;">Support system: <span style="font-size:0.8em; font-style:italic; color:#666;">(family/friends/support groups)</span></label>
        <textarea id="op-support" rows="2"></textarea>
        <label style="display:block;">Social history: <span style="font-size:0.8em; font-style:italic; color:#666;">(living situation, employment, legal issues, driving, access to care)</span></label>
        <textarea id="op-social" rows="2"></textarea>
        <label style="display:block;">Motivation and goals: <span style="font-size:0.8em; font-style:italic; color:#666;">(readiness to change 1–10, treatment goals)</span></label>
        <textarea id="op-motivation" rows="2"></textarea>

        <h3 style="margin-top:12px;">Past Medical History</h3>
        <label style="display:block;">Medical: <span style="font-size:0.8em; font-style:italic; color:#666;">(e.g., liver disease, hypertension, pancreatitis, seizure disorder)</span></label>
        <textarea id="op-pmh-medical" rows="2"></textarea>
        <label style="display:block;">Psychiatric: <span style="font-size:0.8em; font-style:italic; color:#666;">(e.g., depression, anxiety, bipolar, PTSD)</span></label>
        <textarea id="op-pmh-psych" rows="2"></textarea>
        <label>Surgical:</label>
        <textarea id="op-pmh-surgical" rows="2"></textarea>
        <label>Allergies:</label>
        <textarea id="op-pmh-allergies" rows="2"></textarea>
        <label style="display:block;">Medications: <span style="font-size:0.8em; font-style:italic; color:#666;">(include psychiatric, antihypertensives, etc.)</span></label>
        <textarea id="op-pmh-meds" rows="2"></textarea>
        <label style="display:block;">Substance Use: <span style="font-size:0.8em; font-style:italic; color:#666;">(tobacco, other drugs, prescription misuse)</span></label>
        <textarea id="op-pmh-substance" rows="2"></textarea>

        <h3 style="margin-top:12px;">Family History</h3>
        <label style="display:block;">Family History: <span style="font-size:0.8em; font-style:italic; color:#666;">(alcoholism, mental illness, seizure disorder, suicide, etc.)</span></label>
        <textarea id="op-family" rows="2"></textarea>

        <h3 style="margin-top:12px;">Review of Systems (pertinent positives/negatives)</h3>
        <label style="display:block;">Constitutional: <span style="font-size:0.8em; font-style:italic; color:#666;">(fatigue, sweats, tremor)</span></label>
        <textarea id="op-ros-const" rows="2"></textarea>
        <label style="display:block;">Neuro: <span style="font-size:0.8em; font-style:italic; color:#666;">(headache, dizziness, confusion, seizure)</span></label>
        <textarea id="op-ros-neuro" rows="2"></textarea>
        <label style="display:block;">Psych: <span style="font-size:0.8em; font-style:italic; color:#666;">(anxiety, irritability, depression, hallucinations, suicidal ideation)</span></label>
        <textarea id="op-ros-psych" rows="2"></textarea>
        <label style="display:block;">GI: <span style="font-size:0.8em; font-style:italic; color:#666;">(nausea, vomiting, abdominal pain)</span></label>
        <textarea id="op-ros-gi" rows="2"></textarea>
        <label style="display:block;">Cardiac: <span style="font-size:0.8em; font-style:italic; color:#666;">(palpitations, chest pain)</span></label>
        <textarea id="op-ros-cardiac" rows="2"></textarea>

        <h3 style="margin-top:12px;">Objective</h3>
        <label>Vital Signs:</label>
        <div style="display:flex; gap:16px; flex-wrap:wrap;">
            <div style="display:flex; flex-direction:column; align-items:center;">
                <input type="text" id="op-vs-bp" style="width:100px; padding:6px; margin-bottom:6px;" />
                <label style="font-size:0.85em; text-align:center; margin:0;">BP</label>
            </div>
            <div style="display:flex; flex-direction:column; align-items:center;">
                <input type="text" id="op-vs-hr" style="width:80px; padding:6px; margin-bottom:6px;" />
                <label style="font-size:0.85em; text-align:center; margin:0;">HR</label>
            </div>
            <div style="display:flex; flex-direction:column; align-items:center;">
                <input type="text" id="op-vs-rr" style="width:80px; padding:6px; margin-bottom:6px;" />
                <label style="font-size:0.85em; text-align:center; margin:0;">RR</label>
            </div>
            <div style="display:flex; flex-direction:column; align-items:center;">
                <input type="text" id="op-vs-temp" style="width:100px; padding:6px; margin-bottom:6px;" />
                <label style="font-size:0.85em; text-align:center; margin:0;">Temp</label>
            </div>
            <div style="display:flex; flex-direction:column; align-items:center;">
                <input type="text" id="op-vs-spo2" style="width:100px; padding:6px; margin-bottom:6px;" />
                <label style="font-size:0.85em; text-align:center; margin:0;">SpO₂</label>
            </div>
        </div>

        <label>Physical Exam:</label>
        <label style="display:block;">General: <span style="font-size:0.8em; font-style:italic; color:#666;">(alert / drowsy / anxious / tremulous)</span></label>
        <textarea id="op-pe-general" rows="2"></textarea>
        <label style="display:block;">Neuro: <span style="font-size:0.8em; font-style:italic; color:#666;">(tremor present? orientation? gait? reflexes?)</span></label>
        <textarea id="op-pe-neuro" rows="2"></textarea>
        <label style="display:block;">Psychiatric: <span style="font-size:0.8em; font-style:italic; color:#666;">(mood, affect, thought process, insight/judgment)</span></label>
        <textarea id="op-pe-psych" rows="2"></textarea>

        <label>Withdrawal Scale: CIWA-Ar</label>
        <div style="display:flex; gap:8px; align-items:center;">
            <input type="number" id="op-ciwa-score" placeholder="CIWA-Ar score" style="width:140px; padding:6px;" min="0" max="70" oninput="updateDossingDisplay(); updateFinalNote();" />
            <button type="button" class="mse-button" id="open-ciwa-btn" style="width:auto; padding:8px 12px;">Open CIWA-Ar</button>
        </div>
        <div style="background-color:#f0f4f8; border-left:4px solid #3b82f6; padding:10px; margin:8px 0; font-size:0.9em;">
            <strong>CIWA-Ar Interpretation Scale:</strong><br/>
            0–9: Minimal/mild withdrawal risk; monitor for symptom progression<br/>
            10–19: Moderate withdrawal risk; pharmacological support recommended (benzodiazepine-based detoxification)<br/>
            20+: Severe withdrawal risk; strongly recommend inpatient detoxification and intensive pharmacological management
        </div>

        <label>Labs/Studies:</label>
        <div style="display:grid; grid-template-columns: auto 1fr; gap:8px; align-items:center;">
            <label><input type="checkbox" id="op-lab-cbc"> CBC</label><input type="text" id="op-lab-cbc-txt" placeholder="result/notes" style="width:100%;" />
            <label><input type="checkbox" id="op-lab-cmp"> CMP</label><input type="text" id="op-lab-cmp-txt" placeholder="result/notes" style="width:100%;" />
            <label><input type="checkbox" id="op-lab-lfts"> LFTs</label><input type="text" id="op-lab-lfts-txt" placeholder="result/notes" style="width:100%;" />
            <label><input type="checkbox" id="op-lab-mag"> Magnesium</label><input type="text" id="op-lab-mag-txt" placeholder="result/notes" style="width:100%;" />
            <label><input type="checkbox" id="op-lab-phos"> Phosphate</label><input type="text" id="op-lab-phos-txt" placeholder="result/notes" style="width:100%;" />
            <label><input type="checkbox" id="op-lab-uds"> Urine drug screen</label><input type="text" id="op-lab-uds-txt" placeholder="result/notes" style="width:100%;" />
            <label><input type="checkbox" id="op-lab-ethanol"> Serum ethanol</label><input type="text" id="op-lab-ethanol-txt" placeholder="result/notes" style="width:100%;" />
            <label><input type="checkbox" id="op-lab-preg"> Pregnancy test</label><input type="text" id="op-lab-preg-txt" placeholder="result/notes" style="width:100%;" />
        </div>

        <h3 style="margin-top:12px;">Assessment</h3>
        <label>Primary Diagnosis:</label>
        <select id="op-primary-dx">
            <option value="">Select an option</option>
            <option value="Alcohol Use Disorder, mild, with acute withdrawal">Alcohol Use Disorder, mild, with acute withdrawal</option>
            <option value="Alcohol Use Disorder, moderate, with acute withdrawal">Alcohol Use Disorder, moderate, with acute withdrawal</option>
            <option value="Alcohol Use Disorder, severe, with acute withdrawal">Alcohol Use Disorder, severe, with acute withdrawal</option>
        </select>
        <label style="display:block;">Secondary Diagnoses: <span style="font-size:0.8em; font-style:italic; color:#666;">(e.g., anxiety, hypertension)</span></label>
        <input type="text" id="op-secondary-dx" />
        <label>Risk Assessment:</label>
        <label>Withdrawal risk:</label>
        <select id="op-withdrawal-risk"><option value="">Select an option</option><option>Mild</option><option>Moderate</option><option>Severe</option></select>
        <label>Seizure or DT risk:</label>
        <select id="op-seizure-risk"><option value="">Select an option</option><option>Low</option><option>Moderate</option><option>High</option></select>
        <label>Social support adequate for outpatient management:</label>
        <div class="radio-group"><label><input type="radio" name="op-support-adequate" value="Yes"> Yes</label><label><input type="radio" name="op-support-adequate" value="No"> No</label></div>
        <label>Safety concerns (SI/HI, medical instability):</label>
        <div class="radio-group"><label><input type="radio" name="op-safety-concerns" value="Yes"> Yes</label><label><input type="radio" name="op-safety-concerns" value="No"> No</label></div>
        <div id="op-safety-details-container" class="conditional hidden"><label>Safety Concerns and Safety Plan:</label><textarea id="op-safety-details" rows="3"></textarea></div>

        <h3 style="margin-top:12px;">Plan</h3>
        <label>Detoxification / Medication Management</label>
        <label style="font-weight:bold; color:#666; font-size:0.95em;">Appropriateness:</label>
        <div style="display:flex; flex-direction:column; gap:8px;">
            <label><input type="checkbox" id="op-plan-outpatient"> Outpatient detox appropriate</label>
            <label><input type="checkbox" id="op-plan-inpatient"> Consider inpatient referral (reason: <input type="text" id="op-plan-inpatient-reason" placeholder="reason" style="width:300px; padding:6px;"/>)</label>
            <label><input type="checkbox" id="op-plan-decline-inpatient"> Patient declines inpatient referral.  Patient declined recommended level of care and preferrable to treat in Outpatient setting as risks outweigh benefits.  Patient aware of risks of declining recommended level of care.</label>
        </div>

        <h3 style="margin-top:16px;">Dosing - Fixed Schedule Benzodiazepine or Gabapentin Regimen</h3>
        <p style="font-size:0.85em; font-style:italic; color:#666; margin:0 0 8px 0;">Use this simplified taper schedule for patients appropriate for outpatient management. If any concern for misuse, oversedation or liver function would use gabapentin.</p>
        <div style="background-color:#f9f9f9; border:1px solid #ddd; padding:10px; margin-bottom:12px; font-size:0.9em;">
            <p style="margin:0;"><strong>CIWA-Ar score:</strong> <span id="op-dosing-ciwa-display" style="font-weight:bold; color:#0ea5e9;">[Enter CIWA score above]</span></p>
        </div>

        <div style="background-color:#fff3cd; border-left:4px solid #ffc107; padding:10px; margin:8px 0;">
            <strong>If CIWA less than 7 or patient perceived as low–moderate risk of withdrawal symptoms:</strong>
        </div>
        <div style="padding:10px; margin-left:10px;">
            <p style="font-size:0.9em;">Recommended medication options (choose one):</p>
            <div style="display:flex; flex-direction:column; gap:8px; margin-bottom:12px;">
                <label style="display:flex; align-items:center; cursor:pointer;">
                    <input type="radio" name="op-dosing-low-risk" value="gabapentin" id="op-dosing-gabapentin-low" onchange="toggleDossingOption(this);" /> 
                    <span style="margin-left:8px;">Gabapentin 300 mg</span>
                </label>
                <label style="display:flex; align-items:center; cursor:pointer;">
                    <input type="radio" name="op-dosing-low-risk" value="diazepam" id="op-dosing-diazepam-low" onchange="toggleDossingOption(this);" /> 
                    <span style="margin-left:8px;">Diazepam 5 mg</span>
                </label>
                <label style="display:flex; align-items:center; cursor:pointer;">
                    <input type="radio" name="op-dosing-low-risk" value="chlordiazepoxide" id="op-dosing-chlord-low" onchange="toggleDossingOption(this);" /> 
                    <span style="margin-left:8px;">Chlordiazepoxide 25 mg</span>
                </label>
            </div>
        </div>

        <div style="background-color:#fff3cd; border-left:4px solid #ffc107; padding:10px; margin:16px 0 8px 0;">
            <strong>If CIWA greater than 7 or patient perceived as moderate–high risk of withdrawal symptoms:</strong>
        </div>
        <div style="padding:10px; margin-left:10px;">
            <p style="font-size:0.9em;">Recommended medication options (choose one):</p>
            <div style="display:flex; flex-direction:column; gap:8px; margin-bottom:12px;">
                <label style="display:flex; align-items:center; cursor:pointer;">
                    <input type="radio" name="op-dosing-high-risk" value="diazepam" id="op-dosing-diazepam-high" onchange="toggleDossingOption(this);" /> 
                    <span style="margin-left:8px;">Diazepam 10 mg</span>
                </label>
                <label style="display:flex; align-items:center; cursor:pointer;">
                    <input type="radio" name="op-dosing-high-risk" value="chlordiazepoxide" id="op-dosing-chlord-high" onchange="toggleDossingOption(this);" /> 
                    <span style="margin-left:8px;">Chlordiazepoxide 50 mg</span>
                </label>
            </div>
        </div>

        <!-- Display selected dosing schedule -->
        <div id="op-dosing-schedule-display" style="background-color:#e8f4f8; border:1px solid #0ea5e9; padding:12px; margin:12px 0; display:none;">
            <strong>Dosing Schedule:</strong>
            <div id="op-dosing-schedule-content" style="margin-top:8px; font-size:0.9em; white-space:pre-wrap; font-family:monospace;"></div>
        </div>

        <label>Supportive/Adjunctive Medications (select as appropriate):</label>
        <table style="width:100%; border-collapse:collapse; margin-bottom:12px; font-size:0.95em;">
            <thead style="background-color:#f0f0f0; border-bottom:2px solid #333;">
                <tr>
                    <th style="border:1px solid #ddd; padding:8px; text-align:left; width:30px;"></th>
                    <th style="border:1px solid #ddd; padding:8px; text-align:left;">Indication</th>
                    <th style="border:1px solid #ddd; padding:8px; text-align:left;">Medication</th>
                    <th style="border:1px solid #ddd; padding:8px; text-align:left;">Typical Dose</th>
                    <th style="border:1px solid #ddd; padding:8px; text-align:left;">Prescriber Guidance</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td style="border:1px solid #ddd; padding:8px; text-align:center;"><input type="checkbox" id="op-med-thiamine"></td>
                    <td style="border:1px solid #ddd; padding:8px;">Vitamin supplementation</td>
                    <td style="border:1px solid #ddd; padding:8px;">Thiamine</td>
                    <td style="border:1px solid #ddd; padding:8px;"><input type="text" id="op-med-thiamine-dose" value="100 mg PO/IM daily" style="width:100%; padding:4px; box-sizing:border-box;" /></td>
                    <td style="border:1px solid #ddd; padding:8px; font-size:0.85em; font-style:italic; color:#555;">Give before glucose</td>
                </tr>
                <tr>
                    <td style="border:1px solid #ddd; padding:8px; text-align:center;"><input type="checkbox" id="op-med-folate"></td>
                    <td style="border:1px solid #ddd; padding:8px;">Vitamin supplementation</td>
                    <td style="border:1px solid #ddd; padding:8px;">Folic acid</td>
                    <td style="border:1px solid #ddd; padding:8px;"><input type="text" id="op-med-folate-dose" value="1 mg PO daily" style="width:100%; padding:4px; box-sizing:border-box;" /></td>
                    <td style="border:1px solid #ddd; padding:8px; font-size:0.85em; font-style:italic; color:#555;"></td>
                </tr>
                <tr>
                    <td style="border:1px solid #ddd; padding:8px; text-align:center;"><input type="checkbox" id="op-med-multivit"></td>
                    <td style="border:1px solid #ddd; padding:8px;">Vitamin supplementation</td>
                    <td style="border:1px solid #ddd; padding:8px;">Multivitamin</td>
                    <td style="border:1px solid #ddd; padding:8px;"><input type="text" id="op-med-multivit-dose" value="daily" style="width:100%; padding:4px; box-sizing:border-box;" /></td>
                    <td style="border:1px solid #ddd; padding:8px; font-size:0.85em; font-style:italic; color:#555;"></td>
                </tr>
                <tr>
                    <td style="border:1px solid #ddd; padding:8px; text-align:center;"><input type="checkbox" id="op-med-clonidine"></td>
                    <td style="border:1px solid #ddd; padding:8px;">Autonomic symptoms</td>
                    <td style="border:1px solid #ddd; padding:8px;">Clonidine</td>
                    <td style="border:1px solid #ddd; padding:8px;"><input type="text" id="op-med-clonidine-dose" value="0.1–0.2 mg PO q6–8h PRN" style="width:100%; padding:4px; box-sizing:border-box;" /></td>
                    <td style="border:1px solid #ddd; padding:8px; font-size:0.85em; font-style:italic; color:#555;">Hold if SBP <90</td>
                </tr>
                <tr>
                    <td style="border:1px solid #ddd; padding:8px; text-align:center;"><input type="checkbox" id="op-med-hydroxyzine"></td>
                    <td style="border:1px solid #ddd; padding:8px;">Anxiety/Insomnia</td>
                    <td style="border:1px solid #ddd; padding:8px;">Hydroxyzine</td>
                    <td style="border:1px solid #ddd; padding:8px;"><input type="text" id="op-med-hydroxyzine-dose" value="25–50 mg PO q6h PRN" style="width:100%; padding:4px; box-sizing:border-box;" /></td>
                    <td style="border:1px solid #ddd; padding:8px; font-size:0.85em; font-style:italic; color:#555;">Non-addictive</td>
                </tr>
                <tr>
                    <td style="border:1px solid #ddd; padding:8px; text-align:center;"><input type="checkbox" id="op-med-gabapentin"></td>
                    <td style="border:1px solid #ddd; padding:8px;">Adjunct</td>
                    <td style="border:1px solid #ddd; padding:8px;">Gabapentin</td>
                    <td style="border:1px solid #ddd; padding:8px;"><input type="text" id="op-med-gabapentin-dose" value="300–600 mg PO TID" style="width:100%; padding:4px; box-sizing:border-box;" /></td>
                    <td style="border:1px solid #ddd; padding:8px; font-size:0.85em; font-style:italic; color:#555;">Can be used concurrently or as taper</td>
                </tr>
                <tr>
                    <td style="border:1px solid #ddd; padding:8px; text-align:center;"><input type="checkbox" id="op-med-trazodone"></td>
                    <td style="border:1px solid #ddd; padding:8px;">Sleep</td>
                    <td style="border:1px solid #ddd; padding:8px;">Trazodone</td>
                    <td style="border:1px solid #ddd; padding:8px;"><input type="text" id="op-med-trazodone-dose" value="50–100 mg PO HS PRN" style="width:100%; padding:4px; box-sizing:border-box;" /></td>
                    <td style="border:1px solid #ddd; padding:8px; font-size:0.85em; font-style:italic; color:#555;"></td>
                </tr>
                <tr>
                    <td style="border:1px solid #ddd; padding:8px; text-align:center;"><input type="checkbox" id="op-med-ondansetron"></td>
                    <td style="border:1px solid #ddd; padding:8px;">Nausea</td>
                    <td style="border:1px solid #ddd; padding:8px;">Ondansetron</td>
                    <td style="border:1px solid #ddd; padding:8px;"><input type="text" id="op-med-ondansetron-dose" value="4 mg PO q8h PRN" style="width:100%; padding:4px; box-sizing:border-box;" /></td>
                    <td style="border:1px solid #ddd; padding:8px; font-size:0.85em; font-style:italic; color:#555;"></td>
                </tr>
            </tbody>
        </table>

        <label>Monitoring</label>
        <div style="display:flex; flex-direction:column; gap:6px;">
            <label><input type="checkbox" id="op-monitor-daily"> Daily follow-up</label>
            <label><input type="checkbox" id="op-monitor-ciwa"> CIWA-Ar scoring at each contact</label>
            <label><input type="checkbox" id="op-monitor-hold-benzo"> Hold benzodiazepine if sedated or hypotensive</label>
            <label><input type="checkbox" id="op-monitor-hydration"> Encourage hydration, nutrition, and rest</label>
            <label><input type="checkbox" id="op-monitor-safety-plan"> Safety plan: call 911 or go to ED if seizures, confusion, hallucinations, or suicidality</label>
        </div>

        <label>Follow-up</label>
        <label><input type="checkbox" id="op-followup-return"> Return in <input type="text" id="op-followup-days" placeholder="# days" style="width:80px; padding:6px;"/> days or sooner if worsening</label>
        <label><input type="checkbox" id="op-followup-reviewlabs"> Review labs and progress at next visit</label>

        <label>Patient Education</label>
        <label><input type="checkbox" id="op-edu-warning"> Reviewed withdrawal warning signs</label>
        <label><input type="checkbox" id="op-edu-avoid"> Avoid alcohol and sedatives during taper</label>
        <label><input type="checkbox" id="op-edu-avoid-driving"> Avoid driving or operating machinery while sedated</label>
        <label><input type="checkbox" id="op-edu-hydration"> Reinforced hydration, nutrition, and support engagement</label>

    </div>

    <!-- CIWA-Ar Assessment Container -->
    <div id="ciwa-ar-assessment-container" class="note-container hidden">
        <h2 style="margin-top: 20px;">CIWA-Ar Assessment</h2>
        
        <h3 style="margin-top:16px;">CIWA-Ar Assessment</h3>
        <div style="display:grid; grid-template-columns:1fr 1fr; gap:16px; margin-bottom:12px;">
            <!-- NAUSEA AND VOMITING -->
            <div>
                <label style="display:block; font-weight:bold; margin-bottom:6px; min-height:1.2em;">NAUSEA AND VOMITING</label>
                <p style="font-size:0.8em; font-style:italic; color:#666; margin:0 0 8px 0; min-height:2.4em;">Ask "Do you feel sick to your stomach? Have you vomited?" Observation.</p>
                <select id="ciwa-q-0" onchange="computeCIWAScore();" style="width:100%; padding:6px;">
                    <option value="">Select an option</option>
                    <option value="0">0 - no nausea and no vomiting</option>
                    <option value="1">1 - mild nausea with no vomiting</option>
                    <option value="2">2</option>
                    <option value="3">3</option>
                    <option value="4">4 - intermittent nausea with dry heaves</option>
                    <option value="5">5</option>
                    <option value="6">6</option>
                    <option value="7">7 - constant nausea, frequent dry heaves and vomiting</option>
                </select>
            </div>

            <!-- TREMOR -->
            <div>
                <label style="display:block; font-weight:bold; margin-bottom:6px; min-height:1.2em;">TREMOR</label>
                <p style="font-size:0.8em; font-style:italic; color:#666; margin:0 0 8px 0; min-height:2.4em;">Arms extended and fingers spread apart. Observation.</p>
                <select id="ciwa-q-1" onchange="computeCIWAScore();" style="width:100%; padding:6px;">
                    <option value="">Select an option</option>
                    <option value="0">0 - no tremor</option>
                    <option value="1">1 - not visible, but can be felt fingertip to fingertip</option>
                    <option value="2">2</option>
                    <option value="3">3</option>
                    <option value="4">4 - moderate, with patient's arms extended</option>
                    <option value="5">5</option>
                    <option value="6">6</option>
                    <option value="7">7 - severe, even with arms not extended</option>
                </select>
            </div>

            <!-- PAROXYSMAL SWEATS -->
            <div>
                <label style="display:block; font-weight:bold; margin-bottom:6px; min-height:1.2em;">PAROXYSMAL SWEATS</label>
                <p style="font-size:0.8em; font-style:italic; color:#666; margin:0 0 8px 0; min-height:2.4em;">Observation.</p>
                <select id="ciwa-q-2" onchange="computeCIWAScore();" style="width:100%; padding:6px;">
                    <option value="">Select an option</option>
                    <option value="0">0 - no sweat visible</option>
                    <option value="1">1 - barely perceptible sweating, palms moist</option>
                    <option value="2">2</option>
                    <option value="3">3</option>
                    <option value="4">4 - beads of sweat obvious on forehead</option>
                    <option value="5">5</option>
                    <option value="6">6</option>
                    <option value="7">7 - drenching sweats</option>
                </select>
            </div>

            <!-- ANXIETY -->
            <div>
                <label style="display:block; font-weight:bold; margin-bottom:6px; min-height:1.2em;">ANXIETY</label>
                <p style="font-size:0.8em; font-style:italic; color:#666; margin:0 0 8px 0; min-height:2.4em;">Ask "Do you feel nervous?" Observation.</p>
                <select id="ciwa-q-3" onchange="computeCIWAScore();" style="width:100%; padding:6px;">
                    <option value="">Select an option</option>
                    <option value="0">0 - no anxiety, at ease</option>
                    <option value="1">1 - mild anxious</option>
                    <option value="2">2</option>
                    <option value="3">3</option>
                    <option value="4">4 - moderately anxious, or guarded, so anxiety is inferred</option>
                    <option value="5">5</option>
                    <option value="6">6</option>
                    <option value="7">7 - equivalent to acute panic states as seen in severe delirium or acute schizophrenic reactions</option>
                </select>
            </div>

            <!-- HEADACHE, FULLNESS IN HEAD -->
            <div>
                <label style="display:block; font-weight:bold; margin-bottom:6px; min-height:1.2em;">HEADACHE, FULLNESS IN HEAD</label>
                <p style="font-size:0.8em; font-style:italic; color:#666; margin:0 0 8px 0; min-height:2.4em;">Ask "Does your head feel different? Does it feel like there is a band around your head?" Do not rate for dizziness or lightheadedness.</p>
                <select id="ciwa-q-5" onchange="computeCIWAScore();" style="width:100%; padding:6px;">
                    <option value="">Select an option</option>
                    <option value="0">0 - not present</option>
                    <option value="1">1 - very mild</option>
                    <option value="2">2 - mild</option>
                    <option value="3">3 - moderate</option>
                    <option value="4">4 - moderately severe</option>
                    <option value="5">5 - severe</option>
                    <option value="6">6 - very severe</option>
                    <option value="7">7 - extremely severe</option>
                </select>
            </div>

            <!-- AUDITORY DISTURBANCES -->
            <div>
                <label style="display:block; font-weight:bold; margin-bottom:6px; min-height:1.2em;">AUDITORY DISTURBANCES</label>
                <p style="font-size:0.8em; font-style:italic; color:#666; margin:0 0 8px 0; min-height:2.4em;">Ask "Are you more aware of sounds around you? Are they harsh? Do they frighten you? Are you hearing anything that is disturbing to you? Are you hearing things you know are not there?" Observation.</p>
                <select id="ciwa-q-6" onchange="computeCIWAScore();" style="width:100%; padding:6px;">
                    <option value="">Select an option</option>
                    <option value="0">0 - not present</option>
                    <option value="1">1 - very mild harshness or ability to frighten</option>
                    <option value="2">2 - mild harshness or ability to frighten</option>
                    <option value="3">3 - moderate harshness or ability to frighten</option>
                    <option value="4">4 - moderately severe hallucinations</option>
                    <option value="5">5 - severe hallucinations</option>
                    <option value="6">6 - extremely severe hallucinations</option>
                    <option value="7">7 - continuous hallucinations</option>
                </select>
            </div>

            <!-- VISUAL DISTURBANCES -->
            <div>
                <label style="display:block; font-weight:bold; margin-bottom:6px; min-height:1.2em;">VISUAL DISTURBANCES</label>
                <p style="font-size:0.8em; font-style:italic; color:#666; margin:0 0 8px 0; min-height:2.4em;">Ask "Does the light appear to be too bright? Is its color different? Does it hurt your eyes? Are you seeing anything that is disturbing to you? Are you seeing things you know are not there?" Observation.</p>
                <select id="ciwa-q-7" onchange="computeCIWAScore();" style="width:100%; padding:6px;">
                    <option value="">Select an option</option>
                    <option value="0">0 - not present</option>
                    <option value="1">1 - very mild sensitivity</option>
                    <option value="2">2 - mild sensitivity</option>
                    <option value="3">3 - moderate sensitivity</option>
                    <option value="4">4 - moderately severe hallucinations</option>
                    <option value="5">5 - severe hallucinations</option>
                    <option value="6">6 - extremely severe hallucinations</option>
                    <option value="7">7 - continuous hallucinations</option>
                </select>
            </div>

            <!-- TACTILE DISTURBANCES -->
            <div>
                <label style="display:block; font-weight:bold; margin-bottom:6px; min-height:1.2em;">TACTILE DISTURBANCES</label>
                <p style="font-size:0.8em; font-style:italic; color:#666; margin:0 0 8px 0; min-height:2.4em;">Ask "Have you any itching, pins and needles sensations, any burning, any numbness, or do you feel bugs crawling on or under your skin?" Observation.</p>
                <select id="ciwa-q-8" onchange="computeCIWAScore();" style="width:100%; padding:6px;">
                    <option value="">Select an option</option>
                    <option value="0">0 - none</option>
                    <option value="1">1 - very mild itching, pins and needles, burning or numbness</option>
                    <option value="2">2 - mild itching, pins and needles, burning or numbness</option>
                    <option value="3">3 - moderate itching, pins and needles, burning or numbness</option>
                    <option value="4">4 - moderately severe hallucinations</option>
                    <option value="5">5 - severe hallucinations</option>
                    <option value="6">6 - extremely severe hallucinations</option>
                    <option value="7">7 - continuous hallucinations</option>
                </select>
            </div>

            <!-- AGITATION -->
            <div>
                <label style="display:block; font-weight:bold; margin-bottom:6px; min-height:1.2em;">AGITATION</label>
                <p style="font-size:0.8em; font-style:italic; color:#666; margin:0 0 8px 0; min-height:2.4em;">Observation.</p>
                <select id="ciwa-q-4" onchange="computeCIWAScore();" style="width:100%; padding:6px;">
                    <option value="">Select an option</option>
                    <option value="0">0 - normal activity</option>
                    <option value="1">1 - somewhat more than normal activity</option>
                    <option value="2">2</option>
                    <option value="3">3</option>
                    <option value="4">4 - moderately fidgety and restless</option>
                    <option value="5">5</option>
                    <option value="6">6</option>
                    <option value="7">7 - paces back and forth during most of the interview, or constantly thrashes about</option>
                </select>
            </div>

            <!-- ORIENTATION AND CLOUDING OF SENSORIUM -->
            <div>
                <label style="display:block; font-weight:bold; margin-bottom:6px; min-height:1.2em;">ORIENTATION AND CLOUDING OF SENSORIUM</label>
                <p style="font-size:0.8em; font-style:italic; color:#666; margin:0 0 8px 0; min-height:2.4em;">Ask "What day is this? Where are you? Who am I?"</p>
                <select id="ciwa-q-9" onchange="computeCIWAScore();" style="width:100%; padding:6px;">
                    <option value="">Select an option</option>
                    <option value="0">0 - oriented and can do serial additions</option>
                    <option value="1">1 - cannot do serial additions or is uncertain about date</option>
                    <option value="2">2 - disoriented for date by no more than 2 calendar days</option>
                    <option value="3">3 - disoriented for date by more than 2 calendar days</option>
                    <option value="4">4 - disoriented for place/or person</option>
                </select>
            </div>
        </div>
        
        <div style="background-color:#f9f9f9; border:1px solid #ddd; padding:12px; margin-bottom:12px;">
            <p style="margin:0;"><strong>CIWA-Ar Total Score: </strong><span id="ciwa-embedded-score" style="font-size:1.1em; font-weight:bold; color:#0ea5e9;">0</span></p>
        </div>
        
        <button type="button" class="mse-button" id="compute-ciwa-btn" style="margin-bottom:12px;" onclick="saveCIWAAndClose();">Calculate & Save Score</button>
        
        <div id="ciwa-ar-result" style="background-color:#f0f4f8; border:1px solid #ddd; padding:12px; margin-top:12px; display:none;">
            <p><strong>CIWA-Ar Score: </strong><span id="ciwa-final-score" style="font-size:1.2em; font-weight:bold; color:#0ea5e9;"></span></p>
            <p id="ciwa-interpretation" style="margin-top:8px;"></p>
        </div>
    </div>

    <!-- Drug Treatment Court Report Container -->
    <div id="drug-treatment-court-report-container" class="note-container hidden">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-top:20px; margin-bottom:20px;">
            <h2 style="margin:0; flex-grow:1;">Drug Treatment Court Report</h2>
            <button type="button" onclick="clearDrugTreatmentCourtReport()" style="background-color:#dc3545; color:white; border:none; padding:6px 12px; border-radius:4px; cursor:pointer; font-weight:bold; white-space:nowrap; font-size:14px; flex-shrink:0;">Clear Report</button>
        </div>
        
        <div style="display:grid; grid-template-columns:1fr 1fr; gap:16px; margin-bottom:16px;">
            <div>
                <label for="dtc-clientName">Client Name</label>
                <input type="text" id="dtc-clientName" onchange="updateFinalNote()">
            </div>
            <div>
                <label for="dtc-careCoordination">Care Coordination Sources</label>
                <input type="text" id="dtc-careCoordination" placeholder="e.g., probation, parole, mental health" onchange="updateFinalNote()">
            </div>
            <div>
                <label for="dtc-initialCourtDate">Last Court Date</label>
                <input type="date" id="dtc-initialCourtDate" onchange="handleDtcLudVisibility(); updateFinalNote()">
            </div>
            <div>
                <label for="dtc-courtPrepDate">Next Court Date</label>
                <input type="date" id="dtc-courtPrepDate" onchange="updateFinalNote()">
            </div>
        </div>

        <h3 style="margin-top:16px;">Client Progress & Attendance</h3>
        <div style="display:grid; grid-template-columns:1fr 1fr; gap:16px; margin-bottom:16px;">
            <div>
                <label for="dtc-checkingIn">Checking In with Case Manager</label>
                <select id="dtc-checkingIn" onchange="updateFinalNote()">
                    <option value="">Select an option</option>
                    <option value="Yes">Yes</option>
                    <option value="No">No</option>
                </select>
            </div>
            <div>
                <label for="dtc-treatmentSchedule">Treatment Schedule</label>
                <input type="text" id="dtc-treatmentSchedule" placeholder="e.g., # individuals/week, # groups/week" onchange="updateFinalNote()">
            </div>
        </div>

        <label style="display:block;">Overall Appointment Attendance</label>
        <div style="display:flex; align-items:center; margin-bottom:16px; gap:8px;">
            <select id="dtc-hasNotHas" onchange="updateFinalNote()" style="width:auto; min-width:120px;">
                <option value="">Select an option</option>
                <option value="has">has</option>
                <option value="has not">has not</option>
            </select>
            <span style="color:#666;">kept all appointments as scheduled.</span>
        </div>

        <div style="margin-bottom:16px;">
            <label>Individual Sessions</label>
            <div style="display:flex; align-items:center; gap:8px; margin-bottom:8px;">
                <input type="number" id="dtc-individualAttended" placeholder="Attended" onchange="updateDtcMissedStatus(); updateFinalNote()">
                <span style="color:#666; font-weight:bold;">/</span>
                <input type="number" id="dtc-individualTotal" placeholder="Total" onchange="updateDtcMissedStatus(); updateFinalNote()">
            </div>
            <div id="dtc-individualMissedContainer" style="display:none; margin-bottom:16px;">
                <input type="text" id="dtc-individualMissed" placeholder="Dates missed, excused status" onchange="updateFinalNote()">
            </div>
        </div>

        <div style="margin-bottom:16px;">
            <label>Group Sessions</label>
            <div style="display:flex; align-items:center; gap:8px; margin-bottom:8px;">
                <input type="number" id="dtc-groupAttended" placeholder="Attended" onchange="updateDtcMissedStatus(); updateFinalNote()">
                <span style="color:#666; font-weight:bold;">/</span>
                <input type="number" id="dtc-groupTotal" placeholder="Total" onchange="updateDtcMissedStatus(); updateFinalNote()">
            </div>
            <div id="dtc-groupMissedContainer" style="display:none; margin-bottom:16px;">
                <input type="text" id="dtc-groupMissed" placeholder="Dates missed, excused status" onchange="updateFinalNote()">
            </div>
        </div>

        <div style="margin-bottom:16px;">
            <label>Medication Appointments</label>
            <div style="display:flex; align-items:center; gap:8px; margin-bottom:8px;">
                <input type="number" id="dtc-medAttended" placeholder="Attended" onchange="updateDtcMissedStatus(); updateFinalNote()">
                <span style="color:#666; font-weight:bold;">/</span>
                <input type="number" id="dtc-medTotal" placeholder="Total" onchange="updateDtcMissedStatus(); updateFinalNote()">
            </div>
            <div id="dtc-medMissedContainer" style="display:none; margin-bottom:16px;">
                <input type="text" id="dtc-medMissed" placeholder="Dates missed, excused status" onchange="updateFinalNote()">
            </div>
        </div>

        <div style="display:grid; grid-template-columns:1fr 1fr; gap:16px; margin-bottom:16px;">
            <div>
                <label for="dtc-nextDate">Next Appointment Date</label>
                <input type="date" id="dtc-nextDate" onchange="updateFinalNote()">
            </div>
            <div>
                <label for="dtc-appointmentType">Next Appointment Type</label>
                <input type="text" id="dtc-appointmentType" placeholder="e.g., Individual Session" onchange="updateFinalNote()">
            </div>
        </div>

        <h3 style="margin-top:16px;">Toxicology & Substance Use</h3>
        <div style="margin-bottom:16px;">
            <label for="dtc-lud">Last Use Date (LUD)</label>
            <input type="date" id="dtc-lud" onchange="handleDtcLudVisibility(); updateFinalNote()">
            <div id="dtc-ludExtra" style="display:none; margin-top:12px; padding:12px; background-color:#f9f9f9; border:1px solid #ddd; border-radius:4px;">
                <div style="display:grid; grid-template-columns:1fr 1fr; gap:16px;">
                    <div>
                        <label for="dtc-ludResponse">Response</label>
                        <select id="dtc-ludResponse" onchange="updateFinalNote()">
                            <option value=""></option>
                            <option value="reported promptly">Reported promptly</option>
                            <option value="not reported promptly">Not reported promptly</option>
                            <option value="denies use">Denies Use</option>
                        </select>
                    </div>
                    <div>
                        <label for="dtc-ludSubstance">Substance(s)</label>
                        <input type="text" id="dtc-ludSubstance" placeholder="e.g., Alcohol, Cannabis" oninput="updateFinalNote()">
                    </div>
                </div>
            </div>
        </div>

        <div style="margin-bottom:16px;">
            <label>Toxicology Screens at Treatment</label>
            <label style="display:flex; align-items:center; margin-top:8px; margin-bottom:8px;">
                <input type="checkbox" id="dtc-toxNotScreened" onchange="updateFinalNote()">
                <span style="margin-left:8px; color:#666;">N/A - not screened since last court date</span>
            </label>
            <div id="dtc-toxContainer"></div>
            <button type="button" class="mse-button" onclick="addDtcToxRow();" style="background-color:#28a745; color:white; border:none; padding:8px 16px; border-radius:4px; cursor:pointer;">+ Add Screen</button>
        </div>

        <div style="margin-bottom:16px;">
            <label>Random Screens</label>
            <label style="display:flex; align-items:center; margin-top:8px; margin-bottom:8px;">
                <input type="checkbox" id="dtc-randomNotScreened" onchange="updateFinalNote()">
                <span style="margin-left:8px; color:#666;">N/A - not screened since last court date</span>
            </label>
            <div id="dtc-randomContainer"></div>
            <button type="button" class="mse-button" onclick="addDtcRandomRow();" style="background-color:#28a745; color:white; border:none; padding:8px 16px; border-radius:4px; cursor:pointer;">+ Add Screen</button>
        </div>

        <label style="display:block;">Medication-Assisted Treatment (MAT)</label>
        <div style="display:flex; align-items:center; margin-top:8px; margin-bottom:16px; gap:8px;">
            <span style="color:#666;">Client</span>
            <select id="dtc-matAttendance" onchange="updateFinalNote()" style="width:auto; min-width:120px;">
                <option value=""></option>
                <option value="is">is</option>
                <option value="is not">is not</option>
            </select>
            <span style="color:#666;">attending MAT appointments as scheduled.</span>
        </div>

        <h3 style="margin-top:16px;">Additional Notes</h3>
        <div style="margin-bottom:16px;">
            <label for="dtc-probation">Probation Notes</label>
            <textarea id="dtc-probation" oninput="updateFinalNote()" style="width:100%; padding:10px; border:1px solid #ccc; border-radius:4px; min-height:100px; resize:vertical;"></textarea>
        </div>
        <div style="margin-bottom:16px;">
            <label for="dtc-mentalHealth">Mental Health Notes</label>
            <textarea id="dtc-mentalHealth" oninput="updateFinalNote()" style="width:100%; padding:10px; border:1px solid #ccc; border-radius:4px; min-height:100px; resize:vertical;"></textarea>
        </div>
        <div style="margin-bottom:16px;">
            <label for="dtc-additionalNotes">Additional Notes</label>
            <textarea id="dtc-additionalNotes" oninput="updateFinalNote()" style="width:100%; padding:10px; border:1px solid #ccc; border-radius:4px; min-height:100px; resize:vertical;"></textarea>
        </div>
    </div>

    <!-- Read-only Note Output for Copying -->
    <div class="copy-area-container">
        <h2>Copy Area</h2>
        <div id="dtc-validation-warning" style="display:none; background-color:#fff3cd; border:2px solid #dc3545; color:#dc3545; padding:15px; border-radius:4px; margin-bottom:20px; font-weight:bold;">
            ⚠️ Not all required fields have been filled. Please complete the following:
            <ul id="dtc-missing-fields" style="margin-top:10px; margin-bottom:0;"></ul>
        </div>
        
        <div id="single-note-copy-area">
            <textarea id="final-note-copy"></textarea>
            <button id="copy-button" class="copy-button">Copy Note to Clipboard</button>
        </div>
        
        <div id="dtc-dual-copy-area" style="display:none;">
            <h3 style="margin-top:20px;">Progress Note</h3>
            <textarea id="dtc-progress-note-copy" style="width:100%; padding:10px; border:1px solid #ccc; border-radius:4px; min-height:150px; resize:vertical;"></textarea>
            <button id="dtc-progress-copy-button" class="copy-button" onclick="copyDtcText('dtc-progress-note-copy', this)">Copy Progress Note to Clipboard</button>
            
            <h3 style="margin-top:20px;">Court Note</h3>
            <textarea id="dtc-court-note-copy" style="width:100%; padding:10px; border:1px solid #ccc; border-radius:4px; min-height:150px; resize:vertical;"></textarea>
            <button id="dtc-court-copy-button" class="copy-button" onclick="copyDtcText('dtc-court-note-copy', this)">Copy Court Note to Clipboard</button>
        </div>
    </div>

    <!-- MSE Modal -->
    <div id="mse-modal" class="modal">
        <div class="modal-content">
            <span class="close-btn">&times;</span>
            <div class="mse-form-container" id="MSE">
                <form autocomplete="off" onsubmit="return false;">
                    <h1 style="text-align: center; font-size: 1.875rem; font-weight: 700; color: #1f2937; margin-bottom: 1.5rem;">Mental Status Exam</h1>
                    <fieldset style="border: 1px solid #d1d5db; padding: 0.75rem; border-radius: 0.375rem; margin-bottom: 1rem;">
                        <legend>Presets</legend>
                        <div style="display: flex; flex-direction: column; gap: 0.5rem;">
                            <label style="display: flex; align-items: center;"><input style="height: 1rem; width: 1rem; border-radius: 0.25rem; border-color: #9ca3af; color: #4f46e5; " id="positiveMSE" onclick="togglePositiveMSE()" type="checkbox"> <span style="margin-left: 0.5rem;">Normal MSE</span></label>
                            <label style="display: flex; align-items: center;"><input style="height: 1rem; width: 1rem; border-radius: 0.25rem; border-color: #9ca3af; color: #4f46e5; " id="telehealthpositiveMSE" onclick="TelehealthPositiveMSE()" type="checkbox"> <span style="margin-left: 0.5rem;">Telehealth Normal MSE</span></label><br>
                           <button class="mse-button" onclick="clearAllMseCheckboxes();" type="button">
                                Clear Form
                            </button>
                        </div>
                    </fieldset>
                    <div style="display: flex; flex-direction: column; gap: 1rem;">
                        <fieldset class="border p-3 rounded-md"><legend>Orientation</legend><div class="mse-category"><label><input onchange="updateMseText()" type="checkbox"> Oriented x4</label><label><input onchange="updateMseText()" type="checkbox"> Time</label><label><input onchange="updateMseText()" type="checkbox"> Place</label><label><input onchange="updateMseText()" type="checkbox"> Situation</label><label><input onchange="updateMseText()" type="checkbox"> Person</label><input class="mse-custom-input border-gray-300 rounded-md" data-category="Orientation" oninput="updateMseText()" placeholder="Other" type="text"></div></fieldset>
                        <fieldset class="border p-3 rounded-md"><legend>Clothing/Grooming</legend><div class="mse-category"><label><input onchange="updateMseText()" type="checkbox"> Neat</label><label><input onchange="updateMseText()" type="checkbox"> Clean</label><label><input onchange="updateMseText()" type="checkbox"> Appropriately Dressed</label><label><input onchange="updateMseText()" type="checkbox"> Careless</label><label><input onchange="updateMseText()" type="checkbox"> Disheveled</label><label><input onchange="updateMseText()" type="checkbox"> Dirty</label><label><input onchange="updateMseText()" type="checkbox"> Inappropriate</label><label><input onchange="updateMseText()" type="checkbox"> Bizarre</label><input class="mse-custom-input border-gray-300 rounded-md" data-category="Clothing/Grooming" oninput="updateMseText()" placeholder="Other" type="text"></div></fieldset>
                        <fieldset class="border p-3 rounded-md"><legend>Motor Activity</legend><div class="mse-category"><label><input onchange="updateMseText()" type="checkbox"> Not Remarkable</label><label><input onchange="updateMseText()" type="checkbox"> Slowed</label><label><input onchange="updateMseText()" type="checkbox"> Repetitive</label><label><input onchange="updateMseText()" type="checkbox"> Restless</label><label><input onchange="updateMseText()" type="checkbox"> Agitated</label><label><input onchange="updateMseText()" type="checkbox"> Tremor</label><input class="mse-custom-input border-gray-300 rounded-md" data-category="Motor Activity" oninput="updateMseText()" placeholder="Other" type="text"></div></fieldset>
                        <fieldset class="border p-3 rounded-md"><legend>Behavior</legend><div class="mse-category"><label><input onchange="updateMseText()" type="checkbox"> Appropriate</label><label><input onchange="updateMseText()" type="checkbox"> Aggressive</label><label><input onchange="updateMseText()" type="checkbox"> Angry</label><label><input onchange="updateMseText()" type="checkbox"> Apathetic</label><label><input onchange="updateMseText()" type="checkbox"> Irritable</label><label><input onchange="updateMseText()" type="checkbox"> Passive</label><label><input onchange="updateMseText()" type="checkbox"> Manipulative</label><input class="mse-custom-input border-gray-300 rounded-md" data-category="Behavior" oninput="updateMseText()" placeholder="Other" type="text"></div></fieldset>
                        <fieldset class="border p-3 rounded-md"><legend>Withdrawal</legend><div class="mse-category"><label><input onchange="updateMseText()" type="checkbox"> Ct is in active withdrawal</label><label><input onchange="updateMseText()" type="checkbox"> Ct shows potential indicators of withdrawal</label><label><input onchange="updateMseText()" type="checkbox"> Ct does not show signs of withdrawal</label><input class="mse-custom-input border-gray-300 rounded-md" data-category="Withdrawal" oninput="updateMseText()" placeholder="Other" type="text"></div></fieldset>
                        <fieldset class="border p-3 rounded-md"><legend>Attention</legend><div class="mse-category"><label><input onchange="updateMseText()" type="checkbox"> Normal</label><label><input onchange="updateMseText()" type="checkbox"> Unaware</label><label><input onchange="updateMseText()" type="checkbox"> Distractible</label><label><input onchange="updateMseText()" type="checkbox"> Vigilant</label><input class="mse-custom-input border-gray-300 rounded-md" data-category="Attention" oninput="updateMseText()" placeholder="Other" type="text"></div></fieldset>
                        <fieldset class="border p-3 rounded-md"><legend>Recall/Memory</legend><div class="mse-category"><label><input onchange="updateMseText()" type="checkbox"> Normal</label><label><input onchange="updateMseText()" type="checkbox"> Short-term Impaired, Long-Term Intact</label><label><input onchange="updateMseText()" type="checkbox"> Short-term Intact, Long-term Impaired</label><input class="mse-custom-input border-gray-300 rounded-md" data-category="Recall/Memory" oninput="updateMseText()" placeholder="Other" type="text"></div></fieldset>
                        <fieldset class="border p-3 rounded-md"><legend>Eye Contact</legend><div class="mse-category"><label><input onchange="updateMseText()" type="checkbox"> Normal</label><label><input onchange="updateMseText()" type="checkbox"> Fleeting</label><label><input onchange="updateMseText()" type="checkbox"> Avoided</label><label><input onchange="updateMseText()" type="checkbox"> None</label><label><input onchange="updateMseText()" type="checkbox"> Staring</label><input class="mse-custom-input border-gray-300 rounded-md" data-category="Eye Contact" oninput="updateMseText()" placeholder="Other" type="text"></div></fieldset>
                        <fieldset class="border p-3 rounded-md"><legend>Facial Expression</legend><div class="mse-category"><label><input onchange="updateMseText()" type="checkbox"> Responsive</label><label><input onchange="updateMseText()" type="checkbox"> Tense</label><label><input onchange="updateMseText()" type="checkbox"> Anxious</label><label><input onchange="updateMseText()" type="checkbox"> Sad</label><label><input onchange="updateMseText()" type="checkbox"> Angry</label><input class="mse-custom-input border-gray-300 rounded-md" data-category="Facial Expression" oninput="updateMseText()" placeholder="Other" type="text"></div></fieldset>
                        <fieldset class="border p-3 rounded-md"><legend>Attitude toward Evaluator</legend><div class="mse-category"><label><input onchange="updateMseText()" type="checkbox"> Cooperative</label><label><input onchange="updateMseText()" type="checkbox"> Friendly</label><label><input onchange="updateMseText()" type="checkbox"> Guarded</label><label><input onchange="updateMseText()" type="checkbox"> Hostile</label><label><input onchange="updateMseText()" type="checkbox"> Indifferent</label><label><input onchange="updateMseText()" type="checkbox"> Ingratiating</label><label><input onchange="updateMseText()" type="checkbox"> Manipulative</label><label><input onchange="updateMseText()" type="checkbox"> Open</label><label><input onchange="updateMseText()" type="checkbox"> Seductive</label><label><input onchange="updateMseText()" type="checkbox"> Suspicious</label><label><input onchange="updateMseText()" type="checkbox"> Uncooperative</label><input class="mse-custom-input border-gray-300 rounded-md" data-category="Attitude toward Evaluator" oninput="updateMseText()" placeholder="Other" type="text"></div></fieldset>
                        <fieldset class="border p-3 rounded-md"><legend>Affect</legend><div class="mse-category"><label><input onchange="updateMseText()" type="checkbox"> Congruent</label><label><input onchange="updateMseText()" type="checkbox"> Incongruent</label><label><input onchange="updateMseText()" type="checkbox"> Appropriate</label><label><input onchange="updateMseText()" type="checkbox"> Inappropriate</label><label><input onchange="updateMseText()" type="checkbox"> Labile</label><label><input onchange="updateMseText()" type="checkbox"> Restricted</label><label><input onchange="updateMseText()" type="checkbox"> Flat</label><label><input onchange="updateMseText()" type="checkbox"> Reactive</label><label><input onchange="updateMseText()" type="checkbox"> Blunted</label><input class="mse-custom-input border-gray-300 rounded-md" data-category="Affect" oninput="updateMseText()" placeholder="Other" type="text"></div></fieldset>
                        <fieldset class="border p-3 rounded-md"><legend>Mood</legend><div class="mse-category"><label><input onchange="updateMseText()" type="checkbox"> Euthymic</label><label><input onchange="updateMseText()" type="checkbox"> Dysphoric</label><label><input onchange="updateMseText()" type="checkbox"> Anxious</label><label><input onchange="updateMseText()" type="checkbox"> Angry</label><label><input onchange="updateMseText()" type="checkbox"> Irritable</label><label><input onchange="updateMseText()" type="checkbox"> Pessimistic</label><label><input onchange="updateMseText()" type="checkbox"> Depressed</label><label><input onchange="updateMseText()" type="checkbox"> Hypomanic</label><label><input onchange="updateMseText()" type="checkbox"> Euphoric</label><input class="mse-custom-input border-gray-300 rounded-md" data-category="Mood" oninput="updateMseText()" placeholder="Other" type="text"></div></fieldset>
                        <fieldset class="border p-3 rounded-md"><legend>Speech</legend><div class="mse-category"><label><input onchange="updateMseText()" type="checkbox"> Normal</label><label><input onchange="updateMseText()" type="checkbox"> Loud</label><label><input onchange="updateMseText()" type="checkbox"> Blocked</label><label><input onchange="updateMseText()" type="checkbox"> Pressured</label><label><input onchange="updateMseText()" type="checkbox"> Flight of Ideas</label><label><input onchange="updateMseText()" type="checkbox"> Slurred</label><label><input onchange="updateMseText()" type="checkbox"> Soft</label><label><input onchange="updateMseText()" type="checkbox"> Stuttering</label><label><input onchange="updateMseText()" type="checkbox"> Mute</label><label><input onchange="updateMseText()" type="checkbox"> Verbose</label><input class="mse-custom-input border-gray-300 rounded-md" data-category="Speech" oninput="updateMseText()" placeholder="Other" type="text"></div></fieldset>
                        <fieldset class="border p-3 rounded-md"><legend>Expression of Thought Content</legend><div class="mse-category"><label><input onchange="updateMseText()" type="checkbox"> Congruent</label><label><input onchange="updateMseText()" type="checkbox"> Incongruent</label><label><input onchange="updateMseText()" type="checkbox"> Loose Associations</label><label><input onchange="updateMseText()" type="checkbox"> Suspicions</label><label><input onchange="updateMseText()" type="checkbox"> Delusions</label><label><input onchange="updateMseText()" type="checkbox"> Phobias</label><label><input onchange="updateMseText()" type="checkbox"> Obsessions</label><input class="mse-custom-input border-gray-300 rounded-md" data-category="Expression of Thought Content" oninput="updateMseText()" placeholder="Other" type="text"></div></fieldset>
                        <fieldset class="border p-3 rounded-md"><legend>Organization of Thought</legend><div class="mse-category"><label><input onchange="updateMseText()" type="checkbox"> Normal</label><label><input onchange="updateMseText()" type="checkbox"> Logical</label><label><input onchange="updateMseText()" type="checkbox"> Goal-directed</label><input class="mse-custom-input border-gray-300 rounded-md" data-category="Organization of Thought" oninput="updateMseText()" placeholder="Other" type="text"></div></fieldset>
                        <fieldset class="border p-3 rounded-md"><legend>Perception</legend><div class="mse-category"><label><input onchange="updateMseText()" type="checkbox"> No Hallucinations or Delusions during Interview</label><label><input onchange="updateMseText()" type="checkbox"> Auditory Hallucinations</label><label><input onchange="updateMseText()" type="checkbox"> Visual Hallucinations</label><label><input onchange="updateMseText()" type="checkbox"> Olfactory Hallucinations</label><label><input onchange="updateMseText()" type="checkbox"> Tactile Hallucinations</label><label><input onchange="updateMseText()" type="checkbox"> Gustatory Hallucinations</label><label><input onchange="updateMseText()" type="checkbox"> Delusions Present</label><input class="mse-custom-input border-gray-300 rounded-md" data-category="Perception" oninput="updateMseText()" placeholder="Other" type="text"></div></fieldset>
                        <fieldset class="border p-3 rounded-md"><legend>Insight</legend><div class="mse-category"><label><input onchange="updateMseText()" type="checkbox"> Excellent</label><label><input onchange="updateMseText()" type="checkbox"> Good</label><label><input onchange="updateMseText()" type="checkbox"> Fair</label><label><input onchange="updateMseText()" type="checkbox"> Poor</label><label><input onchange="updateMseText()" type="checkbox"> nil</label><input class="mse-custom-input border-gray-300 rounded-md" data-category="Insight" oninput="updateMseText()" placeholder="Other" type="text"></div></fieldset>
                        <fieldset class="border p-3 rounded-md"><legend>Judgment</legend><div class="mse-category"><label><input onchange="updateMseText()" type="checkbox"> Excellent</label><label><input onchange="updateMseText()" type="checkbox"> Good</label><label><input onchange="updateMseText()" type="checkbox"> Fair</label><label><input onchange="updateMseText()" type="checkbox"> Poor</label><label><input onchange="updateMseText()" type="checkbox"> nil</label><label><input onchange="updateMseText()" type="checkbox"> Dangerous</label><input class="mse-custom-input border-gray-300 rounded-md" data-category="Judgment" oninput="updateMseText()" placeholder="Other" type="text"></div></fieldset>
                        <fieldset class="border p-3 rounded-md"><legend>Decision Making</legend><div class="mse-category"><label><input onchange="updateMseText()" type="checkbox"> Normal</label><label><input onchange="updateMseText()" type="checkbox"> Only Simple</label><label><input onchange="updateMseText()" type="checkbox"> Impulsive</label><label><input onchange="updateMseText()" type="checkbox"> Confused</label><input class="mse-custom-input border-gray-300 rounded-md" data-category="Decision Making" oninput="updateMseText()" placeholder="Other" type="text"></div></fieldset>
                        <fieldset class="border p-3 rounded-md"><legend>Safety</legend><div class="mse-category"><label><input onchange="updateMseText()" type="checkbox"> No evidence or report of SI/HI</label><label><input onchange="updateMseText()" type="checkbox"> Denies SI/HI</label><label><input onchange="updateMseText()" type="checkbox"> Reports HI</label><label><input onchange="updateMseText()" type="checkbox"> Reports Passive Suicidal Thoughts</label><label><input onchange="updateMseText()" type="checkbox"> Reports Suicide Plan</label><label><input onchange="updateMseText()" type="checkbox"> Reports Suicidal Intention</label><input class="mse-custom-input border-gray-300 rounded-md" data-category="Safety" oninput="updateMseText()" placeholder="Other" type="text"></div></fieldset>
                    </div>
                    <textarea class="w-full mt-4 p-2 border border-gray-300 rounded-md hidden" id="mseTextbox" rows="12"></textarea>
                    <button class="mse-button" onclick="saveMseAndClose()" type="button">Save & Close</button>
                </form>
            </div>
        </div>
    </div>
</div>

<script>
        // --- Staff-Role driven Note Type population ---
        const staffTypeSelect = document.getElementById('staff-type-select');
        const noteTypeSelect = document.getElementById('note-type-select');

        const staffNoteOptions = {
            counseling: [
                { value: 'closing-note-admitted', label: 'Closing Note – Admitted' },
                { value: 'closing-note-non-admitted', label: 'Closing Note – Non-Admitted' },
                { value: 'discharge-plan', label: 'Discharge Plan' },
                { value: 'drug-treatment-court-report', label: 'Drug Treatment Court Report' },
                { value: 'entry-cd', label: 'Entry Session - Chemical Dependency' },
                { value: 'entry-so', label: 'Entry Session - Significant Other' },
                { value: 'eval-cd', label: 'Evaluation - Chemical Dependency' },
                { value: 'eval-so', label: 'Evaluation - Significant Other' },
                { value: 'mat-education', label: 'MAT Education' },
                { value: 'mdt', label: 'MDT Note' },
                { value: 'narcan-kit', label: 'Narcan Education & Kit' },
                { value: 'telehealth', label: 'Telehealth' }
            ],
            medical: [
                { value: 'injections', label: 'Injections' },
                { value: 'mat-education', label: 'MAT Education' },
                { value: 'medical-screening', label: 'Medical Screening' },
                { value: 'med-mgmt-follow-up', label: 'Medication Management Follow-up' },
                { value: 'narcan-kit', label: 'Narcan Education & Kit' },
                { value: 'nurse-follow-up', label: 'Nurse Follow Up' },
                { value: 'op-alcohol-detox', label: 'OP Alcohol Detox' },
                { value: 'ciwa-ar-assessment', label: 'CIWA-Ar Assessment' },
                { value: 'opioid-use-disorder-short', label: 'Opioid Use Disorder Short' },
                { value: 'alcohol-use-disorder-short', label: 'Alcohol Use Disorder Short' },
                { value: 'telehealth', label: 'Telehealth' }
            ]
        };

        function populateNoteTypesForRole(role) {
            // clear current options
            noteTypeSelect.innerHTML = '';
            const placeholder = document.createElement('option');
            placeholder.value = '';
            placeholder.disabled = true;
            placeholder.selected = true;
            placeholder.textContent = 'Select a note type...';
            noteTypeSelect.appendChild(placeholder);

            const options = staffNoteOptions[role] || [];
            options.forEach(opt => {
                const o = document.createElement('option');
                o.value = opt.value;
                o.textContent = opt.label;
                noteTypeSelect.appendChild(o);
            });
            noteTypeSelect.disabled = options.length === 0;
        }

        // When staff role changes, populate allowed note types and reset selection
        staffTypeSelect.addEventListener('change', () => {
            const role = staffTypeSelect.value;
            populateNoteTypesForRole(role);
            sortSelectOptions(noteTypeSelect);
            noteTypeSelect.value = '';
            // hide all containers and clear generated note area
            noteContainers.forEach(c => c.classList.add('hidden'));
            updateFinalNote();
        });

    // Get all interactive elements
    const finalNoteCopy = document.getElementById('final-note-copy');
    const copyButton = document.getElementById('copy-button');

    // Eval-CD elements
    const diagnosisContainer = document.getElementById('diagnosis-container');
    const detailsTextarea = document.getElementById('details-criteria');
    const mandateCheckbox = document.getElementById('mandate-checkbox');
    const cdHasMhProviderTextCheckbox = document.getElementById('cd-has-mh-provider-text');
    const cdSafetyPlanHasProviderCheckbox = document.getElementById('cd-safety-plan-has-provider');
    const cdNoMhProviderTextCheckbox = document.getElementById('cd-no-mh-provider-text');
    const cdSafetyPlanNoProviderCheckbox = document.getElementById('cd-safety-plan-no-provider');
    const cdOverdoseRiskCheckbox = document.getElementById('cd-overdose-risk');
    const cdGamblingRiskCheckbox = document.getElementById('cd-gambling-risk');

    // Eval-SO elements
    const soDiagnosisSelect = document.getElementById('so-diagnosis-select');
    const soDetailsTextarea = document.getElementById('so-details-criteria');
    const soHasMhProviderTextCheckbox = document.getElementById('so-has-mh-provider-text');
    const soSafetyPlanHasProviderCheckbox = document.getElementById('so-safety-plan-has-provider');
    const soNoMhProviderTextCheckbox = document.getElementById('so-no-mh-provider-text');
    const soSafetyPlanNoProviderCheckbox = document.getElementById('so-safety-plan-no-provider');
    const soOverdoseRiskCheckbox = document.getElementById('so-overdose-risk');
    const soGamblingRiskCheckbox = document.getElementById('so-gambling-risk');
    
    // Entry-CD elements
    const clientGoalsContainer = document.getElementById('client-goals-container');
    const treatmentGoalsContainer = document.getElementById('treatment-goals-container');
    
    // Entry-SO elements
    const soClientGoalsContainer = document.getElementById('so-client-goals-container');
    const soTreatmentGoalsContainer = document.getElementById('so-treatment-goals-container');

    // Narcan elements
    const narcanProvidedCheckbox = document.getElementById('narcan-provided-checkbox');
    const narcanDeclinedCheckbox = document.getElementById('narcan-declined-checkbox');

    // MAT elements
    const matEducationType = document.getElementById('mat-education-type');
    const matNotTakingSection = document.getElementById('mat-not-taking-section');
    const matAlreadyTakingSection = document.getElementById('mat-already-taking-section');
    const matResponseDropdown = document.getElementById('mat-response-dropdown');
    const matFormFields = document.getElementById('mat-form-fields');
    const matSubstancesTextbox = document.getElementById('mat-substances-textbox');
    const matExploredOptionsDropdown = document.getElementById('mat-explored-options-dropdown');
    const matOptionsDetailsSection = document.getElementById('mat-options-details-section');
    const matSpecificOptionsCheckboxes = document.getElementById('mat-specific-options-checkboxes');
    const matNicotineUseDropdown = document.getElementById('mat-nicotine-use-dropdown');
    const matNicotineResourcesSection = document.getElementById('mat-nicotine-resources-section');
    const matNicotineReplacementCheckbox = document.getElementById('mat-nicotine-replacement-checkbox');
    const matNicotineCounselingCheckbox = document.getElementById('mat-nicotine-counseling-checkbox');
    const matNicotineReferralCheckbox = document.getElementById('mat-nicotine-referral-checkbox');
    const matNicotineOtherCheckbox = document.getElementById('mat-nicotine-other-checkbox');
    const matNicotineOtherTextbox = document.getElementById('mat-nicotine-other-textbox');
    
    // Telehealth elements
    const telehealthVisitType = document.getElementById('telehealth-visit-type');
    const telehealthReason = document.getElementById('telehealth-reason');
    const telehealthReasonOther = document.getElementById('telehealth-reason-other');
    const telehealthDisruption = document.getElementById('telehealth-disruption');
    const telehealthDisruptionFollowup = document.getElementById('telehealth-disruption-followup');
    const telehealthDisruptionPlan = document.getElementById('telehealth-disruption-plan');
    const telehealthClientLocation = document.getElementById('telehealth-client-location');
    const telehealthPractitionerLocation = document.getElementById('telehealth-practitioner-location');
    const telehealthPresenceDropdown = document.getElementById('telehealth-presence-dropdown');
    const telehealthOthersPresent = document.getElementById('telehealth-others-present');
    const telehealthSatisfaction = document.getElementById('telehealth-satisfaction');
    const telehealthSatisfactionConcerns = document.getElementById('telehealth-satisfaction-concerns');

    // Closing Note (Admitted) elements
    const closingReason = document.getElementById('closing-reason');
    const closingRecommendations = document.getElementById('closing-recommendations');
    const closingMedsDropdown = document.getElementById('closing-meds-dropdown');
    const closingMedsActionsContainer = document.getElementById('closing-meds-actions-container');
    const closingMedsActions = document.getElementById('closing-meds-actions');
    const closingReferrals = document.getElementById('closing-referrals');
    const closingOfferedToDropdown = document.getElementById('closing-offered-to-dropdown');
    const closingClientResponse = document.getElementById('closing-client-response');
    
    // Closing Note (Non-Admitted) elements
    const nonAdmittedClientType = document.getElementById('non-admitted-client-type');
    const nonAdmittedNoEngageSection = document.getElementById('non-admitted-no-engage-section');
    const nonAdmittedHigherLocSection = document.getElementById('non-admitted-higher-loc-section');
    const nonAdmittedNoCriteriaSection = document.getElementById('non-admitted-no-criteria-section');
    const nonAdmittedEfforts = document.getElementById('non-admitted-efforts');
    const nonAdmittedProvidedTo1 = document.getElementById('non-admitted-provided-to-1');
    const nonAdmittedLocadtr = document.getElementById('non-admitted-locadtr');
    const nonAdmittedEfforts2 = document.getElementById('non-admitted-efforts-2');
    const nonAdmittedProvidedTo2 = document.getElementById('non-admitted-provided-to-2');
    const nonAdmittedProvidedTo3 = document.getElementById('non-admitted-provided-to-3');
    const nonAdmittedUrineScreen = document.getElementById('non-admitted-urine-screen');

    // Injections elements
    const injectionTypeSelect = document.getElementById('injection-type-select');
    const vivitrolSection = document.getElementById('vivitrol-section');
    const sublocadeSection = document.getElementById('sublocade-section');
    const brixadiSection = document.getElementById('brixadi-section');
    const vivitrolSite = document.getElementById('vivitrol-site');
    const vivitrolLot = document.getElementById('vivitrol-lot');
    const vivitrolExp = document.getElementById('vivitrol-exp');
    const vivitrolSn = document.getElementById('vivitrol-sn');
    const vivitrolNextInjection = document.getElementById('vivitrol-next-injection');
    const sublocadeSite = document.getElementById('sublocade-site');
    const sublocadeLot = document.getElementById('sublocade-lot');
    const sublocadeExp = document.getElementById('sublocade-exp');
    const sublocadeSn = document.getElementById('sublocade-sn');
    const sublocadeNextInjection = document.getElementById('sublocade-next-injection');
    const brixadiSite = document.getElementById('brixadi-site');
    const brixadiLot = document.getElementById('brixadi-lot');
    const brixadiExp = document.getElementById('brixadi-exp');
    const brixadiSn = document.getElementById('brixadi-sn');
    const brixadiNextInjection = document.getElementById('brixadi-next-injection');

    // MDT elements
    const mdtDiagnosisContainer = document.getElementById('mdt-diagnosis-container');
    const mdtReasonHighRisk = document.getElementById('mdt-reason-high-risk');
    const mdtCriteriaOffHighRisk = document.getElementById('mdt-criteria-off-high-risk');
    const mdtRiskFactors = document.getElementById('mdt-risk-factors');
    const mdtProtectiveFactors = document.getElementById('mdt-protective-factors');
    const mdtCareCoordination = document.getElementById('mdt-care-coordination');
    const mdtStageOfChange = document.getElementById('mdt-stage-of-change');
    const mdtStageOfChangeOther = document.getElementById('mdt-stage-of-change-other');
    const mdtSafetyPlanCompleted = document.getElementById('mdt-safety-plan-completed');
    const mdtSafetyPlanApplicable = document.getElementById('mdt-safety-plan-applicable');
    const mdtMatStatus = document.getElementById('mdt-mat-status');
    const mdtLastToxDate = document.getElementById('mdt-last-tox-date');
    const mdtToxResult = document.getElementById('mdt-tox-result');
    const mdtClientEngaging = document.getElementById('mdt-client-engaging');
    const mdtMostRecentAppt = document.getElementById('mdt-most-recent-appt');
    const mdtNextAppt = document.getElementById('mdt-next-appt');
    const mdtProgressRecommendations = document.getElementById('mdt-progress-recommendations');
    const mdtGuidingQuestions = document.getElementById('mdt-guiding-questions');

    // Medication Management Follow-up elements
    const mmfuNicotineUse = document.getElementById('mmfu-nicotine-use');
    const mmfuNicotineDetailsSection = document.getElementById('mmfu-nicotine-details-section');
    const mmfuNicotineInterest = document.getElementById('mmfu-nicotine-interest');
    const mmfuNicotineDetails = document.getElementById('mmfu-nicotine-details');

    // Opioid Use Disorder Short elements
    const oudsActiveUseRadios = document.querySelectorAll('input[name="ouds-active-use"]');
    const oudsLastUseDateRow = document.getElementById('ouds-last-use-date-row');
    const oudsLastUseDateLabel = oudsLastUseDateRow.querySelector('label'); // Get the label
    const oudsPharmRadios = document.querySelectorAll('input[name="ouds-pharmacotherapy"]');
    const oudsPharmFields = document.getElementById('ouds-pharm-fields');
    const oudsSubstances = [
        'alcohol', 'amphet', 'benzodiazepines', 'cocaine', 'hallucinogens', 'illicit-opioids', 'ivdu', 'kratom', 'mdma', 'nicotine', 'prescription-opioids', 'other'
    ];


    // Get containers
    const noteContainers = document.querySelectorAll('.note-container');

    const diagnosisOptionsHTML = `
        <option value="" selected disabled>Select a diagnosis...</option>
        <optgroup label="F10: Alcohol Use Disorder"><option value="F10.10: Alcohol use disorder, mild">F10.10: Alcohol use disorder, mild</option><option value="F10.20: Alcohol use disorder, moderate">F10.20: Alcohol use disorder, moderate</option><option value="F10.20: Alcohol use disorder, severe">F10.20: Alcohol use disorder, severe</option></optgroup>
        <optgroup label="F11: Opioid Use Disorder"><option value="F11.10: Opioid use disorder, mild">F11.10: Opioid use disorder, mild</option><option value="F11.20: Opioid use disorder, moderate">F11.20: Opioid use disorder, moderate</option><option value="F11.20: Opioid use disorder, severe">F11.20: Opioid use disorder, severe</option></optgroup>
        <optgroup label="F12: Cannabis Use Disorder"><option value="F12.10: Cannabis use disorder, mild">F12.10: Cannabis use disorder, mild</option><option value="F12.20: Cannabis use disorder, moderate">F12.20: Cannabis use disorder, moderate</option><option value="F12.20: Cannabis use disorder, severe">F12.20: Cannabis use disorder, severe</option></optgroup>
        <optgroup label="F13: Sedative, Hypnotic, or Anxiolytic Use Disorder"><option value="F13.10: Sedative, hypnotic, or anxiolytic use disorder, mild">F13.10: Sedative, hypnotic, or anxiolytic use disorder, mild</option><option value="F13.20: Sedative, hypnotic, or anxiolytic use disorder, moderate">F13.20: Sedative, hypnotic, or anxiolytic use disorder, moderate</option><option value="F13.20: Sedative, hypnotic, or anxiolytic use disorder, severe">F13.20: Sedative, hypnotic, or anxiolytic use disorder, severe</option></optgroup>
        <optgroup label="F14: Cocaine Use Disorder"><option value="F14.10: Stimulant Use Disorder Cocaine, mild">F14.10: Stimulant Use Disorder Cocaine, mild</option><option value="F14.20: Stimulant Use Disorder Cocaine, moderate">F14.20: Stimulant Use Disorder Cocaine, moderate</option><option value="F14.20: Stimulant Use Disorder Cocaine, severe">F14.20: Stimulant Use Disorder Cocaine, severe</option></optgroup>
        <optgroup label="F15: Other Stimulant Use Disorder"><option value="F15.10: Other stimulant use disorder, mild">F15.10: Other stimulant use disorder, mild</option><option value="F15.20: Other stimulant use disorder, moderate">F15.20: Other stimulant use disorder, moderate</option><option value="F15.20: Other stimulant use disorder, severe">F15.20: Other stimulant use disorder, severe</option></optgroup>
        <optgroup label="F16: Hallucinogen Use Disorder"><option value="F16.10: Hallucinogen use disorder, mild">F16.10: Hallucinogen use disorder, mild</option><option value="F16.10: Hallucinogen use disorder, moderate">F16.10: Hallucinogen use disorder, moderate</option><option value="F16.10: Hallucinogen use disorder, severe">F16.10: Hallucinogen use disorder, severe</option></optgroup>
        <optgroup label="F17: Tobacco Use Disorder"><option value="F17.200: Nicotine dependence, unspecified">F17.200: Nicotine dependence, unspecified</option><option value="F17.210: Nicotine dependence, cigarettes, uncomplicated">F17.210: Nicotine dependence, cigarettes, uncomplicated</option><option value="F17.220: Nicotine dependence, chewing tobacco, uncomplicated">F17.220: Nicotine dependence, chewing tobacco, uncomplicated</option><option value="F17.290: Nicotine dependence, other tobacco product, uncomplicated">F17.290: Nicotine dependence, other tobacco product, uncomplicated</option></optgroup>
        <optgroup label="F18: Inhalant Use Disorder"><option value="F18.10: Inhalant use disorder, mild">F18.10: Inhalant use disorder, mild</option><option value="F18.20: Inhalant use disorder, moderate">F18.20: Inhalant use disorder, moderate</option><option value="F18.20: Inhalant use disorder, severe">F18.20: Inhalant use disorder, severe</option></optgroup>
        <optgroup label="F19: Other (or Unknown) Psychoactive Substance Use Disorder"><option value="F19.10: Other psychoactive substance use disorder, mild">F19.10: Other psychoactive substance use disorder, mild</option><option value="F19.20: Other psychoactive substance use disorder, moderate">F19.20: Other psychoactive substance use disorder, moderate</option><option value="F19.20: Other psychoactive substance use disorder, severe">F19.20: Other psychoactive substance use disorder, severe</option></optgroup>
        <optgroup label="No Criteria Met"><option value="F19.99 - Unspecified or Other Unknown Substance Use Disorder">F19.99 - Unspecified or Other Unknown Substance Use Disorder</option></optgroup>
    `;
    
    function createDynamicRow(container, placeholder) {
        const row = document.createElement('div');
        row.className = 'dynamic-row';
        const input = document.createElement('input');
        input.type = 'text';
        input.placeholder = placeholder;
        input.addEventListener('input', updateFinalNote);
        const button = document.createElement('button');
        button.type = 'button';

        if (container.children.length === 0) {
            button.className = 'add-btn';
            button.textContent = '+';
            button.onclick = () => createDynamicRow(container, placeholder);
        } else {
            button.className = 'remove-btn';
            button.textContent = '-';
            button.onclick = () => { row.remove(); updateFinalNote(); };
        }
        row.appendChild(input);
        row.appendChild(button);
        container.appendChild(row);
        updateFinalNote();
    }
    
    function addDiagnosisRow() {
        const row = document.createElement('div');
        row.className = 'dynamic-row';
        const select = document.createElement('select');
        select.innerHTML = diagnosisOptionsHTML;
        select.addEventListener('change', updateFinalNote);
        const button = document.createElement('button');
        button.type = 'button';
        if (diagnosisContainer.children.length === 0) {
            button.className = 'add-btn';
            button.textContent = '+';
            button.onclick = addDiagnosisRow;
        } else {
            button.className = 'remove-btn';
            button.textContent = '-';
            button.onclick = () => { row.remove(); updateFinalNote(); };
        }
        row.appendChild(select);
        row.appendChild(button);
        diagnosisContainer.appendChild(row);
        updateFinalNote();
    }

    function addMmfuDiagnosisRow() {
        const container = document.getElementById('mmfu-diagnosis-container');
        const row = document.createElement('div');
        row.className = 'dynamic-row';
        const select = document.createElement('select');
        select.innerHTML = diagnosisOptionsHTML;
        select.addEventListener('change', updateFinalNote);
        const button = document.createElement('button');
        button.type = 'button';
        if (container.children.length === 0) {
            button.className = 'add-btn';
            button.textContent = '+';
            button.onclick = addMmfuDiagnosisRow;
        } else {
            button.className = 'remove-btn';
            button.textContent = '-';
            button.onclick = () => { row.remove(); updateFinalNote(); };
        }
        row.appendChild(select);
        row.appendChild(button);
        container.appendChild(row);
        updateFinalNote();
    }

    function addMdtDiagnosisRow() {
        const row = document.createElement('div');
        row.className = 'dynamic-row';
        const select = document.createElement('select');
        select.innerHTML = diagnosisOptionsHTML;
        select.addEventListener('change', updateFinalNote);
        const button = document.createElement('button');
        button.type = 'button';
        if (mdtDiagnosisContainer.children.length === 0) {
            button.className = 'add-btn';
            button.textContent = '+';
            button.onclick = addMdtDiagnosisRow;
        } else {
            button.className = 'remove-btn';
            button.textContent = '-';
            button.onclick = () => { row.remove(); updateFinalNote(); };
        }
        row.appendChild(select);
        row.appendChild(button);
        mdtDiagnosisContainer.appendChild(row);
        updateFinalNote();
    }
const nurseInterventionOptions = `
        <option value="" selected disabled>Select an intervention...</option>
        <optgroup label="Monitoring">
            <option value="Observed and recorded medication adherence and any side effects.">Observed and recorded medication adherence and any side effects.</option>
            <option value="Monitored clients' responses to treatment and symptom changes.">Monitored clients' responses to treatment and symptom changes.</option>
            <option value="Assessed for signs of adverse reactions or complications related to medications.">Assessed for signs of adverse reactions or complications related to medications.</option>
        </optgroup>
        <optgroup label="Education">
            <option value="Provided instruction on proper medication administration and dosing.">Provided instruction on proper medication administration and dosing.</option>
            <option value="Taught clients about potential side effects and how to manage them.">Taught clients about potential side effects and how to manage them.</option>
            <option value="Educated on lifestyle strategies to support overall health and recovery.">Educated on lifestyle strategies to support overall health and recovery.</option>
            <option value="Reviewed the importance of attending follow-up appointments and lab tests.">Reviewed the importance of attending follow-up appointments and lab tests.</option>
            <option value="Explained warning signs that required immediate medical attention.">Explained warning signs that required immediate medical attention.</option>
            <option value="Educated on harm reduction strategies.">Educated on harm reduction strategies.</option>
        </optgroup>
        <optgroup label="Referrals">
            <option value="(Pending guidance/direction from MD/NP) identified need for specialty care (e.g., cardiology, psychiatry) and facilitated referrals.">(Pending guidance/direction from MD/NP) identified need for specialty care (e.g., cardiology, psychiatry) and facilitated referrals.</option>
            <option value="Identified community resources for primary care, dental needs, and communicable disease treatment and symptom management.">Identified community resources for primary care, dental needs, and communicable disease treatment and symptom management.</option>
            <option value="Encouraged engagement with medical providers for additional support services and assessed client need for assistance in completing referrals.">Encouraged engagement with medical providers for additional support services and assessed client need for assistance in completing referrals.</option>
            <option value="Provided contact information and guidance for support programs.">Provided contact information and guidance for support programs.</option>
        </optgroup>
        <optgroup label="Screening">
            <option value="Conducted initial medical screenings to establish baseline health status.">Conducted initial medical screenings to establish baseline health status.</option>
            <option value="Screened for medication side effects and adverse reactions.">Screened for medication side effects and adverse reactions.</option>
            <option value="Assessed for comorbid conditions that could impact treatment.">Assessed for comorbid conditions that could impact treatment.</option>
            <option value="Reassessed risk factors (e.g., substance use, falls, infection) at each visit.">Reassessed risk factors (e.g., substance use, falls, infection) at each visit.</option>
        </optgroup>
        <optgroup label="Plan/Next Steps">
            <option value="Continued current medication regimen.">Continued current medication regimen.</option>
            <option value="Encouraged continued attendance in counseling/group.">Encouraged continued attendance in counseling/group.</option>
            <option value="Referred to RN/NP/MD for [e.g., medication concerns, side effects].">Referred to RN/NP/MD for [e.g., medication concerns, side effects].</option>
            <option value="Scheduled next appointment for [date].">Scheduled next appointment for [date].</option>
        </optgroup>
        <option value="custom">Other (Type Custom)...</option>
    `;

function addNurseInterventionRow(isFirstRow = false) {
        const container = document.getElementById('nurse-interventions-container');
        const rowWrapper = document.createElement('div'); // Wrapper for dropdown row + textarea
        rowWrapper.style.marginBottom = '15px'; // Add space between intervention blocks

        const row = document.createElement('div');
        row.className = 'dynamic-row';

        const select = document.createElement('select');
        select.innerHTML = nurseInterventionOptions;
        select.style.marginBottom = '5px'; // Add small space below dropdown

        const buttonContainer = document.createElement('div');
        buttonContainer.style.display = 'flex';
        buttonContainer.style.gap = '5px';

        const addButton = document.createElement('button');
        addButton.type = 'button';
        addButton.className = 'add-btn';
        addButton.textContent = '+';
        addButton.onclick = () => addNurseInterventionRow();
        buttonContainer.appendChild(addButton);

        if (!isFirstRow) { // Only add remove button if it's not the first row
            const removeButton = document.createElement('button');
            removeButton.type = 'button';
            removeButton.className = 'remove-btn';
            removeButton.textContent = '-';
            removeButton.onclick = () => {
                rowWrapper.remove();
                updateFinalNote();
            };
            buttonContainer.appendChild(removeButton);
        }

        row.appendChild(select);
        row.appendChild(buttonContainer);
        rowWrapper.appendChild(row); // Add dropdown row to wrapper

        // Textarea initially hidden, shown on selection
        const textarea = document.createElement('textarea');
        textarea.placeholder = "Customize or enter new intervention...";
        textarea.rows = 2;
        textarea.classList.add('hidden'); // Start hidden
        textarea.style.width = 'calc(100% - 58px)'; // Adjust width to align roughly under dropdown
        textarea.style.marginLeft = '0px'; // Align left
        textarea.style.marginTop = '0px'; // Remove top margin
        textarea.addEventListener('input', () => {
            autoResize(textarea);
            updateFinalNote();
        });
        rowWrapper.appendChild(textarea); // Add textarea to wrapper

        select.addEventListener('change', () => {
            const selectedValue = select.value;
            if (selectedValue) { // If something valid is selected (not the placeholder)
                textarea.value = selectedValue === 'custom' ? '' : selectedValue;
                textarea.classList.remove('hidden'); // Show the textarea
                autoResize(textarea);
            } else {
                textarea.classList.add('hidden'); // Hide if placeholder selected again
            }
            updateFinalNote();
        });

        container.appendChild(rowWrapper);
        updateFinalNote(); // Update note after adding row initially
    }

    function resetDiagnosisRows() {
        diagnosisContainer.innerHTML = '';
        addDiagnosisRow();
    }
    
    function resetGoalRows(clientContainer, treatmentContainer) {
        clientContainer.innerHTML = '';
        treatmentContainer.innerHTML = '';
        createDynamicRow(clientContainer, 'Enter client goal...');
        createDynamicRow(treatmentContainer, 'Enter treatment plan goal...');
    }

    function autoResize(element) {
        element.style.height = 'auto';
        element.style.height = (element.scrollHeight) + 'px';
    }

    function autoResizeDtcTextareas(progressElement, courtElement) {
        if (progressElement) {
            progressElement.style.height = 'auto';
            progressElement.style.height = (progressElement.scrollHeight) + 'px';
        }
        if (courtElement) {
            courtElement.style.height = 'auto';
            courtElement.style.height = (courtElement.scrollHeight) + 'px';
        }
    }

    // Drug Treatment Court Report Helper Functions
    function formatDate(dateString) {
        if (!dateString) return '';
        const date = new Date(dateString + 'T00:00:00');
        return new Intl.DateTimeFormat('en-US').format(date);
    }

    function handleDtcLudVisibility() {
        const ludInput = document.getElementById('dtc-lud').value;
        const initialCourtDateInput = document.getElementById('dtc-initialCourtDate').value;
        const ludExtraDiv = document.getElementById('dtc-ludExtra');

        if (!ludInput || !initialCourtDateInput) {
            ludExtraDiv.style.display = 'none';
            return;
        }
        const ludDate = new Date(ludInput);
        const initialCourtDate = new Date(initialCourtDateInput);
        if (ludDate >= initialCourtDate) {
            ludExtraDiv.style.display = 'block';
        } else {
            ludExtraDiv.style.display = 'none';
        }
    }

    function updateDtcMissedStatus() {
        const individualAttended = Number(document.getElementById('dtc-individualAttended').value) || 0;
        const individualTotal = Number(document.getElementById('dtc-individualTotal').value) || 0;
        document.getElementById('dtc-individualMissedContainer').style.display = (individualAttended >= individualTotal) ? 'none' : 'block';

        const groupAttended = Number(document.getElementById('dtc-groupAttended').value) || 0;
        const groupTotal = Number(document.getElementById('dtc-groupTotal').value) || 0;
        document.getElementById('dtc-groupMissedContainer').style.display = (groupAttended >= groupTotal) ? 'none' : 'block';

        const medAttended = Number(document.getElementById('dtc-medAttended').value) || 0;
        const medTotal = Number(document.getElementById('dtc-medTotal').value) || 0;
        document.getElementById('dtc-medMissedContainer').style.display = (medAttended >= medTotal) ? 'none' : 'block';
    }

    function toggleDtcSubstance(selectElem) {
        const row = selectElem.closest('.dynamic-row');
        const substanceInput = row.querySelector('.substance-input');
        if (substanceInput) {
            substanceInput.style.display = (selectElem.value === "positive") ? "block" : "none";
            if (selectElem.value !== "positive") {
                substanceInput.value = "";
            }
        }
    }

    function copyDtcText(elementId, button) {
        const textarea = document.getElementById(elementId);
        textarea.select();
        if (navigator.clipboard && navigator.clipboard.writeText) {
            navigator.clipboard.writeText(textarea.value).then(() => {
                const originalText = button.innerText;
                button.innerText = 'Copied!';
                setTimeout(() => { button.innerText = originalText; }, 2000);
            }).catch(err => {
                console.error('Could not copy text: ', err);
                fallbackCopyText(textarea.value, button);
            });
        } else {
            fallbackCopyText(textarea.value, button);
        }
    }

    function fallbackCopyText(text, button) {
        const textArea = document.createElement("textarea");
        textArea.value = text;
        textArea.style.top = "0";
        textArea.style.left = "0";
        textArea.style.position = "fixed";
        document.body.appendChild(textArea);
        textArea.focus();
        textArea.select();
        try {
            const successful = document.execCommand('copy');
            if (successful) {
                const originalText = button.innerText;
                button.innerText = 'Copied!';
                setTimeout(() => { button.innerText = originalText; }, 2000);
            }
        } catch (err) {
            console.error('Fallback: Oops, unable to copy', err);
        }
        document.body.removeChild(textArea);
    }

    function validateDtcRequiredFields() {
        const requiredFields = [
            { id: 'dtc-clientName', label: 'Client Name' },
            { id: 'dtc-initialCourtDate', label: 'Last Court Date' },
            { id: 'dtc-courtPrepDate', label: 'Next Court Date' },
            { id: 'dtc-checkingIn', label: 'Checking In with Case Manager' },
            { id: 'dtc-treatmentSchedule', label: 'Treatment Schedule' },
            { id: 'dtc-hasNotHas', label: 'Overall Appointment Attendance' },
            { id: 'dtc-nextDate', label: 'Next Appointment Date' },
            { id: 'dtc-appointmentType', label: 'Next Appointment Type' },
            { id: 'dtc-lud', label: 'Last Use Date' }
        ];

        const missingFields = [];
        
        requiredFields.forEach(field => {
            const element = document.getElementById(field.id);
            const value = element?.value || '';
            if (!value || value.trim() === '') {
                missingFields.push(field.label);
            }
        });

        // Check if at least one toxicology screen is filled or checkbox is marked
        const toxNotScreenedCheckbox = document.getElementById('dtc-toxNotScreened');
        const toxContainer = document.getElementById('dtc-toxContainer');
        const hasToxData = toxNotScreenedCheckbox.checked || Array.from(toxContainer.querySelectorAll('input[type="date"]')).some(input => input.value);
        if (!hasToxData) {
            missingFields.push('Toxicology Screens at Treatment');
        }

        // Check if at least one random screen is filled or checkbox is marked
        const randomNotScreenedCheckbox = document.getElementById('dtc-randomNotScreened');
        const randomContainer = document.getElementById('dtc-randomContainer');
        const hasRandomData = randomNotScreenedCheckbox.checked || Array.from(randomContainer.querySelectorAll('input[type="date"]')).some(input => input.value);
        if (!hasRandomData) {
            missingFields.push('Random Screens');
        }

        // Show or hide warning
        const warningDiv = document.getElementById('dtc-validation-warning');
        const missingFieldsList = document.getElementById('dtc-missing-fields');
        
        if (missingFields.length > 0) {
            warningDiv.style.display = 'block';
            missingFieldsList.innerHTML = missingFields.map(field => `<li>${field}</li>`).join('');
        } else {
            warningDiv.style.display = 'none';
            missingFieldsList.innerHTML = '';
        }

        return missingFields.length === 0;
    }

    function clearDrugTreatmentCourtReport() {
        // Clear all text inputs and text areas
        const textInputIds = [
            'dtc-clientName',
            'dtc-careCoordination',
            'dtc-treatmentSchedule',
            'dtc-appointmentType',
            'dtc-ludSubstance',
            'dtc-probation',
            'dtc-mentalHealth',
            'dtc-additionalNotes',
            'dtc-individualMissed',
            'dtc-groupMissed',
            'dtc-medMissed'
        ];
        textInputIds.forEach(id => {
            const element = document.getElementById(id);
            if (element) {
                element.value = '';
            }
        });

        // Clear all date inputs
        const dateInputIds = [
            'dtc-initialCourtDate',
            'dtc-courtPrepDate',
            'dtc-nextDate',
            'dtc-lud'
        ];
        dateInputIds.forEach(id => {
            const element = document.getElementById(id);
            if (element) {
                element.value = '';
            }
        });

        // Clear all select dropdowns
        const selectIds = [
            'dtc-checkingIn',
            'dtc-hasNotHas',
            'dtc-ludResponse',
            'dtc-matAttendance'
        ];
        selectIds.forEach(id => {
            const element = document.getElementById(id);
            if (element) {
                element.value = '';
            }
        });

        // Clear all number inputs
        const numberInputIds = [
            'dtc-individualAttended',
            'dtc-individualTotal',
            'dtc-groupAttended',
            'dtc-groupTotal',
            'dtc-medAttended',
            'dtc-medTotal'
        ];
        numberInputIds.forEach(id => {
            const element = document.getElementById(id);
            if (element) {
                element.value = '';
            }
        });

        // Clear all checkboxes
        const checkboxIds = [
            'dtc-toxNotScreened',
            'dtc-randomNotScreened'
        ];
        checkboxIds.forEach(id => {
            const element = document.getElementById(id);
            if (element) {
                element.checked = false;
            }
        });

        // Clear toxicology and random screen rows
        document.getElementById('dtc-toxContainer').innerHTML = '';
        document.getElementById('dtc-randomContainer').innerHTML = '';

        // Reset form visibility
        handleDtcLudVisibility();
        updateDtcMissedStatus();

        // Clear the copy boxes
        document.getElementById('dtc-progress-note-copy').value = '';
        document.getElementById('dtc-court-note-copy').value = '';

        // Clear validation warning
        document.getElementById('dtc-validation-warning').style.display = 'none';
        document.getElementById('dtc-missing-fields').innerHTML = '';

        // Reinitialize with empty rows
        addDtcToxRow();
        addDtcRandomRow();

        // Trigger update
        updateFinalNote();
    }

    function addDtcToxRow() {
        const container = document.getElementById('dtc-toxContainer');
        const row = document.createElement('div');
        row.className = 'dynamic-row dtc-tox-row';
        row.style.cssText = 'display:flex; align-items:center; gap:10px; margin-bottom:8px; padding:10px; background-color:#f9f9f9; border-radius:4px;';
        row.innerHTML = `
            <input type="date" class="input-field dtcToxDate" onchange="updateFinalNote()" style="flex-grow:1; margin:0; padding:8px;">
            <select class="select-field dtcToxResult" onchange="toggleDtcSubstance(this); updateFinalNote()" style="flex-grow:1; margin:0; padding:8px;">
                <option value="negative">Negative</option>
                <option value="positive">Positive</option>
                <option value="pending">Pending</option>
            </select>
            <input type="text" class="input-field substance-input dtcToxSubstance" placeholder="Substance(s)" style="flex-grow:1; margin:0; padding:8px; display:none;" onchange="updateFinalNote()">
            <button type="button" style="flex-shrink:0; width:38px; height:38px; padding:0; background-color:#dc3545; color:white; border:none; border-radius:4px; cursor:pointer; font-weight:bold;" onclick="this.parentElement.remove(); updateFinalNote();">X</button>
        `;
        container.appendChild(row);
    }

    function addDtcRandomRow() {
        const container = document.getElementById('dtc-randomContainer');
        const row = document.createElement('div');
        row.className = 'dynamic-row dtc-random-row';
        row.style.cssText = 'display:flex; align-items:center; gap:10px; margin-bottom:8px; padding:10px; background-color:#f9f9f9; border-radius:4px;';
        row.innerHTML = `
            <input type="date" class="input-field dtcRandomDate" onchange="updateFinalNote()" style="flex-grow:1; margin:0; padding:8px;">
            <select class="select-field dtcRandomResult" onchange="toggleDtcSubstance(this); updateFinalNote()" style="flex-grow:1; margin:0; padding:8px;">
                <option value="negative">Negative</option>
                <option value="positive">Positive</option>
                <option value="missed random">Missed Random</option>
            </select>
            <input type="text" class="input-field substance-input dtcRandomSubstance" placeholder="Substance(s)" style="flex-grow:1; margin:0; padding:8px; display:none;" onchange="updateFinalNote()">
            <button type="button" style="flex-shrink:0; width:38px; height:38px; padding:0; background-color:#dc3545; color:white; border:none; border-radius:4px; cursor:pointer; font-weight:bold;" onclick="this.parentElement.remove(); updateFinalNote();">X</button>
        `;
        container.appendChild(row);
    }

    function updateFinalNote() {
        const selectedNoteType = noteTypeSelect.value;
        let finalNote = '';

        // Hide all containers first
        noteContainers.forEach(c => c.classList.add('hidden'));
        
        // Show the relevant container
        const activeContainer = document.getElementById(`${selectedNoteType}-container`);
        if (activeContainer) {
            activeContainer.classList.remove('hidden');
        }

        if (selectedNoteType === 'eval-cd') {
            const diagnosisElements = diagnosisContainer.querySelectorAll('select');
            const selectedOptions = Array.from(diagnosisElements).map(select => select.value).filter(val => val);
            const diagnosis = selectedOptions.length > 0 ? selectedOptions.join(', ') : '[SPECIFY DIAGNOSIS]';

            // Hide "as evidenced by" and details textbox if F19.99 is selected
            const evidencedByLabel = document.getElementById('eval-cd-evidenced-by-label');
            const detailsCriteria = document.getElementById('details-criteria');
            const isF1999 = selectedOptions.includes('F19.99 - Unspecified or Other Unknown Substance Use Disorder');
            if (evidencedByLabel && detailsCriteria) {
                evidencedByLabel.style.display = isF1999 ? 'none' : '';
                detailsCriteria.style.display = isF1999 ? 'none' : '';
            }

            // Compose note
            let baseNote = `The client presented for services and meets diagnostic criteria for a substance use disorder, specifically ${diagnosis}`;
            if (!isF1999) {
                const details = detailsCriteria.value || '[DETAILS OF CRITERIA MET]';
                baseNote += `, as evidenced by: \n\n${details}`;
            } else {
                baseNote += '.';
            }
            baseNote += `\n\nThe clinician reviewed: Program expectations, rules, and attendance policies; Delphi Rise’s policy as a tobacco, nicotine, alcohol, and drug-free environment; and Client rights and responsibilities, including HIPAA and 42 CFR Part 2 confidentiality protections.\n\nThe clinician confirmed client understanding and emphasized the collaborative nature of recovery, highlighting the agency’s role in supporting the client’s treatment goals. The client demonstrated an understanding that participation in services is voluntary and may be discontinued at any time${mandateCheckbox.checked ? ' The clinician clarified the implications of external mandates, noting that mandated status does not override the client’s right to voluntary engagement in treatment or toxicology screenings. Corresponding handouts were provided.' : ''}\n\nThe clinician reviewed the client’s Behavioral Health and Chemical Dependency screening results and supported the client in understanding their scores. A comprehensive review of the client’s presenting concerns, referral reason, psychosocial needs, and current and historical functioning was conducted to assess eligibility for Outpatient services. The client's initial treatment goal is to complete the evaluation process; additional goals will be developed collaboratively in future sessions inclusive of discussions during evaluation session.`;

            let scenariosText = [];
            if (cdHasMhProviderTextCheckbox.checked) {
                let text = cdHasMhProviderTextCheckbox.nextElementSibling.textContent;
                if (cdSafetyPlanHasProviderCheckbox.checked) {
                    text += ' ' + cdSafetyPlanHasProviderCheckbox.nextElementSibling.textContent;
                }
                scenariosText.push(text);
            }
            if (cdNoMhProviderTextCheckbox.checked) {
                let text = cdNoMhProviderTextCheckbox.nextElementSibling.textContent;
                if (cdSafetyPlanNoProviderCheckbox.checked) {
                    text += ' ' + cdSafetyPlanNoProviderCheckbox.nextElementSibling.textContent;
                }
                scenariosText.push(text);
            }
            if (cdOverdoseRiskCheckbox.checked) {
                scenariosText.push(cdOverdoseRiskCheckbox.nextElementSibling.textContent);
            }
            if (cdGamblingRiskCheckbox.checked) {
                scenariosText.push(cdGamblingRiskCheckbox.nextElementSibling.textContent);
            }

            if (scenariosText.length > 0) {
                finalNote = baseNote + "\n\n" + scenariosText.join("\n\n");
            } else {
                finalNote = baseNote;
            }
        } else if (selectedNoteType === 'eval-so') {
            const diagnosis = soDiagnosisSelect.value || '[SELECT A DIAGNOSIS]';
            const details = soDetailsTextarea.value || '[DETAILS OF CRITERIA MET]';
            let baseNote = `The client presented for services due to experiencing stress related to supporting someone in their life who struggles with substance use. The client meets diagnostic criteria, specifically ${diagnosis}, as evidenced by: \n\n${details}\n\nThe clinician reviewed: Program expectations, rules, and attendance policies; Delphi Rise’s policy as a tobacco, nicotine, alcohol, and drug-free environment; and Client rights and responsibilities, including HIPAA and 42 CFR Part 2 confidentiality protections.\n\nThe clinician confirmed client understanding and emphasized the collaborative nature of treatment, highlighting the agency’s role in supporting the client’s treatment goals. The client demonstrated an understanding that participation in services is voluntary and may be discontinued at any time.\n\nThe clinician reviewed the client’s Behavioral Health screening results and supported the client in understanding their scores. A comprehensive review of the client’s presenting concerns, referral reason, psychosocial needs, and current and historical functioning was conducted to assess eligibility for Outpatient services. The client's initial treatment goal is to complete the evaluation process; additional goals will be developed collaboratively in future sessions inclusive of discussions during evaluation session.`;
            
            let scenariosText = [];
            if (soHasMhProviderTextCheckbox.checked) {
                let text = soHasMhProviderTextCheckbox.nextElementSibling.textContent;
                if (soSafetyPlanHasProviderCheckbox.checked) {
                    text += ' ' + soSafetyPlanHasProviderCheckbox.nextElementSibling.textContent;
                }
                scenariosText.push(text);
            }
            if (soNoMhProviderTextCheckbox.checked) {
                let text = soNoMhProviderTextCheckbox.nextElementSibling.textContent;
                if (soSafetyPlanNoProviderCheckbox.checked) {
                    text += ' ' + soSafetyPlanNoProviderCheckbox.nextElementSibling.textContent;
                }
                scenariosText.push(text);
            }
            if (soOverdoseRiskCheckbox.checked) {
                scenariosText.push(soOverdoseRiskCheckbox.nextElementSibling.textContent);
            }
            if (soGamblingRiskCheckbox.checked) {
                scenariosText.push(soGamblingRiskCheckbox.nextElementSibling.textContent);
            }

            if (scenariosText.length > 0) {
                finalNote = baseNote + "\n\n" + scenariosText.join("\n\n");
            } else {
                finalNote = baseNote;
            }

        } else if (selectedNoteType === 'entry-cd') {
            const clientGoals = Array.from(clientGoalsContainer.querySelectorAll('input')).map(input => input.value).filter(val => val);
            const treatmentGoals = Array.from(treatmentGoalsContainer.querySelectorAll('input')).map(input => input.value).filter(val => val);
            
            let clientGoalsText = clientGoals.length > 0 ? '\n' + clientGoals.map(goal => `"${goal}"`).join('\n') : ' [CLIENT-STATED GOALS / CLIENT VOICE/QUOTES]';
            let treatmentGoalsText = treatmentGoals.length > 0 ? '\n' + treatmentGoals.join('\n') : ' [TREATMENT PLAN GOALS]';

            finalNote = `The client has identified personal goals to support their recovery, including:${clientGoalsText}\n\nBased on the client’s psychosocial needs, current presentation, and clinical history, the client is expected to benefit from the following treatment plan goals:${treatmentGoalsText}\n\nThe clinician reviewed all services available through the Outpatient clinic, with a focus on peer support, medication management, and therapeutic group offerings. Corresponding handouts were provided to support the client’s engagement and alignment with their identified recovery goals.`;

        } else if (selectedNoteType === 'entry-so') {
            const clientGoals = Array.from(soClientGoalsContainer.querySelectorAll('input')).map(input => input.value).filter(val => val);
            const treatmentGoals = Array.from(soTreatmentGoalsContainer.querySelectorAll('input')).map(input => input.value).filter(val => val);
            
            let clientGoalsText = clientGoals.length > 0 ? '\n' + clientGoals.map(goal => `"${goal}"`).join('\n') : ' [CLIENT-STATED GOALS / CLIENT VOICE/QUOTES]';
            let treatmentGoalsText = treatmentGoals.length > 0 ? '\n' + treatmentGoals.join('\n') : ' [TREATMENT PLAN GOALS]';

            finalNote = `The client has identified personal goals to support their recovery, including:${clientGoalsText}\n\nBased on the client’s psychosocial needs, current presentation, and clinical history, the client is expected to benefit from the following treatment plan goals:${treatmentGoalsText}\n\nThe clinician reviewed all services available through the Outpatient clinic, with a focus on peer support, medication management, and therapeutic group offerings. Corresponding handouts were provided to support the client’s engagement and alignment with their identified recovery goals.`;
        
        } else if (selectedNoteType === 'narcan-kit') {
            if (narcanProvidedCheckbox.checked) {
                finalNote = "Writer provided Ct with an overview of Narcan, showed a brief video demonstrating how to use Narcan, and provided Ct with a Narcan kit.";
            } else if (narcanDeclinedCheckbox.checked) {
                finalNote = "Ct declined Narcan training when offered and declined to accept a Narcan kit.";
            } else {
                finalNote = "";
            }
        
        } else if (selectedNoteType === 'mat-education') {
            let noteParts = [];
            const educationType = matEducationType.value;

            if (educationType === 'not-taking') {
                noteParts.push("Medication Assisted Treatment (MAT) has been introduced, and education has been offered based on client's history and current presentation. Writer provided client with an overview of MAT’s benefits & risks and offered to connect client to medication management in our clinic");
            } else if (educationType === 'already-taking') {
                noteParts.push("Client is currently taking medication to manage their Substance Use Disorder");
            }
            
            if (matExploredOptionsDropdown.value) {
                noteParts.push(matExploredOptionsDropdown.options[matExploredOptionsDropdown.selectedIndex].text);

                if(matExploredOptionsDropdown.value === 'did') {
                    if (matSubstancesTextbox.value.trim() !== "") {
                        noteParts.push(`MAT is recommended for the following substance(s): ${matSubstancesTextbox.value.trim()}`);
                    }
                    const selectedOptions = Array.from(matSpecificOptionsCheckboxes.querySelectorAll('input[type="checkbox"]:checked')).map(cb => cb.value);
                    if(selectedOptions.length > 0){
                        noteParts.push(`Specific options explored include: ${selectedOptions.join(', ')}`);
                    }
                }
            }
            
            if (matResponseDropdown.value) {
                noteParts.push(matResponseDropdown.value);
            }

            if (matNicotineUseDropdown.value) {
                const nicotineUse = matNicotineUseDropdown.value === 'does' ? 'does' : 'does not';
                let nicotineSentence = `The client ${nicotineUse} report current nicotine use`;
                if (nicotineUse === 'does') {
                    let resources = [];
                    if (matNicotineReplacementCheckbox.checked) resources.push('nicotine replacement options');
                    if (matNicotineCounselingCheckbox.checked) resources.push('tobacco cessation counseling');
                    if (matNicotineReferralCheckbox.checked) resources.push('referral to a tobacco cessation program');
                    if (matNicotineOtherCheckbox.checked && matNicotineOtherTextbox.value) {
                        resources.push(matNicotineOtherTextbox.value);
                    }
                    if (resources.length > 0) {
                        nicotineSentence += `, and the following nicotine cessation resources were provided: ${resources.join(', ')}`;
                    }
                }
                noteParts.push(nicotineSentence);
            }
            
            const joinedNote = noteParts.filter(Boolean).join('. ');
            if (joinedNote) {
                finalNote = joinedNote + '.';
            }

        } else if (selectedNoteType === 'telehealth') {
            
            telehealthReasonOther.style.display = (telehealthReason.value === 'other') ? 'inline-block' : 'none';
            telehealthDisruptionFollowup.style.display = (telehealthDisruption.value === 'was a service disruption') ? 'inline-block' : 'none';
            telehealthSatisfactionConcerns.style.display = (telehealthSatisfaction.value === 'expressed the following concerns:') ? 'inline-block' : 'none';
            telehealthOthersPresent.style.display = (telehealthPresenceDropdown.value === 'others') ? 'inline-block' : 'none';

            let noteParts = [];
            
            if (telehealthVisitType.value) {
                noteParts.push(`This session was conducted via ${telehealthVisitType.value}, and client is clinically appropriate to receive services via telepractice`);
            }
            
            let reason = telehealthReason.value;
            if (reason) {
                if (reason === 'other') {
                    reason = telehealthReasonOther.value || '[specify]';
                }
                noteParts.push(`the use of telepractice was due to ${reason}`);
            }
            
            let disruption = telehealthDisruption.value;
            if (disruption) {
                let disruptionText = `there ${disruption}`;
                if (disruption === 'was a service disruption') {
                    const plan = telehealthDisruptionPlan.value || '[plan for follow-up]';
                    disruptionText += `. Writer will follow up by ${plan}`;
                }
                noteParts.push(disruptionText);
            }

            const clientLocation = telehealthClientLocation.value || '[client location]';
            const practitionerLocation = telehealthPractitionerLocation.value || '[practitioner location]';
            noteParts.push(`the client was located at ${clientLocation}, and the practitioner was located at ${practitionerLocation} at the time of the session`);
            
            let presence = telehealthPresenceDropdown.value;
            if (presence) {
                if (presence === 'only') {
                    noteParts.push('Provider and client were the only individuals present in the session');
                } else if (presence === 'others') {
                    const others = telehealthOthersPresent.value || '[specify]';
                    noteParts.push(`in addition to the provider and client, the following individual(s) were present with the client: ${others}`);
                }
            }

            let satisfaction = telehealthSatisfaction.value;
            if (satisfaction) {
                let satisfactionText = satisfaction;
                if (satisfaction.startsWith('expressed the following concerns')) {
                    const concerns = telehealthSatisfactionConcerns.value || '[specify]';
                    satisfactionText += ` ${concerns}`;
                }
                noteParts.push(`The client was asked about their satisfaction with receiving services via telepractice and ${satisfactionText}`);
            }

            const joinedNote = noteParts.filter(Boolean).map(s => s.charAt(0).toUpperCase() + s.slice(1)).join('. ');
            if(joinedNote) {
                finalNote = joinedNote + '.';
            }

        } else if (selectedNoteType === 'closing-note-admitted') {
            let noteParts = [];
            const reason = closingReason.value || '[reason for discharge]';
            noteParts.push(`Client was discharged due to ${reason}`);

            const recommendations = closingRecommendations.value || '[recommended treatment plan or next steps]';
            noteParts.push(`Treatment recommendations include ${recommendations}`);

            const meds = closingMedsDropdown.value;
            if (meds) {
                let medsSentence = `The client ${meds} currently prescribed medications most recently prescribed at Delphi`;
                if (meds === 'is') {
                    const actions = closingMedsActions.value || '[describe actions taken, e.g., medication reconciliation, prescription coordination, referral to prescriber, etc.]';
                    medsSentence += `. The following actions were taken to support the client’s medication management: ${actions}`;
                }
                noteParts.push(medsSentence);
            }

            const referrals = closingReferrals.value || '[list referrals, e.g., outpatient counseling, primary care, housing support, etc.]';
            noteParts.push(`Referrals initiated to support the client post-discharge include: ${referrals}`);

            const offeredTo = closingOfferedToDropdown.value;
            if (offeredTo) {
                noteParts.push(`The ${offeredTo} was offered a copy of their discharge plan, a recovery resource handout outlining community resources for urgent support, harm reduction resources, referrals to MAT providers and recovery peer services, and an overdose prevention/Narcan kit`);
            }
            
            const clientResponse = closingClientResponse.value;
            if (clientResponse) {
                noteParts.push(`Client's Response to Resources Offered at Discharge: ${clientResponse}`);
            }
            
            const joinedNote = noteParts.filter(Boolean).map(s => s.charAt(0).toUpperCase() + s.slice(1)).join('. ');
            if (joinedNote) {
                finalNote = joinedNote + '.';
            }

        } else if (selectedNoteType === 'closing-note-non-admitted') {
            const clientType = nonAdmittedClientType.value;
            if (clientType === 'no-engage') {
                const efforts = nonAdmittedEfforts.value || '[list efforts]';
                const providedTo = nonAdmittedProvidedTo1.value ? ` and also provided to: ${nonAdmittedProvidedTo1.value}` : '';
                finalNote = `Client will not be admitted for treatment at this time due to not engaging in treatment beyond their evaluation(s). Engagement efforts included ${efforts}. The decision not to admit was provided via mail to client${providedTo}. Included in this letter is a recovery resource handout outlining community resources for urgent support, harm reduction resources, MAT providers, and recovery peer services.`;
            } else if (clientType === 'higher-loc') {
                const locadtr = nonAdmittedLocadtr.value || '[LOCADTR outcome]';
                const efforts = nonAdmittedEfforts2.value || '[list efforts made, e.g., coordination with other providers, referral outreach, discussion with client/family, etc.]';
                const providedTo = nonAdmittedProvidedTo2.value ? ` and also provided to: ${nonAdmittedProvidedTo2.value}` : '';
                finalNote = `The client will not be admitted for treatment at this time, as they meet criteria for a higher level of care ${locadtr}. Following a thorough review and discussion by the multidisciplinary team, it was determined that the client’s needs would be more safely and appropriately addressed in a setting equipped to provide a higher intensity of services. Efforts to explore treatment options and identify appropriate referrals were made, including: ${efforts}. The decision not to admit was communicated to the client via mail${providedTo}. Included in the letter was a recovery resource handout outlining local options for urgent support, harm reduction services, MAT providers, and peer recovery resources.`;
            } else if (clientType === 'no-criteria') {
    const urineScreenResult = nonAdmittedUrineScreen.value || '[urine screen result]';
    const providedTo = nonAdmittedProvidedTo3.value ? ` and ${nonAdmittedProvidedTo3.value}` : '';
    finalNote = `Client will not be admitted for treatment at this time due to not meeting diagnostic criteria. Urine screen was ${urineScreenResult} and no concerns were reported by collateral contacts. An outcome letter was provided to the client${providedTo}.`;
}
        } else if (selectedNoteType === 'injections') {
            const injectionType = injectionTypeSelect.value;
            switch (injectionType) {
                case 'vivitrol':
                    finalNote = `Vivitrol 380mg Sus ER rec\nSuspension prepared as instructed with preparation needle.\nSite: ${vivitrolSite.value || '[Site]'}\nLot #: ${vivitrolLot.value || '[Lot #]'}\nExp date: ${vivitrolExp.value || '[Exp Date]'}\nSN: ${vivitrolSn.value || '[SN]'}\nGluteal injection site identified by landmarks, prepped with alcohol swab. 2-inch admin needle used. 4.2 ml of suspension injected (Vivitrol 380 mg) with scant bleeding, Band-aid applied. Pt tolerated procedure well without complication. Reviewed with Pt medication side effects, signs/systems of infection at injection site. Encouraged PT to contact clinic for any concerns/ questions regarding injection.\nNext scheduled Injection: ${vivitrolNextInjection.value || '[Next Injection Date]'}`;
                    break;
                case 'sublocade':
                    finalNote = `Sublocade SQ injection administered\nSite: ${sublocadeSite.value || '[Site]'}\nLot #: ${sublocadeLot.value || '[Lot #]'}\nExp date: ${sublocadeExp.value || '[Exp Date]'}\nSN: ${sublocadeSn.value || '[SN]'}\nIce pack applied to site prior to administration Cold Spray applied to site. Site prepped with alcohol swab. Pt tolerated procedure well without complication. Reviewed with Pt medication side effects, signs/systems of infection at injection site. Encouraged PT to contact clinic for any concerns/ questions regarding injection. PT instructed on importance of medication adherence and follow appointments with providers.\nNext scheduled Injection: ${sublocadeNextInjection.value || '[Next Injection Date]'}`;
                    break;
                case 'brixadi':
                    finalNote = `Brixadi SQ injection administered\nSite: ${brixadiSite.value || '[Site]'}\nLot #: ${brixadiLot.value || '[Lot #]'}\nExp date: ${brixadiExp.value || '[Exp Date]'}\nSN: ${brixadiSn.value || '[SN]'}\nSite prepped with alcohol swab. Pt tolerated procedure. Reviewed with Pt medication side effects, signs/systems of infection at injection site. Encouraged PT to contact clinic for any concerns/ questions regarding injection.\nNext scheduled Injection: ${brixadiNextInjection.value || '[Next Injection Date]'}`;
                    break;
            }
        } else if (selectedNoteType === 'medical-screening') {
            // Logic for Medical Screening Note
            let pcpNarrative = [];
            let diseaseNarrative = [];
            let substanceNarrative = [];

            // Helper to get radio value
            const getRadioValue = (name) => {
                const radio = document.querySelector(`#medical-screening-container input[name="${name}"]:checked`);
                return radio ? radio.value : '';
            };

            // --- PCP and Physical Exams ---
            const hasPCP = getRadioValue('hasPCP');
            if (hasPCP === 'yes') {
                const pcpName = document.getElementById('pcpName').value || '[PCP Name Not Provided]';
                const lastPEDate = document.getElementById('lastPEDate').value || '[Date Not Provided]';
                pcpNarrative.push(`Client has a primary care physician, ${pcpName}. Their last physical exam was on ${lastPEDate}.`);
                if (document.getElementById('pcpDiscussed').checked) {
                    pcpNarrative.push("Writer and client discussed the importance of routine health maintenance and management of chronic conditions with their PCP.");
                }
            } else if (hasPCP === 'no') {
                pcpNarrative.push("Client does not have a primary care physician.");
                const hadPE = getRadioValue('hadPELastYear');
                if (hadPE === 'yes') {
                    const peLocation = document.getElementById('peLocation').value || '[Location Not Provided]';
                    const peConsent = document.querySelector('[name="peConsent"]').value;
                    let consentText = peConsent === 'yes' ? 'and consent was obtained to get PE records.' : 'and consent was declined to get PE records.';
                    if (!peConsent) consentText = "Consent to obtain records was not addressed.";
                    pcpNarrative.push(`Client reports having a physical exam within the last year at ${peLocation}, ${consentText}`);
                } else if (hadPE === 'no') {
                    if (document.getElementById('noPeDiscussed').checked) {
                        pcpNarrative.push("Client has not had a physical exam in the last year. Writer and client discussed the importance of routine health maintenance and management of chronic conditions with a PCP. Client was provided with information of local PCP offices that are taking new clients, and the writer offered to provide support in making a referral.");
                    }
                }
            }

            const pcpConsent = getRadioValue('pcpConsentCompleted');
            if (pcpConsent === 'yes') {
                pcpNarrative.push("PCP consent was completed. Writer reviewed with client OASAS guidelines regarding obtaining a recent physical exam review and the information that client is consenting to.");
            } else if (pcpConsent === 'no') {
                const declineReason = getRadioValue('declineReason');
                let reasonText = "Client declined consent for Delphi to contact their PCP.";
                if (declineReason === 'confidential') {
                    reasonText += " The reason provided was that the client does not want their PCP to know about their substance abuse treatment.";
                } else if (declineReason === 'other') {
                    const otherReason = document.querySelector('[name="declineReasonOtherText"]').value || '[Reason not specified]';
                    reasonText += ` The reason provided was: ${otherReason}.`;
                }
                pcpNarrative.push(reasonText);
                if (document.getElementById('oasasReviewedNoConsent').checked) {
                    pcpNarrative.push("Writer reviewed with client OASAS guidelines regarding obtaining a recent physical exam review, clarifying that the request would only be for the last PE and current medication list. Client understands and does not consent to PCP contact.");
                }
            }
            
            // --- Communicable Diseases ---
            const stdHepTest = getRadioValue('stdHepTest');
            if (stdHepTest === 'yes') {
                const status = document.getElementById('stdHepStatus').value;
                if (status === 'known_negative') {
                    diseaseNarrative.push("Client reports recent STD/HEP testing and states they are known to be negative, with no concerns from themselves or their PCP. Writer and client reviewed the importance of STD/communicable disease testing and prevention resources available to the client at Delphi and in the community.");
                } else if (status === 'known_positive') {
                    const positiveSpecify = document.getElementById('stdHepPositiveSpecify').value || '[Condition Not Specified]';
                    diseaseNarrative.push(`Client reports recent STD/HEP testing and is known to be positive for: ${positiveSpecify}.`);
                }
            } else if (stdHepTest === 'no') {
                diseaseNarrative.push("Client reports no recent STD/HEP testing.");
            }

            const tbTest = getRadioValue('tbTest');
            if (tbTest === 'yes') {
                const tbResult = getRadioValue('tbResult');
                if (tbResult === 'negative') {
                    diseaseNarrative.push("Client reports having been tested for TB and had a negative PPD. Writer offered to connect the client to resources to support their education, risk reduction, counseling, and testing services, and an overview of the benefits was provided.");
                } else if (tbResult === 'positive') {
                    const details = document.getElementById('tbPositiveDetails').value || '[Details not provided]';
                    diseaseNarrative.push(`Client reports a positive TB test. Details: ${details}.`);
                }
            } else if (tbTest === 'no') {
                diseaseNarrative.push("Client reports that they have not been tested for TB or do not remember getting tested.");
                const tbRisk = getRadioValue('tbRiskFactors');
                const tbReferral = document.getElementById('tbReferralStatus').value;
                let referralText = tbReferral ? `Client ${tbReferral} the offer for support with a referral.` : '';
                if (tbRisk === 'yes') {
                    diseaseNarrative.push(`Client presents with risk factors indicating the need for TB testing. The medical director was notified by the writer. The client has been offered connection to resources for education, risk reduction, counseling, and testing services. An overview of benefits and a warm hand-off referral has been offered. ${referralText}`);
                } else if (tbRisk === 'no') {
                    diseaseNarrative.push(`Client does not have risk factors/symptoms that indicate a need for TB testing. The client has been offered connection to resources for education, risk reduction, counseling, and testing services. An overview of benefits and a warm hand-off referral has been offered. ${referralText}`);
                }
            }

            // --- Substance Use ---
            const tobaccoUse = getRadioValue('tobaccoUse');
            if (tobaccoUse === 'yes') {
                const tobaccoAmount = document.getElementById('tobaccoAmount').value;
                const vapeAmount = document.getElementById('vapeAmount').value;
                let useText = "Client reports using tobacco";
                if (tobaccoAmount) useText += ` (${tobaccoAmount})`;
                if (vapeAmount) useText += ` and nicotine vape products (${vapeAmount})`;
                useText += ".";
                substanceNarrative.push(useText);

                const cessationInterest = getRadioValue('cessationInterest');
                if (cessationInterest === 'yes') {
                    substanceNarrative.push("Client is interested in quitting smoking. Writer and client discussed the NY State QUITS hotline, and information was provided. Writer also discussed that medication providers at Delphi could prescribe medications for smoking cessation.");
                    const scheduled = getRadioValue('medProviderScheduled');
                    if (scheduled === 'yes') {
                        substanceNarrative.push("Client is scheduled with a medication provider at Delphi.");
                    } else if (scheduled === 'no') {
                        substanceNarrative.push("Client declined an appointment with a medication provider but is aware they can schedule one in the future.");
                    }
                } else if (cessationInterest === 'no') {
                    substanceNarrative.push("Client is not currently interested in quitting smoking. Writer and client discussed the NY State QUITS hotline, and information was provided. Writer discussed that medication providers would be able to prescribe medications for smoking cessation if the client becomes interested in the future.");
                }
            } else if (tobaccoUse === 'no') {
                substanceNarrative.push("Client denies tobacco use.");
            }

            const onMAT = getRadioValue('onMAT');
            if (onMAT === 'yes') {
                substanceNarrative.push("Client is currently taking medication to manage their substance use disorder.");
                const matProviderStatus = getRadioValue('matProviderStatus');
                if (matProviderStatus === 'happy') {
                    substanceNarrative.push("Client reports they are happy with their current provider.");
                } else if (matProviderStatus === 'switch') {
                    substanceNarrative.push("Client would like to switch their MAT provider to Delphi and has been scheduled with a medication provider.");
                }
            } else if (onMAT === 'no') {
                substanceNarrative.push("Medication Assisted Treatment (MAT) was introduced, and education was offered based on the client's history and current presentation. An overview of MAT’s benefits and risks was provided, and the client was offered a connection to medication management in the clinic.");
                const matInterest = getRadioValue('matInterest');
                if (matInterest === 'declined') {
                    substanceNarrative.push("Client declined MAT at this time and is aware they can discuss it with their therapist or nurse in the future if interested.");
                } else if (matInterest === 'accepted') {
                    substanceNarrative.push("Client would like to see a medication provider for MAT and has been scheduled.");
                }
            }

            const narcanOffered = getRadioValue('narcanOffered');
            if (narcanOffered === 'yes') {
                substanceNarrative.push("Client was provided Narcan training, overdose prevention education, and given a Narcan kit.");
            } else if (narcanOffered === 'no') {
                substanceNarrative.push("Client declined Narcan training and a Narcan kit. Client was given overdose prevention education and resources for Narcan if they would like to be trained in the future.");
            }
            
            const pcpText = pcpNarrative.join(' ');
            const diseaseText = diseaseNarrative.join(' ');
            const substanceText = substanceNarrative.join(' ');

            let narrativeParts = [];
            if (pcpText.trim() !== '') {
                narrativeParts.push('[PCP AND PHYSICAL EXAMS]\n' + pcpText);
            }
            if (diseaseText.trim() !== '') {
                narrativeParts.push('[COMMUNICABLE DISEASES]\n' + diseaseText);
            }
            if (substanceText.trim() !== '') {
                narrativeParts.push('[SUBSTANCE USE]\n' + substanceText);
            }

            finalNote = narrativeParts.join('\n\n');
        } else if (selectedNoteType === 'mdt') {
            let noteParts = [];
            const diagnosisElements = mdtDiagnosisContainer.querySelectorAll('select');
            const selectedOptions = Array.from(diagnosisElements).map(select => select.value).filter(val => val);
            const diagnosis = selectedOptions.length > 0 ? selectedOptions.join(',\n') : '[SPECIFY DIAGNOSIS]';
            noteParts.push(`Diagnosis:\n${diagnosis}`);

            noteParts.push(`Reason on High Risk:\n${mdtReasonHighRisk.value || '[Reason]'}`);
            noteParts.push(`Criteria to Come Off High Risk:\n${mdtCriteriaOffHighRisk.value || '[Criteria]'}`);
            noteParts.push(`Risk Factors:\n${mdtRiskFactors.value || '[Factors]'}`);
            noteParts.push(`Protective Factors:\n${mdtProtectiveFactors.value || '[Factors]'}`);
            noteParts.push(`Care Coordination Needs:\n${mdtCareCoordination.value || '[Needs]'}`);

            let stageOfChange = mdtStageOfChange.value;
            if (stageOfChange === 'Other') {
                stageOfChange = mdtStageOfChangeOther.value || '[Other Stage]';
            }
            noteParts.push(`Stage of Change / Motivation Level:\n${stageOfChange || '[Stage]'}`);

            noteParts.push(`Safety Plan Completed:\n${mdtSafetyPlanCompleted.value || '[Yes/No]'}`);
            noteParts.push(`Safety Plan Applicable to Current Presentation:\n${mdtSafetyPlanApplicable.value || '[Details]'}`);
            noteParts.push(`MAT Status:\n${mdtMatStatus.value || '[Status]'}`);
            noteParts.push(`Date Last Urine Toxicology Collected:\n${mdtLastToxDate.value || '[Date]'}`);
            noteParts.push(`Result of Toxicology Screen:\n${mdtToxResult.value || '[Result]'}`);
            noteParts.push(`Is Client Engaging?:\n${mdtClientEngaging.value || '[Engaging Status]'}`);
            noteParts.push(`Most Recent Appointment Date:\n${mdtMostRecentAppt.value || '[Date]'}`);
            noteParts.push(`Next Appointment Date:\n${mdtNextAppt.value || '[Date]'}`);
            noteParts.push(`Progress on Most Recent MDT Recommendations:\n${mdtProgressRecommendations.value || '[Progress]'}`);
            noteParts.push(`Guiding Question(s) for Today’s MDT Discussion:\n${mdtGuidingQuestions.value || '[Questions]'}`);

            finalNote = noteParts.join('\n\n');
    } else if (selectedNoteType === 'med-mgmt-follow-up') {
        let noteParts = [];
        noteParts.push(`Chief Complaint:\n${document.getElementById('mmfu-chief-complaint').value || '[Client’s statement]'}`);

        const diagnoses = Array.from(document.querySelectorAll('#mmfu-diagnosis-container select'))
            .map(select => select.value.trim()).filter(val => val);
        noteParts.push(`Diagnosis:\n${diagnoses.length > 0 ? diagnoses.join('\n') : '[Diagnosis]'}`);

        let subjectiveParts = [];
        const presentingConcern = document.getElementById('mmfu-presenting-concern').value || '[presenting concern]';
        const medRegimen = document.getElementById('mmfu-med-regimen').value || '[medication regimen]';
        subjectiveParts.push(`Client presents for ${presentingConcern}. Current medication regimen (${medRegimen}) addresses the presenting concern.`);
        subjectiveParts.push(`Symptoms/Cravings: ${document.getElementById('mmfu-symptoms').value || '[Not documented]'}`);
        subjectiveParts.push(`Substance Use: ${document.getElementById('mmfu-substance-use').value || '[Not documented]'}`);
        subjectiveParts.push(`Medication Adherence: ${document.getElementById('mmfu-adherence').value || '[Not documented]'}`);
        subjectiveParts.push(`Side Effects/Complications: ${document.getElementById('mmfu-side-effects').value || '[Not documented]'}`);
        subjectiveParts.push(`Psychosocial/Environmental Changes: ${document.getElementById('mmfu-psychosocial').value || '[Not documented]'}`);
        
        const nicotineUse = document.getElementById('mmfu-nicotine-use').value;
        if (nicotineUse) {
            let nicotineSentence = `The patient ${nicotineUse === 'yes' ? 'reports' : 'denies'} using nicotine.`;
            if (nicotineUse === 'yes') {
                const nicotineInterest = document.getElementById('mmfu-nicotine-interest').value;
                if (nicotineInterest) {
                    nicotineSentence += ` Client ${nicotineInterest === 'yes' ? 'is' : 'is not'} interested in reduction or cessation of nicotine.`;
                }
                const nicotineDetails = document.getElementById('mmfu-nicotine-details').value;
                if (nicotineDetails) {
                    nicotineSentence += `\n\nNicotine History: ${nicotineDetails}`;
                }
            }
            subjectiveParts.push(nicotineSentence);
        }

        noteParts.push(`Subjective:\n${subjectiveParts.join('\n\n')}`);

        let objectiveParts = [];
        objectiveParts.push(`I-STOP/Prescription Monitoring:\n${document.getElementById('mmfu-istop').value || '[Not documented]'}`);
        objectiveParts.push(`UDS Results (Reviewed):\n${document.getElementById('mmfu-uds').value || '[Not documented]'}`);
        noteParts.push(`Objective:\n${objectiveParts.join('\n\n')}`);

        let assessmentParts = [];
        assessmentParts.push(`Interventions: ${document.getElementById('mmfu-interventions').value || '[Not documented]'}`);
        assessmentParts.push(`Medication Plan: ${document.getElementById('mmfu-med-plan').value || '[Not documented]'}`);
        assessmentParts.push(`Client's Response: ${document.getElementById('mmfu-client-response').value || '[Not documented]'}`);
        assessmentParts.push(`Suicidality: ${document.getElementById('mmfu-suicidality').value}`);
        noteParts.push(`Assessment:\n${assessmentParts.join('\n\n')}`);

        let planParts = [];
        if (document.getElementById('mmfu-plan-continue-meds').checked) planParts.push('Continue medications as prescribed.');
        if (document.getElementById('mmfu-plan-attend-appts').checked) planParts.push('Attend all medication management appointments.');
        const followupTime = document.getElementById('mmfu-plan-followup-time').value || '[timeframe]';
        planParts.push(`Follow up in ${followupTime} for medication management.`);
        const followupProvider = document.getElementById('mmfu-plan-followup-provider').value || '[provider]';
        planParts.push(`Follow up with ${followupProvider} as scheduled.`);
        if (document.getElementById('mmfu-plan-call-911').checked) planParts.push('Client agrees to call 911 and contact staff with any SI/HI or urgent mental health concerns.');
        noteParts.push(`Plan:\n${planParts.join('\n\n')}`);

        finalNote = noteParts.join('\n\n');
    } else if (selectedNoteType === 'opioid-use-disorder-short') {
            let noteParts = [];
            noteParts.push("New patient visit.");
            noteParts.push(`Chief Complaint: Opioid Use Disorder`); // Static Chief Complaint

            let suh = [];
            if (document.getElementById('ouds-age-first-use').value) suh.push(`Age at first use: ${document.getElementById('ouds-age-first-use').value}`);
            if (document.getElementById('ouds-types-substance').value) suh.push(`Type(s) of substance: ${document.getElementById('ouds-types-substance').value}`);
            if (document.getElementById('ouds-frequency').value) suh.push(`Frequency of use: ${document.getElementById('ouds-frequency').value}`);
            if (document.getElementById('ouds-prev-treatment').value) suh.push(`Previous treatment programs: ${document.getElementById('ouds-prev-treatment').value}`);
            if (document.getElementById('ouds-prev-recovery').value) suh.push(`Previous periods in recovery: ${document.getElementById('ouds-prev-recovery').value}`);
            const activeUse = document.querySelector('input[name="ouds-active-use"]:checked');
            if (activeUse) {
                suh.push(`Current active use: ${activeUse.value}`);
                if (activeUse.value === 'yes' && document.getElementById('ouds-last-use-date').value) {
                    suh.push(`Date of last use: ${document.getElementById('ouds-last-use-date').value}`);
                }
            }
            if (suh.length > 0) noteParts.push(`Substance Use History\n${suh.join('\n')}`);

            let pharm = [];
            const onPharm = document.querySelector('input[name="ouds-pharmacotherapy"]:checked');
            if (onPharm) {
                pharm.push(`Patient current on pharmacotherapy for SUD: ${onPharm.value}`);
                if (onPharm.value === 'yes') {
                    if (document.getElementById('ouds-symptoms').value) pharm.push(`Symptoms/cravings: ${document.getElementById('ouds-symptoms').value}`);
                    if (document.getElementById('ouds-substance-use').value) pharm.push(`Substance use: ${document.getElementById('ouds-substance-use').value}`);
                    if (document.getElementById('ouds-adherence').value) pharm.push(`Medication adherence: ${document.getElementById('ouds-adherence').value}`);
                    if (document.getElementById('ouds-side-effects').value) pharm.push(`Side effects/complications: ${document.getElementById('ouds-side-effects').value}`);
                }
            }
            if (pharm.length > 0) noteParts.push(`Pharmacotherapy\n${pharm.join('\n')}`);

            let otherSubs = [];
            oudsSubstances.forEach(key => {
                const cb = document.getElementById(`ouds-sub-${key}`);
                if (cb && cb.checked) {
                    let detail = `${document.querySelector(`label[for="ouds-sub-${key}"]`).textContent}`;
                    if (key === 'other' && document.getElementById('ouds-sub-other-text').value) {
                        detail += ` (${document.getElementById('ouds-sub-other-text').value})`;
                    }
                    const amt = document.getElementById(`ouds-amt-${key}`).value;
                    const date = document.getElementById(`ouds-date-${key}`).value;
                    if (amt) detail += ` - Amount used: ${amt}`;
                    if (date) detail += ` - Last date of use: ${date}`;
                    otherSubs.push(detail);
                }
            });
document.getElementById('ouds-psych-ideation').addEventListener('change', (event) => {
        const safetyContainer = document.getElementById('ouds-safety-planning-container');
        const safetyCheckbox = document.getElementById('ouds-safety-planning-checkbox');
        if (event.target.value.includes('Endorses')) {
            safetyContainer.classList.remove('hidden');
        } else {
            safetyContainer.classList.add('hidden');
            safetyCheckbox.checked = false; // Uncheck it when hidden
        }
        updateFinalNote();
    });
            if (otherSubs.length > 0) noteParts.push(`Any other substance use?\n${otherSubs.join('\n')}`);

            let medHistory = [];
            ['ivdu', 'shared', 'hep-c', 'hiv'].forEach(id => {
                if (document.getElementById(`ouds-med-${id}`).checked) {
                    medHistory.push(`${document.querySelector(`label[for="ouds-med-${id}"]`).textContent}`);
                }
            });
            if (medHistory.length > 0) noteParts.push(`Medical History Related to Substance Use:\n${medHistory.join('\n')}`);

            if (document.getElementById('ouds-pmh').value) noteParts.push(`PMH: ${document.getElementById('ouds-pmh').value}`);
            if (document.getElementById('ouds-psych').value) noteParts.push(`Psych History: ${document.getElementById('ouds-psych').value}`);
            if (document.getElementById('ouds-medications').value) noteParts.push(`Medications: ${document.getElementById('ouds-medications').value}`);
            if (document.getElementById('ouds-allergies').value) noteParts.push(`Allergies: ${document.getElementById('ouds-allergies').value}`);
            if (document.getElementById('ouds-pcp').value) noteParts.push(`PCP: ${document.getElementById('ouds-pcp').value}`);
            if (document.getElementById('ouds-last-pcp-visit').value) noteParts.push(`Last Visit with PCP: ${document.getElementById('ouds-last-pcp-visit').value}`);

            let ros = [];
            const gi = document.querySelector('input[name="ouds-gi-const"]:checked');
            if (gi) ros.push(`- GI: Constipation: ${gi.value}`);
           const psych = document.getElementById('ouds-psych-ideation');
            if (psych && psych.value) ros.push(`- Psychiatric: Suicidal or Homicidal Ideation: ${psych.value}`);
            
            // Check for the safety planning checkbox separately
            const safetyCheckbox = document.getElementById('ouds-safety-planning-checkbox');
            if (safetyCheckbox && safetyCheckbox.checked) {
                ros.push(`Staff provided safety planning.`);
            }
            if (ros.length > 0) noteParts.push(`Pertinent Review of Systems:\n${ros.join('\n')}`);

            if (document.getElementById('ouds-family').value) noteParts.push(`Family History: ${document.getElementById('ouds-family').value}`);
            if (document.getElementById('ouds-social').value) noteParts.push(`Social: ${document.getElementById('ouds-social').value}`);
            if (document.getElementById('ouds-living').value) noteParts.push(`Current Living Situation: ${document.getElementById('ouds-living').value}`);
            if (document.getElementById('ouds-employment').value) noteParts.push(`Employment: ${document.getElementById('ouds-employment').value}`);
            if (document.getElementById('ouds-leisure').value) noteParts.push(`Leisure: ${document.getElementById('ouds-leisure').value}`);

            let objective = []; // Re-declare 'objective' specifically for this section
                        if (document.getElementById('ouds-mse').value) objective.push(`MSE:\n${document.getElementById('ouds-mse').value}`);
                        if (objective.length > 0) noteParts.push(`Objective:\n${objective.join('\n')}`);

                        if (document.getElementById('ouds-istop').value) noteParts.push(`I-STOP/Prescription Monitoring:\n${document.getElementById('ouds-istop').value}`);
            if (document.getElementById('ouds-uds').value) noteParts.push(`UDS Results (Reviewed):\n${document.getElementById('ouds-uds').value}`);

            let assessmentText = [];
            if (document.getElementById('ouds-assess-purpose').checked) assessmentText.push("Medication Purpose & Use:\nDiscussed that buprenorphine is a partial opioid agonist used to treat opioid use disorder by reducing cravings and withdrawal symptoms. Explained the induction process and the need to be in mild to moderate withdrawal before first dose to avoid precipitated withdrawal. Reviewed dosing schedule, route of administration (typically sublingual or buccal), and importance of adherence.");
            if (document.getElementById('ouds-assess-side-effects').checked) assessmentText.push("Potential Side Effects:\nReviewed common side effects (e.g., headache, constipation, nausea, sedation) and rare but serious risks (e.g., respiratory depression when combined with other sedatives, hepatic injury).");
            if (document.getElementById('ouds-assess-overdose').checked) assessmentText.push("Overdose Risk & Safety:\nAdvised that risk of overdose is lower than full opioid agonists but present if combined with other CNS depressants (benzodiazepines, alcohol). Provided prescription for Naloxone and instructed patient/family on its use.");
            if (document.getElementById('ouds-assess-dental').checked) assessmentText.push("Dental Health Considerations:\nEducated patient that use of buprenorphine, especially in sublingual/buccal forms, has been associated with dental problems (tooth decay, cavities, oral infections).\nRecommended:\no Rinsing mouth with water after each dose\no Waiting at least 1 hour after taking medication before brushing teeth (to avoid enamel damage)\no Maintaining regular dental hygiene and biannual dental visits\no Notifying dentist about buprenorphine use");
            if (document.getElementById('ouds-assess-followup').checked) assessmentText.push("Follow-up & Monitoring:\nExplained need for regular follow-up appointments to assess response, side effects, urine drug testing, and support services (counseling, behavioral therapy).");
            if (document.getElementById('ouds-assess-consent').checked) assessmentText.push("Informed Consent:\nPatient expressed understanding of risks and benefits, and agreed to start buprenorphine treatment.");
            if (document.getElementById('ouds-assess-therapeutic-contract').checked) assessmentText.push("Therapeutic Contract:\nPatient reviewed and signed the therapeutic contract, acknowledging understanding of program expectations, responsibilities, and the collaborative nature of treatment.");
            if (assessmentText.length > 0) noteParts.push(`Assessment:\nOpioid Use Disorder appropriate for pharmacotherapy\n\n${assessmentText.join('\n\n')}`);

            let plan = [];
            if (document.getElementById('ouds-plan-start').checked) plan.push("Start buprenorphine as discussed");
            if (document.getElementById('ouds-plan-prescribe').checked) plan.push("Provide prescription and instructions");
            if (document.getElementById('ouds-plan-naloxone').checked) plan.push("Provide naloxone kit");
            if (document.getElementById('ouds-plan-followup-time').value) plan.push(`Schedule follow-up in ${document.getElementById('ouds-plan-followup-time').value}`);
            if (document.getElementById('ouds-plan-dental').checked) plan.push("Encourage dental visit within next 3 months");
            if (plan.length > 0) noteParts.push(`Plan:\n${plan.join('\n')}`);

            let time = [];
            if (document.getElementById('ouds-time-face').checked) time.push(`Face to face/telephonic time: ${document.getElementById('ouds-time-face-txt').value}`);
            if (document.getElementById('ouds-time-doc').checked) time.push(`Documentation: ${document.getElementById('ouds-time-doc-txt').value}`);
            if (document.getElementById('ouds-time-coord').checked) time.push(`Coordination of care: ${document.getElementById('ouds-time-coord-txt').value}`);
            if (document.getElementById('ouds-time-total').checked) time.push(`Total visit time: ${document.getElementById('ouds-time-total-txt').value}`);
            if (time.length > 0) noteParts.push(`Time Statement\nToday's visit time consisted of the following:\n${time.join('\n')}`);

            finalNote = noteParts.join('\n\n');
} else if (selectedNoteType === 'alcohol-use-disorder-short') {
    let noteParts = [];
    noteParts.push("New patient visit.");
    noteParts.push(`Chief Complaint: Alcohol Use Disorder`);

    let audsSuh = [];
    if (document.getElementById('auds-age-first-use').value) audsSuh.push(`Age at first use: ${document.getElementById('auds-age-first-use').value}`);
    if (document.getElementById('auds-types-alcohol').value) audsSuh.push(`Type(s) of Alcohol: ${document.getElementById('auds-types-alcohol').value}`);
    if (document.getElementById('auds-frequency').value) audsSuh.push(`Frequency of use: ${document.getElementById('auds-frequency').value}`);
    if (document.getElementById('auds-prev-treatment').value) audsSuh.push(`Previous treatment programs: ${document.getElementById('auds-prev-treatment').value}`);
    if (document.getElementById('auds-prev-recovery').value) audsSuh.push(`Previous periods in recovery: ${document.getElementById('auds-prev-recovery').value}`);
    if (document.getElementById('auds-withdrawal-exp').value) audsSuh.push(`Experience of withdrawal symptoms in past: ${document.getElementById('auds-withdrawal-exp').value}`);
    if (document.getElementById('auds-withdrawal-severity').value) audsSuh.push(`Severity of withdrawal: ${document.getElementById('auds-withdrawal-severity').value}`);

    const audsActiveDrinking = document.querySelector('input[name="auds-active-drinking"]:checked');
    if (audsActiveDrinking) {
        audsSuh.push(`Current active drinking: ${audsActiveDrinking.value}`);
        if (audsActiveDrinking.value === 'yes' && document.getElementById('auds-last-drink-date').value) {
            audsSuh.push(`Last drink: ${document.getElementById('auds-last-drink-date').value}`);
        }
    }
    if (audsSuh.length > 0) noteParts.push(`Alcohol Use History\n${audsSuh.join('\n')}`);

    let audsPharm = [];
    const audsOnPharm = document.querySelector('input[name="auds-pharmacotherapy"]:checked');
    if (audsOnPharm) {
        audsPharm.push(`Patient current on pharmacotherapy for AUD: ${audsOnPharm.value}`);
        if (audsOnPharm.value === 'yes') {
            if (document.getElementById('auds-symptoms').value) audsPharm.push(`Symptoms/Cravings: ${document.getElementById('auds-symptoms').value}`);
            if (document.getElementById('auds-substance-use').value) audsPharm.push(`Substance Use: ${document.getElementById('auds-substance-use').value}`);
            if (document.getElementById('auds-adherence').value) audsPharm.push(`Medication Adherence: ${document.getElementById('auds-adherence').value}`);
            if (document.getElementById('auds-side-effects').value) audsPharm.push(`Side Effects/Complications: ${document.getElementById('auds-side-effects').value}`);
        }
    }
    if (audsPharm.length > 0) noteParts.push(`Pharmacotherapy\n${audsPharm.join('\n')}`);

    let audsOtherSubs = [];
    // Define audsSubstances directly within this block to ensure proper scope
    const audsSubstances = [
        'illicit-opioids', 'prescription-opioids', 'kratom', 'ivdu', 'benzodiazepines',
        'cocaine', 'amphet', 'hallucinogens', 'mdma', 'nicotine'
    ];
    audsSubstances.forEach(key => {
        const cb = document.getElementById(`auds-sub-${key}`);
        if (cb && cb.checked) {
            let detail = `${document.querySelector(`label[for="auds-sub-${key}"]`).textContent}`;
            const amt = document.getElementById(`auds-amt-${key}`).value;
            const date = document.getElementById(`auds-date-${key}`).value;
            if (amt) detail += ` - Amount used: ${amt}`;
            if (date) detail += ` - Last date of use: ${date}`;
            audsOtherSubs.push(detail);
        }
    });

    // Special handling for 'Other' substance if needed (if you add an 'other' checkbox/field for AUD)
    // if (document.getElementById('auds-sub-other') && document.getElementById('auds-sub-other').checked) {
    //     let detail = `Other: ${document.getElementById('auds-sub-other-text').value || '[Identify other drug]'}`;
    //     const amt = document.getElementById('auds-amt-other').value;
    //     const date = document.getElementById('auds-date-other').value;
    //     if (amt) detail += ` - Amount used: ${amt}`;
    //     if (date) detail += ` - Last date of use: ${date}`;
    //     audsOtherSubs.push(detail);
    // }

    if (audsOtherSubs.length > 0) noteParts.push(`Any other substance use?\n${audsOtherSubs.join('\n')}`);

    let audsMedHistory = [];
    ['ivdu', 'shared', 'hep-c', 'hiv'].forEach(id => {
        if (document.getElementById(`auds-med-${id}`).checked) {
            audsMedHistory.push(`${document.querySelector(`label[for="auds-med-${id}"]`).textContent}`);
        }
    });
    if (audsMedHistory.length > 0) noteParts.push(`Medical History Related to Substance Use:\n${audsMedHistory.join('\n')}`);

    if (document.getElementById('auds-pmh').value) noteParts.push(`PMH: ${document.getElementById('auds-pmh').value}`);
    if (document.getElementById('auds-psych').value) noteParts.push(`Psych History: ${document.getElementById('auds-psych').value}`);
    if (document.getElementById('auds-medications').value) noteParts.push(`Medications: ${document.getElementById('auds-medications').value}`);
    if (document.getElementById('auds-allergies').value) noteParts.push(`Allergies: ${document.getElementById('auds-allergies').value}`);
    if (document.getElementById('auds-pcp').value) noteParts.push(`PCP: ${document.getElementById('auds-pcp').value}`);
    if (document.getElementById('auds-last-pcp-visit').value) noteParts.push(`Last Visit with PCP: ${document.getElementById('auds-last-pcp-visit').value}`);
    if (document.getElementById('auds-pcp-referral').checked) noteParts.push("Client requires assistance securing a PCP.");

    let audsRos = [];
    const audsGi = document.querySelector('input[name="auds-gi-const"]:checked');
    if (audsGi) audsRos.push(`- GI: Constipation: ${audsGi.value}`);
    const audsPsychIdeation = document.getElementById('auds-psych-ideation');
    if (audsPsychIdeation && audsPsychIdeation.value) audsRos.push(`- Psychiatric: Suicidal or Homicidal Ideation: ${audsPsychIdeation.value}`);
    const audsSafetyCheckbox = document.getElementById('auds-safety-planning-checkbox');
    if (audsSafetyCheckbox && audsSafetyCheckbox.checked) {
        audsRos.push(`Staff provided safety planning.`);
    }
    if (audsRos.length > 0) noteParts.push(`Pertinent Review of Systems:\n${audsRos.join('\n')}`);

    if (document.getElementById('auds-family').value) noteParts.push(`Family History: ${document.getElementById('auds-family').value}`);
    if (document.getElementById('auds-social').value) noteParts.push(`Social: ${document.getElementById('auds-social').value}`);
    if (document.getElementById('auds-living').value) noteParts.push(`Current Living Situation: ${document.getElementById('auds-living').value}`);
    if (document.getElementById('auds-employment').value) noteParts.push(`Employment: ${document.getElementById('auds-employment').value}`);
    if (document.getElementById('auds-leisure').value) noteParts.push(`Leisure: ${document.getElementById('auds-leisure').value}`);

    let audsObjective = [];
        if (document.getElementById('auds-mse').value) audsObjective.push(`MSE:\n${document.getElementById('auds-mse').value}`);
        if (audsObjective.length > 0) noteParts.push(`Objective:\n${audsObjective.join('\n')}`);

    if (document.getElementById('auds-istop').value) noteParts.push(`I-STOP/Prescription Monitoring:\n${document.getElementById('auds-istop').value}`);
    if (document.getElementById('auds-uds').value) noteParts.push(`UDS Results (Reviewed):\n${document.getElementById('auds-uds').value}`);

    let audsAssessmentText = [];
    // General Counseling Provided
    if (document.getElementById('auds-assess-purpose').checked) audsAssessmentText.push("Medication Purpose & Use:\nDiscussed that medications can support recovery from alcohol use disorder by reducing cravings, reducing pleasurable effects of alcohol, and helping maintain abstinence. Reviewed that medication works best combined with counseling/behavioral therapy.");
    // Naltrexone General
    if (document.getElementById('auds-assess-naltrexone').checked) audsAssessmentText.push("Naltrexone (oral or injectable):\nBlocks opioid receptors to reduce rewarding effects of alcohol and decrease cravings. May cause nausea, headache, dizziness, fatigue. Should not be used if patient is currently using opioids or has acute hepatitis/liver failure. Importance of checking baseline liver function tests and periodic monitoring.");
    // Acamprosate General
    if (document.getElementById('auds-assess-acamprosate').checked) audsAssessmentText.push("Acamprosate:\nHelps restore brain chemical balance and reduce post-acute withdrawal symptoms/cravings. Generally well tolerated; may cause diarrhea. Requires dosing three times daily. Safe for use in liver disease but contraindicated in severe renal impairment — baseline kidney function to be checked.");
    // Disulfiram General
    if (document.getElementById('auds-assess-disulfiram').checked) audsAssessmentText.push("Disulfiram:\nCauses unpleasant reaction (flushing, nausea, vomiting, tachycardia) if alcohol is consumed. Must be fully abstinent before starting. Discussed risk of hepatotoxicity; will monitor liver function. Warned about avoiding alcohol-containing products (mouthwash, cough syrups, sauces, etc.).");
    // Safety & Monitoring General
    if (document.getElementById('auds-assess-safety-monitoring').checked) audsAssessmentText.push("Safety & Monitoring:\nEmphasized the need for medication adherence. Reviewed possible drug interactions and need to inform all healthcare providers of medication use. Arranged for baseline liver/kidney labs as appropriate, with periodic monitoring.");
    // Behavioral Support General
    if (document.getElementById('auds-assess-behavioral').checked) audsAssessmentText.push("Behavioral Support:\nReinforced that medication is most effective when combined with counseling, therapy, or mutual support groups (e.g., Alcoholics Anonymous). Provided resources for behavioral support.");
    // Informed Consent General
    if (document.getElementById('auds-assess-consent').checked) {
        const chosenMed = document.getElementById('auds-chosen-med').value || '[chosen medication]';
        audsAssessmentText.push(`Informed Consent:\nPatient verbalized understanding of medication options, side effects, and the importance of ongoing support. Patient agreed to start ${chosenMed}.`);
    }

    // Naltrexone Detailed Counseling
    if (document.getElementById('auds-naltrexone-purpose').checked) audsAssessmentText.push("Naltrexone Purpose & Mechanism:\nExplained that naltrexone blocks opioid receptors to reduce the pleasurable effects of alcohol and help decrease cravings.");
    if (document.getElementById('auds-naltrexone-dosing').checked) audsAssessmentText.push("Naltrexone Dosing & Administration:\nReviewed once-daily oral form or monthly injectable (Vivitrol) option. Patient to start on oral formulation first to confirm tolerability before long-acting injectable, if indicated.");
    if (document.getElementById('auds-naltrexone-side-effects').checked) audsAssessmentText.push("Naltrexone Side Effects:\nDiscussed common side effects (nausea, headache, dizziness, fatigue) and rare but serious risks (hepatotoxicity, allergic reaction).");
    if (document.getElementById('auds-naltrexone-safety').checked) audsAssessmentText.push("Naltrexone Safety Considerations:\nMust be opioid-free for at least 7–10 days before starting to avoid precipitated withdrawal. Not to be used if patient has acute hepatitis or liver failure. Will obtain baseline liver function tests and monitor periodically. Carry medical alert card/bracelet noting naltrexone use.");
    if (document.getElementById('auds-naltrexone-support').checked) audsAssessmentText.push("Naltrexone Behavioral Support:\nEncouraged concurrent participation in counseling or mutual support groups (e.g., Alcoholics Anonymous) to enhance success.");
    if (document.getElementById('auds-naltrexone-consent').checked) audsAssessmentText.push("Naltrexone Informed Consent:\nPatient verbalized understanding of risks, benefits, and alternatives and agreed to start naltrexone.");

    // Acamprosate Detailed Counseling
    if (document.getElementById('auds-acamprosate-purpose').checked) audsAssessmentText.push("Acamprosate Purpose & Mechanism:\nExplained that acamprosate helps reduce post-acute withdrawal symptoms and cravings by restoring brain neurotransmitter balance disrupted by chronic alcohol use.");
    if (document.getElementById('auds-acamprosate-dosing').checked) audsAssessmentText.push("Acamprosate Dosing & Administration:\nTaken as 666 mg three times daily (may need dose adjustment for low body weight). Emphasized importance of adherence to TID dosing schedule.");
    if (document.getElementById('auds-acamprosate-side-effects').checked) audsAssessmentText.push("Acamprosate Side Effects:\nDiscussed common side effect of diarrhea and possible GI upset; usually mild and transient.");
    if (document.getElementById('auds-acamprosate-safety').checked) audsAssessmentText.push("Acamprosate Safety Considerations:\nSafe for patients with liver disease. Contraindicated in severe renal impairment (CrCl ≤30 mL/min); use caution in moderate renal impairment. Will obtain baseline renal function prior to initiation.");
    if (document.getElementById('auds-acamprosate-support').checked) audsAssessmentText.push("Acamprosate Behavioral Support:\nReinforced need for concurrent counseling or support group involvement to improve success rates.");
    if (document.getElementById('auds-acamprosate-consent').checked) audsAssessmentText.push("Acamprosate Informed Consent:\nPatient verbalized understanding of medication purpose, side effects, and agreed to start acamprosate.");

    // Disulfiram Detailed Counseling
    if (document.getElementById('auds-disulfiram-purpose').checked) audsAssessmentText.push("Disulfiram Purpose & Mechanism:\nExplained that disulfiram works as an alcohol deterrent by causing an unpleasant physical reaction if alcohol is consumed (flushing, nausea, vomiting, headache, palpitations).");
    if (document.getElementById('auds-disulfiram-dosing').checked) audsAssessmentText.push("Disulfiram Dosing & Administration:\nTaken once daily; must be started only after patient has been completely abstinent from alcohol for at least 12–24 hours.");
    if (document.getElementById('auds-disulfiram-side-effects').checked) audsAssessmentText.push("Disulfiram Side Effects:\nReviewed potential side effects (drowsiness, fatigue, metallic taste) and rare but serious effects (hepatotoxicity, neuropathy, psychosis).");
    if (document.getElementById('auds-disulfiram-safety').checked) audsAssessmentText.push("Disulfiram Safety Considerations:\nAvoid all forms of alcohol (including hidden sources: mouthwash, cough syrups, sauces, topical products, colognes). Baseline liver function tests prior to starting; monitor periodically. Discussed that disulfiram reaction can occur up to 14 days after last dose.");
    if (document.getElementById('auds-disulfiram-support').checked) audsAssessmentText.push("Disulfiram Behavioral Support:\nEmphasized that disulfiram works best when combined with behavioral therapy or counseling.");
    if (document.getElementById('auds-disulfiram-consent').checked) audsAssessmentText.push("Disulfiram Informed Consent:\nPatient verbalized understanding of mechanism, risks, and need for strict alcohol abstinence, and agreed to start disulfiram.");

    if (audsAssessmentText.length > 0) noteParts.push(`Assessment:\nAlcohol Use Disorder appropriate for pharmacotherapy\n\n${audsAssessmentText.join('\n\n')}`);

    let audsPlan = [];
    // General Plan
    if (document.getElementById('auds-plan-gen-start').checked) {
        const chosenMed = document.querySelector('#auds-plan-gen-start ~ label input').value || '[chosen medication]';
        audsPlan.push(`Start ${chosenMed} as discussed`);
    }
    if (document.getElementById('auds-plan-gen-labs').checked) audsPlan.push("Obtain baseline labs (LFTs, renal function as indicated)");
    if (document.getElementById('auds-plan-gen-support').checked) audsPlan.push("Provide counseling/referral to behavioral support");
    if (document.getElementById('auds-plan-gen-fup').checked) audsPlan.push("Schedule follow-up in 2–4 weeks to assess response, side effects, adherence");
    if (document.getElementById('auds-plan-gen-pcp').checked) audsPlan.push("F/U with nurse to support connection with PCP");

    // Naltrexone Plan
    if (document.getElementById('auds-plan-nal-start').checked) audsPlan.push("Start oral naltrexone 50 mg daily");
    if (document.getElementById('auds-plan-nal-labs').checked) audsPlan.push("Obtain baseline LFTs");
    if (document.getElementById('auds-plan-nal-fup').checked) audsPlan.push("Schedule follow-up in 2–4 weeks");
    if (document.getElementById('auds-plan-nal-pcp').checked) audsPlan.push("F/U with nurse to support connection with PCP");

    // Acamprosate Plan
    if (document.getElementById('auds-plan-aca-start').checked) audsPlan.push("Start acamprosate 666 mg TID");
    if (document.getElementById('auds-plan-aca-labs').checked) audsPlan.push("Obtain baseline renal function");
    if (document.getElementById('auds-plan-aca-fup').checked) audsPlan.push("Schedule follow-up in 2–4 weeks");
    if (document.getElementById('auds-plan-aca-pcp').checked) audsPlan.push("F/U with nurse to support connection with PCP");

    // Disulfiram Plan
    if (document.getElementById('auds-plan-dis-start').checked) audsPlan.push("Start disulfiram 250 mg daily");
    if (document.getElementById('auds-plan-dis-labs').checked) audsPlan.push("Obtain baseline LFTs");
    if (document.getElementById('auds-plan-dis-fup').checked) audsPlan.push("Schedule follow-up in 2–4 weeks");
    if (document.getElementById('auds-plan-dis-pcp').checked) audsPlan.push("F/U with nurse to support connection with PCP");

    if (audsPlan.length > 0) noteParts.push(`Plan:\n${audsPlan.join('\n')}`);

    let audsTime = [];
    if (document.getElementById('auds-time-face').checked) audsTime.push(`Face to face/telephonic time: ${document.getElementById('auds-time-face-txt').value || '[time]'}`);
    if (document.getElementById('auds-time-doc').checked) audsTime.push(`Documentation: ${document.getElementById('auds-time-doc-txt').value || '[time]'}`);
    if (document.getElementById('auds-time-coord').checked) audsTime.push(`Coordination of care: ${document.getElementById('auds-time-coord-txt').value || '[time]'}`);
    if (document.getElementById('auds-time-total').checked) audsTime.push(`Total visit time: ${document.getElementById('auds-time-total-txt').value || '[time]'}`);
    if (audsTime.length > 0) noteParts.push(`Time Statement\nToday's visit time consisted of the following:\n${audsTime.join('\n')}`);

    finalNote = noteParts.join('\n\n');
}   
    else if (selectedNoteType === 'nurse-follow-up') {
            let noteParts = [];
            const diag = document.getElementById('nurse-diag').value;
            const goal = document.getElementById('nurse-goal').value;
            const reason = document.getElementById('nurse-reason').value;
            const services = document.getElementById('nurse-services').value;
            const response = document.getElementById('nurse-response').value;
            const plan = document.getElementById('nurse-plan').value;

            if (diag) noteParts.push(`Diagnosis:\n${diag}`);
            if (goal) noteParts.push(`Goal:\n${goal}`);
            if (reason) noteParts.push(`Reason for visit:\n${reason}`);
            if (services) noteParts.push(`Services provided & Client observations:\n${services}`);

let interventions = [];
            // Find all textareas within the container, excluding hidden ones
            document.querySelectorAll('#nurse-interventions-container textarea:not(.hidden)').forEach(textarea => {
                if (textarea.value.trim() !== '') {
                    interventions.push(`- ${textarea.value.trim()}`);
                }
            });
            if (interventions.length > 0) {
                noteParts.push(`Interventions:\n${interventions.join('\n')}`);
            }

            if (response) noteParts.push(`Client's response:\n${response}`);
            
            // Build Plan/Next Steps from checked items and manual text
            let planItems = [];
            for (let i = 1; i <= 4; i++) {
                const checkbox = document.getElementById(`nurse-plan-checkbox-${i}`);
                if (checkbox && checkbox.checked) {
                    let text = checkbox.getAttribute('data-text');
                    if (i === 3 || i === 4) {
                        const customInput = document.getElementById(`nurse-plan-custom-${i}`);
                        if (customInput && customInput.value.trim()) {
                            text += customInput.value.trim();
                            // For date input (checkbox 4), format the date nicely
                            if (i === 4) {
                                const dateObj = new Date(customInput.value + 'T00:00:00');
                                if (!isNaN(dateObj.getTime())) {
                                    text = text.replace(customInput.value, dateObj.toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' }));
                                }
                            }
                            text += '.';
                        }
                    }
                    planItems.push(text);
                }
            }
            
            // Combine checked items with manual textarea content
            let fullPlanText = planItems.join('\n');
            if (plan) {
                if (fullPlanText) fullPlanText += '\n' + plan;
                else fullPlanText = plan;
            }
            
            if (fullPlanText) noteParts.push(`Plan/Next Steps:\n${fullPlanText}`);

            finalNote = noteParts.join('\n\n');
            } else if (selectedNoteType === 'op-alcohol-detox') {
            // OP Alcohol Detox note generation with CIWA-Ar interpretation
            let noteParts = [];
            
            // Chief Complaint
            const opChief = document.getElementById('op-chief')?.value;
            if (opChief) noteParts.push(`Chief Complaint:\n${opChief}`);
            
            // HPI
            let hpiParts = [];
            const opHpiOnset = document.getElementById('op-hpi-onset')?.value;
            if (opHpiOnset) hpiParts.push(`Onset of use: ${opHpiOnset}`);
            const opHpiQty = document.getElementById('op-hpi-qty')?.value;
            if (opHpiQty) hpiParts.push(`Quantity/frequency: ${opHpiQty}`);
            const opHpiType = document.getElementById('op-hpi-type')?.value;
            if (opHpiType) hpiParts.push(`Type(s) of alcohol: ${opHpiType}`);
            const opHpiLastDrink = document.getElementById('op-hpi-last-drink')?.value;
            if (opHpiLastDrink) hpiParts.push(`Last drink: ${opHpiLastDrink}`);
            const opHpiPrevWithdrawal = document.getElementById('op-hpi-prev-withdrawal')?.value;
            if (opHpiPrevWithdrawal) hpiParts.push(`Prior withdrawal experiences: ${opHpiPrevWithdrawal}`);
            const opHpiPriorDetox = document.getElementById('op-hpi-prior-detox')?.value;
            if (opHpiPriorDetox) hpiParts.push(`Prior detoxifications: ${opHpiPriorDetox}`);
            const opHpiDurationSobriety = document.getElementById('op-hpi-duration-sobriety')?.value;
            if (opHpiDurationSobriety) hpiParts.push(`Longest period of sobriety: ${opHpiDurationSobriety}`);
            const opHpiTriggers = document.getElementById('op-hpi-triggers')?.value;
            if (opHpiTriggers) hpiParts.push(`Identified triggers: ${opHpiTriggers}`);
            
            if (hpiParts.length > 0) noteParts.push(`History of Present Illness:\n${hpiParts.join('\n')}`);
            
            // Withdrawal Symptoms Assessment
            let withdrawalSymptoms = [];
            const wsMap = {
                'op-w-tremor': 'Tremor',
                'op-w-anxiety': 'Anxiety',
                'op-w-nausea': 'Nausea/vomiting',
                'op-w-sweating': 'Diaphoresis/sweating',
                'op-w-insomnia': 'Insomnia',
                'op-w-hallucinations': 'Hallucinations',
                'op-w-seizures': 'Seizures',
                'op-w-headache': 'Headache',
                'op-w-palpitations': 'Palpitations',
                'op-w-other': 'Other symptoms'
            };
            for (const [id, label] of Object.entries(wsMap)) {
                if (document.getElementById(id)?.checked) {
                    withdrawalSymptoms.push(label);
                }
            }
            if (withdrawalSymptoms.length > 0) noteParts.push(`Withdrawal Symptoms Present:\n${withdrawalSymptoms.join(', ')}`);
            
            const opAssociated = document.getElementById('op-associated')?.value;
            if (opAssociated) noteParts.push(`Associated symptoms/comorbidities:\n${opAssociated}`);
            
            // Social/Support History
            const opSupport = document.getElementById('op-support')?.value;
            if (opSupport) noteParts.push(`Support system/family involvement:\n${opSupport}`);
            
            const opSocial = document.getElementById('op-social')?.value;
            if (opSocial) noteParts.push(`Social history:\n${opSocial}`);
            
            const opMotivation = document.getElementById('op-motivation')?.value;
            if (opMotivation) noteParts.push(`Readiness for treatment/motivation:\n${opMotivation}`);
            
            // PMH and Family History
            const opPmh = document.getElementById('op-pmh')?.value;
            if (opPmh) noteParts.push(`Past Medical History:\n${opPmh}`);
            
            const opFamily = document.getElementById('op-family')?.value;
            if (opFamily) noteParts.push(`Family History:\n${opFamily}`);
            
            // ROS
            let rosParts = [];
            const rosItems = [
                { id: 'op-ros-gi', label: 'GI' },
                { id: 'op-ros-cardiovascular', label: 'Cardiovascular' },
                { id: 'op-ros-neuro', label: 'Neurological' },
                { id: 'op-ros-psych', label: 'Psychiatric' },
                { id: 'op-ros-other', label: 'Other' }
            ];
            rosItems.forEach(item => {
                const val = document.getElementById(item.id)?.value;
                if (val) rosParts.push(`${item.label}: ${val}`);
            });
            if (rosParts.length > 0) noteParts.push(`Review of Systems:\n${rosParts.join('\n')}`);
            
            // Objective: Vitals & Physical Exam
            let objectiveParts = [];
            const vitalsItems = [
                { id: 'op-vs-bp', label: 'BP' },
                { id: 'op-vs-hr', label: 'HR' },
                { id: 'op-vs-rr', label: 'RR' },
                { id: 'op-vs-temp', label: 'Temp' },
                { id: 'op-vs-o2', label: 'O2 sat' }
            ];
            let vitalsParts = [];
            vitalsItems.forEach(item => {
                const val = document.getElementById(item.id)?.value;
                if (val) vitalsParts.push(`${item.label}: ${val}`);
            });
            if (vitalsParts.length > 0) objectiveParts.push(`Vitals:\n${vitalsParts.join(', ')}`);
            
            const peItems = [
                { id: 'op-pe-general', label: 'General' },
                { id: 'op-pe-neuro', label: 'Neuro exam' },
                { id: 'op-pe-cardiac', label: 'Cardiac' },
                { id: 'op-pe-lungs', label: 'Lungs' },
                { id: 'op-pe-abdomen', label: 'Abdomen' },
                { id: 'op-pe-extremities', label: 'Extremities' }
            ];
            let peParts = [];
            peItems.forEach(item => {
                const val = document.getElementById(item.id)?.value;
                if (val) peParts.push(`${item.label}: ${val}`);
            });
            if (peParts.length > 0) objectiveParts.push(`Physical Exam:\n${peParts.join('\n')}`);
            
            // CIWA-Ar Score with Interpretation
            const ciwaScore = document.getElementById('op-ciwa-score')?.value;
            if (ciwaScore) {
                let ciwaInterpretation = '';
                const score = parseInt(ciwaScore);
                if (score <= 9) {
                    ciwaInterpretation = 'minimal/mild withdrawal risk; monitor for symptom progression';
                } else if (score <= 19) {
                    ciwaInterpretation = 'moderate withdrawal risk; pharmacological support recommended (benzodiazepine-based detoxification)';
                } else {
                    ciwaInterpretation = 'severe withdrawal risk; strongly recommend inpatient detoxification and intensive pharmacological management';
                }
                objectiveParts.push(`CIWA-Ar Assessment: Score ${ciwaScore} — ${ciwaInterpretation}`);
            }
            
            if (objectiveParts.length > 0) noteParts.push(`Objective:\n${objectiveParts.join('\n\n')}`);
            
            // Labs
            let labsParts = [];
            const labItems = [
                { id: 'op-lab-cbc', label: 'CBC' },
                { id: 'op-lab-cmp', label: 'CMP' },
                { id: 'op-lab-lfts', label: 'LFTs' },
                { id: 'op-lab-mag', label: 'Magnesium' },
                { id: 'op-lab-phos', label: 'Phosphate' },
                { id: 'op-lab-uds', label: 'Urine drug screen' },
                { id: 'op-lab-ethanol', label: 'Serum ethanol' },
                { id: 'op-lab-preg', label: 'Pregnancy test' }
            ];
            labItems.forEach(item => {
                const checkbox = document.getElementById(item.id);
                if (checkbox?.checked) {
                    const notes = document.getElementById(`${item.id}-txt`)?.value;
                    let labText = item.label;
                    if (notes) labText += `: ${notes}`;
                    labsParts.push(labText);
                }
            });
            if (labsParts.length > 0) noteParts.push(`Diagnostic Testing:\n${labsParts.join('\n')}`);
            
            // Assessment
            let assessmentParts = [];
            const primaryDx = document.getElementById('op-primary-dx')?.value;
            if (primaryDx) assessmentParts.push(`Primary Diagnosis: ${primaryDx}`);
            
            const secondaryDx = document.getElementById('op-secondary-dx')?.value;
            if (secondaryDx) assessmentParts.push(`Secondary Diagnoses: ${secondaryDx}`);
            
            const withdrawalRisk = document.getElementById('op-withdrawal-risk')?.value;
            if (withdrawalRisk) assessmentParts.push(`Withdrawal Risk: ${withdrawalRisk}`);
            
            const seizureRisk = document.getElementById('op-seizure-risk')?.value;
            if (seizureRisk) assessmentParts.push(`Seizure/DT Risk: ${seizureRisk}`);
            
            const supportAdequate = document.querySelector('input[name="op-support-adequate"]:checked');
            if (supportAdequate) assessmentParts.push(`Social support adequate for outpatient management: ${supportAdequate.value}`);
            
            const safetyConcerns = document.querySelector('input[name="op-safety-concerns"]:checked');
            if (safetyConcerns) assessmentParts.push(`Safety concerns (SI/HI, medical instability): ${safetyConcerns.value}`);
            
            const safetyDetails = document.getElementById('op-safety-details')?.value;
            if (safetyDetails) assessmentParts.push(`Safety Plan Details:\n${safetyDetails}`);
            
            if (assessmentParts.length > 0) noteParts.push(`Assessment:\n${assessmentParts.join('\n')}`);
            
            // Plan: Detoxification Regimen with Dosing Option
            let planParts = [];
            
            // Check for low-risk medication selection
            const lowRiskSelected = document.querySelector('input[name="op-dosing-low-risk"]:checked');
            const highRiskSelected = document.querySelector('input[name="op-dosing-high-risk"]:checked');
            
            if (lowRiskSelected) {
                const med = lowRiskSelected.value;
                let medLabel = '';
                if (med === 'gabapentin') medLabel = 'Gabapentin 300 mg';
                else if (med === 'diazepam') medLabel = 'Diazepam 5 mg';
                else if (med === 'chlordiazepoxide') medLabel = 'Chlordiazepoxide 25 mg';
                
                planParts.push(`Dosing - Fixed Schedule Benzodiazepine/Gabapentin Regimen\n\nMedication: ${medLabel}\n\nSchedule:\n• Day 1: 1 tab QID (4 doses/day)\n• Day 2: 1 tab TID (3 doses/day)\n• Day 3: 1 tab BID (2 doses/day)\n• Day 4: 1 tab once daily\n\nPRN: Prescribe 5 additional tablets for breakthrough withdrawal symptoms.\n\nTotal dispensed: 15 tablets (10 scheduled + 5 PRN).`);
            }
            
            if (highRiskSelected) {
                const med = highRiskSelected.value;
                let medLabel = '';
                if (med === 'diazepam') medLabel = 'Diazepam 10 mg';
                else if (med === 'chlordiazepoxide') medLabel = 'Chlordiazepoxide 50 mg';
                
                planParts.push(`Dosing - Fixed Schedule Benzodiazepine Regimen (Moderate-High Risk)\n\nMedication: ${medLabel}\n\nSchedule:\n• Day 1: 1 tab QID (4 doses/day)\n• Day 2: 1 tab TID (3 doses/day)\n• Day 3: 1 tab BID (2 doses/day)\n• Day 4: 1 tab once daily\n\nPRN: Prescribe 5 additional tablets for breakthrough symptoms.\n\nTotal dispensed: 15 tablets (10 scheduled + 5 PRN).`);
            }
            
            // Include dosing option dropdown if selected (legacy)
            const dosingOption = document.getElementById('op-dosing-option')?.value;
            if (dosingOption && !lowRiskSelected && !highRiskSelected) {
                planParts.push(`Benzodiazepine Detoxification Strategy:\n${dosingOption}`);
            }
            const dosingOther = document.getElementById('op-dosing-other')?.value;
            if (dosingOther && document.getElementById('op-dosing-option')?.value === 'Other (specify in plan notes)') {
                planParts.push(`Alternative Dosing Approach:\n${dosingOther}`);
            }
            
            // Outpatient vs inpatient decision
            if (document.getElementById('op-plan-outpatient')?.checked) planParts.push('• Outpatient detoxification appropriate');
            if (document.getElementById('op-plan-inpatient')?.checked) {
                const inpatientReason = document.getElementById('op-plan-inpatient-reason')?.value;
                let inpatientText = '• Consider inpatient referral';
                if (inpatientReason) inpatientText += ` (${inpatientReason})`;
                planParts.push(inpatientText);
            }
            if (document.getElementById('op-plan-decline-inpatient')?.checked) planParts.push('• Patient declines inpatient referral');
            
            // Supportive/adjunctive medications
            let supportParts = [];
            const supportMeds = [
                { id: 'op-med-thiamine', indication: 'Vitamin supplementation', med: 'Thiamine', doseId: 'op-med-thiamine-dose', notesId: 'op-med-thiamine-notes' },
                { id: 'op-med-folate', indication: 'Vitamin supplementation', med: 'Folic acid', doseId: 'op-med-folate-dose', notesId: 'op-med-folate-notes' },
                { id: 'op-med-multivit', indication: 'Vitamin supplementation', med: 'Multivitamin', doseId: 'op-med-multivit-dose', notesId: 'op-med-multivit-notes' },
                { id: 'op-med-clonidine', indication: 'Autonomic symptoms', med: 'Clonidine', doseId: 'op-med-clonidine-dose', notesId: 'op-med-clonidine-notes' },
                { id: 'op-med-hydroxyzine', indication: 'Anxiety/Insomnia', med: 'Hydroxyzine', doseId: 'op-med-hydroxyzine-dose', notesId: 'op-med-hydroxyzine-notes' },
                { id: 'op-med-gabapentin', indication: 'Adjunct', med: 'Gabapentin', doseId: 'op-med-gabapentin-dose', notesId: 'op-med-gabapentin-notes' },
                { id: 'op-med-trazodone', indication: 'Sleep', med: 'Trazodone', doseId: 'op-med-trazodone-dose', notesId: 'op-med-trazodone-notes' },
                { id: 'op-med-ondansetron', indication: 'Nausea', med: 'Ondansetron', doseId: 'op-med-ondansetron-dose', notesId: 'op-med-ondansetron-notes' }
            ];
            supportMeds.forEach(item => {
                if (document.getElementById(item.id)?.checked) {
                    const dose = document.getElementById(item.doseId)?.value || '';
                    
                    let medLine = item.indication + ': ' + item.med;
                    if (dose) medLine += ', ' + dose;
                    medLine += '.';
                    
                    supportParts.push('• ' + medLine);
                }
            });
            if (supportParts.length > 0) {
                planParts.push(`\nSupportive/Adjunctive Medications:\n${supportParts.join('\n')}`);
            }
            
            if (planParts.length > 0) noteParts.push(`Plan:\n${planParts.join('\n')}`);
            
            // Monitoring
            let monitoringParts = [];
            const monitoringItems = [
                { id: 'op-monitor-daily', label: 'Daily follow-up' },
                { id: 'op-monitor-ciwa', label: 'CIWA-Ar scoring at each contact' },
                { id: 'op-monitor-hold-benzo', label: 'Hold benzodiazepine if sedated or hypotensive' },
                { id: 'op-monitor-hydration', label: 'Encourage hydration, nutrition, and rest' },
                { id: 'op-monitor-safety-plan', label: 'Safety plan: call 911 or go to ED if seizures, confusion, hallucinations, or suicidality' }
            ];
            monitoringItems.forEach(item => {
                if (document.getElementById(item.id)?.checked) {
                    monitoringParts.push(`• ${item.label}`);
                }
            });
            if (monitoringParts.length > 0) noteParts.push(`Monitoring:\n${monitoringParts.join('\n')}`);
            
            // Follow-up
            let followupParts = [];
            if (document.getElementById('op-followup-return')?.checked) {
                const days = document.getElementById('op-followup-days')?.value || 'as specified';
                followupParts.push(`• Return in ${days} days or sooner if worsening`);
            }
            if (document.getElementById('op-followup-reviewlabs')?.checked) {
                followupParts.push('• Review labs and progress at next visit');
            }
            if (followupParts.length > 0) noteParts.push(`Follow-up:\n${followupParts.join('\n')}`);
            
            // Education
            let educationParts = [];
            const educationItems = [
                { id: 'op-edu-warning', label: 'Reviewed withdrawal warning signs' },
                { id: 'op-edu-avoid', label: 'Avoid alcohol and sedatives during taper' },
                { id: 'op-edu-avoid-driving', label: 'Avoid driving or operating machinery while sedated' },
                { id: 'op-edu-hydration', label: 'Reinforced hydration, nutrition, and support engagement' }
            ];
            educationItems.forEach(item => {
                if (document.getElementById(item.id)?.checked) {
                    educationParts.push(`• ${item.label}`);
                }
            });
            if (educationParts.length > 0) noteParts.push(`Patient Education:\n${educationParts.join('\n')}`);
            
            finalNote = noteParts.join('\n\n');
            } else if (selectedNoteType === 'ciwa-ar-assessment') {
            // CIWA-Ar Assessment note generation
            let noteParts = [];
            
            const ciwaScore = document.getElementById('ciwa-score-output')?.value || '';
            
            if (ciwaScore) {
                let interpretation = '';
                const scoreNum = parseInt(ciwaScore, 10);
                if (scoreNum <= 9) {
                    interpretation = 'Minimal/mild withdrawal risk; monitor for symptom progression';
                } else if (scoreNum <= 19) {
                    interpretation = 'Moderate withdrawal risk; pharmacological support recommended (benzodiazepine-based detoxification)';
                } else {
                    interpretation = 'Severe withdrawal risk; strongly recommend inpatient detoxification and intensive pharmacological management';
                }
                noteParts.push(`CIWA-Ar Score: ${ciwaScore}\nInterpretation: ${interpretation}`);
            }
            
            finalNote = noteParts.join('\n\n');
            } else if (selectedNoteType === 'drug-treatment-court-report') {
            // Drug Treatment Court Report note generation
            let progressText = '';
            let courtText = '';

            const lastCourtDate = formatDate(document.getElementById('dtc-initialCourtDate').value);
            if (lastCourtDate) {
                progressText += `Since last court date ${lastCourtDate}, writer provided treatment report via Unified Court System portal UCMS to coordinate care with Drug Treatment Court per request of Michelle Devine.\n\n`;
            }
            progressText += "To complete this client's DTC report, writer previously spoke one on one with client and summarized client's treatment schedule and attendance.\n\n";
            progressText += "In addition, writer checks client's UDS results in both eCR and the New York State Unified Court System portal UCMS.\n\n";

            const courtPrepDate = formatDate(document.getElementById('dtc-courtPrepDate').value);
            if (courtPrepDate) {
                progressText += `Writer also prepared for court and ways to support and advocate for client in the court room on ${courtPrepDate}. Writer prepared a report for treatment court, which included an update on client's presentation in services inclusive of client's individual session attendance, group session attendance, weekly check-ins as required by court, random toxicology screens as required by court, and toxicology screens (and results) provided by client to Delphi Rise. \n\n`;
            }

            const careCoordination = document.getElementById('dtc-careCoordination').value;
            if (careCoordination) {
                progressText += `Writer also coordinated care with ${careCoordination}.\n\n`;
            }
            progressText += "SEE Criminal Drug Treatment Court Appearance Report completed and scanned into client's chart.";

            // --- Court Note Generation ---
            if (lastCourtDate) {
                courtText += `Since last court date ${lastCourtDate}:\n\n`;
            }

            const clientName = document.getElementById('dtc-clientName').value;
            const hasNotHas = document.getElementById('dtc-hasNotHas').value;
            if (hasNotHas) {
                courtText += `${clientName || 'Client'} ${hasNotHas} kept all appointments as scheduled.\n`;
            }

            const checkingIn = document.getElementById('dtc-checkingIn').value;
            if (checkingIn === 'Yes') {
                courtText += `Checking in with case manager per requirements: Yes\n\n`;
            } else if (checkingIn === 'No') {
                courtText += `NOT checking in with case manager per requirements.\n\n`;
            }

            const lud = formatDate(document.getElementById('dtc-lud').value);
            if (lud) {
                courtText += `LUD: ${lud}`;
                const ludExtra = document.getElementById('dtc-ludExtra');
                if (ludExtra && ludExtra.style.display !== 'none') {
                    const ludResponse = document.getElementById('dtc-ludResponse').value;
                    const ludSubstance = document.getElementById('dtc-ludSubstance').value;
                    if (ludResponse) {
                        courtText += ` (${ludResponse}`;
                        if (ludSubstance) courtText += `, ${ludSubstance}`;
                        courtText += `)`;
                    }
                }
                courtText += '\n\n';
            }

            const treatmentSchedule = document.getElementById('dtc-treatmentSchedule').value;
            if (treatmentSchedule) {
                courtText += `Treatment Schedule: ${treatmentSchedule}\n\n`;
            }

            // Attendance Details
            const individualAttended = document.getElementById('dtc-individualAttended').value;
            const individualTotal = document.getElementById('dtc-individualTotal').value;
            if (individualAttended && individualTotal) {
                courtText += `Attended ${individualAttended}/${individualTotal} individual sessions`;
                if (Number(individualAttended) < Number(individualTotal) && document.getElementById('dtc-individualMissed').value) {
                    courtText += ` (${document.getElementById('dtc-individualMissed').value})`;
                }
                courtText += '.\n';
            }

            const groupAttended = document.getElementById('dtc-groupAttended').value;
            const groupTotal = document.getElementById('dtc-groupTotal').value;
            if (groupAttended && groupTotal) {
                courtText += `Attended ${groupAttended}/${groupTotal} group sessions`;
                if (Number(groupAttended) < Number(groupTotal) && document.getElementById('dtc-groupMissed').value) {
                    courtText += ` (${document.getElementById('dtc-groupMissed').value})`;
                }
                courtText += '.\n';
            }

            const medAttended = document.getElementById('dtc-medAttended').value;
            const medTotal = document.getElementById('dtc-medTotal').value;
            if (medAttended && medTotal) {
                courtText += `Attended ${medAttended}/${medTotal} medication appointments`;
                if (Number(medAttended) < Number(medTotal) && document.getElementById('dtc-medMissed').value) {
                    courtText += ` (${document.getElementById('dtc-medMissed').value})`;
                }
                courtText += '.\n';
            }

            const nextDate = formatDate(document.getElementById('dtc-nextDate').value);
            const appointmentType = document.getElementById('dtc-appointmentType').value;
            if (nextDate && appointmentType) {
                courtText += `\nNext Appointment: ${nextDate} - ${appointmentType}\n\n`;
            } else {
                courtText += '\n';
            }

            // Toxicology Screens
            courtText += `Toxicology Screens at Treatment:\n`;
            if (document.getElementById('dtc-toxNotScreened').checked) {
                courtText += `N/A - not screened since last court date\n\n`;
            } else {
                const toxRows = document.querySelectorAll('#dtc-toxContainer .dtc-tox-row');
                const filledToxRows = Array.from(toxRows).filter(r => {
                    const dateVal = r.querySelector('input[type="date"]')?.value;
                    return dateVal && dateVal.trim() !== '';
                });
                
                if (filledToxRows.length === 0) {
                    courtText += 'No screens reported.\n\n';
                } else {
                    filledToxRows.forEach(row => {
                        const dateInput = row.querySelector('input[type="date"]');
                        const resultSelect = row.querySelector('select');
                        const substanceInput = row.querySelector('input[type="text"]');
                        
                        const toxDate = formatDate(dateInput?.value);
                        const toxResult = resultSelect?.value;
                        const toxSubstance = substanceInput?.value;
                        
                        if (toxDate) {
                            courtText += `${toxDate} - ${toxResult}`;
                            if (toxResult === 'positive' && toxSubstance) {
                                courtText += ` (${toxSubstance})`;
                            }
                            courtText += '\n';
                        }
                    });
                    courtText += '\n';
                }
            }

            // Random Screens
            courtText += `Random Screens:\n`;
            if (document.getElementById('dtc-randomNotScreened').checked) {
                courtText += `N/A - not screened since last court date\n\n`;
            } else {
                const randomRows = document.querySelectorAll('#dtc-randomContainer .dtc-random-row');
                const filledRandomRows = Array.from(randomRows).filter(r => {
                    const dateVal = r.querySelector('input[type="date"]')?.value;
                    return dateVal && dateVal.trim() !== '';
                });
                
                if (filledRandomRows.length === 0) {
                    courtText += 'No screens reported.\n\n';
                } else {
                    filledRandomRows.forEach(row => {
                        const dateInput = row.querySelector('input[type="date"]');
                        const resultSelect = row.querySelector('select');
                        const substanceInput = row.querySelector('input[type="text"]');
                        
                        const randomDate = formatDate(dateInput?.value);
                        const randomResult = resultSelect?.value;
                        const randomSubstance = substanceInput?.value;
                        
                        if (randomDate) {
                            courtText += `${randomDate} - ${randomResult}`;
                            if (randomResult === 'positive' && randomSubstance) {
                                courtText += ` (${randomSubstance})`;
                            }
                            courtText += '\n';
                        }
                    });
                    courtText += '\n';
                }
            }

            const matAttendance = document.getElementById('dtc-matAttendance').value;
            if (matAttendance) {
                courtText += `MAT: Client ${matAttendance} attending MAT appts as scheduled.\n\n`;
            }

            const probation = document.getElementById('dtc-probation').value;
            if (probation) {
                courtText += `Probation: ${probation}\n\n`;
            }

            const mentalHealth = document.getElementById('dtc-mentalHealth').value;
            if (mentalHealth) {
                courtText += `Mental Health: ${mentalHealth}\n\n`;
            }
            
            const additionalNotes = document.getElementById('dtc-additionalNotes').value;
            if (additionalNotes) {
                courtText += `Additional Notes: ${additionalNotes}\n`;
            }

            finalNote = `PROGRESS NOTE:\n\n${progressText.trim()}\n\n---\n\nCOURT NOTE:\n\n${courtText.trim()}`;
            
            // For DTC, populate separate text areas
            const dtcProgressCopy = document.getElementById('dtc-progress-note-copy');
            const dtcCourtCopy = document.getElementById('dtc-court-note-copy');
            dtcProgressCopy.value = progressText.trim();
            dtcCourtCopy.value = courtText.trim();
            // Auto-resize the textareas to fit content
            autoResizeDtcTextareas(dtcProgressCopy, dtcCourtCopy);
            }
        
        // Toggle copy area visibility based on note type
        const singleCopyArea = document.getElementById('single-note-copy-area');
        const dtcDualCopyArea = document.getElementById('dtc-dual-copy-area');
        
        if (selectedNoteType === 'drug-treatment-court-report') {
            singleCopyArea.style.display = 'none';
            dtcDualCopyArea.style.display = 'block';
            // Validate required fields for DTC
            validateDtcRequiredFields();
        } else {
            singleCopyArea.style.display = 'block';
            dtcDualCopyArea.style.display = 'none';
            document.getElementById('dtc-validation-warning').style.display = 'none';
            finalNoteCopy.value = finalNote.trim();
            autoResize(finalNoteCopy);
        }
    }

    function toggleSafetyPlan(mainCheckbox, safetyPlanCheckbox) {
        safetyPlanCheckbox.disabled = !mainCheckbox.checked;
        if (!mainCheckbox.checked) {
            safetyPlanCheckbox.checked = false;
        }
    }

    function sortSelectOptions(selectElement) {
        const options = Array.from(selectElement.options);
        let placeholder = null;
        
        if (options.length > 0 && options[0].disabled) {
            placeholder = options.shift();
        }

        options.sort((a, b) => a.text.localeCompare(b.text));

        selectElement.innerHTML = '';

        if (placeholder) {
            selectElement.add(placeholder);
        }

        options.forEach(option => selectElement.add(option));
    }


// EVENT LISTENERS
    noteTypeSelect.addEventListener('change', () => {
        const selection = noteTypeSelect.value;
        if (selection === 'eval-cd') {
            resetDiagnosisRows();
        } else if (selection === 'entry-cd') {
            resetGoalRows(clientGoalsContainer, treatmentGoalsContainer);
        } else if (selection === 'entry-so') {
            resetGoalRows(soClientGoalsContainer, soTreatmentGoalsContainer);
        } else if (selection === 'telehealth') {
            telehealthPractitionerLocation.value = "72 Hinchey Road, Rochester, NY";
        } else if (selection === 'mdt') {
            mdtDiagnosisContainer.innerHTML = '';
            addMdtDiagnosisRow();
        } else if (selection === 'med-mgmt-follow-up') {
            const container = document.getElementById('mmfu-diagnosis-container');
            container.innerHTML = '';
            addMmfuDiagnosisRow();
        } else if (selection === 'nurse-follow-up') {
            document.getElementById('nurse-interventions-container').innerHTML = '';
            addNurseInterventionRow(true); // Add the first row automatically
            initNursePlanCheckboxes(); // Initialize plan checkboxes
        } else if (selection === 'op-alcohol-detox') {
            // Initialize OP Alcohol Detox inputs and listeners
            initOpAlcoholDetox();
        } else if (selection === 'ciwa-ar-assessment') {
            // Initialize CIWA-Ar Assessment
            initCiwaArAssessment();
        } else if (selection === 'drug-treatment-court-report') {
            // Initialize Drug Treatment Court Report
            initDrugTreatmentCourtReport();
        }
        updateFinalNote();
    });
    
    // Eval-CD Listeners
    detailsTextarea.addEventListener('input', () => { autoResize(detailsTextarea); updateFinalNote(); });
    mandateCheckbox.addEventListener('change', updateFinalNote);
    cdHasMhProviderTextCheckbox.addEventListener('change', () => { toggleSafetyPlan(cdHasMhProviderTextCheckbox, cdSafetyPlanHasProviderCheckbox); updateFinalNote(); });
    cdNoMhProviderTextCheckbox.addEventListener('change', () => { toggleSafetyPlan(cdNoMhProviderTextCheckbox, cdSafetyPlanNoProviderCheckbox); updateFinalNote(); });
    cdSafetyPlanHasProviderCheckbox.addEventListener('change', updateFinalNote);
    cdSafetyPlanNoProviderCheckbox.addEventListener('change', updateFinalNote);
    cdOverdoseRiskCheckbox.addEventListener('change', updateFinalNote);
    cdGamblingRiskCheckbox.addEventListener('change', updateFinalNote);

    // Eval-SO Listeners
    soDiagnosisSelect.addEventListener('change', updateFinalNote);
    soDetailsTextarea.addEventListener('input', () => { autoResize(soDetailsTextarea); updateFinalNote(); });
    soHasMhProviderTextCheckbox.addEventListener('change', () => { toggleSafetyPlan(soHasMhProviderTextCheckbox, soSafetyPlanHasProviderCheckbox); updateFinalNote(); });
    soNoMhProviderTextCheckbox.addEventListener('change', () => { toggleSafetyPlan(soNoMhProviderTextCheckbox, soSafetyPlanNoProviderCheckbox); updateFinalNote(); });
    soSafetyPlanHasProviderCheckbox.addEventListener('change', updateFinalNote);
    soSafetyPlanNoProviderCheckbox.addEventListener('change', updateFinalNote);
    soOverdoseRiskCheckbox.addEventListener('change', updateFinalNote);
    soGamblingRiskCheckbox.addEventListener('change', updateFinalNote);

    // Opioid Use Disorder Short Listeners
    const oudsInputs = document.querySelectorAll('#opioid-use-disorder-short-container input, #opioid-use-disorder-short-container textarea, #opioid-use-disorder-short-container select');
    oudsInputs.forEach(input => {
        input.addEventListener('input', updateFinalNote);
        input.addEventListener('change', updateFinalNote);
    });
    oudsActiveUseRadios.forEach(radio => radio.addEventListener('change', () => {
        oudsLastUseDateRow.classList.toggle('hidden', radio.value !== 'yes');
        // Update label text if needed - now handled by initial HTML and only visibility changes.
        oudsLastUseDateLabel.textContent = "Date of last use:";
        updateFinalNote();
    }));
    oudsPharmRadios.forEach(radio => radio.addEventListener('change', () => {
        oudsPharmFields.classList.toggle('hidden', radio.value !== 'yes');
        updateFinalNote();
    }));
    oudsSubstances.forEach(key => {
        const cb = document.getElementById(`ouds-sub-${key}`);
        if (cb) {
            cb.addEventListener('change', () => {
                const isChecked = cb.checked;
                const amtInput = document.getElementById(`ouds-amt-${key}`);
                const dateInput = document.getElementById(`ouds-date-${key}`);
                const otherTextInput = document.getElementById('ouds-sub-other-text');

                if (amtInput) amtInput.classList.toggle('hidden', !isChecked);
                if (dateInput) dateInput.classList.toggle('hidden', !isChecked);
                if (key === 'other' && otherTextInput) {
                    otherTextInput.classList.toggle('hidden', !isChecked);
                }
                updateFinalNote();
            });
        }
    });
// Alcohol Use Disorder Short Listeners
    const audsInputs = document.querySelectorAll('#alcohol-use-disorder-short-container input, #alcohol-use-disorder-short-container textarea, #alcohol-use-disorder-short-container select');
    audsInputs.forEach(input => {
        input.addEventListener('input', updateFinalNote);
        input.addEventListener('change', updateFinalNote);
        if (input.tagName.toLowerCase() === 'textarea') {
            input.addEventListener('input', () => autoResize(input));
        }
    });

    const audsActiveDrinkingRadios = document.querySelectorAll('input[name="auds-active-drinking"]');
    const audsLastDrinkDateRow = document.getElementById('auds-last-drink-date-row');
    audsActiveDrinkingRadios.forEach(radio => radio.addEventListener('change', () => {
        audsLastDrinkDateRow.classList.toggle('hidden', radio.value !== 'yes');
        updateFinalNote();
    }));

    const audsPharmRadios = document.querySelectorAll('input[name="auds-pharmacotherapy"]');
    const audsPharmFields = document.getElementById('auds-pharm-fields');
    audsPharmRadios.forEach(radio => radio.addEventListener('change', () => {
        audsPharmFields.classList.toggle('hidden', radio.value !== 'yes');
        updateFinalNote();
    }));

    const audsSubstanceList = document.getElementById('auds-substance-list');
    const audsSubstanceCheckboxes = audsSubstanceList.querySelectorAll('input[type="checkbox"]');
    audsSubstanceCheckboxes.forEach(checkbox => {
        checkbox.addEventListener('change', () => {
            const isChecked = checkbox.checked;
            const key = checkbox.id.replace('auds-sub-', '');
            const amtInput = document.getElementById(`auds-amt-${key}`);
            const dateInput = document.getElementById(`auds-date-${key}`);

            if (amtInput) amtInput.classList.toggle('hidden', !isChecked);
            if (dateInput) dateInput.classList.toggle('hidden', !isChecked);
            // If you add an 'other' substance, you'll need similar logic for a custom text input
            // if (key === 'other' && document.getElementById('auds-sub-other-text')) {
            //     document.getElementById('auds-sub-other-text').classList.toggle('hidden', !isChecked);
            // }
            updateFinalNote();
        });
    });

    // Listener for Psychiatric Ideation dropdown to show/hide safety planning
    const audsPsychIdeationSelect = document.getElementById('auds-psych-ideation');
    const audsSafetyPlanningContainer = document.getElementById('auds-safety-planning-container');
    const audsSafetyPlanningCheckbox = document.getElementById('auds-safety-planning-checkbox');
    audsPsychIdeationSelect.addEventListener('change', (event) => {
        if (event.target.value.includes('Endorses')) { // Covers 'Endorses SI', 'Endorses HI', 'Endorses SI/HI'
            audsSafetyPlanningContainer.classList.remove('hidden');
        } else {
            audsSafetyPlanningContainer.classList.add('hidden');
            audsSafetyPlanningCheckbox.checked = false; // Uncheck it when hidden
        }
        updateFinalNote();
    });

    // Ensure initial state is set on page load for the safety planning checkbox
    document.addEventListener('DOMContentLoaded', () => {
        // Trigger change for audsPsychIdeationSelect to set initial visibility of safety planning
        audsPsychIdeationSelect.dispatchEvent(new Event('change'));
    });
    // Med Mgmt Follow Up Listeners
    mmfuNicotineUse.addEventListener('change', () => {
        mmfuNicotineDetailsSection.classList.toggle('hidden', mmfuNicotineUse.value !== 'yes');
        updateFinalNote();
    });
    document.querySelectorAll('#med-mgmt-follow-up-container input, #med-mgmt-follow-up-container select, #med-mgmt-follow-up-container textarea').forEach(el => {
        el.addEventListener('input', updateFinalNote);
        el.addEventListener('change', updateFinalNote);
        if (el.tagName.toLowerCase() === 'textarea') {
            el.addEventListener('input', () => autoResize(el));
        }
    });


    // Narcan Listeners
    narcanProvidedCheckbox.addEventListener('change', () => {
        if (narcanProvidedCheckbox.checked) narcanDeclinedCheckbox.checked = false;
        updateFinalNote();
    });
    narcanDeclinedCheckbox.addEventListener('change', () => {
        if (narcanDeclinedCheckbox.checked) narcanProvidedCheckbox.checked = false;
        updateFinalNote();
    });

    // MAT Listeners
    matEducationType.addEventListener('change', () => {
        const selected = matEducationType.value;
        matNotTakingSection.classList.toggle('hidden', selected !== 'not-taking');
        matAlreadyTakingSection.classList.toggle('hidden', selected !== 'already-taking');
        matFormFields.classList.toggle('hidden', !selected);

        matResponseDropdown.value = ""; // Reset selection
        const options = matResponseDropdown.options;
        for (let i = 0; i < options.length; i++) {
            const option = options[i];
            if (option.dataset.type) {
                option.hidden = option.dataset.type !== selected;
            }
        }
        updateFinalNote();
    });
    matExploredOptionsDropdown.addEventListener('change', () => {
        matOptionsDetailsSection.classList.toggle('hidden', matExploredOptionsDropdown.value !== 'did');
        updateFinalNote();
    });
    matNicotineUseDropdown.addEventListener('change', () => {
        matNicotineResourcesSection.classList.toggle('hidden', matNicotineUseDropdown.value !== 'does');
        updateFinalNote();
    });
    matNicotineOtherCheckbox.addEventListener('change', () => {
        matNicotineOtherTextbox.classList.toggle('hidden', !matNicotineOtherCheckbox.checked);
        updateFinalNote();
    });
    [matResponseDropdown, matSubstancesTextbox, matNicotineReplacementCheckbox, matNicotineCounselingCheckbox, matNicotineReferralCheckbox, matNicotineOtherTextbox].forEach(el => {
        el.addEventListener('input', updateFinalNote);
        el.addEventListener('change', updateFinalNote);
    });
    matSpecificOptionsCheckboxes.querySelectorAll('input[type="checkbox"]').forEach(checkbox => {
        checkbox.addEventListener('change', updateFinalNote);
    });
    
    // Telehealth Listeners
    [telehealthVisitType, telehealthReason, telehealthDisruption, telehealthSatisfaction, telehealthPresenceDropdown].forEach(el => {
        el.addEventListener('change', updateFinalNote);
    });
    [telehealthReasonOther, telehealthDisruptionPlan, telehealthClientLocation, telehealthPractitionerLocation, telehealthOthersPresent, telehealthSatisfactionConcerns].forEach(el => {
        el.addEventListener('input', updateFinalNote);
    });
    
    // Closing Note (Admitted) Listeners
    closingMedsDropdown.addEventListener('change', () => {
        closingMedsActionsContainer.classList.toggle('hidden', closingMedsDropdown.value !== 'is');
        updateFinalNote();
    });
    [closingReason, closingRecommendations, closingMedsActions, closingReferrals, closingOfferedToDropdown, closingClientResponse].forEach(el => {
        el.addEventListener('input', updateFinalNote);
        el.addEventListener('change', updateFinalNote);
    });
    
    // Closing Note (Non-Admitted) Listeners
    nonAdmittedClientType.addEventListener('change', () => {
        nonAdmittedNoEngageSection.classList.toggle('hidden', nonAdmittedClientType.value !== 'no-engage');
        nonAdmittedHigherLocSection.classList.toggle('hidden', nonAdmittedClientType.value !== 'higher-loc');
        nonAdmittedNoCriteriaSection.classList.toggle('hidden', nonAdmittedClientType.value !== 'no-criteria');
        updateFinalNote();
    });
    [nonAdmittedEfforts, nonAdmittedProvidedTo1, nonAdmittedLocadtr, nonAdmittedEfforts2, nonAdmittedProvidedTo2, nonAdmittedUrineScreen, nonAdmittedProvidedTo3].forEach(el => {
        el.addEventListener('input', updateFinalNote);
    });

    // MDT Listeners
    mdtStageOfChange.addEventListener('change', () => {
        mdtStageOfChangeOther.classList.toggle('hidden', mdtStageOfChange.value !== 'Other');
        updateFinalNote();
    });
    const mdtInputs = document.querySelectorAll('#mdt-container input, #mdt-container textarea, #mdt-container select');
    mdtInputs.forEach(input => {
        input.addEventListener('input', updateFinalNote);
        input.addEventListener('change', updateFinalNote);
    });

    // Medication Management Follow-up Listeners
    const mmfuInputs = document.querySelectorAll('#med-mgmt-follow-up-container input, #med-mgmt-follow-up-container textarea, #med-mgmt-follow-up-container select');
    mmfuInputs.forEach(input => {
        input.addEventListener('input', updateFinalNote);
        input.addEventListener('change', updateFinalNote);
        if (input.tagName.toLowerCase() === 'textarea') {
            input.addEventListener('input', () => autoResize(input));
        }
    });

    // Injections Listeners
    injectionTypeSelect.addEventListener('change', () => {
        const selection = injectionTypeSelect.value;
        vivitrolSection.classList.toggle('hidden', selection !== 'vivitrol');
        sublocadeSection.classList.toggle('hidden', selection !== 'sublocade');
        brixadiSection.classList.toggle('hidden', selection !== 'brixadi');
        updateFinalNote();
    });
    [
        vivitrolSite, vivitrolLot, vivitrolExp, vivitrolSn, vivitrolNextInjection,
        sublocadeSite, sublocadeLot, sublocadeExp, sublocadeSn, sublocadeNextInjection,
        brixadiSite, brixadiLot, brixadiExp, brixadiSn, brixadiNextInjection
    ].forEach(el => el.addEventListener('input', updateFinalNote));

    // Medical Screening Listeners
    const medicalScreeningContainer = document.getElementById('medical-screening-container');
    if (medicalScreeningContainer) {
        const msInputs = medicalScreeningContainer.querySelectorAll('input, select, textarea');
        msInputs.forEach(input => {
            input.addEventListener('change', updateFinalNote);
            input.addEventListener('keyup', updateFinalNote);
        });

        const setupMSConditional = (triggerName, conditions) => {
            const triggers = document.querySelectorAll(`#medical-screening-container [name="${triggerName}"]`);
            triggers.forEach(trigger => {
                trigger.addEventListener('change', () => {
                    Object.values(conditions).forEach(sectionId => {
                        const section = document.querySelector(sectionId);
                        if (section) section.classList.add('hidden');
                    });
                    const value = trigger.value;
                    const sectionToShow = document.querySelector(conditions[value]);
                    if (sectionToShow) {
                        sectionToShow.classList.remove('hidden');
                    }
                });
            });
        };

        setupMSConditional('hasPCP', { 'yes': '#ms-pcpYesSection', 'no': '#ms-pcpNoSection' });
        setupMSConditional('hadPELastYear', { 'yes': '#ms-peLastYearYesSection', 'no': '#ms-peLastYearNoSection' });
        setupMSConditional('pcpConsentCompleted', { 'no': '#ms-pcpConsentNoSection' });
        setupMSConditional('declineReason', { 'other': '#ms-declineReasonOtherSpecify' });
        setupMSConditional('stdHepTest', { 'yes': '#ms-stdHepTestYesSection' });
        document.getElementById('stdHepStatus').addEventListener('change', () => {
            const status = document.getElementById('stdHepStatus').value;
            document.getElementById('ms-stdHepPositiveSection').classList.toggle('hidden', status !== 'known_positive');
        });
        setupMSConditional('tbTest', { 'yes': '#ms-tbTestYesSection', 'no': '#ms-tbTestNoSection' });
        setupMSConditional('tbResult', { 'positive': '#ms-tbPositiveDetailsSection' });
        setupMSConditional('tobaccoUse', { 'yes': '#ms-tobaccoUseYesSection' });
        setupMSConditional('cessationInterest', { 'yes': '#ms-cessationInterestYesSection' });
        setupMSConditional('onMAT', { 'yes': '#ms-matYesSection', 'no': '#ms-matNoSection' });
    }


    // Copy Button functionality
    copyButton.addEventListener('click', () => {
        finalNoteCopy.select();
        try {
            const successful = document.execCommand('copy');
            const originalText = copyButton.textContent;
            if(successful) {
                copyButton.textContent = 'Copied!';
                copyButton.style.backgroundColor = '#1e7e34';
                setTimeout(() => {
                    copyButton.textContent = originalText;
                    copyButton.style.backgroundColor = '#28a745';
                }, 1500);
            } else {
                    copyButton.textContent = 'Copy Failed';
            }
        } catch (err) {
            console.error('Fallback copy failed', err);
        }
    });

    // Initial call to populate the form on page load
    document.addEventListener('DOMContentLoaded', () => {
        // sortSelectOptions(noteTypeSelect); // Sort the main dropdown
        resetDiagnosisRows();
        resetGoalRows(clientGoalsContainer, treatmentGoalsContainer);
        resetGoalRows(soClientGoalsContainer, soTreatmentGoalsContainer);
        toggleSafetyPlan(cdHasMhProviderTextCheckbox, cdSafetyPlanHasProviderCheckbox);
        toggleSafetyPlan(cdNoMhProviderTextCheckbox, cdSafetyPlanNoProviderCheckbox);
        toggleSafetyPlan(soHasMhProviderTextCheckbox, soSafetyPlanHasProviderCheckbox);
        toggleSafetyPlan(soNoMhProviderTextCheckbox, soSafetyPlanNoProviderCheckbox);
        updateFinalNote();
    });

    // Copy button logic for discharge plan textboxes
    function copyTextboxContent(textbox, button) {
        textbox.select();
        try {
            document.execCommand('copy');
            const originalText = button.textContent;
            button.textContent = 'Copied!';
            button.style.backgroundColor = '#1e7e34';
            setTimeout(() => {
                button.textContent = originalText;
                button.style.backgroundColor = '#28a745';
            }, 1200);
        } catch (err) {
            button.textContent = 'Copy Failed';
        }
    }
    const copyPeerSupportBtn = document.getElementById('copy-peer-support-btn');
    const copyFamilyServicesBtn = document.getElementById('copy-family-services-btn');
    const peerSupportTextbox = document.getElementById('peer-support-textbox');
    const familyServicesTextbox = document.getElementById('family-services-textbox');
    if (copyPeerSupportBtn && peerSupportTextbox) {
        copyPeerSupportBtn.addEventListener('click', () => copyTextboxContent(peerSupportTextbox, copyPeerSupportBtn));
    }
    if (copyFamilyServicesBtn && familyServicesTextbox) {
        copyFamilyServicesBtn.addEventListener('click', () => copyTextboxContent(familyServicesTextbox, copyFamilyServicesBtn));
    }

    // Eval-CD Goal Copy Buttons
    const copyEvalCdGoal1Btn = document.getElementById('copy-eval-cd-goal1-btn');
    const evalCdGoal1Textbox = document.getElementById('eval-cd-goal1-textbox');
    if (copyEvalCdGoal1Btn && evalCdGoal1Textbox) {
        copyEvalCdGoal1Btn.addEventListener('click', () => copyTextboxContent(evalCdGoal1Textbox, copyEvalCdGoal1Btn));
    }
    const copyEvalCdGoal2Btn = document.getElementById('copy-eval-cd-goal2-btn');
    const evalCdGoal2Textbox = document.getElementById('eval-cd-goal2-textbox');
    if (copyEvalCdGoal2Btn && evalCdGoal2Textbox) {
        copyEvalCdGoal2Btn.addEventListener('click', () => copyTextboxContent(evalCdGoal2Textbox, copyEvalCdGoal2Btn));
    }

    // Eval-SO Goal Copy Buttons
    const copyEvalSoGoal1Btn = document.getElementById('copy-eval-so-goal1-btn');
    const evalSoGoal1Textbox = document.getElementById('eval-so-goal1-textbox');
    if (copyEvalSoGoal1Btn && evalSoGoal1Textbox) {
        copyEvalSoGoal1Btn.addEventListener('click', () => copyTextboxContent(evalSoGoal1Textbox, copyEvalSoGoal1Btn));
    }
    const copyEvalSoGoal2Btn = document.getElementById('copy-eval-so-goal2-btn');
    const evalSoGoal2Textbox = document.getElementById('eval-so-goal2-textbox');
    if (copyEvalSoGoal2Btn && evalSoGoal2Textbox) {
        copyEvalSoGoal2Btn.addEventListener('click', () => copyTextboxContent(evalSoGoal2Textbox, copyEvalSoGoal2Btn));
    }
    
    // --- MSE Modal and related logic ---
        const mseModal = document.getElementById('mse-modal');
        const closeMseBtn = document.querySelector('#mse-modal .close-btn');
        let activeMseTargetId = null; // Variable to store which MSE textarea is being edited
    
        document.querySelectorAll('.open-mse-modal-btn').forEach(button => {
            button.onclick = function() {
                activeMseTargetId = this.dataset.target; // Get the target ID from the button's data-target attribute
                mseModal.style.display = 'block';
            }
        });
    closeMseBtn.onclick = function() {
        mseModal.style.display = 'none';
    }
    window.onclick = function(event) {
        if (event.target == mseModal) {
            mseModal.style.display = 'none';
        }
    }

    const positiveMseValues = ["Normal MSE", "Oriented x4", "Neat", "Clean", "Appropriately Dressed", "Not Remarkable", "Appropriate", "Ct does not show signs of withdrawal", "Normal", "Normal", "Normal", "Responsive", "Cooperative", "Congruent", "Appropriate", "Euthymic", "Normal", "Congruent", "Normal", "No Hallucinations or Delusions during Interview", "Good", "Good", "Normal", "No evidence or report of SI/HI"];
    const telehealthMseValues = ["Telehealth Normal MSE", "Oriented x4", "Appropriate", "Normal", "Normal", "Normal", "Responsive", "Cooperative", "Congruent", "Euthymic", "Normal", "Congruent", "Normal", "No Hallucinations or Delusions during Interview", "Good", "Good", "Normal", "No evidence or report of SI/HI"];
    function setCheckboxes(valuesToSelect) {
        document.querySelectorAll('.mse-form-container input[type="checkbox"]').forEach(cb => {
            const labelText = cb.parentElement.textContent.trim();
            cb.checked = valuesToSelect.includes(labelText);
        });
        updateMseText();
    }

    function togglePositiveMSE() {
        const cb = document.getElementById('positiveMSE');
        if (cb.checked) {
            document.getElementById('telehealthpositiveMSE').checked = false;
            setCheckboxes(positiveMseValues);
        } else {
            clearAllMseCheckboxes();
        }
    }

    function TelehealthPositiveMSE() {
        const cb = document.getElementById('telehealthpositiveMSE');
        if (cb.checked) {
            document.getElementById('positiveMSE').checked = false;
            setCheckboxes(telehealthMseValues);
        } else {
            clearAllMseCheckboxes();
        }
    }
    
    function clearAllMseCheckboxes() {
        document.querySelectorAll('#MSE input[type="checkbox"]').forEach(cb => cb.checked = false);
        document.querySelectorAll('#MSE input[type="text"]').forEach(input => input.value = '');
        updateMseText();
    }
    
    function updateMseText() {
        const mseTextbox = document.getElementById("mseTextbox");
        let text = "";
        const fieldsets = document.querySelectorAll('.mse-form-container fieldset');

        fieldsets.forEach(fieldset => {
            const legend = fieldset.querySelector('legend');
            if (!legend || legend.textContent === 'Presets') return;

            const categoryName = legend.textContent;
            const checkedItems = [];

            fieldset.querySelectorAll('input[type="checkbox"]:checked').forEach(checkbox => {
                checkedItems.push(checkbox.parentElement.textContent.trim());
            });

            const customInput = fieldset.querySelector('input[type="text"]');
            if (customInput && customInput.value.trim() !== "") {
                checkedItems.push(customInput.value.trim());
            }

            if (checkedItems.length > 0) {
                text += `${categoryName}: ${checkedItems.join(", ")}\n`;
            }
        });

        mseTextbox.value = text.trim();
    }

    function saveMseAndClose() {
            updateMseText(); // Ensure the text is up-to-date
            const mseResult = document.getElementById("mseTextbox").value;
            
            // Use the activeMseTargetId to find the correct textarea
            if (activeMseTargetId) {
                const mainMseTextarea = document.getElementById(activeMseTargetId);
                if (mainMseTextarea) {
                    mainMseTextarea.value = mseResult;
                    // Trigger input event to update the main note copy area
                    mainMseTextarea.dispatchEvent(new Event('input', { bubbles: true }));
                }
            }
    
            mseModal.style.display = "none";
            activeMseTargetId = null; // Reset the target ID
        }

    // Initial call to set up the form on page load.
    document.addEventListener('DOMContentLoaded', updateMseText);

    // Function to update final note from checkboxes (does not modify textarea)
    function updateNursePlanFromCheckboxes() {
        // Just trigger the final note update - the logic is now in updateFinalNote
        updateFinalNote();
    }

    // Attach listeners to plan checkboxes when nurse-follow-up is loaded
    function initNursePlanCheckboxes() {
        for (let i = 1; i <= 4; i++) {
            const checkbox = document.getElementById(`nurse-plan-checkbox-${i}`);
            if (checkbox) {
                checkbox.addEventListener('change', updateNursePlanFromCheckboxes);
            }
            
            // For checkboxes with custom input
            if (i === 3 || i === 4) {
                const customInput = document.getElementById(`nurse-plan-custom-${i}`);
                if (customInput) {
                    customInput.addEventListener('input', () => {
                        if (document.getElementById(`nurse-plan-checkbox-${i}`).checked) {
                            updateNursePlanFromCheckboxes();
                        }
                    });
                    customInput.addEventListener('keyup', () => {
                        if (document.getElementById(`nurse-plan-checkbox-${i}`).checked) {
                            updateNursePlanFromCheckboxes();
                        }
                    });
                }
            }
        }
    }
    
    // Initialize OP Alcohol Detox inputs & listeners
    function toggleDossingOption(radio) {
        // If clicking the same radio twice, deselect it
        if (radio.wasChecked) {
            radio.checked = false;
            radio.wasChecked = false;
            // Clear opposite group
            const oppositeName = radio.name === 'op-dosing-low-risk' ? 'op-dosing-high-risk' : 'op-dosing-low-risk';
            document.querySelectorAll(`input[name=${oppositeName}]`).forEach(r => {
                r.wasChecked = false;
                r.checked = false;
            });
        } else {
            // Set this one, clear opposite group
            const oppositeName = radio.name === 'op-dosing-low-risk' ? 'op-dosing-high-risk' : 'op-dosing-low-risk';
            document.querySelectorAll(`input[name=${oppositeName}]`).forEach(r => {
                r.wasChecked = false;
                r.checked = false;
            });
            radio.wasChecked = true;
        }
        updateDossingDisplay();
    }

    function updateDossingDisplay() {
        // Update CIWA display
        const ciwaScore = document.getElementById('op-ciwa-score')?.value;
        const ciwaDisplay = document.getElementById('op-dosing-ciwa-display');
        if (ciwaDisplay) {
            ciwaDisplay.textContent = ciwaScore || '[Enter CIWA score above]';
        }
        
        // Check which dosing option is selected
        const lowRiskSelected = document.querySelector('input[name="op-dosing-low-risk"]:checked');
        const highRiskSelected = document.querySelector('input[name="op-dosing-high-risk"]:checked');
        const displayDiv = document.getElementById('op-dosing-schedule-display');
        const contentDiv = document.getElementById('op-dosing-schedule-content');
        
        if (!displayDiv || !contentDiv) return;
        
        let scheduleText = '';
        if (lowRiskSelected) {
            const med = lowRiskSelected.value;
            let medLabel = '';
            if (med === 'gabapentin') medLabel = 'Gabapentin 300 mg';
            else if (med === 'diazepam') medLabel = 'Diazepam 5 mg';
            else if (med === 'chlordiazepoxide') medLabel = 'Chlordiazepoxide 25 mg';
            
            scheduleText = `Medication: ${medLabel}

Schedule:
• Day 1: 1 tab QID (4 doses/day)
• Day 2: 1 tab TID (3 doses/day)
• Day 3: 1 tab BID (2 doses/day)
• Day 4: 1 tab once daily

PRN: Prescribe 5 additional tablets for breakthrough withdrawal symptoms.

Total dispensed: 15 tablets (10 scheduled + 5 PRN).`;
        } else if (highRiskSelected) {
            const med = highRiskSelected.value;
            let medLabel = '';
            if (med === 'diazepam') medLabel = 'Diazepam 10 mg';
            else if (med === 'chlordiazepoxide') medLabel = 'Chlordiazepoxide 50 mg';
            
            scheduleText = `Medication: ${medLabel}

Schedule:
• Day 1: 1 tab QID (4 doses/day)
• Day 2: 1 tab TID (3 doses/day)
• Day 3: 1 tab BID (2 doses/day)
• Day 4: 1 tab once daily

PRN: Prescribe 5 additional tablets for breakthrough symptoms.

Total dispensed: 15 tablets (10 scheduled + 5 PRN).`;
        }
        
        if (scheduleText) {
            contentDiv.textContent = scheduleText;
            displayDiv.style.display = 'block';
        } else {
            displayDiv.style.display = 'none';
            contentDiv.textContent = '';
        }
        
        updateFinalNote();
    }

    function initOpAlcoholDetox() {
        // Quick-set chief complaint
        const quick = document.getElementById('op-chief-quick');
        const chief = document.getElementById('op-chief');
        if (quick && chief) {
            quick.addEventListener('change', () => {
                if (quick.value === 'Other') chief.value = '';
                else chief.value = quick.value;
                updateFinalNote();
            });
            chief.addEventListener('input', updateFinalNote);
        }

        // Wire most inputs to updateFinalNote
        const container = document.getElementById('op-alcohol-detox-container');
        if (!container) return;
        const inputs = container.querySelectorAll('input, textarea, select');
        inputs.forEach(el => el.addEventListener('input', updateFinalNote));
        inputs.forEach(el => el.addEventListener('change', updateFinalNote));

        // CIWA button
        const ciwaBtn = document.getElementById('open-ciwa-btn');
        if (ciwaBtn) ciwaBtn.addEventListener('click', openCIWAModal);

        // Safety concerns toggle
        const safetyRadios = document.getElementsByName('op-safety-concerns');
        safetyRadios.forEach(r => r.addEventListener('change', () => {
            const details = document.getElementById('op-safety-details-container');
            if (!details) return;
            const anyYes = Array.from(safetyRadios).some(rr => rr.checked && rr.value === 'Yes');
            details.classList.toggle('hidden', !anyYes);
        }));
    }

    function initCiwaArAssessment() {
        // Wire embedded CIWA questions to update final note
        for (let i = 0; i < 10; i++) {
            const q = document.getElementById(`ciwa-q-${i}`);
            if (q) {
                q.addEventListener('change', () => {
                    computeCIWAScore();
                    updateFinalNote();
                });
            }
        }
    }

    function initDrugTreatmentCourtReport() {
        // Initialize form visibility
        handleDtcLudVisibility();
        updateDtcMissedStatus();
        // Initialize with first tox and random rows if empty
        if (document.getElementById('dtc-toxContainer').children.length === 0) {
            addDtcToxRow();
        }
        if (document.getElementById('dtc-randomContainer').children.length === 0) {
            addDtcRandomRow();
        }
    }

    // CIWA modal open/save functions
    function openCIWAModal() {
        // create modal if not present
        if (!document.getElementById('ciwa-modal')) {
            const modal = document.createElement('div');
            modal.id = 'ciwa-modal';
            modal.className = 'modal';
            modal.innerHTML = `
                <div class="modal-content">
                    <span class="close-btn">&times;</span>
                    <h2>CIWA-Ar</h2>
                    <div id="ciwa-questions" style="display:grid; grid-template-columns: 1fr 1fr; gap:10px; max-height:60vh; overflow:auto;">
                    </div>
                    <div style="margin-top:10px; display:flex; gap:8px; align-items:center;"><strong>Score: </strong><input type="text" id="ciwa-score-output" style="width:120px;" readonly /></div>
                    <div style="margin-top:12px;"><button id="ciwa-save-btn" class="mse-button">Save & Close</button></div>
                </div>`;
            document.body.appendChild(modal);

            // add questions
            const qContainer = modal.querySelector('#ciwa-questions');
            const items = [
                { label: 'NAUSEA AND VOMITING', ask: 'Ask "Do you feel sick to your stomach? Have you vomited?" Observation.', options: ['no nausea and no vomiting', 'mild nausea with no vomiting', '', '', 'intermittent nausea with dry heaves', '', '', 'constant nausea, frequent dry heaves and vomiting'] },
                { label: 'TREMOR', ask: 'Arms extended and fingers spread apart. Observation.', options: ['no tremor', 'not visible, but can be felt fingertip to fingertip', '', '', 'moderate, with patient\'s arms extended', '', '', 'severe, even with arms not extended'] },
                { label: 'PAROXYSMAL SWEATS', ask: 'Observation.', options: ['no sweat visible', 'barely perceptible sweating, palms moist', '', '', 'beads of sweat obvious on forehead', '', '', 'drenching sweats'] },
                { label: 'ANXIETY', ask: 'Ask "Do you feel nervous?" Observation.', options: ['no anxiety, at ease', 'mild anxious', '', '', 'moderately anxious, or guarded, so anxiety is inferred', '', '', 'equivalent to acute panic states as seen in severe delirium or acute schizophrenic reactions'] },
                { label: 'HEADACHE, FULLNESS IN HEAD', ask: 'Ask "Does your head feel different? Does it feel like there is a band around your head?" Do not rate for dizziness or lightheadedness.', options: ['not present', 'very mild', 'mild', 'moderate', 'moderately severe', 'severe', 'very severe', 'extremely severe'] },
                { label: 'AUDITORY DISTURBANCES', ask: 'Ask "Are you more aware of sounds around you? Are they harsh? Do they frighten you? Are you hearing anything that is disturbing to you? Are you hearing things you know are not there?" Observation.', options: ['not present', 'very mild harshness or ability to frighten', 'mild harshness or ability to frighten', 'moderate harshness or ability to frighten', 'moderately severe hallucinations', 'severe hallucinations', 'extremely severe hallucinations', 'continuous hallucinations'] },
                { label: 'VISUAL DISTURBANCES', ask: 'Ask "Does the light appear to be too bright? Is its color different? Does it hurt your eyes? Are you seeing anything that is disturbing to you? Are you seeing things you know are not there?" Observation.', options: ['not present', 'very mild sensitivity', 'mild sensitivity', 'moderate sensitivity', 'moderately severe hallucinations', 'severe hallucinations', 'extremely severe hallucinations', 'continuous hallucinations'] },
                { label: 'TACTILE DISTURBANCES', ask: 'Ask "Have you any itching, pins and needles sensations, any burning, any numbness, or do you feel bugs crawling on or under your skin?" Observation.', options: ['none', 'very mild itching, pins and needles, burning or numbness', 'mild itching, pins and needles, burning or numbness', 'moderate itching, pins and needles, burning or numbness', 'moderately severe hallucinations', 'severe hallucinations', 'extremely severe hallucinations', 'continuous hallucinations'] },
                { label: 'AGITATION', ask: 'Observation.', options: ['normal activity', 'somewhat more than normal activity', '', '', 'moderately fidgety and restless', '', '', 'paces back and forth during most of the interview, or constantly thrashes about'] },
                { label: 'ORIENTATION AND CLOUDING OF SENSORIUM', ask: 'Ask "What day is this? Where are you? Who am I?"', options: ['oriented and can do serial additions', 'cannot do serial additions or is uncertain about date', 'disoriented for date by no more than 2 calendar days', 'disoriented for date by more than 2 calendar days', 'disoriented for place/or person', '', '', ''] }
            ];
            items.forEach((item, idx) => {
                const div = document.createElement('div');
                div.innerHTML = `<label style="display:block; font-weight:bold; margin-bottom:4px;">${item.label}</label><p style="font-size:0.75em; font-style:italic; color:#666; margin:0 0 6px 0;">${item.ask}</p>`;
                const select = document.createElement('select');
                select.id = `ciwa-q-${idx}`;
                select.style.width = '100%';
                // Add "Select an option" as first choice
                const selectOpt = document.createElement('option');
                selectOpt.value = '';
                selectOpt.textContent = 'Select an option';
                select.appendChild(selectOpt);
                for (let i=0;i<=7;i++) {
                    const opt = document.createElement('option');
                    opt.value = i;
                    const desc = item.options[i] ? ` - ${item.options[i]}` : '';
                    opt.textContent = i + desc;
                    select.appendChild(opt);
                }
                select.addEventListener('change', computeCIWAScore);
                div.appendChild(select);
                qContainer.appendChild(div);
            });

            // close
            modal.querySelector('.close-btn').addEventListener('click', () => modal.style.display = 'none');
            modal.querySelector('#ciwa-save-btn').addEventListener('click', saveCIWAAndClose);
        }
        document.getElementById('ciwa-modal').style.display = 'block';
        computeCIWAScore();
    }

    function computeCIWAScore() {
        let score = 0;
        for (let i=0;i<10;i++) {
            const sel = document.getElementById(`ciwa-q-${i}`);
            if (sel) score += parseInt(sel.value || '0',10);
        }
        const out = document.getElementById('ciwa-score-output');
        if (out) out.value = score;
        const embedded = document.getElementById('ciwa-embedded-score');
        if (embedded) embedded.textContent = score;
    }

    function saveCIWAAndClose() {
        const selectedNoteType = document.getElementById('note-type-select')?.value;
        
        // If on CIWA-Ar Assessment form (embedded version), get score from embedded input
        let score;
        if (selectedNoteType === 'ciwa-ar-assessment') {
            score = document.getElementById('ciwa-embedded-score').textContent;
        } else {
            // Otherwise, get from modal's ciwa-score-output
            const modal = document.getElementById('ciwa-modal');
            if (!modal) return;
            score = document.getElementById('ciwa-score-output').value;
            modal.style.display = 'none';
        }
        
        const ciwaField = document.getElementById('op-ciwa-score');
        if (ciwaField) ciwaField.value = score;
        
        // Update CIWA-Ar Assessment result display if on that note type
        if (selectedNoteType === 'ciwa-ar-assessment') {
            const resultDiv = document.getElementById('ciwa-ar-result');
            const scoreSpan = document.getElementById('ciwa-final-score');
            const interpPara = document.getElementById('ciwa-interpretation');
            if (resultDiv && scoreSpan && interpPara && score) {
                scoreSpan.textContent = score;
                const scoreNum = parseInt(score, 10);
                let interpretation = '';
                if (scoreNum <= 9) {
                    interpretation = 'Minimal/mild withdrawal risk; monitor for symptom progression';
                } else if (scoreNum <= 19) {
                    interpretation = 'Moderate withdrawal risk; pharmacological support recommended (benzodiazepine-based detoxification)';
                } else {
                    interpretation = 'Severe withdrawal risk; strongly recommend inpatient detoxification and intensive pharmacological management';
                }
                interpPara.textContent = 'Interpretation: ' + interpretation;
                resultDiv.style.display = 'block';
            }
        }
        
        updateDossingDisplay();
        updateFinalNote();
    }
    
// Nurse Follow Up Listeners
    [
        document.getElementById('nurse-diag'),
        document.getElementById('nurse-goal'),
        document.getElementById('nurse-reason'),
        document.getElementById('nurse-services'),
        document.getElementById('nurse-response'),
        document.getElementById('nurse-plan')
    ].forEach(el => {
        if(el) {
            el.addEventListener('input', () => {
                autoResize(el);
                updateFinalNote();
            });
        }
    });
    
         
</script>
</body>
</html>
