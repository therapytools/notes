<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Safety Plan</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* General Body and Font Styles */
        body {
            background-color: #f3f4f6; /* bg-gray-100 */
            font-family: Arial, sans-serif;
            padding: 20px;
        }

        /* Styles for Safety Plan Container */
        .safety-plan-container {
            max-width: 900px;
            margin: 2rem auto;
            padding: 2rem;
            background-color: #ffffff;
            border-radius: 0.5rem;
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
        }

        h1 {
            text-align: center;
            font-size: 28px;
            font-weight: bold;
            margin-bottom: 1.5rem;
        }

        .header-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 20px;
            flex-wrap: wrap; /* Allow wrapping on smaller screens */
            gap: 1rem;
        }
        
        .header-row > div {
            flex: 1;
            min-width: 200px; /* Ensure inputs don't get too crushed */
        }

        .form-label {
            font-weight: bold;
            display: block;
            margin-bottom: 0.5rem;
        }
        
        input[type="text"], input[type="date"] {
            border: 1px solid #000000;
            padding: 8px;
            border-radius: 4px;
            width: 100%;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .dynamic-input, .three-col-input, .additional-resource-row {
            display: flex;
            align-items: center;
            margin-bottom: 8px;
            gap: 10px;
        }

        .dynamic-input input[type="text"], .three-col-input input[type="text"], .additional-resource-row input[type="text"] {
            flex: 1;
        }
        
        .three-col-input .name-field { flex-basis: 40%; }
        .three-col-input .phone-field { flex-basis: 35%; }
        .three-col-input .ext-field { flex-basis: 15%; }
        
        .additional-resource-row input:first-child { flex: 0 1 40%; }
        .additional-resource-row input:last-of-type { flex: 1 1 60%; }

        .dynamic-input button, .three-col-input button, .additional-resource-row button {
            padding: 4px 8px;
            border: 1px solid #ccc;
            background-color: #f0f0f0;
            cursor: pointer;
            border-radius: 4px;
        }

        .checkbox-group label {
            display: block;
            margin-bottom: 0.5rem;
        }
        
        .checkbox-group input {
            margin-right: 8px;
        }

        .no-pdf {
            color: #555;
            font-style: italic;
            font-size: 0.9em;
            margin-top: 4px;
            margin-bottom: 15px;
        }

        #saveBtn {
            margin-top: 20px;
            padding: 10px 15px;
            font-size: 16px;
        }
    </style>
</head>
<body>

    <div id="SafetyPlan">
        <div class="safety-plan-container">
            <h1 class="text-4xl font-bold text-center mb-6">Safety Plan</h1>
            <div class="header-row">
                <div>
                    <label class="form-label" for="patientName">Patient Name:</label>
                    <input id="patientName" name="patientName" type="text">
                </div>
                <div>
                    <label class="form-label" for="planDate">Date:</label>
                    <input id="planDate" name="planDate" type="date">
                </div>
                <div>
                    <label class="form-label" for="createdWith">Created with help from:</label>
                    <input id="createdWith" name="createdWith" type="text">
                </div>
            </div>
    
            <div class="form-group">
                <label class="form-label">Warning signs (thoughts, images, mood, situation, behavior) that a crisis may be developing:</label>
                <div id="warningSignsList"></div>
            </div>
    
            <div class="form-group">
                <label class="form-label">Internal coping strategies (relaxation techniques, physical activities, distractions, etc.):</label>
                <div id="copingStrategiesList"></div>
            </div>
    
            <div class="form-group">
                <label class="form-label">People who can provide distractions:</label>
                <div id="distractionPeopleList"></div>
            </div>
            
            <div class="form-group">
                <label class="form-label">Social settings that can provide distractions:</label>
                <div id="socialSettingsList"></div>
            </div>
    
            <div class="form-group">
                <label class="form-label">People who I can ask for help:</label>
                <div id="helpPeopleList"></div>
            </div>
    
            <div class="form-group">
                <label class="form-label">Ways I can make my environment safe:</label>
                 <div class="no-pdf">
                    Reminder: Discuss lethal means safety: access to firearms, medications, sharp objects, safe storage, temporary removal, and supportive help.
                </div>
                <div id="safetyEnvironmentList"></div>
            </div>
    
            <div class="form-group">
                <label class="form-label">Professionals or agencies I can contact for help:</label>
                <div id="professionalHelpList"></div>
            </div>
    
            <div class="form-group checkbox-group">
                <label class="form-label">National and NYS Resources:</label>
                <label><input type="checkbox" checked> <strong>Suicide & Crisis Lifeline:</strong> 988</label>
                <label><input type="checkbox"> <strong>Veteran Crisis Line:</strong> 988, option 1</label>
                <label><input type="checkbox" checked> <strong>Crisis Text Line:</strong> Text HOME to 741741</label>
                <label><input type="checkbox"> <strong>National Alliance on Mental Illness (NAMI):</strong> 1-800-950-NAMI (6264). M-F, 10a.m.-10p.m. ET</label>
                <label><input type="checkbox"> <strong>Substance Abuse and Mental Health Services Administration:</strong> 1‑800‑662‑HELP (4357)</label>
                <label><input type="checkbox"> <strong>NYS HOPEline (Addiction & Gambling):</strong> 1-877-846-7369 or text HOPENY (467369)</label>
                <label><input type="checkbox"> <strong>Disaster and Distress Help Line:</strong> 1-800-985-5990</label>
                <label><input type="checkbox"> <strong>National Domestic Violence Hotline:</strong> 1-800‑799‑SAFE (7233)</label>
                <label><input type="checkbox"> <strong>New York State Domestic Violence Hotline:</strong> 1-800-942-6906 or text 844-997-2121</label>
                <label><input type="checkbox"> <strong>Childhelp National Child Abuse Hotline:</strong> 1‑800‑422‑4453</label>
                <label><input type="checkbox"> <strong>Sexual Assault (RAINN):</strong> 1‑800‑656‑4673</label>
                <label><input type="checkbox"> <strong>National Eating Disorder Association:</strong> 1‑800‑931‑2237 or text “NEDA” to 741741</label>
                <label><input type="checkbox"> <strong>The Trevor Project for LGBTQ Youth:</strong> 1‑866‑488‑7386 or text “START” to 67867</label>
                <label><input type="checkbox"> <strong>24/7 Open Access (Peer Run):</strong> 585-627-1777, 72 Hinchey Road Rochester, NY</label>
            </div>
    
            <div class="form-group" id="additional-resources-container">
                <label class="form-label">Additional Resources:</label>
                <div id="additional-resources-list"></div>
            </div>
    
            <button id="saveBtn" class="mt-2 px-6 py-2 bg-indigo-600 text-white font-semibold rounded-md shadow-sm hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">Save as PDF</button>
        </div>
    </div>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script>
     const { jsPDF } = window.jspdf;

    /**
     * PDF Generation Function
     */
    function generatePDF() {
        const doc = new jsPDF();
        const pageHeight = doc.internal.pageSize.height;
        const pageWidth = doc.internal.pageSize.width;
        const margin = 15;
        let y = 20; // Initial Y position

        function checkPageBreak(requiredHeight) {
            if (y + requiredHeight >= pageHeight - margin) {
                doc.addPage();
                y = margin;
            }
        }

        doc.setFontSize(18);
        doc.setFont(undefined, 'bold');
        doc.text("Safety Plan", pageWidth / 2, y, { align: 'center' });
        y += 10;

        const patientName = `Patient Name: ${document.getElementById('patientName').value || 'N/A'}`;
        let planDateStr = "N/A";
        const dateValue = document.getElementById('planDate').value;
        if (dateValue) {
            const [year, month, day] = dateValue.split('-');
            planDateStr = `${month}-${day}-${year}`;
        }
        const planDate = `Date: ${planDateStr}`;
        const createdWith = `Created with: ${document.getElementById('createdWith').value || 'N/A'}`;

        doc.setFontSize(9);
        doc.setFont(undefined, 'normal');
        checkPageBreak(10);
        doc.text(patientName, margin, y);
        doc.text(planDate, pageWidth / 2, y, { align: 'center' });
        doc.text(createdWith, pageWidth - margin, y, { align: 'right' });
        y += 10;

        document.querySelectorAll('.form-group').forEach(group => {
            const label = group.querySelector('.form-label');
            if (label && !group.querySelector('.no-pdf')) { 
                checkPageBreak(10);
                doc.setFontSize(9);
                doc.setFont(undefined, 'bold');
                doc.text(label.textContent, margin, y);
                y += 5;
            }

            const threeColInputs = group.querySelectorAll('.three-col-input');
            if (threeColInputs.length > 0) {
                 const col1x = margin + 5, col2x = 90, col3x = 145;
                 const col1Width = col2x - col1x - 2, col2Width = col3x - col2x - 2, col3Width = pageWidth - col3x - margin;

                 if (Array.from(threeColInputs).some(input => input.querySelector('.name-field').value)) {
                     doc.setFontSize(9);
                     doc.setFont(undefined, 'bold');
                     doc.text("Name", col1x, y);
                     doc.text("Phone", col2x, y);
                     doc.text("Extension", col3x, y);
                     y += 4;
                 }
            
                 doc.setFontSize(9);
                 doc.setFont(undefined, 'normal');
                 threeColInputs.forEach(inputWrapper => {
                     const name = inputWrapper.querySelector('.name-field').value;
                     const phone = inputWrapper.querySelector('.phone-field').value;
                     const ext = inputWrapper.querySelector('.ext-field').value;

                     if (name || phone || ext) {
                         const nameLines = doc.splitTextToSize(name, col1Width);
                         const phoneLines = doc.splitTextToSize(phone, col2Width);
                         const extLines = doc.splitTextToSize(ext, col3Width);
                    
                         const linesRequired = Math.max(nameLines.length, phoneLines.length, extLines.length);
                         const heightRequired = linesRequired * 4;
                         checkPageBreak(heightRequired);

                         doc.text(nameLines, col1x, y);
                         doc.text(phoneLines, col2x, y);
                         doc.text(extLines, col3x, y);

                         y += heightRequired + 1;
                     }
                 });
            }

            const singleInputs = group.querySelectorAll('.dynamic-input input[type="text"]');
            if (singleInputs.length > 0) {
                doc.setFont(undefined, 'normal');
                singleInputs.forEach(input => {
                     if (input.value.trim() !== '') {
                         const line = `- ${input.value}`;
                         const splitText = doc.splitTextToSize(line, pageWidth - (margin * 2) - 5);
                         const heightRequired = splitText.length * 4;
                         checkPageBreak(heightRequired);
                         doc.text(splitText, margin + 5, y);
                         y += heightRequired + 1;
                     }
                 });
            }
            
            if (group.classList.contains('checkbox-group') || group.id === 'additional-resources-container') {
                const resources = [];
                // Get static checked resources
                if (group.classList.contains('checkbox-group')) {
                    group.querySelectorAll('input[type="checkbox"]:checked').forEach(checkbox => {
                        const fullText = checkbox.parentElement.textContent.trim();
                        const parts = fullText.split(':');
                        if (parts.length >= 2) {
                             const label = parts[0].trim();
                             let value = parts.slice(1).join(':').trim().replace(/‑/g, '-');
                             resources.push({ label, value });
                        }
                    });
                }
                
                // Get dynamic additional resources
                if (group.id === 'additional-resources-container') {
                    document.querySelectorAll('#additional-resources-list .additional-resource-row').forEach(row => {
                        const nameInput = row.querySelector('input:first-child');
                        const contactInput = row.querySelector('input:last-of-type');
                        if (nameInput && contactInput && nameInput.value.trim()) {
                            resources.push({ label: nameInput.value.trim(), value: contactInput.value.trim() });
                        }
                    });
                }

                if (resources.length > 0) {
                    const col1Width = 80;
                    const col2x = margin + col1Width + 2;
                    doc.setFontSize(9);

                    resources.forEach(resource => {
                        doc.setFont(undefined, 'bold');
                        const labelLines = doc.splitTextToSize(resource.label, col1Width);
                        doc.setFont(undefined, 'normal');
                        const valueLines = doc.splitTextToSize(resource.value, pageWidth - col2x - margin);
                        
                        const linesRequired = Math.max(labelLines.length, valueLines.length);
                        const heightRequired = linesRequired * 5;
                        checkPageBreak(heightRequired);

                        doc.setFont(undefined, 'bold');
                        doc.text(resource.label, margin + 5, y, { maxWidth: col1Width, align: 'left' });
                        doc.setFont(undefined, 'normal');
                        doc.text(resource.value, col2x, y, { maxWidth: (pageWidth - col2x - margin), align: 'left' });
                        
                        y += heightRequired + 2;
                    });
                }
            }
            y += 4;
        });

        const totalPages = doc.internal.getNumberOfPages();
        doc.setPage(totalPages);
        let signatureBlockY = pageHeight - 40;
        if (y > signatureBlockY) {
            doc.addPage();
        }
        const signatureY = pageHeight - 35;
        const dateY = signatureY + 15;
        const labelY = signatureY + 4;
        const dateLabelY = dateY + 4;
        const lineLength = 75;
        const leftX = margin;
        const rightX = pageWidth - margin;
        doc.setFontSize(9);
        doc.setFont(undefined, 'normal');
        doc.line(leftX, signatureY, leftX + lineLength, signatureY);
        doc.text("Client", leftX, labelY);
        doc.line(leftX, dateY, leftX + lineLength, dateY);
        doc.text("Date", leftX, dateLabelY);
        doc.line(rightX - lineLength, signatureY, rightX, signatureY);
        doc.text("Clinician", rightX - lineLength, labelY);
        doc.line(rightX - lineLength, dateY, rightX, dateY);
        doc.text("Date", rightX - lineLength, dateLabelY);

        doc.save("safety_plan.pdf");
    }

    document.getElementById("saveBtn").addEventListener("click", generatePDF);

    function createPhoneRow() {
        const nameInput = document.createElement('input'); nameInput.type = 'text'; nameInput.placeholder = 'Name'; nameInput.className = 'name-field';
        const phoneInput = document.createElement('input'); phoneInput.type = 'text'; phoneInput.placeholder = 'Phone (###-###-####)'; phoneInput.className = 'phone-field';
        const extInput = document.createElement('input'); extInput.type = 'text'; extInput.placeholder = 'Extension'; extInput.className = 'ext-field';
        return [nameInput, phoneInput, extInput];
    }

    function createDynamicList(containerId, count, triple = false) {
        const container = document.getElementById(containerId);
        container.innerHTML = '';
        for (let i = 0; i < count; i++) { addEntry(containerId, triple); }
    }

    function addEntry(containerId, triple = false) {
        const container = document.getElementById(containerId);
        const wrapper = document.createElement('div');
        wrapper.className = triple ? 'three-col-input' : 'dynamic-input';
        
        const addBtn = document.createElement('button'); addBtn.type = 'button'; addBtn.textContent = '+'; addBtn.onclick = () => addEntry(containerId, triple);
        const removeBtn = document.createElement('button'); removeBtn.type = 'button'; removeBtn.textContent = '-'; removeBtn.onclick = () => removeEntry(removeBtn);

        if (triple) {
            const [name, phone, ext] = createPhoneRow();
            wrapper.append(name, phone, ext);
        } else {
            const input = document.createElement('input'); input.type = 'text';
            wrapper.appendChild(input);
        }
        wrapper.append(addBtn, removeBtn);
        container.appendChild(wrapper);
    }
    
    function addAdditionalResource() {
        const list = document.getElementById('additional-resources-list');
        const row = document.createElement('div');
        row.className = 'additional-resource-row';
        
        const nameInput = document.createElement('input'); nameInput.type = 'text'; nameInput.placeholder = 'Resource Name';
        const contactInput = document.createElement('input'); contactInput.type = 'text'; contactInput.placeholder = 'Contact Information';
        const addBtn = document.createElement('button'); addBtn.type = 'button'; addBtn.textContent = '+'; addBtn.onclick = addAdditionalResource;
        const removeBtn = document.createElement('button'); removeBtn.type = 'button'; removeBtn.textContent = '-'; removeBtn.onclick = () => removeEntry(removeBtn);

        row.append(nameInput, contactInput, addBtn, removeBtn);
        list.appendChild(row);
    }

    function removeEntry(button) {
        const row = button.parentElement;
        if (row.parentElement.children.length > 1 || row.parentElement.id === 'additional-resources-list') {
            row.remove();
        }
        const list = document.getElementById('additional-resources-list');
        if (list && list.children.length === 0) {
            addAdditionalResource();
        }
    }

    document.addEventListener('input', function(e) {
        if (e.target.matches('.phone-field')) {
            const input = e.target;
            const value = input.value.replace(/\D/g, '').substring(0, 10);
            const size = value.length;
            if (size > 6) input.value = `${value.substring(0, 3)}-${value.substring(3, 6)}-${value.substring(6, 10)}`;
            else if (size > 3) input.value = `${value.substring(0, 3)}-${value.substring(3, 6)}`;
            else if (size > 0) input.value = value;
        }
    });

    document.addEventListener('DOMContentLoaded', () => {
        document.getElementById('planDate').value = new Date().toISOString().split('T')[0];
        
        createDynamicList('warningSignsList', 3);
        createDynamicList('copingStrategiesList', 3);
        createDynamicList('distractionPeopleList', 2, true);
        createDynamicList('socialSettingsList', 2);
        createDynamicList('helpPeopleList', 2, true);
        createDynamicList('safetyEnvironmentList', 2);
        createDynamicList('professionalHelpList', 2, true);
        
        addAdditionalResource();
    });
  </script>
</body>
</html>
